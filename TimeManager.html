<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Raze - Task Management for Accountants</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext y='50' x='6' font-size='48'%3E%E2%8F%B1%3C/text%3E%3C/svg%3E">

  <style>
    :root {
      --bg: #050509;
      --panel: #0f151a;
      --panel-2: #141420;
      --text: #f5f5f7;
      --muted: #9ca3af;
      --border: #2a2a3d;
      --accent: #3b82f6;
      --accent-2: #60a5fa;
      --teal: #3b82f6;
      --teal-2: #60a5fa;
      --danger: #ef4444;
      --warning: #f59e0b;
      --success: #22c55e;
    }

    /* Light theme */
    :root.light {
      --bg: #f5f7fa;
      --panel: #ffffff;
      --panel-2: #e8ecf1;
      --text: #1a1a2e;
      --muted: #6b7280;
      --border: #d1d5db;
      --accent: #2563eb;
      --accent-2: #3b82f6;
      --teal: #2563eb;
      --teal-2: #3b82f6;
      --danger: #dc2626;
      --warning: #d97706;
      --success: #16a34a;
    }

    :root.light input[type="checkbox"] {
      background: #ffffff !important;
    }

    :root.light .custom-checkbox {
      background: #ffffff !important;
    }

    :root.light .completed {
      background: rgba(0, 0, 0, 0.02);
      color: rgba(26, 26, 46, 0.55);
    }

    :root.light input[type="date"]::-webkit-calendar-picker-indicator {
      filter: none;
    }

    /* Theme toggle button */
    .theme-toggle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1px solid rgba(20, 184, 166, 0.55);
      background: transparent;
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: border-color 0.2s;
    }

    .theme-toggle:hover {
      border-color: var(--teal-2);
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 20px;
    }

    .header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    h1 {
      margin: 0;
      font-size: 20px;
      color: var(--text);
    }

    .meta {
      display: flex;
      align-items: baseline;
      gap: 12px;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    #activeTimer {
      font-size: 40px;
      font-weight: 700;
      color: var(--teal-2);
      white-space: nowrap;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--panel);
    }

    th, td {
      height: 40px;
      white-space: nowrap;
      border: 1px solid var(--border);
      padding: 4px 6px;
      font-size: 14px;
      vertical-align: middle;
      color: var(--text);
    }

    th {
      background: var(--panel-2);
      text-align: left;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    input[type="text"],
    input[type="password"],
    input[type="email"],
    input[type="number"] {
      width: 100%;
      box-sizing: border-box;
      height: 31px;
      padding: 4px 8px;
      border: 1px solid rgba(20, 184, 166, 0.55);
      border-radius: 8px;
      outline: none;
      background: transparent;
      color: var(--text);
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="email"]:focus,
    input[type="number"]:focus {
      border-color: var(--teal-2);
    }

    .controls {
      margin: 10px 0;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    button {
      padding: 6px 12px;
      cursor: pointer;
      border: 1px solid rgba(20, 184, 166, 0.55);
      background: transparent;
      color: var(--text);
      border-radius: 8px;
    }

    button:hover {
      border-color: var(--teal-2);
    }

    .btn-danger {
      border-color: rgba(255, 90, 95, 0.55);
      color: rgba(255, 90, 95, 0.95);
    }

    .btn-danger:hover {
      border-color: rgba(255, 90, 95, 0.95);
    }

    select {
      height: 31px;
      border: 1px solid rgba(20, 184, 166, 0.55);
      border-radius: 8px;
      background: var(--panel-2);
      padding: 2px 8px;
      color: var(--text);
      outline: none;
    }

    select:focus {
      border-color: var(--teal-2);
    }

    option {
      background: var(--panel);
      color: var(--text);
    }

    input[type="date"] {
      height: 31px;
      border: 1px solid rgba(20, 184, 166, 0.55);
      border-radius: 8px;
      background: var(--panel-2);
      padding: 2px 4px;
      color: var(--text);
      outline: none;
      box-sizing: border-box;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    input[type="date"]:focus {
      border-color: var(--teal-2);
    }

    input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
      opacity: 0.6;
      cursor: pointer;
    }

    .due-date-display:hover {
      border-color: var(--teal-2);
      background: var(--panel);
    }

    input[type="checkbox"] {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border: 1px solid rgba(20, 184, 166, 0.55);
      border-radius: 4px;
      background: #0f151a !important;
      cursor: pointer;
      position: relative;
      outline: none;
    }

    input[type="checkbox"]:checked {
      background: var(--teal);
      border-color: var(--teal);
    }

    input[type="checkbox"]:checked::after {
      content: '‚úì';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--bg);
      font-size: 12px;
      font-weight: bold;
    }

    input[type="checkbox"]:hover {
      border-color: var(--teal-2);
    }

    .custom-checkbox:hover {
      border-color: var(--teal-2) !important;
    }

    .custom-checkbox.checked {
      background: var(--teal) !important;
      color: #fff !important;
    }

    th[id^="sort"]:hover {
      background: var(--panel);
      color: var(--teal-2);
    }

    th[id^="sort"] span {
      font-size: 12px;
      margin-left: 2px;
      color: var(--teal-2);
      font-weight: bold;
    }

    .delete-btn {
      cursor: pointer;
      color: var(--danger);
      font-weight: 900;
      text-align: center;
      user-select: none;
    }

    .completed {
      background: rgba(255, 255, 255, 0.02);
      color: rgba(232, 238, 242, 0.55);
    }

    tr.selected:not(.divider) {
      background: rgba(45, 212, 191, 0.08);
      outline: 1px solid rgba(45, 212, 191, 0.3);
      outline-offset: -1px;
    }

    tr.divider td {
      background: rgba(255, 255, 255, 0.03);
      height: 26px;
      font-size: 12px;
      color: var(--muted);
      padding: 4px 8px;
      border-left: 1px solid var(--border);
      border-right: 1px solid var(--border);
    }

    .prio {
      width: 100%;
      height: 31px;
      line-height: 31px;
      text-align: center;
      border: 1px solid rgba(20, 184, 166, 0.55);
      border-radius: 8px;
      user-select: none;
      cursor: pointer;
      font-weight: 800;
      color: var(--text);
      background: transparent;
    }

    .prio.low { color: rgba(232, 238, 242, 0.75); }
    .prio.medium { color: var(--accent-2); }
    .prio.high { color: #ff9aa2; }

    /* Due date styles */
    .due-badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      white-space: nowrap;
    }
    .due-overdue { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .due-soon { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
    .due-normal { background: rgba(59, 130, 246, 0.15); color: var(--accent-2); }

    /* Status styles */
    .status-badge {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      font-weight: 600;
      white-space: nowrap;
    }
    .status-not-started { background: rgba(107, 114, 128, 0.3); color: #9ca3af; }
    .status-info-requested { background: rgba(245, 158, 11, 0.3); color: #fbbf24; }
    .status-in-progress { background: rgba(59, 130, 246, 0.3); color: #60a5fa; }
    .status-review { background: rgba(139, 92, 246, 0.3); color: #a78bfa; }
    .status-lodged { background: rgba(34, 197, 94, 0.3); color: #4ade80; }
    .status-complete { background: rgba(16, 185, 129, 0.3); color: #34d399; }

    /* Job type */
    .job-type {
      font-size: 10px;
      color: var(--muted);
      background: rgba(255, 255, 255, 0.05);
      padding: 2px 6px;
      border-radius: 4px;
    }

    /* Billable indicator */
    .billable-icon {
      color: var(--success) !important;
    }
    .non-billable-icon {
      color: var(--muted) !important;
      opacity: 0.6;
    }
    [data-field="billable"]:hover {
      border-color: var(--teal-2) !important;
    }

    /* Summary bar */
    .summary-bar {
      display: flex;
      gap: 20px;
      padding: 10px 0;
      margin-bottom: 10px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .summary-stat {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .summary-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
    }
    .summary-value.overdue { color: var(--danger); }
    .summary-value.accent { color: var(--accent-2); }
    .summary-label {
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .center { text-align: center; }

    .timer-btn,
    .icon-btn {
      width: 100%;
      height: 31px;
      line-height: 31px;
      text-align: center;
      border: 1px solid rgba(20, 184, 166, 0.55);
      border-radius: 8px;
      user-select: none;
      cursor: pointer;
      font-weight: 900;
      color: var(--text);
      background: transparent;
      font-size: 13px;
      position: relative;
    }

    .timer-btn.running {
      border-color: var(--teal-2);
      color: var(--teal-2);
    }

    .timer-btn.disabled,
    .icon-btn.disabled {
      opacity: 0.35;
      cursor: not-allowed;
    }

    .has-dot::after {
      content: '';
      position: absolute;
      top: 5px;
      right: 6px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--teal-2);
      box-shadow: 0 0 0 1px rgba(0,0,0,0.35);
    }

    .subtle {
      font-size: 12px;
      color: var(--muted);
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }
    #scheduleModalBackdrop {
      z-index: 10001;
    }
    #ganttModalBackdrop {
      z-index: 10000;
    }

    .draggable-modal {
      position: absolute;
      margin: 0;
    }
    .draggable-handle {
      cursor: move;
      user-select: none;
    }
    .draggable-handle input,
    .draggable-handle button,
    .draggable-handle select {
      cursor: pointer;
    }

    .modal {
      width: min(760px, 96vw);
      background: var(--panel);
      border: 1px solid rgba(20, 184, 166, 0.45);
      border-radius: 12px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.45);
      overflow: hidden;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 14px;
      background: var(--panel-2);
      border-bottom: 1px solid var(--border);
    }

    .modal-title {
      font-weight: 800;
      color: var(--text);
      font-size: 13px;
      letter-spacing: 0.2px;
    }

    .modal-body {
      padding: 12px 14px;
    }

    textarea {
      width: 100%;
      min-height: 220px;
      resize: vertical;
      box-sizing: border-box;
      border: 1px solid rgba(20, 184, 166, 0.55);
      border-radius: 10px;
      background: transparent;
      color: var(--text);
      padding: 10px;
      outline: none;
    }

    textarea:focus {
      border-color: var(--teal-2);
    }

    .modal-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      border-top: 1px solid var(--border);
      background: rgba(255,255,255,0.01);
    }

    .link-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }

    .list {
      display: grid;
      gap: 6px;
      margin-top: 8px;
    }

    .list-item {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 8px;
      align-items: center;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(255,255,255,0.01);
    }

    .list-item a {
      color: var(--teal-2);
      text-decoration: none;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: inline-block;
      max-width: 100%;
    }

    .pill {
      font-size: 11px;
      color: var(--muted);
      border: 1px solid var(--border);
      padding: 2px 8px;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .mini {
      padding: 4px 10px;
      font-size: 12px;
    }

    .hidden-input { display: none; }

    .icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      line-height: 0;
    }

    .icon svg {
      width: 14px;
      height: 14px;
      fill: currentColor;
    }

    /* Completion animation */
    @keyframes liftAndDrop {
      0%   { transform: translateY(0) scale(1); box-shadow: none; z-index:1; }
      40%  { transform: translateY(-35px) scale(1.05); box-shadow: 0 45px 140px rgba(0,0,0,0.9); z-index:10; }
      80%  { transform: translateY(-60px) scale(1.07); box-shadow: 0 60px 180px rgba(0,0,0,0.95); z-index:10; }
      100% { transform: translateY(0) scale(1); box-shadow: none; z-index:1; }
    }

    tr.lift-move {
      animation: liftAndDrop 1800ms cubic-bezier(.22,.75,.25,1);
    }

    /* Toast */
    #toast {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(11, 15, 18, 0.88);
      border: none;
      color: var(--text);
      padding: 24px;
      font-weight: 900;
      font-size: 32px;
      letter-spacing: 0.4px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 220ms ease;
      z-index: 20000;
      text-align: center;
    }

    #toast.show {
      opacity: 1;
    }

    /* Schedule list item */
    .schedule-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 6px;
      background: var(--panel-2);
    }
    .schedule-item-date {
      color: var(--text);
      font-weight: 600;
      min-width: 90px;
    }
    .schedule-item-hours {
      color: var(--accent-2);
      font-weight: 700;
      flex: 1;
    }
    .schedule-item-hours-input {
      width: 60px !important;
      height: 28px !important;
      padding: 4px 8px !important;
      border: 1px solid rgba(20, 184, 166, 0.55) !important;
      border-radius: 8px !important;
      background: #141420 !important;
      color: #f4f7fb !important;
      font-weight: 600 !important;
      font-size: 13px !important;
      text-align: center !important;
      -webkit-appearance: none;
      -moz-appearance: textfield;
    }
    .schedule-item-hours-input:focus {
      outline: none !important;
      border-color: #2dd4bf !important;
    }
    .schedule-item-delete {
      color: var(--danger);
      cursor: pointer;
      font-weight: 900;
      padding: 2px 8px;
    }
    .schedule-item-delete:hover {
      background: rgba(239, 68, 68, 0.2);
      border-radius: 4px;
    }

    /* Gantt Chart */
    .gantt-chart {
      min-height: 300px;
      position: relative;
    }
    .gantt-empty {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: var(--muted);
      font-size: 14px;
    }
    .gantt-container {
      display: grid;
      grid-template-columns: 200px 1fr;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    .gantt-sidebar {
      background: var(--panel-2);
      border-right: 1px solid var(--border);
    }
    .gantt-sidebar-header {
      height: 40px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      font-weight: 700;
      color: var(--muted);
      font-size: 12px;
      position: sticky;
      top: 0;
      background: var(--panel-2);
      z-index: 2;
    }
    .gantt-sidebar-header .client-col {
      width: 120px;
      padding: 0 8px;
      border-right: 1px solid var(--border);
    }
    .gantt-sidebar-header .task-col {
      flex: 1;
      padding: 0 8px;
    }
    .gantt-sidebar-row {
      height: 36px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
      color: var(--text);
      cursor: pointer;
      overflow: hidden;
    }
    .gantt-sidebar-row .client-col {
      width: 120px;
      padding: 0 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-right: 1px solid var(--border);
    }
    .gantt-sidebar-row .task-col {
      flex: 1;
      padding: 0 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .gantt-sidebar-row:hover {
      background: rgba(59, 130, 246, 0.1);
    }
    .gantt-timeline {
      overflow-x: auto;
      overflow-y: hidden;
      cursor: grab;
      user-select: none;
    }
    .gantt-timeline .gantt-bar {
      cursor: pointer;
    }
    .gantt-header {
      display: flex;
      height: 40px;
      border-bottom: 1px solid var(--border);
      background: var(--panel-2);
      position: sticky;
      top: 0;
    }
    .gantt-header-cell {
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      border-right: 1px solid var(--border);
      font-size: 10px;
      color: var(--muted);
      flex-shrink: 0;
    }
    .gantt-header-cell.weekend {
      background: rgba(255, 255, 255, 0.02);
    }
    .gantt-header-cell.today {
      background: rgba(59, 130, 246, 0.15);
      color: var(--accent-2);
      font-weight: 700;
    }
    .gantt-rows {
      position: relative;
    }
    .gantt-row {
      height: 36px;
      display: flex;
      border-bottom: 1px solid var(--border);
      position: relative;
    }
    .gantt-row-cell {
      height: 36px;
      border-right: 1px solid var(--border);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .gantt-row-cell:hover {
      background: rgba(59, 130, 246, 0.1);
    }
    .gantt-row-cell.weekend {
      background: rgba(255, 255, 255, 0.02);
    }
    .gantt-row-cell.holiday {
      background: rgba(239, 68, 68, 0.15);
    }
    .gantt-row-cell.holiday::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 3px,
        rgba(239, 68, 68, 0.1) 3px,
        rgba(239, 68, 68, 0.1) 6px
      );
      pointer-events: none;
    }
    .gantt-header-cell.holiday {
      background: rgba(239, 68, 68, 0.2) !important;
      color: #ef4444;
    }
    .gantt-row-cell.today {
      background: rgba(59, 130, 246, 0.08);
    }
    .gantt-totals-row {
      font-weight: 700;
      background: rgba(20, 184, 166, 0.08);
      border-top: 2px solid var(--teal);
    }
    .gantt-sidebar-row.gantt-totals-row {
      color: var(--teal);
    }
    .gantt-total-cell {
      font-size: 10px;
      color: var(--teal);
      cursor: default;
    }
    .gantt-total-cell.over-capacity {
      color: var(--danger);
      background: rgba(239, 68, 68, 0.15);
    }
    .gantt-bar {
      width: calc(100% - 6px);
      height: 24px;
      border-radius: 4px;
      background: var(--accent);
      cursor: grab;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 2px;
      font-size: 9px;
      color: white;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      box-sizing: border-box;
      margin: 0 auto;
    }
    .gantt-bar:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transform: translateY(-1px);
    }
    .gantt-bar:active {
      cursor: grabbing;
    }
    .gantt-bar.completed {
      background: var(--success);
    }
    .gantt-bar.locked-in {
      background: #22c55e; /* Green */
    }
    .gantt-bar.likely {
      background: #3b82f6; /* Blue */
    }
    .gantt-bar.tentative {
      background: #f59e0b; /* Orange */
    }
    .gantt-bar.overdue {
      background: var(--danger);
    }
    .gantt-bar.due-soon {
      background: var(--warning);
    }
    .gantt-bar-resize {
      position: absolute;
      top: 0;
      width: 8px;
      height: 100%;
      cursor: ew-resize;
    }
    .gantt-bar-resize.left { left: 0; }
    .gantt-bar-resize.right { right: 0; }
    .gantt-due-marker {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 2px;
      background: var(--danger);
      z-index: 2;
    }
    .gantt-due-marker::before {
      content: '';
      position: absolute;
      top: 4px;
      left: -4px;
      width: 10px;
      height: 10px;
      background: var(--danger);
      transform: rotate(45deg);
    }
    .gantt-zoom-btn.active {
      background: var(--accent);
      border-color: var(--accent);
    }
    .sched-mode-btn.active {
      background: var(--accent);
      border-color: var(--accent);
    }
    .sched-team-tab {
      transition: background 0.15s, border-color 0.15s;
    }
    .sched-team-tab.active {
      background: var(--teal);
      border-color: var(--teal);
      color: white;
    }

    /* Custom visible checkboxes - hide native, show custom box */
    .checkbox-wrap {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .checkbox-wrap input[type="checkbox"] {
      display: none;
    }
    .checkbox-box {
      width: 18px;
      height: 18px;
      border: 2px solid var(--muted);
      border-radius: 4px;
      background: var(--panel);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: transparent;
      font-weight: 700;
    }
    .checkbox-wrap input[type="checkbox"]:checked + .checkbox-box {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    .checkbox-wrap:hover .checkbox-box {
      border-color: var(--accent);
    }

    /* Notification pulse indicator */
    .notification-pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(59, 130, 246, 0); }
    }

    /* Recurring task icon */
    .recurring-icon {
      color: var(--accent-2);
      cursor: pointer;
    }

    .recurring-icon.active {
      color: var(--success);
    }

    /* Dependency lock icon */
    .dependency-locked {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .dependency-icon {
      color: var(--muted);
      cursor: pointer;
    }

    .dependency-icon.has-deps {
      color: var(--warning);
    }

    /* Drag handle */
    .drag-handle {
      cursor: grab;
      color: var(--muted);
      user-select: none;
      font-size: 14px;
      opacity: 0.5;
      transition: opacity 0.2s;
    }

    .drag-handle:hover {
      opacity: 1;
    }

    tr.dragging {
      opacity: 0.5;
      background: var(--panel-2);
    }

    tr.drag-over {
      border-top: 2px solid var(--accent);
    }

    /* Dashboard styles */
    .dashboard-modal {
      width: min(900px, 96vw);
      max-height: 90vh;
      overflow-y: auto;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      padding: 16px 0;
    }

    .dashboard-card {
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
    }

    .dashboard-card-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 12px;
    }

    .dashboard-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text);
    }

    .completion-ring {
      width: 120px;
      height: 120px;
      margin: 0 auto;
    }

    .bar-chart {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .bar-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .bar-label {
      width: 80px;
      font-size: 11px;
      color: var(--muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .bar-container {
      flex: 1;
      height: 16px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .bar-value {
      width: 50px;
      font-size: 11px;
      color: var(--text);
      text-align: right;
    }

    .pie-chart-container {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .pie-legend {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }

    .time-range-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .time-range-btn {
      padding: 6px 12px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--muted);
      cursor: pointer;
      font-size: 12px;
    }

    .time-range-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    /* Notification settings modal */
    .notification-settings {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .notification-setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--panel-2);
      border-radius: 8px;
    }

    /* Recurrence modal */
    .recurrence-options {
      display: grid;
      gap: 12px;
    }

    .recurrence-option {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Dependencies modal */
    .dependency-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .dependency-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border-bottom: 1px solid var(--border);
    }

    .dependency-item:last-child {
      border-bottom: none;
    }

    .dependency-status {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    .dependency-status.complete {
      background: var(--success);
      color: white;
    }

    .dependency-status.incomplete {
      background: var(--muted);
      color: white;
    }
  </style>

  <!-- Firebase (compat build so this file runs in a plain <script> context) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>

  <!-- Maintenance Mode Overlay -->
  <div id="maintenanceOverlay" style="display:none; position:fixed; inset:0; background:var(--bg); z-index:99999; align-items:center; justify-content:center;">
    <div style="text-align:center; padding:40px; max-width:500px;">
      <div style="font-size:48px; margin-bottom:20px;">&#128736;</div>
      <h1 style="font-size:24px; margin:0 0 16px; color:var(--warning);">Maintenance Mode</h1>
      <p id="maintenanceMessage" style="color:var(--muted); line-height:1.6;">
        We're currently performing scheduled maintenance. Please check back soon.
      </p>
      <button onclick="firebase.auth().signOut().then(() => window.location.href='login.html')" style="margin-top:24px; padding:10px 24px; background:var(--panel); border:1px solid var(--border); border-radius:8px; color:var(--text); cursor:pointer;">
        Sign Out
      </button>
    </div>
  </div>

  <!-- System Announcements Container -->
  <div id="announcementsContainer"></div>

  <!-- Auth (Firebase email/password) -->
  <div id="authBackdrop" class="modal-backdrop" style="display:flex;">
    <div class="modal" style="width:min(520px, 96vw);">
      <div class="modal-header">
        <div class="modal-title">Sign in</div>
        <div class="subtle" id="authStatus" style="margin-left:auto;">‚Äî</div>
      </div>
      <div class="modal-body">
        <div class="subtle" style="margin-bottom:10px;">Email + password login. Tasks sync across devices when Firebase is configured.</div>
        <div style="display:grid; gap:10px;">
          <input id="authEmail" type="text" placeholder="Email" autocomplete="username" />
          <div style="position:relative;">
            <input id="authPass" type="password" placeholder="Password" autocomplete="current-password" style="width:100%; padding-right:40px;" />
            <button id="togglePassBtn" type="button" style="position:absolute; right:8px; top:50%; transform:translateY(-50%); background:none; border:none; color:var(--muted); cursor:pointer; font-size:12px;">Show</button>
          </div>
        </div>
        <div class="controls" style="margin-top:12px; justify-content:space-between;">
          <button id="cancelAuthBtn" type="button" style="background:var(--panel); border:1px solid var(--border);">Cancel</button>
          <div style="display:flex; gap:8px;">
            <button id="signInBtn" type="button">Sign in</button>
            <button id="signUpBtn" type="button">Create account</button>
          </div>
        </div>
        <div style="margin-top:10px; text-align:center;">
          <a id="forgotPassBtn" href="#" style="color:var(--teal-2); font-size:12px;">Forgot password?</a>
        </div>
      </div>
    </div>
  </div>

  <div id="app" style="display:none;">
    <div class="header">
      <div>
        <div style="display:flex; align-items:center; gap:12px;">
          <button id="homeBtn" type="button" style="padding:6px 12px;">Home</button>
          <span style="font-size:20px; font-weight:800; background: linear-gradient(135deg, var(--accent), var(--accent-2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;">Raze</span>
        </div>
      </div>
      <div class="meta">
        <div id="firmSwitcher" style="display:none; position:relative;">
          <button id="firmSwitcherBtn" type="button" onclick="toggleFirmSwitcherDropdown(event)" style="padding:4px 12px; font-size:11px; background:var(--teal); color:white; border-color:var(--teal); border-radius:6px; cursor:pointer; display:flex; align-items:center; gap:6px;">
            <span id="firmSwitcherName">Firm</span>
            <span style="font-size:10px;">‚ñº</span>
          </button>
          <div id="firmSwitcherDropdown" style="display:none; position:absolute; top:100%; right:0; margin-top:4px; background:var(--panel); border:1px solid var(--border); border-radius:8px; min-width:200px; max-height:300px; overflow-y:auto; box-shadow:0 8px 24px rgba(0,0,0,0.4); z-index:9999;">
          </div>
        </div>
        <span class="subtle" id="userBadgeHeader" style="font-size:12px;"></span>
        <button id="signOutBtnHeader" class="mini" type="button" title="Sign out" style="padding:4px 10px; font-size:11px;">Sign out</button>
        <div id="activeTimer">‚è± ‚Äî</div>
        <button id="themeToggle" class="theme-toggle" title="Toggle dark/light theme">üåô</button>
      </div>
    </div>

    <!-- Summary Bar -->
    <div class="summary-bar">
      <div class="summary-stat">
        <span class="summary-value" id="totalTasksCount">0</span>
        <span class="summary-label">Total Tasks</span>
      </div>
      <div class="summary-stat">
        <span class="summary-value overdue" id="overdueCount">0</span>
        <span class="summary-label">Overdue</span>
      </div>
      <div class="summary-stat">
        <span class="summary-value" id="dueThisWeekCount">0</span>
        <span class="summary-label">Due This Week</span>
      </div>
      <div class="summary-stat">
        <span class="summary-value accent" id="timeThisWeek">0:00</span>
        <span class="summary-label">Time This Week</span>
      </div>
      <div class="summary-stat">
        <span class="summary-value accent" id="billableTime">0:00</span>
        <span class="summary-label">Billable Time</span>
      </div>
    </div>

    <div class="controls">
      <button id="addBtn" type="button">Add Task</button>
      <button id="emailBtn" type="button" title="Opens your email app with the current work list.">Email list</button>
      <button id="copyBtn" type="button" title="Copies the current work list to clipboard.">Copy list</button>
      <button id="excelBtn" type="button" title="Download tasks to Excel file.">Download Excel</button>
      <button id="adminBtn" type="button" title="Manage Clients and Job Types">Admin</button>
      <button id="teamBtn" type="button" title="Manage Team Members" style="display:none;">Team</button>
      <button id="rolesBtn" type="button" title="Manage Roles and Hierarchy" style="display:none;">Roles</button>
      <button id="holidaysBtn" type="button" title="Manage Holidays and Blocked Days" style="display:none;">Holidays</button>
      <button id="ganttBtn" type="button" title="View Execution Plan">Execution Plan</button>
      <button id="capacityBtn" type="button" title="Check available capacity" style="background:var(--teal); color:white; border-color:var(--teal);">Capacity</button>
      <button id="dashboardBtn" type="button" title="View analytics dashboard">Dashboard</button>
      <button id="notificationsBtn" type="button" title="Configure notifications">üîî Notifications</button>

      <div style="display:flex; align-items:center; gap:6px;">
        <span class="subtle">Status</span>
        <select id="filterStatus">
          <option value="all">All</option>
          <option value="Not Started">Not Started</option>
          <option value="Info Requested">Info Requested</option>
          <option value="In Progress">In Progress</option>
          <option value="Review">Review</option>
          <option value="Lodged">Lodged</option>
          <option value="Complete">Complete</option>
        </select>
      </div>

      <div style="display:flex; align-items:center; gap:6px;">
        <span class="subtle">Job Type</span>
        <select id="filterJobType">
          <option value="all">All</option>
          <option value="Tax Return">Tax Return</option>
          <option value="BAS">BAS</option>
          <option value="Financial Statements">Financial Statements</option>
          <option value="Audit">Audit</option>
          <option value="Bookkeeping">Bookkeeping</option>
          <option value="Advisory">Advisory</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <button id="clearArchiveBtn" class="btn-danger" type="button" title="Permanently clears archived tasks (not visible in the list).">Clear Archive</button>
      <span class="subtle" id="archiveCount">Archive: 0</span>
      <button id="clearBlankBtn" type="button" title="Remove rows with no client and no task">Clear Blank Rows</button>

      <span style="flex:1;"></span>
      <span class="subtle" id="userBadge" title="Signed in user" style="white-space:nowrap;">‚Äî</span>
      <button id="signOutBtn" class="mini" type="button" title="Sign out">Sign out</button>
    </div>

    <datalist id="clientList"></datalist>

    <table>
      <thead>
        <tr>
          <th style="width:20px; text-align:center;" title="Drag to reorder">‚ãÆ</th>
          <th style="width:32px; text-align:center;">#</th>
          <th id="sortClient" style="width:140px; cursor:pointer;" title="Click to sort by client">Client <span id="sortClientIcon"></span></th>
          <th style="width:300px;">Task</th>
          <th style="width:70px;">Job Type</th>
          <th style="width:70px;">Status</th>
          <th id="assignedHeader" style="width:90px; display:none;">Assigned</th>
          <th id="sortDue" style="width:70px; cursor:pointer;" title="Click to sort by due date">Due <span id="sortDueIcon"></span></th>
          <th id="sortPriority" style="width:20px; text-align:center; cursor:pointer;" title="Click to sort by priority">P <span id="sortPriorityIcon"></span></th>
          <th style="width:24px; text-align:center;">‚úì</th>
          <th style="width:24px; text-align:center;">‚è±</th>
          <th style="width:24px; text-align:center;" title="Schedule">
            <svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true" style="vertical-align:middle; fill: currentColor; opacity:0.85;"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm-8 4H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/></svg>
          </th>
          <th style="width:24px; text-align:center;" title="Notes">
            <svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true" style="vertical-align:middle; fill: currentColor; opacity:0.85;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm0 2.5L19.5 10H14V4.5zM8 13h8v2H8v-2zm0 4h8v2H8v-2zM8 9h4v2H8V9z"/></svg>
          </th>
          <th style="width:24px; text-align:center;" title="Links &amp; Documents">
            <svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true" style="vertical-align:middle; fill: currentColor; opacity:0.85;"><path d="M10.59 13.41a1 1 0 0 1 0-1.41l3.18-3.18a3 3 0 0 1 4.24 4.24l-2.47 2.47a3 3 0 0 1-4.24 0 1 1 0 1 1 1.41-1.41 1 1 0 0 0 1.41 0l2.47-2.47a1 1 0 0 0-1.41-1.41l-3.18 3.18a1 1 0 0 1-1.41 0z"/><path d="M13.41 10.59a1 1 0 0 1 0 1.41l-3.18 3.18a3 3 0 0 1-4.24-4.24l2.47-2.47a3 3 0 0 1 4.24 0 1 1 0 0 1-1.41 1.41 1 1 0 0 0-1.41 0L7.41 11.35a1 1 0 0 0 1.41 1.41l3.18-3.18a1 1 0 0 1 1.41 0z"/></svg>
          </th>
          <th style="width:24px; text-align:center;" title="Recurring">üîÑ</th>
          <th style="width:24px; text-align:center;" title="Dependencies">üîó</th>
          <th style="width:24px; padding:4px; text-align:center;"></th>
        </tr>
      </thead>
      <tbody id="taskBody"></tbody>
    </table>

    <div id="toast" aria-live="polite"></div>

    <!-- Notes Modal -->
    <div id="notesBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title" id="notesTitle">Notes</div>
          <button id="notesClose" class="mini" type="button">Close</button>
        </div>
        <div class="modal-body">
          <textarea id="notesTextarea" placeholder="Write detailed notes here. These do not affect the table layout."></textarea>
          <div class="subtle" style="margin-top:6px;" id="notesHint">Saved automatically.</div>
        </div>
        <div class="modal-footer">
          <div class="subtle" id="notesMeta">‚Äî</div>
          <button id="notesSave" class="mini" type="button">Done</button>
        </div>
      </div>
    </div>

    <!-- Links/Docs Modal -->
    <div id="linksBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title" id="linksTitle">Links &amp; Documents</div>
          <button id="linksClose" class="mini" type="button">Close</button>
        </div>
        <div class="modal-body">
          <div class="link-row">
            <input id="newLinkInput" type="text" placeholder="Paste a link (e.g. SharePoint/Drive/Netlify/Outlook link)" />
            <button id="addLinkBtn" class="mini" type="button">Add</button>
          </div>

          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <button id="uploadBtn" class="mini" type="button">Upload file</button>
            <span class="subtle">Files are stored locally in this browser. Keep them small.</span>
            <input id="filePicker" class="hidden-input" type="file" />
          </div>

          <div class="list" id="linksList" style="margin-top:12px;"></div>
        </div>
        <div class="modal-footer">
          <div class="subtle" id="linksMeta">‚Äî</div>
          <button id="linksDone" class="mini" type="button">Done</button>
        </div>
      </div>
    </div>

    <!-- Admin Modal -->
    <div id="adminBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
      <div class="modal" style="width:min(600px, 96vw);">
        <div class="modal-header">
          <div class="modal-title">Admin Settings</div>
          <button id="adminClose" class="mini" type="button">Close</button>
        </div>
        <div class="modal-body">
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
            <!-- Clients Section -->
            <div>
              <div style="font-weight:700; margin-bottom:8px; color:var(--text);">Clients</div>
              <div style="display:flex; gap:6px; margin-bottom:8px;">
                <input id="newClientInput" type="text" placeholder="Add new client" style="flex:1;" />
                <button id="addClientBtn" class="mini" type="button">Add</button>
              </div>
              <div id="clientsMasterList" style="max-height:200px; overflow-y:auto; border:1px solid var(--border); border-radius:8px; padding:8px;"></div>
            </div>
            <!-- Job Types Section -->
            <div>
              <div style="font-weight:700; margin-bottom:8px; color:var(--text);">Job Types</div>
              <div style="display:flex; gap:6px; margin-bottom:8px;">
                <input id="newJobTypeInput" type="text" placeholder="Add new job type" style="flex:1;" />
                <button id="addJobTypeBtn" class="mini" type="button">Add</button>
              </div>
              <div id="jobTypesMasterList" style="max-height:200px; overflow-y:auto; border:1px solid var(--border); border-radius:8px; padding:8px;"></div>
            </div>
            <!-- Team Names Section -->
            <div>
              <div style="font-weight:700; margin-bottom:8px; color:var(--text);">Team Names</div>
              <div style="display:flex; gap:6px; margin-bottom:8px;">
                <input id="newTeamNameInput" type="text" placeholder="Add new team" style="flex:1;" />
                <button id="addTeamNameBtn" class="mini" type="button">Add</button>
              </div>
              <div id="teamNamesMasterList" style="max-height:200px; overflow-y:auto; border:1px solid var(--border); border-radius:8px; padding:8px;"></div>
            </div>
          </div>
          <!-- Settings Section -->
          <div style="border-top:1px solid var(--border); padding-top:16px;">
            <div style="font-weight:700; margin-bottom:8px; color:var(--text);">Scheduling Settings</div>
            <div style="display:flex; align-items:center; gap:12px;">
              <label style="color:var(--muted); font-size:13px;">Hours per day:</label>
              <select id="hoursPerDaySelect" style="width:80px;">
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="7.5" selected>7.5</option>
                <option value="8">8</option>
                <option value="custom">Custom</option>
              </select>
              <input id="hoursPerDayCustom" type="number" min="1" max="24" step="0.5" style="width:60px; display:none;" placeholder="Hrs" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <div class="subtle">Changes are saved automatically.</div>
          <button id="adminDone" class="mini" type="button">Done</button>
        </div>
      </div>
    </div>

    <!-- Client Search Modal -->
    <div id="clientSearchBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
      <div class="modal" style="width:min(400px, 96vw);">
        <div class="modal-header">
          <div class="modal-title">Search Clients</div>
          <button id="clientSearchClose" class="mini" type="button">Close</button>
        </div>
        <div class="modal-body">
          <input id="clientSearchInput" type="text" placeholder="Type to search..." style="width:100%; margin-bottom:12px;" />
          <div id="clientSearchResults" style="max-height:250px; overflow-y:auto; border:1px solid var(--border); border-radius:8px;"></div>
        </div>
      </div>
    </div>

    <!-- Add Client Confirm Modal -->
    <div id="addClientConfirmBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
      <div class="modal" style="width:min(350px, 96vw);">
        <div class="modal-header">
          <div class="modal-title">Add to Client List?</div>
        </div>
        <div class="modal-body">
          <p id="addClientConfirmText" style="margin:0; color:var(--text);"></p>
        </div>
        <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:10px;">
          <button id="addClientConfirmNo" class="mini" type="button">No</button>
          <button id="addClientConfirmYes" type="button">Yes</button>
        </div>
      </div>
    </div>

    <!-- Schedule Modal -->
    <div id="scheduleModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
      <div class="modal" id="scheduleModal" style="width:min(95vw, 1000px); max-height:90vh;">
        <div class="modal-header" style="flex-wrap:wrap; gap:6px; padding:8px 12px;">
          <div class="modal-title" style="font-size:13px;">Schedule: <span id="schedTaskName"></span></div>
          <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
            <span style="color:var(--muted); font-size:10px;">From:</span>
            <input type="date" id="schedGridDateFrom" style="font-size:10px; padding:2px 4px; height:24px;" />
            <span style="color:var(--muted); font-size:10px;">To:</span>
            <input type="date" id="schedGridDateTo" style="font-size:10px; padding:2px 4px; height:24px;" />
            <label class="checkbox-wrap" style="color:var(--muted); font-size:10px;">
              <input type="checkbox" id="schedGridWeekdaysOnly" checked />
              <span class="checkbox-box" style="width:14px; height:14px; font-size:10px;">‚úì</span>
              Wkdays
            </label>
            <button id="scheduleClose" class="mini" type="button" style="font-size:10px; padding:2px 8px;">Close</button>
          </div>
        </div>
        <div class="modal-body" style="padding:0; overflow:auto; max-height:calc(90vh - 100px);">
          <!-- Summary Bar -->
          <div style="display:flex; justify-content:space-between; align-items:center; padding:6px 12px; border-bottom:1px solid var(--border); background:var(--panel); position:sticky; top:0; z-index:1;">
            <div style="color:var(--muted); font-size:12px;">
              Total: <span id="schedTotalHours" style="color:var(--text); font-weight:700;">0h</span>
              <span id="schedMemberBreakdown" style="font-size:10px; margin-left:8px;"></span>
            </div>
            <div style="display:flex; gap:6px; align-items:center;">
              <button id="schedAddRange" class="mini" type="button" style="font-size:10px; padding:2px 8px; background:var(--teal); color:white; border-color:var(--teal);">+ Add Range</button>
              <select id="schedGridDefaultStatus" style="height:24px; font-size:10px; padding:1px 4px;">
                <option value="locked">Locked In</option>
                <option value="likely">Likely</option>
                <option value="tentative">Tentative</option>
              </select>
              <button id="schedClearAll" class="mini" type="button" style="color:var(--danger); border-color:var(--danger); font-size:10px; padding:2px 6px;">Clear All</button>
            </div>
          </div>

          <!-- Grid Container -->
          <div id="scheduleGridContainer" style="padding:8px; min-height:200px;"></div>

          <!-- Legacy list view (hidden, for solo mode) -->
          <div id="scheduleLegacyView" style="display:none; padding:16px;">
            <div id="scheduleList" style="max-height:200px; overflow-y:auto; margin-bottom:16px;"></div>
            <!-- Add Time Section for solo mode -->
            <div style="padding-top:12px; border-top:1px solid var(--border);">
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <input type="date" id="schedNewDate" style="flex:1; min-width:100px;" />
                <input type="number" id="schedNewHours" min="0.5" max="24" step="0.5" placeholder="Hours" style="width:70px; height:31px; padding:2px 4px; border:1px solid rgba(20,184,166,0.55); border-radius:8px; background:var(--panel-2); color:var(--text); font-size:13px; text-align:center; box-sizing:border-box;" />
                <select id="schedStatus" style="height:31px; font-size:12px;">
                  <option value="locked">Locked In</option>
                  <option value="likely">Likely</option>
                  <option value="tentative">Tentative</option>
                </select>
                <button id="schedAddBtn" type="button" style="height:31px; box-sizing:border-box;">Add</button>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer" style="padding:6px 12px;">
          <button id="schedViewGantt" class="mini" type="button" style="font-size:10px; padding:4px 10px;">View Execution Plan</button>
          <button id="scheduleDone" type="button" style="font-size:11px; padding:4px 14px;">Done</button>
        </div>
      </div>
    </div>

    <!-- Member Range Popout (for bulk scheduling per team member) -->
    <div id="memberRangePopout" style="display:none; position:fixed; z-index:10005; background:var(--panel); border:1px solid var(--border); border-radius:8px; box-shadow:0 8px 32px rgba(0,0,0,0.3); padding:10px; min-width:280px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <div style="font-weight:600; font-size:12px; color:var(--text);">
          <span id="memberRangeTitle">Add Hours</span>
        </div>
        <button id="memberRangeClose" class="mini" type="button" style="padding:1px 6px; font-size:10px;">‚úï</button>
      </div>

      <!-- Member Selector (shown when opened from button) -->
      <div id="memberRangeSelectorRow" style="margin-bottom:8px;">
        <label style="font-size:9px; color:var(--muted); display:block; margin-bottom:2px;">Team Member</label>
        <select id="memberRangeSelector" style="width:100%; height:26px; font-size:10px;"></select>
      </div>

      <!-- Action Tabs -->
      <div style="display:flex; gap:3px; margin-bottom:8px;">
        <button class="mini member-range-tab active" data-tab="add" type="button" style="flex:1; font-size:10px; padding:3px 6px;">Add</button>
        <button class="mini member-range-tab" data-tab="edit" type="button" style="flex:1; font-size:10px; padding:3px 6px;">Edit</button>
        <button class="mini member-range-tab" data-tab="clear" type="button" style="flex:1; font-size:10px; padding:3px 6px; color:var(--danger); border-color:var(--danger);">Clear</button>
      </div>

      <!-- Add Hours Tab -->
      <div id="memberRangeAddTab" class="member-range-content">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-bottom:8px;">
          <div>
            <label style="font-size:9px; color:var(--muted); display:block; margin-bottom:2px;">From</label>
            <input type="date" id="memberRangeFrom" style="width:100%; height:26px; font-size:10px;" />
          </div>
          <div>
            <label style="font-size:9px; color:var(--muted); display:block; margin-bottom:2px;">To</label>
            <input type="date" id="memberRangeTo" style="width:100%; height:26px; font-size:10px;" />
          </div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-bottom:8px;">
          <div>
            <label style="font-size:9px; color:var(--muted); display:block; margin-bottom:2px;">Hrs/Day</label>
            <input type="number" id="memberRangeHours" min="0.5" max="24" step="0.5" value="8" style="width:100%; height:26px; font-size:10px; text-align:center;" />
          </div>
          <div>
            <label style="font-size:9px; color:var(--muted); display:block; margin-bottom:2px;">Status</label>
            <select id="memberRangeStatus" style="width:100%; height:26px; font-size:10px;">
              <option value="locked">Locked In</option>
              <option value="likely">Likely</option>
              <option value="tentative">Tentative</option>
            </select>
          </div>
        </div>
        <label class="checkbox-wrap" style="color:var(--muted); font-size:10px; margin-bottom:8px;">
          <input type="checkbox" id="memberRangeWeekdays" checked />
          <span class="checkbox-box" style="width:12px; height:12px; font-size:9px;">‚úì</span>
          Weekdays only
        </label>
        <button id="memberRangeAddBtn" type="button" style="width:100%; height:28px; font-size:11px;">Add Hours</button>
      </div>

      <!-- Edit Existing Tab -->
      <div id="memberRangeEditTab" class="member-range-content" style="display:none;">
        <div style="max-height:200px; overflow-y:auto; margin-bottom:8px;">
          <div id="memberRangeEditList" style="display:flex; flex-direction:column; gap:4px;"></div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px;">
          <button id="memberRangeSetStatus" class="mini" type="button" style="font-size:10px;">Set All</button>
          <select id="memberRangeBulkStatus" style="height:24px; font-size:10px;">
            <option value="locked">Locked In</option>
            <option value="likely">Likely</option>
            <option value="tentative">Tentative</option>
          </select>
        </div>
      </div>

      <!-- Clear Range Tab -->
      <div id="memberRangeClearTab" class="member-range-content" style="display:none;">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-bottom:8px;">
          <div>
            <label style="font-size:9px; color:var(--muted); display:block; margin-bottom:2px;">From</label>
            <input type="date" id="memberRangeClearFrom" style="width:100%; height:26px; font-size:10px;" />
          </div>
          <div>
            <label style="font-size:9px; color:var(--muted); display:block; margin-bottom:2px;">To</label>
            <input type="date" id="memberRangeClearTo" style="width:100%; height:26px; font-size:10px;" />
          </div>
        </div>
        <label class="checkbox-wrap" style="color:var(--muted); font-size:10px; margin-bottom:8px;">
          <input type="checkbox" id="memberRangeClearWeekdays" checked />
          <span class="checkbox-box" style="width:12px; height:12px; font-size:9px;">‚úì</span>
          Weekdays only
        </label>
        <button id="memberRangeClearBtn" type="button" style="width:100%; height:28px; font-size:11px; background:var(--danger); border-color:var(--danger);">Clear Range</button>
      </div>
    </div>

    <!-- Gantt View Modal -->
    <div id="ganttModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
      <div id="ganttModal" class="modal draggable-modal" style="width:min(95vw, 1400px); max-height:90vh;">
        <div class="modal-header draggable-handle" style="flex-wrap:wrap; gap:12px; cursor:move;">
          <div style="display:flex; align-items:center; gap:16px;">
            <div class="modal-title">Execution Plan</div>
            <div style="display:flex; gap:12px; font-size:11px;">
              <span style="display:flex; align-items:center; gap:4px;"><span style="width:12px; height:12px; background:#22c55e; border-radius:3px;"></span> Locked In</span>
              <span style="display:flex; align-items:center; gap:4px;"><span style="width:12px; height:12px; background:#3b82f6; border-radius:3px;"></span> Likely</span>
              <span style="display:flex; align-items:center; gap:4px;"><span style="width:12px; height:12px; background:#f59e0b; border-radius:3px;"></span> Tentative</span>
            </div>
          </div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <span style="color:var(--muted); font-size:12px;">From:</span>
            <input type="date" id="ganttDateFrom" style="font-size:12px; padding:4px 8px;" />
            <span style="color:var(--muted); font-size:12px;">To:</span>
            <input type="date" id="ganttDateTo" style="font-size:12px; padding:4px 8px;" />
            <button id="ganttDateReset" class="mini" type="button" style="font-size:11px;">Reset</button>
            <span style="color:var(--border);">|</span>
            <label class="checkbox-wrap" style="color:var(--muted); font-size:12px;">
              <input type="checkbox" id="ganttHideWeekends" checked />
              <span class="checkbox-box">‚úì</span>
              Hide weekends
            </label>
            <span style="color:var(--border);">|</span>
            <label class="checkbox-wrap" style="color:var(--muted); font-size:12px;">
              <input type="checkbox" id="ganttShowLocked" checked />
              <span class="checkbox-box">‚úì</span>
              Locked In
            </label>
            <label class="checkbox-wrap" style="color:var(--muted); font-size:12px;">
              <input type="checkbox" id="ganttShowLikely" checked />
              <span class="checkbox-box">‚úì</span>
              Likely
            </label>
            <label class="checkbox-wrap" style="color:var(--muted); font-size:12px;">
              <input type="checkbox" id="ganttShowTentative" checked />
              <span class="checkbox-box">‚úì</span>
              Tentative
            </label>
            <span style="color:var(--border);">|</span>
            <span style="color:var(--muted); font-size:12px;">Zoom:</span>
            <button class="mini gantt-zoom-btn" data-zoom="narrow">-</button>
            <button class="mini gantt-zoom-btn active" data-zoom="normal">‚óã</button>
            <button class="mini gantt-zoom-btn" data-zoom="wide">+</button>
            <span style="color:var(--border);">|</span>
            <span style="display:inline-flex; gap:0;">
              <button id="ganttViewUser" class="gantt-view-btn active" type="button" style="font-size:11px; height:31px; min-width:85px; padding:0 10px; border-radius:6px 0 0 6px; border-right:none; background:var(--teal); color:white; border-color:var(--teal);">My Schedule</button>
              <button id="ganttViewJob" class="gantt-view-btn" type="button" style="font-size:11px; height:31px; min-width:85px; padding:0 10px; border-radius:0 6px 6px 0; background:var(--panel); color:var(--muted); border-color:var(--border);">By Job</button>
            </span>
            <span id="ganttJobFilterSection" style="display:none;">
              <select id="ganttJobFilter" style="height:31px; font-size:11px; padding:2px 6px; max-width:220px; margin-left:6px;">
                <option value="">Select a job...</option>
              </select>
            </span>
            <span style="color:var(--border);">|</span>
            <button id="ganttWeeklyTotal" class="mini" type="button" style="background:var(--teal); color:white; border-color:var(--teal);">Weekly Total</button>
            <button id="ganttClose" class="mini" type="button">Close</button>
          </div>
        </div>
        <div class="modal-body" style="padding:0; overflow:auto; max-height:calc(90vh - 100px);">
          <div id="ganttChart" class="gantt-chart"></div>
        </div>
      </div>
    </div>

    <!-- Weekly Total Modal -->
    <div id="weeklyTotalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" style="z-index:10002;">
      <div class="modal" style="width:min(650px, 95vw); max-height:95vh;">
        <div class="modal-header" style="flex-wrap:wrap; gap:5px;">
          <div class="modal-title">Weekly Totals</div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <input type="date" id="weeklyDateFrom" style="font-size:12px;padding:4px 8px;width:120.22222px;" />
            <input type="date" id="weeklyDateTo" style="font-size:12px;padding:4px 8px;width:120.22222px;" />
            <button id="weeklyDateReset" class="mini" type="button" style="font-size:11px; height:31px; box-sizing:border-box;">Reset</button>
            <span style="color:var(--border);">|</span>
            <label class="checkbox-wrap" style="color:var(--muted); font-size:12px;">
              <input type="checkbox" id="weeklyShowAvailable" />
              <span class="checkbox-box">‚úì</span>
              Capacity
            </label>
          </div>
          <button id="weeklyTotalClose" class="mini" type="button">√ó</button>
        </div>
        <div class="modal-body" style="padding:16px; overflow-y:auto; max-height:calc(95vh - 80px);">
          <div id="weeklyTotalContent"></div>
        </div>
      </div>
    </div>

    <!-- Capacity Checker Modal -->
    <div id="capacityModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" style="z-index:10002;">
      <div class="modal" style="width:min(550px, 95vw); max-height:90vh;">
        <div class="modal-header" style="flex-wrap:wrap; gap:8px;">
          <div class="modal-title">Capacity Checker</div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <input type="date" id="capacityDateFrom" style="font-size:12px;padding:4px 8px;width:120.22222px;" />
            <input type="date" id="capacityDateTo" style="font-size:12px;padding:4px 8px;width:120.22222px;" />
            <button id="capacityCheck" class="mini" type="button" style="font-size:11px; height:31px; box-sizing:border-box; background:var(--teal); color:white; border-color:var(--teal);">Check</button>
          </div>
          <button id="capacityClose" class="mini" type="button">√ó</button>
        </div>
        <div class="modal-body" style="padding:16px; overflow-y:auto; max-height:calc(90vh - 80px);">
          <div id="capacityContent" style="color:var(--muted); text-align:center;">Select a date range and click Check</div>
        </div>
      </div>
    </div>

    <!-- Firm Selector Modal (shown on login when user has multiple firms) -->
    <div id="firmSelectorBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" style="z-index:10004;">
      <div class="modal" style="width:min(400px, 95vw);">
        <div class="modal-header">
          <div class="modal-title">Select a Firm</div>
        </div>
        <div class="modal-body">
          <p class="subtle" style="margin-bottom:16px;">You belong to multiple firms. Select one to continue:</p>
          <div id="firmSelectorList" style="max-height:300px; overflow-y:auto;"></div>
        </div>
      </div>
    </div>

    <!-- Firm Setup Modal -->
    <div id="firmSetupBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" style="z-index:10003;">
      <div class="modal" style="width:min(450px, 95vw);">
        <div class="modal-header">
          <div class="modal-title">Welcome to Raze</div>
        </div>
        <div class="modal-body">
          <p style="color:var(--muted); margin-bottom:16px;">Create a firm to collaborate with your team, or continue in solo mode.</p>
          <div style="display:grid; gap:12px;">
            <input id="firmName" type="text" placeholder="Firm Name (e.g., Smith & Associates)" style="width:100%;" />
            <input id="firmPrefix" type="text" placeholder="Client ID Prefix (e.g., ABC)" maxlength="5" style="width:100%; text-transform:uppercase;" />
            <p style="color:var(--muted); font-size:11px; margin:0;">Prefix will be used for client codes: ABC001, ABC002, etc.</p>
          </div>
        </div>
        <div class="modal-footer" style="justify-content:space-between;">
          <button type="button" onclick="skipFirmSetup()" style="background:var(--panel); border-color:var(--border);">Continue Solo</button>
          <button type="button" onclick="createFirm()" style="background:var(--teal); border-color:var(--teal);">Create Firm</button>
        </div>
      </div>
    </div>

    <!-- Team Management Modal -->
    <div id="teamModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" style="z-index:10001;">
      <div class="modal" style="width:min(800px, 96vw); max-height:90vh;">
        <div class="modal-header">
          <div class="modal-title">Team Management</div>
          <button id="teamCloseBtn" class="mini" type="button">Close</button>
        </div>
        <div class="modal-body" style="padding:16px; overflow-y:auto; max-height:calc(90vh - 140px);">
          <!-- Bulk Add Section -->
          <div style="font-weight:700; margin-bottom:12px; color:var(--text);">Add Team Members</div>
          <div style="border:1px solid var(--border); border-radius:8px; overflow:hidden; margin-bottom:20px;">
            <!-- Header Row -->
            <div style="display:grid; grid-template-columns:1.5fr 1fr 100px 120px 100px 80px 50px 40px; gap:1px; background:var(--border);">
              <div style="background:var(--panel); padding:8px 12px; font-size:11px; font-weight:600; color:var(--muted);">Email</div>
              <div style="background:var(--panel); padding:8px 12px; font-size:11px; font-weight:600; color:var(--muted);">Display Name</div>
              <div style="background:var(--panel); padding:8px 12px; font-size:11px; font-weight:600; color:var(--muted);">Role</div>
              <div style="background:var(--panel); padding:8px 12px; font-size:11px; font-weight:600; color:var(--muted);">Reports To</div>
              <div style="background:var(--panel); padding:8px 12px; font-size:11px; font-weight:600; color:var(--muted);">Team</div>
              <div style="background:var(--panel); padding:8px 12px; font-size:11px; font-weight:600; color:var(--muted);">State</div>
              <div style="background:var(--panel); padding:8px 12px; font-size:11px; font-weight:600; color:var(--muted); text-align:center;">Admin</div>
              <div style="background:var(--panel); padding:8px 12px;"></div>
            </div>
            <!-- Input Rows Container -->
            <div id="bulkMemberRows"></div>
          </div>
          <div style="display:flex; gap:8px; margin-bottom:20px;">
            <button type="button" onclick="addBulkMemberRow()" style="height:31px; padding:0 16px;">+ Add Row</button>
            <button type="button" onclick="saveBulkMembers()" style="height:31px; padding:0 16px; background:var(--teal); border-color:var(--teal);">Save All Members</button>
            <input type="file" id="teamExcelUpload" accept=".xlsx,.xls,.csv" style="display:none;" onchange="handleTeamExcelUpload(event)" />
            <button type="button" onclick="document.getElementById('teamExcelUpload').click()" style="height:31px; padding:0 16px; min-width:110px;">Upload Excel</button>
            <button type="button" onclick="downloadTeamTemplate()" style="height:31px; padding:0 16px; min-width:110px;">Template</button>
          </div>

          <!-- Current Team Members -->
          <div style="font-weight:700; margin-bottom:12px; color:var(--text);">Current Team Members</div>
          <div id="teamMembersList" style="border:1px solid var(--border); border-radius:8px; overflow:hidden;"></div>
        </div>
        <div class="modal-footer">
          <div class="subtle" id="firmNameBadge"></div>
          <button id="teamDoneBtn" class="mini" type="button" onclick="hideModal('teamModalBackdrop')">Done</button>
        </div>
      </div>
    </div>

    <!-- Job Team Assignment Modal -->
    <div id="jobTeamModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" style="z-index:10003;">
      <div class="modal" style="width:min(550px, 96vw); max-height:90vh;">
        <div class="modal-header">
          <div class="modal-title">Team Assignment: <span id="jobTeamTaskName" style="color:var(--muted); font-weight:400;"></span></div>
          <button class="mini" type="button" onclick="closeJobTeamModal()">Close</button>
        </div>
        <div class="modal-body" style="padding:16px; overflow-y:auto; max-height:calc(90vh - 140px);">
          <!-- Current Team Members -->
          <div style="font-weight:700; margin-bottom:12px; color:var(--text);">Current Team</div>
          <div id="jobTeamCurrentList" style="border:1px solid var(--border); border-radius:8px; padding:8px; margin-bottom:20px; min-height:60px;"></div>

          <!-- Add Team Member Section -->
          <div style="font-weight:700; margin-bottom:12px; color:var(--text);">Add Team Member</div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <select id="jobTeamMemberSelect" style="flex:1.5; height:36px; min-width:150px;">
              <option value="">Select person...</option>
            </select>
            <select id="jobTeamRoleSelect" style="flex:1; height:36px; min-width:100px;">
              <option value="Preparer">Preparer</option>
              <option value="Reviewer">Reviewer</option>
              <option value="Partner">Partner</option>
            </select>
            <button type="button" onclick="addJobTeamMember()" style="height:36px; padding:0 16px;">Add</button>
          </div>
        </div>
        <div class="modal-footer">
          <div class="subtle" id="jobTeamTaskInfo"></div>
          <button type="button" onclick="closeJobTeamModal()" style="background:var(--teal); border-color:var(--teal);">Done</button>
        </div>
      </div>
    </div>

    <!-- Edit Member Modal -->
    <div id="editMemberModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" style="z-index:10006;">
      <div class="modal" style="width:min(500px, 96vw); max-height:90vh;">
        <div class="modal-header">
          <div class="modal-title">Edit Team Member</div>
          <button class="mini" type="button" onclick="hideModal('editMemberModalBackdrop')">Close</button>
        </div>
        <div class="modal-body" style="padding:16px; overflow-y:auto; max-height:calc(90vh - 140px);">
          <input type="hidden" id="editMemberUid" />

          <div style="margin-bottom:16px;">
            <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:4px;">Email (read-only)</label>
            <input type="text" id="editMemberEmail" readonly style="width:100%; height:36px; background:var(--panel-2); opacity:0.7;" />
          </div>

          <div style="margin-bottom:16px;">
            <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:4px;">Display Name</label>
            <input type="text" id="editMemberName" style="width:100%; height:36px;" />
          </div>

          <div style="margin-bottom:16px;">
            <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:4px;">Role</label>
            <select id="editMemberRole" style="width:100%; height:36px;"></select>
          </div>

          <div style="margin-bottom:16px;">
            <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:4px;">Reports To</label>
            <select id="editMemberReportsTo" style="width:100%; height:36px;"></select>
          </div>

          <div style="margin-bottom:16px;">
            <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:4px;">Team</label>
            <select id="editMemberTeam" style="width:100%; height:36px;"></select>
          </div>

          <div style="margin-bottom:16px;">
            <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:4px;">State (for public holidays)</label>
            <select id="editMemberState" style="width:100%; height:36px;"></select>
          </div>

          <div style="margin-bottom:16px;">
            <label class="checkbox-wrap" style="color:var(--text);">
              <input type="checkbox" id="editMemberIsAdmin" />
              <span class="checkbox-box">‚úì</span>
              Administrator
            </label>
            <div style="font-size:11px; color:var(--muted); margin-top:4px;">Admins can manage team members, roles, and firm settings</div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="mini btn-danger" type="button" id="editMemberDeleteBtn">Remove Member</button>
          <button type="button" onclick="saveEditMember()" style="background:var(--teal); border-color:var(--teal);">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Roles Admin Modal -->
    <div id="rolesModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" style="z-index:10002;">
      <div class="modal" style="width:min(700px, 96vw); max-height:90vh;">
        <div class="modal-header">
          <div class="modal-title">Role Settings</div>
          <button class="mini" type="button" onclick="hideModal('rolesModalBackdrop')">Close</button>
        </div>
        <div class="modal-body" style="padding:16px; overflow-y:auto; max-height:calc(90vh - 140px);">
          <p style="color:var(--muted); font-size:12px; margin-bottom:16px;">Define roles and their hierarchy. Higher levels can see tasks of lower levels.</p>

          <!-- Roles Table -->
          <div style="border:1px solid var(--border); border-radius:8px; overflow:hidden; margin-bottom:16px;">
            <!-- Header -->
            <div style="display:grid; grid-template-columns:36px 1fr 80px 80px 80px 40px; gap:1px; background:var(--border);">
              <div style="background:var(--panel); padding:8px 6px;"></div>
              <div style="background:var(--panel); padding:8px 12px; font-size:11px; font-weight:600; color:var(--muted);">Role Name</div>
              <div style="background:var(--panel); padding:8px 12px; font-size:11px; font-weight:600; color:var(--muted); text-align:center;" title="Can add/remove team members">Manage Team</div>
              <div style="background:var(--panel); padding:8px 12px; font-size:11px; font-weight:600; color:var(--muted); text-align:center;" title="Can see all firm tasks">See All</div>
              <div style="background:var(--panel); padding:8px 12px; font-size:11px; font-weight:600; color:var(--muted); text-align:center;" title="Can assign tasks to others">Assign</div>
              <div style="background:var(--panel); padding:8px 12px;"></div>
            </div>
            <!-- Roles List -->
            <div id="rolesListContainer"></div>
          </div>

          <!-- Add Role Button -->
          <div style="display:flex; gap:8px; align-items:center;">
            <button type="button" onclick="addRoleRow()" style="height:31px; padding:0 16px;">+ Add Role</button>
            <button type="button" onclick="refreshRolesList()" style="height:31px; padding:0 16px; background:var(--teal); border-color:var(--teal);">Refresh List</button>
          </div>
        </div>
        <div class="modal-footer">
          <div class="subtle">Changes saved automatically</div>
          <button class="mini" type="button" onclick="hideModal('rolesModalBackdrop')">Done</button>
        </div>
      </div>
    </div>

    <!-- ===== HOLIDAYS MANAGEMENT MODAL ===== -->
    <div id="holidaysModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" style="z-index:10003;">
      <div class="modal" style="width:min(600px, 96vw); max-height:90vh;">
        <div class="modal-header">
          <div class="modal-title">Holidays & Blocked Days</div>
          <button class="mini" type="button" onclick="hideModal('holidaysModalBackdrop')">Close</button>
        </div>
        <div class="modal-body" style="padding:16px; overflow-y:auto; max-height:calc(90vh - 180px);">
          <!-- State Selection -->
          <div style="margin-bottom:20px;">
            <label style="display:block; font-size:12px; color:var(--muted); margin-bottom:6px;">Firm Location (for public holidays)</label>
            <div style="display:flex; gap:8px; align-items:center;">
              <select id="firmStateSelect" style="flex:1; height:36px; font-size:13px;" onchange="updateFirmState()">
                <option value="NSW">New South Wales</option>
                <option value="VIC">Victoria</option>
                <option value="QLD">Queensland</option>
                <option value="SA">South Australia</option>
                <option value="WA">Western Australia</option>
                <option value="TAS">Tasmania</option>
                <option value="NT">Northern Territory</option>
                <option value="ACT">Australian Capital Territory</option>
              </select>
            </div>
          </div>

          <!-- Holidays List -->
          <div id="holidaysListContainer"></div>

          <!-- Add Custom Blocked Day -->
          <div style="margin-top:20px; padding:16px; background:var(--panel); border-radius:8px; border:1px solid var(--border);">
            <h4 style="color:var(--teal); margin-bottom:12px; font-size:14px;">Add Custom Blocked Day</h4>
            <div style="display:flex; gap:8px; align-items:flex-end; flex-wrap:wrap;">
              <div style="flex:1; min-width:150px;">
                <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:4px;">Date</label>
                <input type="date" id="newBlockedDate" style="width:100%; height:36px;" />
              </div>
              <div style="flex:2; min-width:200px;">
                <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:4px;">Name (e.g., Strategy Day, Office Closure)</label>
                <input type="text" id="newBlockedName" placeholder="Enter name..." style="width:100%; height:36px;" />
              </div>
              <button type="button" onclick="addCustomBlockedDay()" style="height:36px; padding:0 16px; background:var(--teal); border-color:var(--teal);">Add</button>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <div class="subtle">Blocked days won't be available for scheduling</div>
          <button class="mini" type="button" onclick="hideModal('holidaysModalBackdrop')">Done</button>
        </div>
      </div>
    </div>

    <!-- ===== USER LEAVE MODAL ===== -->
    <div id="leaveModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" style="z-index:10005;">
      <div class="modal" style="width:min(500px, 96vw); max-height:90vh;">
        <div class="modal-header">
          <div class="modal-title">Leave Schedule - <span id="leaveMemberName"></span></div>
          <button class="mini" type="button" onclick="hideModal('leaveModalBackdrop')">Close</button>
        </div>
        <div class="modal-body" style="padding:16px; overflow-y:auto; max-height:calc(90vh - 180px);">
          <!-- Existing Leave -->
          <div id="leaveListContainer" style="background:var(--panel-2); border-radius:8px; margin-bottom:20px;"></div>

          <!-- Add New Leave -->
          <div style="padding:16px; background:var(--panel); border-radius:8px; border:1px solid var(--border);">
            <h4 style="color:var(--teal); margin-bottom:12px; font-size:14px;">Add Leave</h4>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
              <div>
                <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:4px;">Start Date</label>
                <input type="date" id="leaveStartDate" style="width:100%; height:36px;" />
              </div>
              <div>
                <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:4px;">End Date</label>
                <input type="date" id="leaveEndDate" style="width:100%; height:36px;" />
              </div>
            </div>
            <div style="margin-bottom:12px;">
              <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:4px;">Leave Type</label>
              <select id="leaveType" style="width:100%; height:36px;">
                <option value="Annual Leave">Annual Leave</option>
                <option value="Sick Leave">Sick Leave</option>
                <option value="Personal Leave">Personal Leave</option>
                <option value="Parental Leave">Parental Leave</option>
                <option value="Public Holiday (Individual)">Public Holiday (Individual)</option>
                <option value="Study Leave">Study Leave</option>
                <option value="Work From Home">Work From Home</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div style="margin-bottom:12px;">
              <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:4px;">Notes (optional)</label>
              <input type="text" id="leaveNotes" placeholder="Additional details..." style="width:100%; height:36px;" />
            </div>
            <button type="button" onclick="addMemberLeave()" style="width:100%; height:36px; background:var(--teal); border-color:var(--teal);">Add Leave</button>
          </div>
        </div>
        <div class="modal-footer">
          <div class="subtle">Leave dates prevent task scheduling</div>
          <button class="mini" type="button" onclick="hideModal('leaveModalBackdrop')">Done</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard Modal -->
  <div id="dashboardModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" style="z-index:10005;">
    <div class="modal dashboard-modal">
      <div class="modal-header draggable-handle">
        <div class="modal-title">Dashboard &amp; Analytics</div>
        <button class="mini" type="button" onclick="hideModal('dashboardModalBackdrop')">Close</button>
      </div>
      <div class="modal-body">
        <div class="time-range-selector">
          <button class="time-range-btn active" data-range="7">7 Days</button>
          <button class="time-range-btn" data-range="30">30 Days</button>
          <button class="time-range-btn" data-range="365">12 Months</button>
        </div>
        <div id="dashboardContent" class="dashboard-grid">
          <!-- Dashboard content rendered dynamically -->
        </div>
      </div>
    </div>
  </div>

  <!-- Notifications Modal -->
  <div id="notificationsModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" style="z-index:10005;">
    <div class="modal" style="width:min(480px, 96vw);">
      <div class="modal-header draggable-handle">
        <div class="modal-title">Notification Settings</div>
        <button class="mini" type="button" onclick="hideModal('notificationsModalBackdrop')">Close</button>
      </div>
      <div class="modal-body">
        <div class="notification-settings">
          <div class="notification-setting-row">
            <div>
              <div style="font-weight:600; color:var(--text);">Enable Notifications</div>
              <div class="subtle">Receive browser notifications for due tasks</div>
            </div>
            <label class="checkbox-wrap">
              <input type="checkbox" id="notificationsEnabled" />
              <span class="checkbox-box">‚úì</span>
            </label>
          </div>
          <div class="notification-setting-row">
            <div>
              <div style="font-weight:600; color:var(--text);">Overdue Task Alerts</div>
              <div class="subtle">Notify when tasks are past due date</div>
            </div>
            <label class="checkbox-wrap">
              <input type="checkbox" id="notifyOverdue" checked />
              <span class="checkbox-box">‚úì</span>
            </label>
          </div>
          <div class="notification-setting-row">
            <div>
              <div style="font-weight:600; color:var(--text);">Due Soon Alerts</div>
              <div class="subtle">Notify for tasks due within 24-48 hours</div>
            </div>
            <label class="checkbox-wrap">
              <input type="checkbox" id="notifyDueSoon" checked />
              <span class="checkbox-box">‚úì</span>
            </label>
          </div>
          <div class="notification-setting-row">
            <div>
              <div style="font-weight:600; color:var(--text);">Check Interval</div>
              <div class="subtle">How often to check for due tasks</div>
            </div>
            <select id="notificationInterval" style="width:120px;">
              <option value="5">5 minutes</option>
              <option value="15" selected>15 minutes</option>
              <option value="30">30 minutes</option>
              <option value="60">1 hour</option>
            </select>
          </div>
          <button id="requestNotificationPermission" type="button" style="width:100%;">
            Request Notification Permission
          </button>
          <div id="notificationStatus" class="subtle" style="text-align:center;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recurring Task Modal -->
  <div id="recurringModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" style="z-index:10006;">
    <div class="modal" style="width:min(480px, 96vw);">
      <div class="modal-header draggable-handle">
        <div class="modal-title">Recurring Task Settings</div>
        <button class="mini" type="button" onclick="hideModal('recurringModalBackdrop')">Close</button>
      </div>
      <div class="modal-body">
        <div class="recurrence-options">
          <div class="recurrence-option">
            <input type="checkbox" id="isRecurring" />
            <label for="isRecurring" style="font-weight:600; color:var(--text);">Enable Recurring</label>
          </div>
          <div id="recurrenceSettings" style="display:none;">
            <div class="recurrence-option">
              <label style="width:100px; color:var(--muted);">Pattern:</label>
              <select id="recurrenceType" style="flex:1;">
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
                <option value="yearly">Yearly</option>
                <option value="custom">Custom</option>
              </select>
            </div>
            <div class="recurrence-option">
              <label style="width:100px; color:var(--muted);">Every:</label>
              <input type="number" id="recurrenceInterval" value="1" min="1" max="52" style="width:60px;" />
              <span id="recurrenceIntervalLabel" style="color:var(--muted);">week(s)</span>
            </div>
            <div class="recurrence-option" id="dayOfWeekRow">
              <label style="width:100px; color:var(--muted);">Day:</label>
              <select id="recurrenceDayOfWeek" style="flex:1;">
                <option value="0">Sunday</option>
                <option value="1">Monday</option>
                <option value="2">Tuesday</option>
                <option value="3">Wednesday</option>
                <option value="4">Thursday</option>
                <option value="5">Friday</option>
                <option value="6">Saturday</option>
              </select>
            </div>
            <div class="recurrence-option" id="dayOfMonthRow" style="display:none;">
              <label style="width:100px; color:var(--muted);">Day of Month:</label>
              <input type="number" id="recurrenceDayOfMonth" value="1" min="1" max="31" style="width:60px;" />
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <span id="recurringTaskId" style="display:none;"></span>
        <button type="button" onclick="hideModal('recurringModalBackdrop')">Cancel</button>
        <button type="button" id="saveRecurringBtn" style="background:var(--accent); color:white; border-color:var(--accent);">Save</button>
      </div>
    </div>
  </div>

  <!-- Dependencies Modal -->
  <div id="dependenciesModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" style="z-index:10006;">
    <div class="modal" style="width:min(520px, 96vw);">
      <div class="modal-header draggable-handle">
        <div class="modal-title">Task Dependencies</div>
        <button class="mini" type="button" onclick="hideModal('dependenciesModalBackdrop')">Close</button>
      </div>
      <div class="modal-body">
        <div class="subtle" style="margin-bottom:12px;">This task depends on:</div>
        <div id="dependencyList" class="dependency-list">
          <!-- Dependencies rendered dynamically -->
        </div>
        <div style="margin-top:16px;">
          <div class="subtle" style="margin-bottom:8px;">Add dependency:</div>
          <select id="addDependencySelect" style="width:100%;">
            <option value="">Select a task...</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <span id="dependencyTaskId" style="display:none;"></span>
        <button type="button" onclick="hideModal('dependenciesModalBackdrop')">Done</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Firebase Auth + Firestore (email/password) =====
    // Replace FIREBASE_CONFIG with your Firebase project config.
    // Security (Firestore Rules):
    // match /databases/{database}/documents {
    //   match /users/{uid}/tasks/{doc} { allow read, write: if request.auth != null && request.auth.uid == uid; }
    //   match /users/{uid}/archive/{doc} { allow read, write: if request.auth != null && request.auth.uid == uid; }
    // }

    const FIREBASE_CONFIG = {
      apiKey: 'AIzaSyBpkfLUwhpByb3pvkUx4XYFoFp7qxSd0yQ',
      authDomain: 'raze-9311c.firebaseapp.com',
      projectId: 'raze-9311c',
      appId: '1:567484969210:web:a94b5229a072cecfa95943'
    };

    function hasFirebaseConfig() {
      return !!(FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.authDomain && FIREBASE_CONFIG.projectId && FIREBASE_CONFIG.appId);
    }

    // Simple toast notification
    function toast(message) {
      // Create toast element if it doesn't exist
      let toastEl = document.getElementById('toastNotification');
      if (!toastEl) {
        toastEl = document.createElement('div');
        toastEl.id = 'toastNotification';
        toastEl.style.cssText = 'position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#14b8a6; color:white; padding:12px 24px; border-radius:8px; font-size:14px; font-weight:500; z-index:99999; opacity:0; transition:opacity 0.3s;';
        document.body.appendChild(toastEl);
      }
      toastEl.textContent = message;
      toastEl.style.opacity = '1';
      setTimeout(() => { toastEl.style.opacity = '0'; }, 3000);
    }

    let fbApp = null;
    let fbAuth = null;
    let fbDb = null;
    let currentUser = null;

    if (hasFirebaseConfig()) {
      try {
        fbApp = firebase.initializeApp(FIREBASE_CONFIG);
        fbAuth = firebase.auth();
        fbDb = firebase.firestore();
      } catch (e) {
        console.error('Firebase initialization failed:', e);
      }
    } else {
      console.warn('Firebase not configured. Running in local-only mode.');
    }

    // ===== Local keys =====
    const STORAGE_KEY = 'tasks';
    const ARCHIVE_KEY = 'archive';
    const SORT_CLIENT_KEY = 'sortClient';
    const SORT_DUE_KEY = 'sortDue';
    const SORT_PRIORITY_KEY = 'sortPriority';
    const BLANK_KEY = 'blankMode';
    const EMAIL_TO_KEY = 'email_to';
    const THEME_KEY = 'raze_theme';
    const NOTIFICATIONS_KEY = 'raze_notifications';
    const NOTIFIED_TASKS_KEY = 'raze_notified_tasks';

    // ===== State =====
    /** @type {any[]} */
    let tasks = [];
    /** @type {any[]} */
    let archive = [];
    /** @type {string[]} */
    let masterClients = [];
    /** @type {string[]} */
    let masterJobTypes = ['Tax Return', 'BAS', 'Financial Statements', 'Audit', 'Bookkeeping', 'Advisory', 'Other'];
    let masterTeamNames = [];
    /** @type {number} */
    let hoursPerDay = 7.5;

    // ===== Firm Mode State =====
    let currentFirmId = null;
    let currentFirmData = null;
    let currentMember = null;  // { role, isAdmin, reportsTo, displayName }
    let firmMembers = [];      // All firm members for assignment dropdown
    let firmClients = [];      // Firm-wide clients with clientCode
    let userFirms = [];        // All firms user belongs to [{id, name, role, isAdmin}]

    function isInFirmMode() {
      return currentFirmId !== null;
    }

    let firmSetupDismissed = false; // Prevent modal from reappearing after user choice

    // Default roles with properties
    const DEFAULT_ROLES = [
      { name: 'Partner', level: 5, canManageTeam: true, canSeeAll: true, canAssign: true },
      { name: 'Director', level: 4, canManageTeam: true, canSeeAll: true, canAssign: true },
      { name: 'Manager', level: 3, canManageTeam: false, canSeeAll: false, canAssign: true },
      { name: 'Senior', level: 2, canManageTeam: false, canSeeAll: false, canAssign: true },
      { name: 'Graduate', level: 1, canManageTeam: false, canSeeAll: false, canAssign: false }
    ];

    let customRoles = [...DEFAULT_ROLES]; // Will be loaded from Firestore for firm mode

    // Default job roles for team assignments on tasks (different from firm member roles)
    const DEFAULT_JOB_ROLES = ['Preparer', 'Reviewer', 'Partner'];
    let jobRoles = [...DEFAULT_JOB_ROLES]; // Will be loaded from firm settings

    // Australian states for public holidays
    const AU_STATES = [
      { code: 'NSW', name: 'New South Wales' },
      { code: 'VIC', name: 'Victoria' },
      { code: 'QLD', name: 'Queensland' },
      { code: 'SA', name: 'South Australia' },
      { code: 'WA', name: 'Western Australia' },
      { code: 'TAS', name: 'Tasmania' },
      { code: 'NT', name: 'Northern Territory' },
      { code: 'ACT', name: 'Australian Capital Territory' }
    ];

    // Calculate Easter Sunday for a given year (Anonymous Gregorian algorithm)
    function getEasterSunday(year) {
      const a = year % 19;
      const b = Math.floor(year / 100);
      const c = year % 100;
      const d = Math.floor(b / 4);
      const e = b % 4;
      const f = Math.floor((b + 8) / 25);
      const g = Math.floor((b - f + 1) / 3);
      const h = (19 * a + b - d - g + 15) % 30;
      const i = Math.floor(c / 4);
      const k = c % 4;
      const l = (32 + 2 * e + 2 * i - h - k) % 7;
      const m = Math.floor((a + 11 * h + 22 * l) / 451);
      const month = Math.floor((h + l - 7 * m + 114) / 31);
      const day = ((h + l - 7 * m + 114) % 31) + 1;
      return new Date(year, month - 1, day);
    }

    // Get nth weekday of a month (e.g., 2nd Monday of June)
    function getNthWeekdayOfMonth(year, month, weekday, n) {
      const firstDay = new Date(year, month, 1);
      let dayOffset = (weekday - firstDay.getDay() + 7) % 7;
      const date = 1 + dayOffset + (n - 1) * 7;
      return new Date(year, month, date);
    }

    // Adjust date if it falls on weekend (observed holiday)
    function observedDate(date) {
      const day = date.getDay();
      if (day === 0) return new Date(date.getTime() + 86400000); // Sunday -> Monday
      if (day === 6) return new Date(date.getTime() + 2 * 86400000); // Saturday -> Monday
      return date;
    }

    // Generate Australian public holidays for a given year and state
    function getAustralianPublicHolidays(year, stateCode) {
      const holidays = [];
      const easter = getEasterSunday(year);

      // Helper to format date as YYYY-MM-DD (local timezone, not UTC)
      const fmt = (d) => {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
      };

      // National holidays
      // New Year's Day (Jan 1, observed)
      let nyd = new Date(year, 0, 1);
      holidays.push({ date: fmt(observedDate(nyd)), name: "New Year's Day", type: 'national' });

      // Australia Day (Jan 26, observed)
      let ausDay = new Date(year, 0, 26);
      holidays.push({ date: fmt(observedDate(ausDay)), name: 'Australia Day', type: 'national' });

      // Good Friday (2 days before Easter)
      let goodFriday = new Date(easter.getTime() - 2 * 86400000);
      holidays.push({ date: fmt(goodFriday), name: 'Good Friday', type: 'national' });

      // Easter Saturday (public holiday in most states, but NOT in WA or TAS)
      if (stateCode !== 'WA' && stateCode !== 'TAS') {
        let easterSat = new Date(easter.getTime() - 86400000);
        holidays.push({ date: fmt(easterSat), name: 'Easter Saturday', type: 'national' });
      }

      // Easter Monday
      let easterMon = new Date(easter.getTime() + 86400000);
      holidays.push({ date: fmt(easterMon), name: 'Easter Monday', type: 'national' });

      // Anzac Day (Apr 25) - when on weekend, observed on following Monday
      let anzac = new Date(year, 3, 25);
      let anzacDay = anzac.getDay();
      if (anzacDay === 0) { // Sunday -> Monday
        holidays.push({ date: fmt(new Date(year, 3, 26)), name: 'Anzac Day', type: 'national' });
      } else if (anzacDay === 6) { // Saturday -> Monday
        holidays.push({ date: fmt(new Date(year, 3, 27)), name: 'Anzac Day', type: 'national' });
      } else {
        holidays.push({ date: fmt(anzac), name: 'Anzac Day', type: 'national' });
      }

      // Queen's Birthday (varies by state)
      if (stateCode === 'WA') {
        // WA: Last Monday of September
        let lastMon = getNthWeekdayOfMonth(year, 8, 1, 4); // 4th Monday
        if (new Date(year, 8, lastMon.getDate() + 7).getMonth() === 8) {
          lastMon = new Date(year, 8, lastMon.getDate() + 7);
        }
        holidays.push({ date: fmt(lastMon), name: "King's Birthday", type: 'state' });
      } else if (stateCode === 'QLD') {
        // QLD: 2nd Monday of October
        holidays.push({ date: fmt(getNthWeekdayOfMonth(year, 9, 1, 2)), name: "King's Birthday", type: 'state' });
      } else {
        // All other states: 2nd Monday of June
        holidays.push({ date: fmt(getNthWeekdayOfMonth(year, 5, 1, 2)), name: "King's Birthday", type: 'state' });
      }

      // Christmas Day (Dec 25, observed)
      let xmas = new Date(year, 11, 25);
      let xmasObs = observedDate(xmas);
      holidays.push({ date: fmt(xmasObs), name: 'Christmas Day', type: 'national' });

      // Boxing Day (Dec 26, observed - but if Xmas is Sat, Boxing is Mon, so this needs special handling)
      let boxing = new Date(year, 11, 26);
      if (xmas.getDay() === 5) { // Xmas is Friday, Boxing is Saturday -> Monday
        boxing = new Date(year, 11, 28);
      } else if (xmas.getDay() === 6) { // Xmas is Saturday -> Mon, Boxing Sun -> Tue
        boxing = new Date(year, 11, 28);
      } else if (xmas.getDay() === 0) { // Xmas is Sunday -> Mon, Boxing Mon is fine but Tue for Boxing observed
        boxing = new Date(year, 11, 27);
      }
      holidays.push({ date: fmt(boxing), name: 'Boxing Day', type: 'national' });

      // State-specific holidays
      if (stateCode === 'VIC') {
        // Melbourne Cup Day - 1st Tuesday of November
        holidays.push({ date: fmt(getNthWeekdayOfMonth(year, 10, 2, 1)), name: 'Melbourne Cup Day', type: 'state' });
      }

      if (stateCode === 'SA') {
        // Adelaide Cup Day - 2nd Monday of March
        holidays.push({ date: fmt(getNthWeekdayOfMonth(year, 2, 1, 2)), name: 'Adelaide Cup Day', type: 'state' });
        // Proclamation Day - Dec 24 or closest weekday
        let proc = new Date(year, 11, 24);
        holidays.push({ date: fmt(observedDate(proc)), name: 'Proclamation Day', type: 'state' });
      }

      if (stateCode === 'WA') {
        // Western Australia Day - 1st Monday of June
        holidays.push({ date: fmt(getNthWeekdayOfMonth(year, 5, 1, 1)), name: 'Western Australia Day', type: 'state' });
      }

      if (stateCode === 'TAS') {
        // Royal Hobart Regatta - 2nd Monday of February (Southern TAS only, but we'll include it)
        holidays.push({ date: fmt(getNthWeekdayOfMonth(year, 1, 1, 2)), name: 'Royal Hobart Regatta', type: 'state' });
      }

      if (stateCode === 'NT') {
        // May Day - 1st Monday of May
        holidays.push({ date: fmt(getNthWeekdayOfMonth(year, 4, 1, 1)), name: 'May Day', type: 'state' });
        // Picnic Day - 1st Monday of August
        holidays.push({ date: fmt(getNthWeekdayOfMonth(year, 7, 1, 1)), name: 'Picnic Day', type: 'state' });
      }

      if (stateCode === 'ACT') {
        // Canberra Day - 2nd Monday of March
        holidays.push({ date: fmt(getNthWeekdayOfMonth(year, 2, 1, 2)), name: 'Canberra Day', type: 'state' });
        // Reconciliation Day - 27 May or nearest Monday
        let recon = new Date(year, 4, 27);
        if (recon.getDay() === 0) recon = new Date(year, 4, 28);
        else if (recon.getDay() === 6) recon = new Date(year, 4, 29);
        holidays.push({ date: fmt(recon), name: 'Reconciliation Day', type: 'state' });
      }

      if (stateCode === 'NSW') {
        // Bank Holiday - 1st Monday of August
        holidays.push({ date: fmt(getNthWeekdayOfMonth(year, 7, 1, 1)), name: 'Bank Holiday', type: 'state' });
      }

      return holidays;
    }

    // Firm holidays/blocked days (loaded from Firestore)
    let firmHolidays = []; // { date: 'YYYY-MM-DD', name: string, type: 'public'|'firm' }

    // Get role hierarchy object (for backward compatibility)
    function getRoleHierarchy() {
      const hierarchy = {};
      customRoles.forEach(r => { hierarchy[r.name] = r.level; });
      return hierarchy;
    }

    // Legacy constant for backward compatibility
    const ROLE_HIERARCHY = {
      'Partner': 5,
      'Director': 4,
      'Manager': 3,
      'Senior': 2,
      'Graduate': 1
    };

    // Get role by name
    function getRole(roleName) {
      return customRoles.find(r => r.name === roleName) || { name: roleName, level: 0, canManageTeam: false, canSeeAll: false, canAssign: false };
    }

    // Get all role names for dropdowns
    function getRoleNames() {
      return customRoles.map(r => r.name);
    }

    const DEFAULT_JOB_TYPES = ['Tax Return', 'BAS', 'Financial Statements', 'Audit', 'Bookkeeping', 'Advisory', 'Other'];

    let selectedTaskIndex = null;
    let saveTimer = null;

    let sortClient = localStorage.getItem(SORT_CLIENT_KEY) || 'none'; // 'none', 'asc', 'desc'
    let sortDue = localStorage.getItem(SORT_DUE_KEY) || 'none'; // 'none', 'asc', 'desc'
    let sortPriority = localStorage.getItem(SORT_PRIORITY_KEY) || 'none'; // 'none', 'asc', 'desc'
    let blankMode = localStorage.getItem(BLANK_KEY) || 'bottom';

    // Timer state
    let runningTaskIndex = null;
    let ticker = null;

    // Modal state
    let notesTaskIndex = null;
    let linksTaskIndex = null;

    const userTasksCol = (uid) => fbDb.collection('users').doc(uid).collection('tasks');
    const userArchiveCol = (uid) => fbDb.collection('users').doc(uid).collection('archive');

    function pad2(n) { return String(n).padStart(2, '0'); }

    function formatHMS(totalSeconds) {
      const s = Math.max(0, Math.floor(totalSeconds || 0));
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      if (h > 0) return `${h}:${pad2(m)}:${pad2(sec)}`;
      return `${m}:${pad2(sec)}`;
    }

    function stripId(t) {
      const obj = (t || {});
      const copy = { ...obj };
      delete copy.id;
      return copy;
    }

    function backfillTask(t) {
      // Migrate team array - if no team exists but assignedTo does, create team from assignedTo
      let team = Array.isArray(t && t.team) ? t.team : [];
      if (team.length === 0 && t && t.assignedTo) {
        // Migration: convert old assignedTo to team array with Preparer role
        team = [{
          uid: t.assignedTo,
          jobRole: 'Preparer',
          addedAt: t.createdAt || new Date().toISOString(),
          addedBy: t.createdBy || t.assignedTo
        }];
      }

      // Migrate schedules - add memberUid if missing
      let schedules = Array.isArray(t && t.schedules) ? t.schedules : [];
      if (schedules.length > 0 && team.length > 0) {
        const firstMemberUid = team[0]?.uid;
        schedules = schedules.map(s => ({
          ...s,
          memberUid: s.memberUid || firstMemberUid || null
        }));

        // Deduplicate schedules by date+memberUid (keep first occurrence only)
        const seen = new Set();
        schedules = schedules.filter(s => {
          const key = `${s.date}|${s.memberUid || ''}`;
          if (seen.has(key)) return false;
          seen.add(key);
          return true;
        });
      }

      // Build teamMemberUids array for Firestore queries
      const teamMemberUids = team.map(m => m.uid).filter(Boolean);

      return {
        id: t && t.id ? t.id : (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random()),
        client: t && t.client != null ? t.client : '',
        description: t && t.description != null ? t.description : '',
        jobType: t && t.jobType ? t.jobType : 'Tax Return',
        status: t && t.status ? t.status : 'Not Started',
        dueDate: t && t.dueDate ? t.dueDate : '',
        priority: t && t.priority ? t.priority : 'Medium',
        billable: t && t.billable !== undefined ? t.billable : true,
        completed: !!(t && t.completed),
        seconds: Number.isFinite(t && t.seconds) ? t.seconds : 0,
        notes: (t && typeof t.notes === 'string') ? t.notes : '',
        items: Array.isArray(t && t.items) ? t.items : [],
        schedules: schedules,
        createdAt: (t && t.createdAt) ? t.createdAt : new Date().toISOString(),
        archivedAt: (t && t.archivedAt) ? t.archivedAt : null,
        // Recurring task fields
        isRecurring: !!(t && t.isRecurring),
        recurrencePattern: (t && t.recurrencePattern) ? t.recurrencePattern : null,
        nextOccurrence: (t && t.nextOccurrence) ? t.nextOccurrence : null,
        parentTaskId: (t && t.parentTaskId) ? t.parentTaskId : null,
        // Dependency fields
        dependsOn: Array.isArray(t && t.dependsOn) ? t.dependsOn : [],
        // Sort order for drag-and-drop
        sortOrder: Number.isFinite(t && t.sortOrder) ? t.sortOrder : 0,
        // Team-based allocation fields
        team: team,
        teamMemberUids: teamMemberUids,
        // Keep assignedTo for backward compatibility (first Preparer)
        assignedTo: (t && t.assignedTo) ? t.assignedTo : (team.find(m => m.jobRole === 'Preparer')?.uid || team[0]?.uid || null),
        createdBy: (t && t.createdBy) ? t.createdBy : null
      };
    }

    // Due date helper functions
    function formatShortDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      const day = date.getDate();
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return day + ' ' + months[date.getMonth()];
    }

    function isOverdue(dateStr) {
      if (!dateStr) return false;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const due = new Date(dateStr);
      return due < today;
    }

    function isDueSoon(dateStr) {
      if (!dateStr) return false;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const due = new Date(dateStr);
      const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
      return diffDays >= 0 && diffDays <= 3;
    }

    function isThisWeek(dateStr) {
      if (!dateStr) return false;
      const today = new Date();
      const startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - today.getDay());
      startOfWeek.setHours(0, 0, 0, 0);
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 7);
      const due = new Date(dateStr);
      return due >= startOfWeek && due < endOfWeek;
    }

    function formatDueDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
    }

    function getStatusClass(status) {
      const map = {
        'Not Started': 'status-not-started',
        'Info Requested': 'status-info-requested',
        'In Progress': 'status-in-progress',
        'Review': 'status-review',
        'Lodged': 'status-lodged',
        'Complete': 'status-complete'
      };
      return map[status] || 'status-not-started';
    }

    function getStatusRank(status) {
      const order = ['Not Started', 'Info Requested', 'In Progress', 'Review', 'Lodged', 'Complete'];
      return order.indexOf(status);
    }

    function loadLocal() {
      tasks = (JSON.parse(localStorage.getItem(STORAGE_KEY)) || []).map(backfillTask);
      archive = (JSON.parse(localStorage.getItem(ARCHIVE_KEY)) || []).map(backfillTask);
    }

    async function loadFromFirestore() {
      if (!currentUser || !fbDb) return;

      const uid = currentUser.uid;
      const tasksSnap = await userTasksCol(uid).get();
      const archSnap = await userArchiveCol(uid).get();

      const loadedTasks = [];
      tasksSnap.forEach(d => loadedTasks.push(backfillTask({ id: d.id, ...d.data() })));

      const loadedArchive = [];
      archSnap.forEach(d => loadedArchive.push(backfillTask({ id: d.id, ...d.data() })));

      loadedTasks.sort((a, b) => (a.createdAt || '').localeCompare(b.createdAt || '') || String(a.id).localeCompare(String(b.id)));
      loadedArchive.sort((a, b) => (a.archivedAt || '').localeCompare(b.archivedAt || '') || String(a.id).localeCompare(String(b.id)));

      tasks = loadedTasks;
      archive = loadedArchive;

      localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks.map(stripId)));
      localStorage.setItem(ARCHIVE_KEY, JSON.stringify(archive.map(stripId)));
    }

    async function persistTaskToFirestore(task) {
      if (!currentUser || !fbDb || !task || !task.id) return;

      const taskData = stripId(task);

      if (isInFirmMode()) {
        // Firm mode - save to firm tasks collection
        // Ensure createdBy and assignedTo are set
        if (!taskData.createdBy) taskData.createdBy = currentUser.uid;

        // Compute teamMemberUids from team array for Firestore queries
        const team = Array.isArray(taskData.team) ? taskData.team : [];
        taskData.teamMemberUids = team.map(m => m.uid).filter(Boolean);

        // Keep assignedTo in sync with first Preparer (backward compatibility)
        const firstPreparer = team.find(m => m.jobRole === 'Preparer');
        taskData.assignedTo = firstPreparer?.uid || team[0]?.uid || taskData.assignedTo || currentUser.uid;

        await fbDb.collection('firms').doc(currentFirmId)
          .collection('tasks').doc(task.id).set(taskData, { merge: true });
      } else {
        // Solo mode - save to user's tasks collection
        const uid = currentUser.uid;
        await userTasksCol(uid).doc(task.id).set(taskData, { merge: true });
      }
    }

    async function persistArchiveToFirestore(task) {
      if (!currentUser || !fbDb || !task || !task.id) return;

      const taskData = stripId(task);

      if (isInFirmMode()) {
        // Firm mode - save to firm archive collection
        await fbDb.collection('firms').doc(currentFirmId)
          .collection('archive').doc(task.id).set(taskData, { merge: true });
      } else {
        // Solo mode
        const uid = currentUser.uid;
        await userArchiveCol(uid).doc(task.id).set(taskData, { merge: true });
      }
    }

    async function deleteTaskFromFirestore(task) {
      if (!currentUser || !fbDb || !task || !task.id) return;

      if (isInFirmMode()) {
        // Firm mode - delete from firm tasks collection
        await fbDb.collection('firms').doc(currentFirmId)
          .collection('tasks').doc(task.id).delete();
      } else {
        // Solo mode
        const uid = currentUser.uid;
        await userTasksCol(uid).doc(task.id).delete();
      }
    }

    function setSavedStamp() {
      // Removed - no longer displaying save status
    }

    function setArchiveCount() {
      document.getElementById('archiveCount').textContent = `Archive: ${archive.length}`;
    }

    function setActiveTimerStamp() {
      const el = document.getElementById('activeTimer');
      if (runningTaskIndex == null) {
        el.textContent = '‚è± ‚Äî';
        el.title = '';
        return;
      }
      const t = tasks[runningTaskIndex];
      const label = (t && (t.client || t.description))
        ? `${(t.client || '').trim()}${(t.client && t.description) ? ' ‚Äî ' : ''}${(t.description || '').trim()}`
        : 'Selected task';
      el.textContent = `‚è± ${formatHMS(t.seconds)}`;
      el.title = label;
    }

    function saveTasks(immediate = true) {
      const doSave = () => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks.map(stripId)));
        localStorage.setItem(ARCHIVE_KEY, JSON.stringify(archive.map(stripId)));
        setSavedStamp();
        setArchiveCount();
      };

      if (immediate) {
        doSave();
        return;
      }

      clearTimeout(saveTimer);
      saveTimer = setTimeout(doSave, 250);
    }

    function prioLetter(p) { return p === 'Low' ? 'L' : (p === 'Medium' ? 'M' : 'H'); }
    function prioClass(p) { return p === 'Low' ? 'low' : (p === 'Medium' ? 'medium' : 'high'); }
    function prioRank(p) { return p === 'High' ? 0 : (p === 'Medium' ? 1 : 2); }
    function norm(s) { return (s || '').toString().trim().toLowerCase(); }

    function isBlankRow(task) {
      return norm(task.client) === '' && norm(task.description) === '';
    }

    function purgeBlankRowsIfNeeded() {
      if (blankMode !== 'remove') return;

      // Allow a small working buffer of blank rows so "Add Task" still feels like it adds rows.
      // We then purge older blank rows to keep the list tidy.
      const KEEP_BLANK_BUFFER = 5;

      const oldTasks = tasks;
      const beforeLen = oldTasks.length;

      // Collect open blank rows (no text) with no time recorded.
      const blankOpenIdx = [];
      for (let i = 0; i < oldTasks.length; i++) {
        const t = oldTasks[i];
        if (t.completed) continue;
        if (!isBlankRow(t)) continue;
        if ((t.seconds || 0) > 0) continue;
        blankOpenIdx.push(i);
      }

      // Always keep the selected blank row (if applicable)
      const keepIdx = new Set();
      if (
        selectedTaskIndex != null &&
        oldTasks[selectedTaskIndex] &&
        !oldTasks[selectedTaskIndex].completed &&
        isBlankRow(oldTasks[selectedTaskIndex]) &&
        (oldTasks[selectedTaskIndex].seconds || 0) === 0
      ) {
        keepIdx.add(selectedTaskIndex);
      }

      // Keep the most recent N blank rows (from the bottom)
      for (let k = blankOpenIdx.length - 1; k >= 0 && keepIdx.size < KEEP_BLANK_BUFFER; k--) {
        keepIdx.add(blankOpenIdx[k]);
      }

      tasks = oldTasks.filter((t, idx) => {
        if (t.completed) return true;
        if (!isBlankRow(t)) return true;
        if ((t.seconds || 0) > 0) return true;
        return keepIdx.has(idx);
      });

      if (tasks.length !== beforeLen) {
        const remapIndex = (oldIndex) => {
          if (oldIndex == null) return null;
          const old = oldTasks[oldIndex];
          const newIdx = tasks.indexOf(old);
          return newIdx >= 0 ? newIdx : null;
        };

        selectedTaskIndex = remapIndex(selectedTaskIndex);
        runningTaskIndex = remapIndex(runningTaskIndex);
        saveTasks(true);
      }
    }

    function compareBySort(a, b) {
      const ta = a.task;
      const tb = b.task;

      const ca = norm(ta.client);
      const cb = norm(tb.client);
      const da = norm(ta.description);
      const db = norm(tb.description);

      const pa = prioRank(ta.priority);
      const pb = prioRank(tb.priority);

      // Check if row is blank (no client and no description)
      const aIsBlank = ca === '' && da === '';
      const bIsBlank = cb === '' && db === '';

      // Always push blank rows to the end
      if (aIsBlank && !bIsBlank) return 1;
      if (!aIsBlank && bIsBlank) return -1;

      const caIsBlank = ca === '';
      const cbIsBlank = cb === '';

      const clientCompare = () => {
        // Push blank clients to end
        if (caIsBlank && !cbIsBlank) return 1;
        if (!caIsBlank && cbIsBlank) return -1;
        return ca.localeCompare(cb);
      };

      const dateCompare = () => {
        // Push blank dates to end
        if (!ta.dueDate && !tb.dueDate) return 0;
        if (!ta.dueDate) return 1;
        if (!tb.dueDate) return -1;
        return new Date(ta.dueDate) - new Date(tb.dueDate);
      };

      // Sort by Client (alphabetical)
      if (sortClient !== 'none') {
        const c = clientCompare();
        if (c !== 0) return sortClient === 'desc' ? -c : c;
      }

      // Sort by Due Date
      if (sortDue !== 'none') {
        const d = dateCompare();
        if (d !== 0) return sortDue === 'desc' ? -d : d;
      }

      // Sort by Priority
      if (sortPriority !== 'none') {
        const p = pa - pb;
        if (p !== 0) return sortPriority === 'desc' ? -p : p;
      }

      return a.index - b.index;
    }

    // Filter state
    let filterStatus = 'all';
    let filterJobType = 'all';

    function buildClientDatalist() {
      const dl = document.getElementById('clientList');
      dl.innerHTML = '';
      // Combine master clients and clients from tasks
      const set = new Set([
        ...masterClients,
        ...tasks.map(t => (t.client || '').trim()).filter(v => v.length > 0)
      ]);
      Array.from(set).sort((a, b) => a.localeCompare(b)).forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        dl.appendChild(opt);
      });
    }

    function setSelected(index) {
      selectedTaskIndex = index;
      const rows = document.querySelectorAll('tbody#taskBody tr[data-task-index]');
      rows.forEach(r => r.classList.toggle('selected', Number(r.dataset.taskIndex) === index));
    }

    function focusClientForTaskIndex(taskIndex) {
      const row = document.querySelector(`tr[data-task-index="${taskIndex}"]`);
      if (!row) return;
      const input = row.querySelector('input[data-field="client"]');
      if (input) input.focus();
    }

    function addTask({ focus = true } = {}) {
      const t = backfillTask({ client: '', description: '', priority: 'Medium', completed: false, seconds: 0, notes: '', items: [] });
      tasks.push(t);
      selectedTaskIndex = tasks.length - 1;
      saveTasks(true);
      if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(t).catch(console.warn);
      renderTasks();
      if (focus) focusClientForTaskIndex(tasks.length - 1);
    }

    function archiveTask(index) {
      if (index == null || index < 0 || index >= tasks.length) return;
      const task = tasks[index];
      const archived = backfillTask({ ...task, archivedAt: new Date().toISOString() });
      archive.push(archived);
      saveTasks(true);
      if (hasFirebaseConfig() && currentUser) persistArchiveToFirestore(archived).catch(console.warn);
      deleteTask(index, { skipArchivePrompt: true });
    }

    function deleteTask(index, { skipArchivePrompt = false } = {}) {
      if (index == null || index < 0 || index >= tasks.length) return;

      if (!skipArchivePrompt && tasks[index] && tasks[index].completed) {
        const yesArchive = confirm('Archive this completed task?\n\nOK = Archive (hidden)\nCancel = Delete permanently');
        if (yesArchive) {
          archiveTask(index);
          return;
        }
      }

      if (runningTaskIndex === index) stopTimer();

      const removed = tasks[index];
      tasks.splice(index, 1);

      if (hasFirebaseConfig() && currentUser) deleteTaskFromFirestore(removed).catch(console.warn);

      if (runningTaskIndex != null && index < runningTaskIndex) runningTaskIndex -= 1;
      if (selectedTaskIndex != null && index < selectedTaskIndex) selectedTaskIndex -= 1;
      if (selectedTaskIndex === index) selectedTaskIndex = null;

      saveTasks(true);
      renderTasks();
    }

    function toggleComplete(index, checked) {
      tasks[index].completed = !!checked;
      if (tasks[index].completed && runningTaskIndex === index) stopTimer();

      saveTasks(true);
      if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(tasks[index]).catch(console.warn);

      if (checked) {
        const row = document.querySelector(`tr[data-task-index="${index}"]`);
        if (row) {
          row.classList.remove('lift-move');
          void row.offsetWidth;
          row.classList.add('lift-move');
        }

        // 1) animation completes
        setTimeout(() => {
          renderTasks();
        }, 1800);

        return;
      }

      renderTasks();
    }

    function cyclePriority(index) {
      const cur = tasks[index].priority;
      const next = cur === 'Low' ? 'Medium' : (cur === 'Medium' ? 'High' : 'Low');
      tasks[index].priority = next;
      saveTasks(true);
      if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(tasks[index]).catch(console.warn);
      renderTasks();
    }

    function startTimer(index) {
      if (index == null || index < 0 || index >= tasks.length) return;
      if (tasks[index].completed) return;

      if (runningTaskIndex != null && runningTaskIndex !== index) stopTimer();

      runningTaskIndex = index;
      setActiveTimerStamp();

      if (ticker) clearInterval(ticker);
      ticker = setInterval(() => {
        if (runningTaskIndex == null) return;
        tasks[runningTaskIndex].seconds = (tasks[runningTaskIndex].seconds || 0) + 1;
        setActiveTimerStamp();
        saveTasks(false);
      }, 1000);

      renderTasks();
    }

    function stopTimer() {
      if (ticker) {
        clearInterval(ticker);
        ticker = null;
      }
      const was = runningTaskIndex;
      runningTaskIndex = null;
      setActiveTimerStamp();
      saveTasks(true);
      if (was != null && tasks[was] && hasFirebaseConfig() && currentUser) {
        persistTaskToFirestore(tasks[was]).catch(console.warn);
      }
      renderTasks();
    }

    function toggleTimer(index) {
      if (tasks[index].completed) return;
      if (runningTaskIndex === index) stopTimer();
      else startTimer(index);
    }

    function hasNotes(task) {
      return (task.notes || '').trim().length > 0;
    }

    function hasItems(task) {
      return Array.isArray(task.items) && task.items.length > 0;
    }

    function showModal(id) {
      document.getElementById(id).style.display = 'flex';
    }

    function hideModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    function openNotes(index) {
      notesTaskIndex = index;
      const t = tasks[index];
      document.getElementById('notesTitle').textContent = `Notes ‚Äî ${((t.client || '').trim() || '‚Äî')} `;
      document.getElementById('notesTextarea').value = t.notes || '';
      document.getElementById('notesMeta').textContent = `${(t.client || '').trim() || 'No client'}${(t.description || '').trim() ? ' ‚Äî ' + (t.description || '').trim() : ''}`;
      showModal('notesBackdrop');
      setTimeout(() => document.getElementById('notesTextarea').focus(), 50);
    }

    function closeNotes() {
      notesTaskIndex = null;
      hideModal('notesBackdrop');
    }

    function openLinks(index) {
      linksTaskIndex = index;
      const t = tasks[index];
      document.getElementById('linksTitle').textContent = `Links & Documents ‚Äî ${((t.client || '').trim() || '‚Äî')} `;
      document.getElementById('linksMeta').textContent = `${(t.client || '').trim() || 'No client'}${(t.description || '').trim() ? ' ‚Äî ' + (t.description || '').trim() : ''}`;
      document.getElementById('newLinkInput').value = '';
      renderLinksList();
      showModal('linksBackdrop');
      setTimeout(() => document.getElementById('newLinkInput').focus(), 50);
    }

    function closeLinks() {
      linksTaskIndex = null;
      hideModal('linksBackdrop');
    }

    // ===== Admin Modal Functions =====
    function openAdmin() {
      renderClientsMasterList();
      renderJobTypesMasterList();
      renderTeamNamesMasterList();
      updateHoursPerDayUI();
      showModal('adminBackdrop');
      setTimeout(() => document.getElementById('newClientInput').focus(), 50);
    }

    function closeAdmin() {
      hideModal('adminBackdrop');
    }

    function renderClientsMasterList() {
      const container = document.getElementById('clientsMasterList');
      container.innerHTML = '';
      if (masterClients.length === 0) {
        container.innerHTML = '<div class="subtle" style="text-align:center; padding:10px;">No clients added yet</div>';
        return;
      }
      masterClients.forEach((client, index) => {
        const row = document.createElement('div');
        row.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:4px 0; border-bottom:1px solid var(--border);';
        row.innerHTML = `
          <span style="color:var(--text); font-size:10px;">${client}</span>
          <button class="mini btn-danger" type="button" style="padding:2px 8px; font-size:11px;">Remove</button>
        `;
        row.querySelector('button').addEventListener('click', () => removeClient(index));
        container.appendChild(row);
      });
    }

    function renderJobTypesMasterList() {
      const container = document.getElementById('jobTypesMasterList');
      container.innerHTML = '';
      if (masterJobTypes.length === 0) {
        container.innerHTML = '<div class="subtle" style="text-align:center; padding:10px;">No job types added yet</div>';
        return;
      }
      masterJobTypes.forEach((jobType, index) => {
        const row = document.createElement('div');
        row.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:4px 0; border-bottom:1px solid var(--border);';
        row.innerHTML = `
          <span style="color:var(--text); font-size:10px;">${jobType}</span>
          <button class="mini btn-danger" type="button" style="padding:2px 8px; font-size:11px;">Remove</button>
        `;
        row.querySelector('button').addEventListener('click', () => removeJobType(index));
        container.appendChild(row);
      });
    }

    function addClient(name) {
      const trimmed = (name || '').trim();
      if (!trimmed) return;
      if (masterClients.includes(trimmed)) return; // No duplicates
      masterClients.push(trimmed);
      masterClients.sort((a, b) => a.localeCompare(b));
      saveMasterLists();
      renderClientsMasterList();
      updateClientDatalist();
      document.getElementById('newClientInput').value = '';
    }

    function removeClient(index) {
      masterClients.splice(index, 1);
      saveMasterLists();
      renderClientsMasterList();
      updateClientDatalist();
    }

    function addJobType(name) {
      const trimmed = (name || '').trim();
      if (!trimmed) return;
      if (masterJobTypes.includes(trimmed)) return; // No duplicates
      masterJobTypes.push(trimmed);
      masterJobTypes.sort((a, b) => a.localeCompare(b));
      saveMasterLists();
      renderJobTypesMasterList();
      updateJobTypeSelects();
      document.getElementById('newJobTypeInput').value = '';
    }

    function removeJobType(index) {
      masterJobTypes.splice(index, 1);
      saveMasterLists();
      renderJobTypesMasterList();
      updateJobTypeSelects();
    }

    function renderTeamNamesMasterList() {
      const container = document.getElementById('teamNamesMasterList');
      if (!container) return;
      container.innerHTML = '';
      if (masterTeamNames.length === 0) {
        container.innerHTML = '<div class="subtle" style="text-align:center; padding:10px;">No teams added yet</div>';
        return;
      }
      masterTeamNames.forEach((team, index) => {
        const row = document.createElement('div');
        row.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:4px 0; border-bottom:1px solid var(--border);';
        row.innerHTML = `
          <span style="color:var(--text); font-size:10px;">${team}</span>
          <button class="mini btn-danger" type="button" style="padding:2px 8px; font-size:11px;">Remove</button>
        `;
        row.querySelector('button').addEventListener('click', () => removeTeamName(index));
        container.appendChild(row);
      });
    }

    function addTeamName(name) {
      const trimmed = (name || '').trim();
      if (!trimmed) return;
      if (masterTeamNames.includes(trimmed)) return;
      masterTeamNames.push(trimmed);
      masterTeamNames.sort((a, b) => a.localeCompare(b));
      saveMasterLists();
      renderTeamNamesMasterList();
      document.getElementById('newTeamNameInput').value = '';
    }

    function removeTeamName(index) {
      masterTeamNames.splice(index, 1);
      saveMasterLists();
      renderTeamNamesMasterList();
    }

    function updateClientDatalist() {
      const datalist = document.getElementById('clientList');
      datalist.innerHTML = '';
      masterClients.forEach(client => {
        const opt = document.createElement('option');
        opt.value = client;
        datalist.appendChild(opt);
      });
    }

    function updateJobTypeSelects() {
      // Update the filter dropdown
      const filterSelect = document.getElementById('filterJobType');
      const currentFilter = filterSelect.value;
      filterSelect.innerHTML = '<option value="all">All</option>';
      masterJobTypes.forEach(jt => {
        const opt = document.createElement('option');
        opt.value = jt;
        opt.textContent = jt;
        filterSelect.appendChild(opt);
      });
      filterSelect.value = currentFilter;

      // Re-render tasks to update job type dropdowns in rows
      renderTasks();
    }

    function updateHoursPerDayUI() {
      const select = document.getElementById('hoursPerDaySelect');
      const custom = document.getElementById('hoursPerDayCustom');
      const standardValues = ['6', '7', '7.5', '8'];
      if (standardValues.includes(String(hoursPerDay))) {
        select.value = String(hoursPerDay);
        custom.style.display = 'none';
      } else {
        select.value = 'custom';
        custom.value = hoursPerDay;
        custom.style.display = 'block';
      }
    }

    function handleHoursPerDayChange() {
      const select = document.getElementById('hoursPerDaySelect');
      const custom = document.getElementById('hoursPerDayCustom');
      if (select.value === 'custom') {
        custom.style.display = 'block';
        custom.focus();
      } else {
        custom.style.display = 'none';
        hoursPerDay = parseFloat(select.value);
        saveMasterLists();
      }
    }

    function handleHoursPerDayCustom() {
      const custom = document.getElementById('hoursPerDayCustom');
      const val = parseFloat(custom.value);
      if (val && val > 0 && val <= 24) {
        hoursPerDay = val;
        saveMasterLists();
      }
    }

    function saveMasterLists() {
      if (hasFirebaseConfig() && currentUser) {
        if (isInFirmMode() && currentFirmId) {
          // Firm mode - save to firm settings
          fbDb.collection('firms').doc(currentFirmId).set({
            settings: {
              clients: masterClients,
              jobTypes: masterJobTypes,
              teamNames: masterTeamNames,
              hoursPerDay: hoursPerDay,
              jobRoles: jobRoles
            }
          }, { merge: true }).catch(console.warn);
        } else {
          // Solo mode - save to user settings
          const uid = currentUser.uid;
          fbDb.collection('users').doc(uid).collection('settings').doc('masterLists').set({
            clients: masterClients,
            jobTypes: masterJobTypes,
            teamNames: masterTeamNames,
            hoursPerDay: hoursPerDay
          }).catch(console.warn);
        }
      }
    }

    async function loadMasterLists() {
      if (hasFirebaseConfig() && currentUser) {
        const uid = currentUser.uid;
        try {
          const doc = await fbDb.collection('users').doc(uid).collection('settings').doc('masterLists').get();
          if (doc.exists) {
            const data = doc.data();
            if (Array.isArray(data.clients)) masterClients = data.clients;
            if (Array.isArray(data.jobTypes) && data.jobTypes.length > 0) masterJobTypes = data.jobTypes;
            if (Array.isArray(data.teamNames)) masterTeamNames = data.teamNames;
            if (typeof data.hoursPerDay === 'number') hoursPerDay = data.hoursPerDay;
          }
        } catch (e) {
          console.warn('Could not load master lists:', e);
        }
      }
      updateClientDatalist();
      updateJobTypeSelects();
      updateHoursPerDayUI();
    }

    // ===== Firm Mode Functions =====

    function showFirmSetupModal() {
      if (firmSetupDismissed) return; // Don't show again if already dismissed
      showModal('firmSetupBackdrop');
    }

    async function createFirm() {
      const name = document.getElementById('firmName').value.trim();
      const prefix = document.getElementById('firmPrefix').value.trim().toUpperCase();

      if (!name) {
        toast('Please enter a firm name');
        return;
      }
      if (!prefix || !/^[A-Z]{2,5}$/.test(prefix)) {
        toast('Prefix must be 2-5 letters');
        return;
      }

      toast('Creating firm...');
      try {
        const firmRef = fbDb.collection('firms').doc();
        const firmId = firmRef.id;

        const batch = fbDb.batch();

        // Create firm document
        batch.set(firmRef, {
          name: name,
          clientIdPrefix: prefix,
          clientIdCounter: 0,
          settings: {
            hoursPerDay: 7.5,
            jobTypes: [...DEFAULT_JOB_TYPES],
            jobRoles: [...DEFAULT_JOB_ROLES]
          },
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: currentUser.uid
        });

        // Add current user as Partner + Admin
        batch.set(firmRef.collection('members').doc(currentUser.uid), {
          email: currentUser.email,
          displayName: currentUser.email.split('@')[0],
          role: 'Partner',
          isAdmin: true,
          reportsTo: null,
          status: 'active',
          joinedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Link user to firm
        batch.set(fbDb.collection('users').doc(currentUser.uid), {
          firmId: firmId,
          email: currentUser.email
        }, { merge: true });

        await batch.commit();

        currentFirmId = firmId;
        firmSetupDismissed = true; // Prevent modal from reappearing

        // Set firm data directly (we just created it)
        currentFirmData = {
          name: name,
          clientIdPrefix: prefix,
          clientIdCounter: 0,
          settings: { hoursPerDay: 7.5, jobTypes: [...DEFAULT_JOB_TYPES], jobRoles: [...DEFAULT_JOB_ROLES] }
        };
        jobRoles = [...DEFAULT_JOB_ROLES];

        // Set current member (we're the creator/admin)
        currentMember = {
          uid: currentUser.uid,
          email: currentUser.email,
          displayName: currentUser.email.split('@')[0],
          role: 'Partner',
          isAdmin: true,
          reportsTo: null,
          status: 'active'
        };

        // Add self to firmMembers array
        firmMembers = [currentMember];

        toast('Firm created successfully!');
        hideModal('firmSetupBackdrop');

        // Try to reload from Firestore (non-blocking)
        loadFirmData(firmId).catch(e => console.warn('loadFirmData:', e));

        updateFirmUI();
        renderTasks();
      } catch (e) {
        console.error('Failed to create firm:', e);
        toast('Failed to create firm: ' + e.message);
      }
    }

    function skipFirmSetup() {
      firmSetupDismissed = true; // Prevent modal from reappearing
      hideModal('firmSetupBackdrop');
      // Load solo mode data
      loadFromFirestore().then(() => loadMasterLists()).catch(console.warn);
      showApp();
      renderTasks();
    }

    function updateFirmUI() {
      const teamBtn = document.getElementById('teamBtn');
      const rolesBtn = document.getElementById('rolesBtn');
      const holidaysBtn = document.getElementById('holidaysBtn');
      const assignedHeader = document.getElementById('assignedHeader');

      // App admins always have admin access to any firm they view
      const hasAdminAccess = window.isAppAdmin || window.isAdminOverride || (currentMember && currentMember.isAdmin);

      if (isInFirmMode() && currentFirmData && (currentMember || window.isAppAdmin || window.isAdminOverride)) {
        // Show team, roles, and holidays buttons if admin (firm admin or app admin)
        if (teamBtn) {
          teamBtn.style.display = hasAdminAccess ? 'inline-flex' : 'none';
        }
        if (rolesBtn) {
          rolesBtn.style.display = hasAdminAccess ? 'inline-flex' : 'none';
        }
        if (holidaysBtn) {
          holidaysBtn.style.display = hasAdminAccess ? 'inline-flex' : 'none';
        }
        // Show assigned column header
        if (assignedHeader) {
          assignedHeader.style.display = '';
        }
      } else {
        // Hide firm elements in solo mode
        if (teamBtn) teamBtn.style.display = 'none';
        if (rolesBtn) rolesBtn.style.display = 'none';
        if (holidaysBtn) holidaysBtn.style.display = 'none';
        if (assignedHeader) assignedHeader.style.display = 'none';
      }
    }

    async function loadFirmData(firmId) {
      // Reset current member before loading new firm
      currentMember = null;

      try {
        // Load firm document
        const firmDoc = await fbDb.collection('firms').doc(firmId).get();
        if (!firmDoc.exists) {
          console.warn('Firm not found:', firmId);
          currentFirmId = null;
          return;
        }
        currentFirmData = firmDoc.data();
        hoursPerDay = currentFirmData.settings?.hoursPerDay || 7.5;
        masterJobTypes = currentFirmData.settings?.jobTypes || [...DEFAULT_JOB_TYPES];
        jobRoles = currentFirmData.settings?.jobRoles || [...DEFAULT_JOB_ROLES];

        // Load custom roles
        loadRolesFromFirestore();

        // Load current member info
        const memberDoc = await fbDb.collection('firms').doc(firmId)
          .collection('members').doc(currentUser.uid).get();
        if (memberDoc.exists) {
          currentMember = { uid: currentUser.uid, ...memberDoc.data() };
        }

        // Load all members
        await loadFirmMembers();

        // Load firm clients
        await loadFirmClients();

        // Load holidays and blocked days
        await loadFirmHolidaysQuiet();

        // Load visible tasks
        await loadFirmTasks();

        updateHoursPerDayUI();
        updateJobTypeSelects();

      } catch (e) {
        console.error('Failed to load firm data:', e);
      }
    }

    async function loadFirmMembers() {
      if (!currentFirmId) return;
      try {
        const snap = await fbDb.collection('firms').doc(currentFirmId)
          .collection('members').get();
        firmMembers = snap.docs.map(d => ({ uid: d.id, ...d.data() }));
        updateReportsToDropdown();
      } catch (e) {
        console.warn('Failed to load firm members:', e);
      }
    }

    async function loadFirmClients() {
      if (!currentFirmId) return;
      try {
        const snap = await fbDb.collection('firms').doc(currentFirmId)
          .collection('clients').where('isActive', '==', true).get();
        firmClients = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        // Update masterClients for compatibility with existing code
        masterClients = firmClients.map(c => `${c.clientCode} - ${c.name}`);
        updateClientDatalist();
      } catch (e) {
        console.warn('Failed to load firm clients:', e);
      }
    }

    // ===== Multi-Firm Management =====
    async function loadUserFirms() {
      if (!currentUser) return;
      userFirms = [];

      try {
        // Read user's document to get their firm memberships
        const userDoc = await fbDb.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.exists ? userDoc.data() : {};

        // Get firm IDs from user document (array of firm IDs they belong to)
        let firmIds = userData.firmIds || [];

        // Fallback: if firmIds array doesn't exist but firmId does, use that
        if (firmIds.length === 0 && userData.firmId) {
          firmIds = [userData.firmId];
        }

        // Query each firm the user belongs to
        for (const firmId of firmIds) {
          try {
            const firmDoc = await fbDb.collection('firms').doc(firmId).get();
            if (!firmDoc.exists) continue;

            const memberDoc = await fbDb.collection('firms').doc(firmId)
              .collection('members').doc(currentUser.uid).get();

            if (memberDoc.exists) {
              const memberData = memberDoc.data();
              if (memberData.status === 'active') {
                userFirms.push({
                  id: firmId,
                  name: firmDoc.data().name,
                  role: memberData.role,
                  isAdmin: memberData.isAdmin || false,
                  status: memberData.status
                });
              }
            }
          } catch (firmErr) {
            console.warn(`Failed to load firm ${firmId}:`, firmErr);
          }
        }

        // Sort by name
        userFirms.sort((a, b) => a.name.localeCompare(b.name));
      } catch (e) {
        console.warn('Failed to load user firms:', e);
      }
    }

    async function switchToFirm(firmId) {
      if (firmId === currentFirmId) return;

      toast('Switching firm...');
      hideFirmSwitcherDropdown();

      try {
        // Update user's current firmId
        await fbDb.collection('users').doc(currentUser.uid).set({
          firmId: firmId
        }, { merge: true });

        currentFirmId = firmId;

        // Load the new firm's data
        await loadFirmData(firmId);

        updateFirmUI();
        updateFirmSwitcher();
        renderTasks();
        hideModal('firmSelectorBackdrop');

        toast('Switched to ' + currentFirmData.name);
      } catch (e) {
        console.error('Failed to switch firm:', e);
        toast('Failed to switch firm: ' + e.message);
      }
    }

    // Show firm selector modal (on login with multiple firms)
    function showFirmSelectorModal() {
      const listContainer = document.getElementById('firmSelectorList');
      listContainer.innerHTML = '';

      userFirms.forEach(firm => {
        const row = document.createElement('div');
        row.style.cssText = 'padding:12px 16px; border-bottom:1px solid var(--border); cursor:pointer; transition: background 0.15s;';
        row.onmouseover = () => row.style.background = 'rgba(59, 130, 246, 0.1)';
        row.onmouseout = () => row.style.background = 'transparent';
        row.onclick = () => selectFirmOnLogin(firm.id);
        row.innerHTML = `
          <div style="font-weight:600; margin-bottom:4px;">${firm.name}</div>
          <div style="font-size:11px; color:var(--muted);">${firm.role}${firm.isAdmin ? ' ‚Ä¢ Admin' : ''}</div>
        `;
        listContainer.appendChild(row);
      });

      showModal('firmSelectorBackdrop');
    }

    async function selectFirmOnLogin(firmId) {
      hideModal('firmSelectorBackdrop');

      // Update user's current firmId
      await fbDb.collection('users').doc(currentUser.uid).set({
        firmId: firmId
      }, { merge: true });

      currentFirmId = firmId;
      firmSetupDismissed = true;

      await loadFirmData(firmId);
      showApp();
      updateFirmUI();
      updateFirmSwitcher();

      setSavedStamp();
      setActiveTimerStamp();
      setArchiveCount();
      renderTasks();
    }

    // Firm switcher in header
    function updateFirmSwitcher() {
      const switcher = document.getElementById('firmSwitcher');
      const nameEl = document.getElementById('firmSwitcherName');
      const dropdown = document.getElementById('firmSwitcherDropdown');

      if (userFirms.length <= 1) {
        switcher.style.display = 'none';
        return;
      }

      switcher.style.display = 'block';
      nameEl.textContent = currentFirmData?.name || 'Select Firm';

      // Build dropdown
      dropdown.innerHTML = '';
      userFirms.forEach(firm => {
        const isCurrent = firm.id === currentFirmId;
        const item = document.createElement('div');
        item.style.cssText = `padding:10px 14px; cursor:pointer; border-bottom:1px solid var(--border); background:${isCurrent ? 'rgba(59, 130, 246, 0.15)' : 'transparent'};`;
        item.onmouseover = () => { if (!isCurrent) item.style.background = 'rgba(59, 130, 246, 0.1)'; };
        item.onmouseout = () => { if (!isCurrent) item.style.background = 'transparent'; };
        item.onclick = () => switchToFirm(firm.id);
        item.innerHTML = `
          <div style="font-weight:${isCurrent ? '600' : '400'}; font-size:13px; color:${isCurrent ? 'var(--accent-2)' : 'var(--text)'};">${firm.name}</div>
          <div style="font-size:10px; color:var(--muted);">${firm.role}</div>
        `;
        dropdown.appendChild(item);
      });
    }

    function toggleFirmSwitcherDropdown(event) {
      if (event) event.stopPropagation();
      const dropdown = document.getElementById('firmSwitcherDropdown');
      const isHidden = dropdown.style.display === 'none' || dropdown.style.display === '';
      dropdown.style.display = isHidden ? 'block' : 'none';
    }
    // Expose to global scope for inline onclick
    window.toggleFirmSwitcherDropdown = toggleFirmSwitcherDropdown;

    function hideFirmSwitcherDropdown() {
      const dropdown = document.getElementById('firmSwitcherDropdown');
      if (dropdown) dropdown.style.display = 'none';
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const switcher = document.getElementById('firmSwitcher');
      const btn = document.getElementById('firmSwitcherBtn');
      // Don't close if clicking the button itself
      if (btn && btn.contains(e.target)) return;
      if (switcher && !switcher.contains(e.target)) {
        hideFirmSwitcherDropdown();
      }
    });

    function getSubordinates(supervisorUid) {
      const direct = firmMembers.filter(m => m.reportsTo === supervisorUid && m.status === 'active');
      let all = direct.map(m => m.uid);
      direct.forEach(m => {
        all = all.concat(getSubordinates(m.uid));
      });
      return all;
    }

    function getVisibleUserIds() {
      // App admin override - see all users in the firm
      if (window.isAdminOverride || window.isAppAdmin) {
        return firmMembers.filter(m => m.status === 'active').map(m => m.uid);
      }
      if (!currentMember) return [currentUser.uid];
      if (currentMember.role === 'Partner' || currentMember.isAdmin) {
        return firmMembers.filter(m => m.status === 'active').map(m => m.uid);
      }
      const subordinates = getSubordinates(currentUser.uid);
      return [currentUser.uid, ...subordinates];
    }

    function chunkArray(arr, size) {
      const chunks = [];
      for (let i = 0; i < arr.length; i += size) {
        chunks.push(arr.slice(i, i + size));
      }
      return chunks;
    }

    async function loadFirmTasks() {
      if (!currentFirmId) return;

      tasks = [];

      try {
        // Admin override: load ALL tasks in the firm
        if (window.isAdminOverride || window.isAppAdmin) {
          const snap = await fbDb.collection('firms').doc(currentFirmId)
            .collection('tasks')
            .get();
          snap.docs.forEach(d => tasks.push({ id: d.id, ...d.data() }));
        } else {
          // Normal user: load tasks based on visibility
          const visibleUsers = getVisibleUserIds();
          const taskIds = new Set(); // Track loaded task IDs to avoid duplicates

          // Firestore 'in' query limit is 30
          const batches = chunkArray(visibleUsers, 30);

          // Query by assignedTo (backward compatibility)
          for (const batch of batches) {
            const snap = await fbDb.collection('firms').doc(currentFirmId)
              .collection('tasks')
              .where('assignedTo', 'in', batch)
              .get();
            snap.docs.forEach(d => {
              if (!taskIds.has(d.id)) {
                taskIds.add(d.id);
                tasks.push({ id: d.id, ...d.data() });
              }
            });
          }

          // Query by teamMemberUids (new team-based visibility)
          // array-contains-any has a limit of 10 values
          const smallBatches = chunkArray(visibleUsers, 10);
          for (const batch of smallBatches) {
            const snap = await fbDb.collection('firms').doc(currentFirmId)
              .collection('tasks')
              .where('teamMemberUids', 'array-contains-any', batch)
              .get();
            snap.docs.forEach(d => {
              if (!taskIds.has(d.id)) {
                taskIds.add(d.id);
                tasks.push({ id: d.id, ...d.data() });
              }
            });
          }

          // Also get unassigned tasks (created by visible users)
          for (const batch of batches) {
            const snap = await fbDb.collection('firms').doc(currentFirmId)
              .collection('tasks')
              .where('createdBy', 'in', batch)
              .get();
            snap.docs.forEach(d => {
              if (!taskIds.has(d.id)) {
                taskIds.add(d.id);
                tasks.push({ id: d.id, ...d.data() });
              }
            });
          }
        }

        tasks.sort((a, b) => {
          const aDate = a.createdAt?.toDate?.() || new Date(a.createdAt) || new Date(0);
          const bDate = b.createdAt?.toDate?.() || new Date(b.createdAt) || new Date(0);
          return bDate - aDate;
        });

        // Backfill tasks (this will also migrate team arrays)
        tasks = tasks.map(t => backfillTask(t));

      } catch (e) {
        console.error('Failed to load firm tasks:', e);
      }
    }

    async function checkPendingMembership(email) {
      if (!email) return null;
      try {
        // Search all firms for a pending member with this email
        const firmsSnap = await fbDb.collectionGroup('members')
          .where('email', '==', email.toLowerCase())
          .where('status', '==', 'pending')
          .limit(1)
          .get();

        if (!firmsSnap.empty) {
          const doc = firmsSnap.docs[0];
          const pathParts = doc.ref.path.split('/');
          const firmId = pathParts[1]; // firms/{firmId}/members/{memberId}
          return { firmId, memberId: doc.id, data: doc.data() };
        }
      } catch (e) {
        console.warn('Error checking pending membership:', e);
      }
      return null;
    }

    async function claimMembership(firmId, pendingMemberId) {
      try {
        const batch = fbDb.batch();

        // Get the pending member data
        const pendingRef = fbDb.collection('firms').doc(firmId)
          .collection('members').doc(pendingMemberId);
        const pendingDoc = await pendingRef.get();
        const pendingData = pendingDoc.data();

        // Create new member doc with real UID
        const newMemberRef = fbDb.collection('firms').doc(firmId)
          .collection('members').doc(currentUser.uid);
        batch.set(newMemberRef, {
          ...pendingData,
          email: currentUser.email,
          status: 'active',
          joinedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Delete pending placeholder
        batch.delete(pendingRef);

        // Link user to firm
        batch.set(fbDb.collection('users').doc(currentUser.uid), {
          firmId: firmId,
          email: currentUser.email
        }, { merge: true });

        await batch.commit();

        currentFirmId = firmId;
        toast('Welcome to the team!');
        await loadFirmData(firmId);

      } catch (e) {
        console.error('Failed to claim membership:', e);
        toast('Failed to join firm: ' + e.message);
      }
    }

    // Team management functions
    let bulkRowCounter = 0;

    function showTeamModal() {
      console.log('showTeamModal check:', {
        isAppAdmin: window.isAppAdmin,
        isAdminOverride: window.isAdminOverride,
        currentMemberIsAdmin: currentMember?.isAdmin,
        currentFirmId: currentFirmId,
        isInFirmMode: isInFirmMode()
      });
      const hasAdminAccess = window.isAppAdmin || window.isAdminOverride || currentMember?.isAdmin;
      console.log('hasAdminAccess:', hasAdminAccess);
      if (!isInFirmMode() || !hasAdminAccess) {
        console.log('BLOCKED - isInFirmMode:', isInFirmMode(), 'hasAdminAccess:', hasAdminAccess);
        toast('Admin access required');
        return;
      }
      document.getElementById('firmNameBadge').textContent = currentFirmData?.name || '';
      renderTeamList();

      // Initialize bulk add rows
      const container = document.getElementById('bulkMemberRows');
      container.innerHTML = '';
      bulkRowCounter = 0;
      for (let i = 0; i < 3; i++) {
        addBulkMemberRow();
      }

      showModal('teamModalBackdrop');
    }

    function addBulkMemberRow() {
      const container = document.getElementById('bulkMemberRows');
      const rowId = 'bulkRow_' + (bulkRowCounter++);

      const roleHierarchy = getRoleHierarchy();
      const supervisorOptions = firmMembers
        .filter(m => m.status === 'active')
        .sort((a, b) => (roleHierarchy[b.role] || 0) - (roleHierarchy[a.role] || 0))
        .map(m => `<option value="${m.uid}">${m.displayName} (${m.role})</option>`)
        .join('');

      // Generate role options from customRoles (sorted by level ascending for dropdown)
      const roleOptions = [...customRoles]
        .sort((a, b) => a.level - b.level)
        .map(r => `<option value="${r.name}">${r.name}</option>`)
        .join('');

      // Generate team options
      const teamOptions = masterTeamNames
        .map(t => `<option value="${t}">${t}</option>`)
        .join('');

      // Generate state options
      const stateOptions = AU_STATES
        .map(s => `<option value="${s.code}">${s.code}</option>`)
        .join('');

      const row = document.createElement('div');
      row.id = rowId;
      row.style.cssText = 'display:grid; grid-template-columns:1.5fr 1fr 100px 120px 100px 80px 50px 40px; gap:1px; background:var(--border);';
      row.innerHTML = `
        <div style="background:var(--bg); padding:4px;">
          <input type="email" placeholder="email@example.com" data-field="email" style="width:100%; height:31px; font-size:12px;" />
        </div>
        <div style="background:var(--bg); padding:4px;">
          <input type="text" placeholder="Display Name" data-field="name" style="width:100%; height:31px; font-size:12px;" />
        </div>
        <div style="background:var(--bg); padding:4px;">
          <select data-field="role" style="width:100%; height:31px; font-size:11px;">
            ${roleOptions}
          </select>
        </div>
        <div style="background:var(--bg); padding:4px;">
          <select data-field="reportsTo" style="width:100%; height:31px; font-size:11px;">
            <option value="">No Supervisor</option>
            ${supervisorOptions}
          </select>
        </div>
        <div style="background:var(--bg); padding:4px;">
          <select data-field="team" style="width:100%; height:31px; font-size:11px;">
            <option value="">No Team</option>
            ${teamOptions}
          </select>
        </div>
        <div style="background:var(--bg); padding:4px;">
          <select data-field="state" style="width:100%; height:31px; font-size:11px;">
            <option value="">State</option>
            ${stateOptions}
          </select>
        </div>
        <div style="background:var(--bg); padding:4px; display:flex; align-items:center; justify-content:center;">
          <label class="checkbox-wrap" style="margin:0;" title="Grant admin privileges">
            <input type="checkbox" data-field="isAdmin" />
            <span class="checkbox-box">‚úì</span>
          </label>
        </div>
        <div style="background:var(--bg); padding:4px; display:flex; align-items:center; justify-content:center;">
          <button type="button" class="mini btn-danger bulk-remove-btn" style="width:28px; height:28px; padding:0; font-size:14px;">√ó</button>
        </div>
      `;
      container.appendChild(row);

      // Attach event listener to remove button
      row.querySelector('.bulk-remove-btn').addEventListener('click', () => row.remove());
    }

    function removeBulkMemberRow(rowId) {
      const row = document.getElementById(rowId);
      if (row) row.remove();
    }
    window.addBulkMemberRow = addBulkMemberRow;
    window.removeBulkMemberRow = removeBulkMemberRow;

    function downloadTeamTemplate() {
      const roleNames = getRoleNames();
      const teamName = masterTeamNames.length > 0 ? masterTeamNames[0] : 'Tax';
      const data = [
        ['Email', 'Name', 'Role', 'Team', 'State', 'Admin'],
        ['example@email.com', 'John Smith', roleNames[0] || 'Partner', teamName, 'NSW', 'No'],
        ['', '', '', '', '', ''],
        ['', '', '', '', '', '']
      ];

      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Team Members');
      XLSX.writeFile(wb, 'Team_Template.xlsx');
    }
    window.downloadTeamTemplate = downloadTeamTemplate;

    function handleTeamExcelUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

          if (rows.length < 2) {
            toast('No data found in Excel file');
            return;
          }

          // Find column indices (case-insensitive)
          const header = rows[0].map(h => (h || '').toString().toLowerCase().trim());
          const emailIdx = header.findIndex(h => h.includes('email'));
          const nameIdx = header.findIndex(h => h.includes('name') && !h.includes('email') && !h.includes('team'));
          const roleIdx = header.findIndex(h => h.includes('role'));
          const teamIdx = header.findIndex(h => h.includes('team'));
          const stateIdx = header.findIndex(h => h.includes('state'));
          const adminIdx = header.findIndex(h => h.includes('admin'));

          if (emailIdx === -1) {
            toast('Excel must have an Email column');
            return;
          }

          // Clear existing rows
          document.getElementById('bulkMemberRows').innerHTML = '';

          // Add rows for each data row
          let addedCount = 0;
          for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const email = row[emailIdx] ? row[emailIdx].toString().trim() : '';
            const name = nameIdx !== -1 && row[nameIdx] ? row[nameIdx].toString().trim() : '';
            const role = roleIdx !== -1 && row[roleIdx] ? row[roleIdx].toString().trim() : '';
            const team = teamIdx !== -1 && row[teamIdx] ? row[teamIdx].toString().trim() : '';
            const state = stateIdx !== -1 && row[stateIdx] ? row[stateIdx].toString().toUpperCase().trim() : '';
            const adminValue = adminIdx !== -1 && row[adminIdx] ? row[adminIdx].toString().toLowerCase().trim() : '';
            const isAdmin = ['yes', 'true', '1', 'y'].includes(adminValue);

            if (email) {
              addBulkMemberRow();
              const lastRow = document.querySelector('[id^="bulkRow_"]:last-child');
              if (lastRow) {
                lastRow.querySelector('[data-field="email"]').value = email;
                if (name) lastRow.querySelector('[data-field="name"]').value = name;
                if (role) {
                  const roleSelect = lastRow.querySelector('[data-field="role"]');
                  const matchingOption = Array.from(roleSelect.options).find(
                    opt => opt.value.toLowerCase() === role.toLowerCase()
                  );
                  if (matchingOption) roleSelect.value = matchingOption.value;
                }
                if (team) {
                  const teamSelect = lastRow.querySelector('[data-field="team"]');
                  const matchingOption = Array.from(teamSelect.options).find(
                    opt => opt.value.toLowerCase() === team.toLowerCase()
                  );
                  if (matchingOption) teamSelect.value = matchingOption.value;
                }
                if (state) {
                  const stateSelect = lastRow.querySelector('[data-field="state"]');
                  const matchingOption = Array.from(stateSelect.options).find(
                    opt => opt.value.toUpperCase() === state
                  );
                  if (matchingOption) stateSelect.value = matchingOption.value;
                }
                lastRow.querySelector('[data-field="isAdmin"]').checked = isAdmin;
                addedCount++;
              }
            }
          }

          toast(addedCount + ' members loaded from Excel');
        } catch (err) {
          console.error('Excel parse error:', err);
          toast('Failed to parse Excel file');
        }
      };
      reader.readAsArrayBuffer(file);

      // Reset file input so same file can be uploaded again
      event.target.value = '';
    }
    window.handleTeamExcelUpload = handleTeamExcelUpload;

    async function saveBulkMembers() {
      const container = document.getElementById('bulkMemberRows');
      const rows = container.querySelectorAll('[id^="bulkRow_"]');

      const membersToAdd = [];
      rows.forEach(row => {
        const email = row.querySelector('[data-field="email"]').value.trim().toLowerCase();
        const name = row.querySelector('[data-field="name"]').value.trim();
        const role = row.querySelector('[data-field="role"]').value;
        const reportsTo = row.querySelector('[data-field="reportsTo"]').value || null;
        const team = row.querySelector('[data-field="team"]').value || null;
        const state = row.querySelector('[data-field="state"]').value || null;
        const isAdmin = row.querySelector('[data-field="isAdmin"]').checked;

        if (email && name) {
          // Check if already exists
          const existing = firmMembers.find(m => m.email === email);
          if (!existing) {
            membersToAdd.push({ email, name, role, reportsTo, team, state, isAdmin });
          }
        }
      });

      if (membersToAdd.length === 0) {
        toast('No valid members to add');
        return;
      }

      try {
        toast(`Adding ${membersToAdd.length} member(s)...`);

        const batch = fbDb.batch();
        membersToAdd.forEach(m => {
          const placeholderUid = 'pending_' + m.email.replace(/[^a-z0-9]/g, '_');
          const memberRef = fbDb.collection('firms').doc(currentFirmId)
            .collection('members').doc(placeholderUid);

          batch.set(memberRef, {
            email: m.email,
            displayName: m.name,
            role: m.role,
            isAdmin: m.isAdmin,
            reportsTo: m.reportsTo,
            team: m.team,
            state: m.state,
            status: 'pending',
            joinedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });

        await batch.commit();
        await loadFirmMembers();

        // Clear the input rows
        container.innerHTML = '';
        bulkRowCounter = 0;
        for (let i = 0; i < 3; i++) {
          addBulkMemberRow();
        }

        renderTeamList();
        renderTasks(); // Refresh task assignment dropdowns
        toast(`${membersToAdd.length} member(s) added successfully!`);
      } catch (e) {
        console.error('Failed to add members:', e);
        toast('Failed to add members: ' + e.message);
      }
    }
    window.saveBulkMembers = saveBulkMembers;

    function updateReportsToDropdown() {
      // Update all Reports To dropdowns in bulk rows
      const roleHierarchy = getRoleHierarchy();
      const selects = document.querySelectorAll('[data-field="reportsTo"]');
      const options = '<option value="">No Supervisor</option>' +
        firmMembers
          .filter(m => m.status === 'active')
          .sort((a, b) => (roleHierarchy[b.role] || 0) - (roleHierarchy[a.role] || 0))
          .map(m => `<option value="${m.uid}">${m.displayName} (${m.role})</option>`)
          .join('');

      selects.forEach(select => {
        const currentValue = select.value;
        select.innerHTML = options;
        select.value = currentValue;
      });
    }

    function renderTeamList() {
      const container = document.getElementById('teamMembersList');
      if (!container) return;

      if (firmMembers.length === 0) {
        container.innerHTML = '<div style="padding:16px; text-align:center; color:var(--muted);">No team members yet</div>';
        return;
      }

      const roleHierarchy = getRoleHierarchy();
      const sorted = [...firmMembers].sort((a, b) => {
        const roleA = roleHierarchy[a.role] || 0;
        const roleB = roleHierarchy[b.role] || 0;
        if (roleA !== roleB) return roleB - roleA;
        return (a.displayName || '').localeCompare(b.displayName || '');
      });

      container.innerHTML = sorted.map(m => {
        const supervisor = m.reportsTo ? firmMembers.find(s => s.uid === m.reportsTo) : null;
        const supervisorName = supervisor ? supervisor.displayName : '‚Äî';
        const statusBadge = m.status === 'pending'
          ? '<span style="background:#f59e0b; color:#000; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:8px;">Pending</span>'
          : '';
        const adminBadge = m.isAdmin
          ? '<span style="background:var(--teal); color:#fff; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:8px;">Admin</span>'
          : '';
        const isCurrentUser = m.uid === currentUser.uid;
        const leaveCount = (m.leave || []).filter(l => new Date(l.endDate) >= new Date()).length;
        const leaveBadge = leaveCount > 0 ? `<span style="background:var(--accent); color:#fff; padding:1px 5px; border-radius:10px; font-size:9px; margin-left:4px;">${leaveCount}</span>` : '';
        const youBadge = isCurrentUser ? '<span style="background:var(--accent); color:#fff; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:8px;">You</span>' : '';

        return `
          <div style="display:grid; grid-template-columns:1fr auto auto auto auto auto auto auto; gap:12px; padding:10px 12px; border-bottom:1px solid var(--border); align-items:center; font-size:13px;" data-member-uid="${m.uid}">
            <div>
              <span style="font-weight:600;">${m.displayName || m.email}</span>
              ${statusBadge}${adminBadge}${youBadge}
              <div style="font-size:11px; color:var(--muted);">${m.email}</div>
            </div>
            <div style="color:var(--muted);">${m.role}</div>
            <div style="color:var(--muted); font-size:11px;">${m.state || '‚Äî'}</div>
            <div style="color:var(--muted); font-size:11px;">‚Üí ${supervisorName}</div>
            <button class="mini member-edit-btn" data-uid="${m.uid}" style="font-size:11px; background:var(--teal); border-color:var(--teal);">
              Edit
            </button>
            <button class="mini member-leave-btn" data-uid="${m.uid}" style="font-size:11px; background:var(--panel-2);">
              Leave${leaveBadge}
            </button>
            <button class="mini member-admin-btn" data-uid="${m.uid}" ${isCurrentUser ? 'disabled title="Cannot modify your own admin status"' : ''} style="font-size:11px; ${isCurrentUser ? 'opacity:0.5; cursor:not-allowed;' : ''}">
              ${m.isAdmin ? 'Remove Admin' : 'Make Admin'}
            </button>
            <button class="mini btn-danger member-remove-btn" data-uid="${m.uid}" ${isCurrentUser ? 'disabled title="Cannot remove yourself from the firm"' : ''} style="font-size:11px; ${isCurrentUser ? 'opacity:0.5; cursor:not-allowed;' : ''}">
              Remove
            </button>
          </div>
        `;
      }).join('');

      // Attach event listeners after rendering
      const editButtons = container.querySelectorAll('.member-edit-btn');
      const leaveButtons = container.querySelectorAll('.member-leave-btn');
      const adminButtons = container.querySelectorAll('.member-admin-btn');
      const removeButtons = container.querySelectorAll('.member-remove-btn');

      editButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          openEditMember(btn.dataset.uid);
        });
      });
      leaveButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          openMemberLeave(btn.dataset.uid);
        });
      });
      adminButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          if (!btn.disabled) toggleMemberAdmin(btn.dataset.uid);
        });
      });
      removeButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('Remove button clicked for uid:', btn.dataset.uid, 'disabled:', btn.disabled);
          if (!btn.disabled) removeMember(btn.dataset.uid);
        });
      });
    }

    async function addTeamMember() {
      const email = document.getElementById('newMemberEmail').value.trim().toLowerCase();
      const displayName = document.getElementById('newMemberName').value.trim();
      const role = document.getElementById('newMemberRole').value;
      const reportsTo = document.getElementById('newMemberReportsTo').value || null;

      if (!email) {
        toast('Please enter an email');
        return;
      }
      if (!displayName) {
        toast('Please enter a display name');
        return;
      }

      // Check if email already exists
      const existing = firmMembers.find(m => m.email === email);
      if (existing) {
        toast('A member with this email already exists');
        return;
      }

      try {
        // Generate a placeholder UID
        const placeholderUid = 'pending_' + email.replace(/[^a-z0-9]/g, '_');

        await fbDb.collection('firms').doc(currentFirmId)
          .collection('members').doc(placeholderUid).set({
            email: email,
            displayName: displayName,
            role: role,
            isAdmin: false,
            reportsTo: reportsTo,
            status: 'pending',
            joinedAt: firebase.firestore.FieldValue.serverTimestamp()
          });

        await loadFirmMembers();
        renderTeamList();
        renderTasks(); // Refresh task assignment dropdowns

        // Clear form
        document.getElementById('newMemberEmail').value = '';
        document.getElementById('newMemberName').value = '';
        document.getElementById('newMemberRole').value = 'Graduate';
        document.getElementById('newMemberReportsTo').value = '';

        toast('Member added! They can sign up with ' + email);

      } catch (e) {
        console.error('Failed to add member:', e);
        toast('Failed to add member: ' + e.message);
      }
    }

    async function toggleMemberAdmin(uid) {
      console.log('toggleMemberAdmin called with uid:', uid);
      const member = firmMembers.find(m => m.uid === uid);
      console.log('Found member:', member);
      if (!member) {
        console.log('Member not found in firmMembers:', firmMembers);
        toast('Member not found');
        return;
      }

      // Prevent removing the last active admin (pending users don't count)
      if (member.isAdmin) {
        const activeAdminCount = firmMembers.filter(m => m.isAdmin && m.status !== 'pending').length;
        if (activeAdminCount <= 1) {
          toast('Cannot remove the last active admin. Promote another active member first.');
          return;
        }
      }

      try {
        console.log('Updating isAdmin from', member.isAdmin, 'to', !member.isAdmin);
        await fbDb.collection('firms').doc(currentFirmId)
          .collection('members').doc(uid)
          .update({ isAdmin: !member.isAdmin });

        await loadFirmMembers();
        renderTeamList();
        toast(member.isAdmin ? 'Admin removed' : 'Admin granted');

      } catch (e) {
        console.error('Failed to update member:', e);
        toast('Failed to update: ' + e.message);
      }
    }
    window.toggleMemberAdmin = toggleMemberAdmin;

    async function removeMember(uid) {
      if (uid === currentUser.uid) {
        toast('Cannot remove yourself');
        return;
      }

      if (!confirm('Remove this team member?')) return;

      try {
        await fbDb.collection('firms').doc(currentFirmId)
          .collection('members').doc(uid).delete();

        await loadFirmMembers();
        renderTeamList();
        renderTasks(); // Refresh task assignment dropdowns
        toast('Member removed');

      } catch (e) {
        console.error('Failed to remove member:', e);
        toast('Failed to remove: ' + e.message);
      }
    }
    window.removeMember = removeMember;

    // ===== Edit Member Functions =====

    function openEditMember(uid) {
      const member = firmMembers.find(m => m.uid === uid);
      if (!member) {
        toast('Member not found');
        return;
      }

      // Store UID
      document.getElementById('editMemberUid').value = uid;
      document.getElementById('editMemberEmail').value = member.email || '';
      document.getElementById('editMemberName').value = member.displayName || '';

      // Populate role dropdown
      const roleSelect = document.getElementById('editMemberRole');
      const roleNames = getRoleNames();
      roleSelect.innerHTML = roleNames.map(r => `<option value="${r}">${r}</option>`).join('');
      roleSelect.value = member.role || roleNames[0];

      // Populate reports to dropdown (exclude self)
      const reportsToSelect = document.getElementById('editMemberReportsTo');
      const otherMembers = firmMembers.filter(m => m.uid !== uid);
      reportsToSelect.innerHTML = '<option value="">No Supervisor</option>' +
        otherMembers.map(m => `<option value="${m.uid}">${m.displayName || m.email}</option>`).join('');
      reportsToSelect.value = member.reportsTo || '';

      // Populate team dropdown
      const teamSelect = document.getElementById('editMemberTeam');
      teamSelect.innerHTML = '<option value="">No Team</option>' +
        masterTeamNames.map(t => `<option value="${t}">${t}</option>`).join('');
      teamSelect.value = member.team || '';

      // Populate state dropdown
      const stateSelect = document.getElementById('editMemberState');
      stateSelect.innerHTML = '<option value="">Select State</option>' +
        AU_STATES.map(s => `<option value="${s.code}">${s.name}</option>`).join('');
      stateSelect.value = member.state || '';

      // Set admin checkbox
      document.getElementById('editMemberIsAdmin').checked = member.isAdmin || false;

      // Setup delete button
      const deleteBtn = document.getElementById('editMemberDeleteBtn');
      const isCurrentUser = uid === currentUser.uid;
      if (isCurrentUser) {
        deleteBtn.disabled = true;
        deleteBtn.title = 'Cannot remove yourself';
        deleteBtn.style.opacity = '0.5';
      } else {
        deleteBtn.disabled = false;
        deleteBtn.title = '';
        deleteBtn.style.opacity = '1';
        deleteBtn.onclick = () => {
          if (confirm('Remove this team member?')) {
            removeMember(uid);
            hideModal('editMemberModalBackdrop');
          }
        };
      }

      document.getElementById('editMemberModalBackdrop').style.display = 'flex';
    }
    window.openEditMember = openEditMember;

    async function saveEditMember() {
      const uid = document.getElementById('editMemberUid').value;
      const displayName = document.getElementById('editMemberName').value.trim();
      const role = document.getElementById('editMemberRole').value;
      const reportsTo = document.getElementById('editMemberReportsTo').value || null;
      const team = document.getElementById('editMemberTeam').value || null;
      const state = document.getElementById('editMemberState').value || null;
      const isAdmin = document.getElementById('editMemberIsAdmin').checked;

      if (!displayName) {
        toast('Display name is required');
        return;
      }

      const member = firmMembers.find(m => m.uid === uid);
      if (!member) {
        toast('Member not found');
        return;
      }

      // Check if removing admin status from last active admin
      if (member.isAdmin && !isAdmin) {
        const activeAdminCount = firmMembers.filter(m => m.isAdmin && m.status !== 'pending').length;
        if (activeAdminCount <= 1) {
          toast('Cannot remove the last active admin. Promote another active member first.');
          return;
        }
      }

      try {
        await fbDb.collection('firms').doc(currentFirmId)
          .collection('members').doc(uid)
          .update({
            displayName,
            role,
            reportsTo,
            team,
            state,
            isAdmin
          });

        await loadFirmMembers();
        renderTeamList();
        renderTasks(); // Refresh task assignment dropdowns
        hideModal('editMemberModalBackdrop');
        toast('Member updated');

      } catch (e) {
        console.error('Failed to update member:', e);
        toast('Failed to update: ' + e.message);
      }
    }
    window.saveEditMember = saveEditMember;

    // ===== Role Management Functions =====

    function showRolesModal() {
      const hasAdminAccess = window.isAppAdmin || window.isAdminOverride || currentMember?.isAdmin;
      if (!isInFirmMode() || !hasAdminAccess) {
        toast('Only firm admins can manage roles');
        return;
      }
      renderRolesList();
      document.getElementById('rolesModalBackdrop').style.display = 'flex';
    }

    // Store sorted roles for reference by index
    let sortedRolesCache = [];
    let draggedRoleIdx = null;

    function renderRolesList() {
      const container = document.getElementById('rolesListContainer');
      if (!container) return;

      // Sort roles by level descending (highest first) and cache for reference
      sortedRolesCache = [...customRoles].sort((a, b) => b.level - a.level);

      container.innerHTML = sortedRolesCache.map((role, idx) => {
        const isNewRole = role.isNew || role.name.startsWith('_new_');
        const displayName = isNewRole ? '' : role.name;
        const escapedName = displayName.replace(/'/g, "\\'").replace(/"/g, '&quot;');

        return `
        <div class="role-row" draggable="true" data-role-idx="${idx}"
          style="display:grid; grid-template-columns:36px 1fr 80px 80px 80px 40px; gap:1px; background:var(--border); cursor:grab;"
          ondragstart="onRoleDragStart(event, ${idx})"
          ondragover="onRoleDragOver(event, ${idx})"
          ondragend="onRoleDragEnd(event)"
          ondrop="onRoleDrop(event, ${idx})">
          <div style="background:var(--bg); padding:8px 6px; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:16px; cursor:grab;" title="Drag to reorder">‚ãÆ‚ãÆ</div>
          <div style="background:var(--bg); padding:8px 12px; display:flex; align-items:center;">
            <input type="text" value="${escapedName}" data-role-idx="${idx}" placeholder="Add Role"
              onchange="updateRoleNameByIdx(${idx}, this.value)"
              style="flex:1; height:28px; background:transparent; border:1px solid var(--border); border-radius:4px; color:var(--text); padding:0 8px;" />
          </div>
          <div style="background:var(--bg); padding:8px 12px; text-align:center;">
            <input type="checkbox" ${role.canManageTeam ? 'checked' : ''}
              onchange="updateRoleFieldByIdx(${idx}, 'canManageTeam', this.checked)"
              style="width:18px; height:18px; cursor:pointer;" />
          </div>
          <div style="background:var(--bg); padding:8px 12px; text-align:center;">
            <input type="checkbox" ${role.canSeeAll ? 'checked' : ''}
              onchange="updateRoleFieldByIdx(${idx}, 'canSeeAll', this.checked)"
              style="width:18px; height:18px; cursor:pointer;" />
          </div>
          <div style="background:var(--bg); padding:8px 12px; text-align:center;">
            <input type="checkbox" ${role.canAssign ? 'checked' : ''}
              onchange="updateRoleFieldByIdx(${idx}, 'canAssign', this.checked)"
              style="width:18px; height:18px; cursor:pointer;" />
          </div>
          <div style="background:var(--bg); padding:8px 12px; text-align:center;">
            <button type="button" onclick="deleteRoleByIdx(${idx})"
              style="width:28px; height:28px; padding:0; background:transparent; border:1px solid var(--danger); color:var(--danger); border-radius:4px; cursor:pointer; font-size:14px;"
              title="Delete Role">√ó</button>
          </div>
        </div>
      `}).join('');
    }

    function onRoleDragStart(e, idx) {
      draggedRoleIdx = idx;
      e.target.style.opacity = '0.5';
      e.dataTransfer.effectAllowed = 'move';
    }

    function onRoleDragOver(e, idx) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      // Add visual indicator
      const rows = document.querySelectorAll('.role-row');
      rows.forEach(r => r.style.borderTop = '');
      if (draggedRoleIdx !== idx) {
        e.target.closest('.role-row').style.borderTop = '2px solid var(--teal)';
      }
    }

    function onRoleDragEnd(e) {
      e.target.style.opacity = '1';
      document.querySelectorAll('.role-row').forEach(r => r.style.borderTop = '');
      draggedRoleIdx = null;
    }

    function onRoleDrop(e, targetIdx) {
      e.preventDefault();
      if (draggedRoleIdx === null || draggedRoleIdx === targetIdx) return;

      // Get the roles being moved
      const draggedRole = sortedRolesCache[draggedRoleIdx];
      const targetRole = sortedRolesCache[targetIdx];

      if (!draggedRole || !targetRole) return;

      // Find them in customRoles and swap levels
      const draggedInCustom = customRoles.find(r => r.name === draggedRole.name);
      const targetInCustom = customRoles.find(r => r.name === targetRole.name);

      if (draggedInCustom && targetInCustom) {
        // If dragging up (to higher position), give it the target's level and shift others down
        // If dragging down (to lower position), give it the target's level and shift others up
        const tempLevel = draggedInCustom.level;
        draggedInCustom.level = targetInCustom.level;
        targetInCustom.level = tempLevel;

        normalizeRoleLevels();
        renderRolesList();
        saveRolesToFirestore();
      }

      draggedRoleIdx = null;
    }

    function refreshRolesList() {
      normalizeRoleLevels();
      renderRolesList();
      saveRolesToFirestore();
      toast('Roles refreshed');
    }

    function moveRoleByIdx(idx, direction) {
      // direction: -1 = up, 1 = down
      if (!sortedRolesCache || sortedRolesCache.length === 0) return;

      const targetIdx = idx + direction;
      if (targetIdx < 0 || targetIdx >= sortedRolesCache.length) return;

      // Get the actual role objects from customRoles
      const currentRoleName = sortedRolesCache[idx].name;
      const targetRoleName = sortedRolesCache[targetIdx].name;

      const currentRole = customRoles.find(r => r.name === currentRoleName);
      const targetRole = customRoles.find(r => r.name === targetRoleName);

      if (!currentRole || !targetRole) return;

      // Swap levels
      const tempLevel = currentRole.level;
      currentRole.level = targetRole.level;
      targetRole.level = tempLevel;

      renderRolesList();
      saveRolesToFirestore();
    }

    function updateRoleNameByIdx(idx, newName) {
      if (!sortedRolesCache || idx < 0 || idx >= sortedRolesCache.length) return;
      const oldName = sortedRolesCache[idx].name;
      updateRoleName(oldName, newName);
    }

    function updateRoleFieldByIdx(idx, field, value) {
      if (!sortedRolesCache || idx < 0 || idx >= sortedRolesCache.length) return;
      const roleName = sortedRolesCache[idx].name;
      updateRoleField(roleName, field, value);
    }

    function deleteRoleByIdx(idx) {
      if (!sortedRolesCache || idx < 0 || idx >= sortedRolesCache.length) return;
      const roleName = sortedRolesCache[idx].name;
      deleteRole(roleName);
    }

    function normalizeRoleLevels() {
      // Assign sequential levels based on current order
      const sorted = [...customRoles].sort((a, b) => b.level - a.level);
      sorted.forEach((role, idx) => {
        role.level = sorted.length - idx;
      });
    }

    function addRoleRow() {
      // Generate unique temporary ID for unnamed roles
      let tempId = '_new_' + Date.now();

      // Add at bottom with level 0, then normalize all levels
      customRoles.push({
        name: tempId,
        level: 0,
        canManageTeam: false,
        canSeeAll: false,
        canAssign: false,
        isNew: true  // Flag for placeholder display
      });

      normalizeRoleLevels();
      renderRolesList();
      // Don't save until user enters a name
      toast('Enter role name');
    }

    function updateRoleName(oldName, newName) {
      newName = newName.trim();
      if (!newName) {
        toast('Role name cannot be empty');
        renderRolesList();
        return;
      }

      // Check if new name conflicts with existing (non-new) roles
      const isNewRole = oldName.startsWith('_new_');
      if (customRoles.some(r => r.name === newName && r.name !== oldName && !r.name.startsWith('_new_'))) {
        toast('Role name already exists');
        renderRolesList();
        return;
      }

      const role = customRoles.find(r => r.name === oldName);
      if (role) {
        role.name = newName;
        delete role.isNew;  // Clear the new flag
        renderRolesList();  // Re-render to update cache
        saveRolesToFirestore();

        // Update any team members using this role (only for non-new roles)
        if (!isNewRole) {
          updateMembersWithRole(oldName, newName);
        }
        toast('Role saved');
      }
    }

    function updateRoleField(roleName, field, value) {
      const role = customRoles.find(r => r.name === roleName);
      if (role) {
        role[field] = value;
        saveRolesToFirestore();
      }
    }

    function deleteRole(roleName) {
      // Check if any members have this role
      const membersWithRole = firmMembers.filter(m => m.role === roleName);
      if (membersWithRole.length > 0) {
        toast('Cannot delete: ' + membersWithRole.length + ' member(s) have this role');
        return;
      }

      if (customRoles.length <= 1) {
        toast('Must have at least one role');
        return;
      }

      customRoles = customRoles.filter(r => r.name !== roleName);
      normalizeRoleLevels();
      renderRolesList();
      saveRolesToFirestore();
    }

    async function saveRolesToFirestore() {
      if (!isInFirmMode()) return;

      try {
        await fbDb.collection('firms').doc(currentFirmId).update({
          'settings.roles': customRoles
        });
      } catch (e) {
        console.error('Failed to save roles:', e);
        toast('Failed to save roles');
      }
    }

    async function loadRolesFromFirestore() {
      if (!isInFirmMode() || !currentFirmData) return;

      const roles = currentFirmData.settings?.roles;
      if (roles && Array.isArray(roles) && roles.length > 0) {
        customRoles = roles;
      } else {
        // Use defaults if no custom roles saved
        customRoles = [...DEFAULT_ROLES];
      }
    }

    async function updateMembersWithRole(oldName, newName) {
      // Update any team members who have the old role name
      const membersToUpdate = firmMembers.filter(m => m.role === oldName);

      for (const member of membersToUpdate) {
        try {
          await fbDb.collection('firms').doc(currentFirmId)
            .collection('members').doc(member.uid).update({ role: newName });
        } catch (e) {
          console.error('Failed to update member role:', e);
        }
      }

      if (membersToUpdate.length > 0) {
        await loadFirmMembers();
        renderTasks(); // Refresh task assignment dropdowns
      }
    }

    // ===== Holidays Management Functions =====

    function showHolidaysModal() {
      const hasAdminAccess = window.isAppAdmin || window.isAdminOverride || currentMember?.isAdmin;
      if (!isInFirmMode() || !hasAdminAccess) {
        toast('Only firm admins can manage holidays');
        return;
      }
      loadFirmHolidays();
      document.getElementById('holidaysModalBackdrop').style.display = 'flex';
    }

    // Quiet version - loads holidays without updating UI (for initial firm load)
    async function loadFirmHolidaysQuiet() {
      if (!currentFirmId) return;

      try {
        const settings = currentFirmData?.settings || {};
        const stateCode = settings.state || 'NSW';
        const customDays = settings.blockedDays || [];

        // Generate public holidays for current and next year
        const currentYear = new Date().getFullYear();
        const publicHolidays = [
          ...getAustralianPublicHolidays(currentYear, stateCode),
          ...getAustralianPublicHolidays(currentYear + 1, stateCode)
        ];

        // Merge into firmHolidays
        firmHolidays = [
          ...publicHolidays.map(h => ({ ...h, enabled: true })),
          ...customDays.map(d => ({ ...d, type: 'firm' }))
        ];
      } catch (e) {
        console.error('Failed to load firm holidays:', e);
      }
    }

    async function loadFirmHolidays() {
      if (!currentFirmId) return;

      try {
        const firmDoc = await fbDb.collection('firms').doc(currentFirmId).get();
        const data = firmDoc.data() || {};
        const settings = data.settings || {};

        // Get configured state, default to NSW
        const stateCode = settings.state || 'NSW';
        document.getElementById('firmStateSelect').value = stateCode;

        // Get custom blocked days
        const customDays = settings.blockedDays || [];

        // Generate public holidays for current and next year
        const currentYear = new Date().getFullYear();
        const publicHolidays = [
          ...getAustralianPublicHolidays(currentYear, stateCode),
          ...getAustralianPublicHolidays(currentYear + 1, stateCode)
        ];

        // Merge into firmHolidays
        firmHolidays = [
          ...publicHolidays.map(h => ({ ...h, enabled: true })),
          ...customDays.map(d => ({ ...d, type: 'firm' }))
        ];

        renderHolidaysList();
      } catch (e) {
        console.error('Failed to load firm holidays:', e);
        toast('Failed to load holidays');
      }
    }

    function renderHolidaysList() {
      const container = document.getElementById('holidaysListContainer');
      if (!container) return;

      // Separate public and custom
      const publicHols = firmHolidays.filter(h => h.type === 'public' || h.type === 'national' || h.type === 'state');
      const customDays = firmHolidays.filter(h => h.type === 'firm');

      // Sort by date
      publicHols.sort((a, b) => a.date.localeCompare(b.date));
      customDays.sort((a, b) => a.date.localeCompare(b.date));

      const formatDate = (d) => {
        const date = new Date(d + 'T00:00:00');
        return date.toLocaleDateString('en-AU', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
      };

      container.innerHTML = `
        <div style="margin-bottom:20px;">
          <h4 style="color:var(--teal); margin-bottom:10px; font-size:14px;">Public Holidays</h4>
          <div style="max-height:200px; overflow-y:auto; background:var(--panel-2); border-radius:8px; padding:8px;">
            ${publicHols.length === 0 ? '<div style="color:var(--muted); padding:8px;">No public holidays configured</div>' :
              publicHols.map(h => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid var(--border);">
                  <span style="color:var(--text);">${escapeHtml(h.name)}</span>
                  <span style="color:var(--muted); font-size:12px;">${formatDate(h.date)}</span>
                </div>
              `).join('')}
          </div>
        </div>

        <div>
          <h4 style="color:var(--teal); margin-bottom:10px; font-size:14px;">Custom Blocked Days</h4>
          <div style="background:var(--panel-2); border-radius:8px; padding:8px;">
            ${customDays.length === 0 ? '<div style="color:var(--muted); padding:8px;">No custom blocked days</div>' :
              customDays.map((d, idx) => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid var(--border);">
                  <span style="color:var(--text);">${escapeHtml(d.name)}</span>
                  <div style="display:flex; align-items:center; gap:10px;">
                    <span style="color:var(--muted); font-size:12px;">${formatDate(d.date)}</span>
                    <button type="button" onclick="removeCustomBlockedDay('${d.date}')"
                      style="width:24px; height:24px; padding:0; background:transparent; border:1px solid var(--danger); color:var(--danger); border-radius:4px; cursor:pointer; font-size:12px;"
                      title="Remove">√ó</button>
                  </div>
                </div>
              `).join('')}
          </div>
        </div>
      `;
    }
    window.renderHolidaysList = renderHolidaysList;

    async function updateFirmState() {
      const stateCode = document.getElementById('firmStateSelect').value;

      try {
        await fbDb.collection('firms').doc(currentFirmId).set({
          settings: { state: stateCode }
        }, { merge: true });

        await loadFirmHolidays();
        toast('State updated');
      } catch (e) {
        console.error('Failed to update state:', e);
        toast('Failed to update state');
      }
    }
    window.updateFirmState = updateFirmState;

    async function addCustomBlockedDay() {
      const dateInput = document.getElementById('newBlockedDate');
      const nameInput = document.getElementById('newBlockedName');

      const date = dateInput.value;
      const name = nameInput.value.trim();

      if (!date) {
        toast('Please select a date');
        return;
      }
      if (!name) {
        toast('Please enter a name');
        return;
      }

      try {
        const firmRef = fbDb.collection('firms').doc(currentFirmId);
        const firmDoc = await firmRef.get();
        const settings = firmDoc.data()?.settings || {};
        const blockedDays = settings.blockedDays || [];

        // Check for duplicate
        if (blockedDays.some(d => d.date === date)) {
          toast('This date is already blocked');
          return;
        }

        blockedDays.push({ date, name, type: 'firm' });

        await firmRef.set({ settings: { blockedDays } }, { merge: true });

        dateInput.value = '';
        nameInput.value = '';

        await loadFirmHolidays();
        toast('Blocked day added');
      } catch (e) {
        console.error('Failed to add blocked day:', e);
        toast('Failed to add blocked day');
      }
    }
    window.addCustomBlockedDay = addCustomBlockedDay;

    async function removeCustomBlockedDay(date) {
      try {
        const firmRef = fbDb.collection('firms').doc(currentFirmId);
        const firmDoc = await firmRef.get();
        const settings = firmDoc.data()?.settings || {};
        let blockedDays = settings.blockedDays || [];

        blockedDays = blockedDays.filter(d => d.date !== date);

        await firmRef.set({ settings: { blockedDays } }, { merge: true });

        await loadFirmHolidays();
        toast('Blocked day removed');
      } catch (e) {
        console.error('Failed to remove blocked day:', e);
        toast('Failed to remove blocked day');
      }
    }
    window.removeCustomBlockedDay = removeCustomBlockedDay;

    // Check if a date is a holiday or blocked day (firm-wide)
    function isHolidayOrBlocked(dateStr) {
      return firmHolidays.some(h => h.date === dateStr);
    }

    // Check if a date is a holiday for a specific member (uses their state)
    function isHolidayForMember(dateStr, memberUid) {
      // Always check firm-level custom blocked days
      const firmBlocked = firmHolidays.some(h => h.date === dateStr && h.type === 'firm');
      if (firmBlocked) return true;

      // Get member's state for public holidays
      const member = firmMembers.find(m => m.uid === memberUid);
      const memberState = member?.state;

      if (!memberState) {
        // Fall back to firm-wide holidays if member has no state set
        return firmHolidays.some(h => h.date === dateStr);
      }

      // Check if date is a public holiday in member's state
      const year = parseInt(dateStr.substring(0, 4));
      const memberHolidays = getAustralianPublicHolidays(year, memberState);
      return memberHolidays.some(h => h.date === dateStr);
    }

    function getHolidayName(dateStr) {
      const holiday = firmHolidays.find(h => h.date === dateStr);
      return holiday ? holiday.name : null;
    }

    function getHolidayNameForMember(dateStr, memberUid) {
      // Check firm blocked days first
      const firmHoliday = firmHolidays.find(h => h.date === dateStr && h.type === 'firm');
      if (firmHoliday) return firmHoliday.name;

      // Get member's state for public holidays
      const member = firmMembers.find(m => m.uid === memberUid);
      const memberState = member?.state;

      if (!memberState) {
        const holiday = firmHolidays.find(h => h.date === dateStr);
        return holiday ? holiday.name : null;
      }

      // Check member's state holidays
      const year = parseInt(dateStr.substring(0, 4));
      const memberHolidays = getAustralianPublicHolidays(year, memberState);
      const holiday = memberHolidays.find(h => h.date === dateStr);
      return holiday ? holiday.name : null;
    }

    // ===== User Leave Management =====

    let currentLeaveMemberUid = null;

    function openMemberLeave(uid) {
      const member = firmMembers.find(m => m.uid === uid);
      if (!member) return;

      currentLeaveMemberUid = uid;
      document.getElementById('leaveMemberName').textContent = member.displayName || member.email;
      renderLeaveList();
      document.getElementById('leaveModalBackdrop').style.display = 'flex';
    }
    window.openMemberLeave = openMemberLeave;

    function renderLeaveList() {
      const container = document.getElementById('leaveListContainer');
      if (!container || !currentLeaveMemberUid) return;

      const member = firmMembers.find(m => m.uid === currentLeaveMemberUid);
      const leave = member?.leave || [];

      // Sort by start date
      const sorted = [...leave].sort((a, b) => a.startDate.localeCompare(b.startDate));

      const formatDate = (d) => {
        const date = new Date(d + 'T00:00:00');
        return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' });
      };

      const today = new Date().toISOString().split('T')[0];

      container.innerHTML = sorted.length === 0
        ? '<div style="padding:16px; text-align:center; color:var(--muted);">No leave scheduled</div>'
        : sorted.map((l, idx) => {
          const isPast = l.endDate < today;
          const isCurrent = l.startDate <= today && l.endDate >= today;
          const statusStyle = isPast ? 'opacity:0.5;' : (isCurrent ? 'background:rgba(20,184,166,0.1);' : '');
          const statusLabel = isPast ? ' (Past)' : (isCurrent ? ' (Current)' : '');

          return `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid var(--border); ${statusStyle}">
              <div>
                <div style="font-weight:600; color:var(--text);">${escapeHtml(l.type || 'Leave')}${statusLabel}</div>
                <div style="font-size:12px; color:var(--muted);">${formatDate(l.startDate)} - ${formatDate(l.endDate)}</div>
                ${l.notes ? `<div style="font-size:11px; color:var(--muted); margin-top:2px;">${escapeHtml(l.notes)}</div>` : ''}
              </div>
              <button type="button" onclick="removeMemberLeave(${idx})"
                style="width:28px; height:28px; padding:0; background:transparent; border:1px solid var(--danger); color:var(--danger); border-radius:4px; cursor:pointer; font-size:14px;"
                title="Remove">√ó</button>
            </div>
          `;
        }).join('');
    }
    window.renderLeaveList = renderLeaveList;

    async function addMemberLeave() {
      if (!currentLeaveMemberUid) return;

      const startDate = document.getElementById('leaveStartDate').value;
      const endDate = document.getElementById('leaveEndDate').value;
      const type = document.getElementById('leaveType').value;
      const notes = document.getElementById('leaveNotes').value.trim();

      if (!startDate || !endDate) {
        toast('Please select start and end dates');
        return;
      }

      if (endDate < startDate) {
        toast('End date must be after start date');
        return;
      }

      try {
        const memberRef = fbDb.collection('firms').doc(currentFirmId)
          .collection('members').doc(currentLeaveMemberUid);

        const memberDoc = await memberRef.get();
        const leave = memberDoc.data()?.leave || [];

        leave.push({
          startDate,
          endDate,
          type,
          notes,
          addedAt: new Date().toISOString()
        });

        await memberRef.update({ leave });

        // Refresh member data
        await loadFirmMembers();
        renderLeaveList();
        renderTeamList();

        // Clear form
        document.getElementById('leaveStartDate').value = '';
        document.getElementById('leaveEndDate').value = '';
        document.getElementById('leaveType').value = 'Annual Leave';
        document.getElementById('leaveNotes').value = '';

        toast('Leave added');
      } catch (e) {
        console.error('Failed to add leave:', e);
        toast('Failed to add leave');
      }
    }
    window.addMemberLeave = addMemberLeave;

    async function removeMemberLeave(idx) {
      if (!currentLeaveMemberUid) return;

      try {
        const memberRef = fbDb.collection('firms').doc(currentFirmId)
          .collection('members').doc(currentLeaveMemberUid);

        const memberDoc = await memberRef.get();
        let leave = memberDoc.data()?.leave || [];

        leave.splice(idx, 1);

        await memberRef.update({ leave });

        await loadFirmMembers();
        renderLeaveList();
        renderTeamList();

        toast('Leave removed');
      } catch (e) {
        console.error('Failed to remove leave:', e);
        toast('Failed to remove leave');
      }
    }
    window.removeMemberLeave = removeMemberLeave;

    // Check if a member is on leave for a specific date
    function isMemberOnLeave(memberUid, dateStr) {
      const member = firmMembers.find(m => m.uid === memberUid);
      if (!member || !member.leave) return false;

      return member.leave.some(l => dateStr >= l.startDate && dateStr <= l.endDate);
    }

    function getMemberLeaveType(memberUid, dateStr) {
      const member = firmMembers.find(m => m.uid === memberUid);
      if (!member || !member.leave) return null;

      const leave = member.leave.find(l => dateStr >= l.startDate && dateStr <= l.endDate);
      return leave ? leave.type : null;
    }

    async function createFirmClient(name) {
      if (!isInFirmMode()) {
        // In solo mode, just add to masterClients
        if (!masterClients.includes(name)) {
          masterClients.push(name);
          masterClients.sort();
          saveMasterLists();
        }
        return { clientCode: null, name };
      }

      const firmRef = fbDb.collection('firms').doc(currentFirmId);

      return fbDb.runTransaction(async (transaction) => {
        const firmDoc = await transaction.get(firmRef);
        const firm = firmDoc.data();

        const nextNum = (firm.clientIdCounter || 0) + 1;
        const clientCode = firm.clientIdPrefix + String(nextNum).padStart(3, '0');

        transaction.update(firmRef, { clientIdCounter: nextNum });

        const clientRef = firmRef.collection('clients').doc();
        transaction.set(clientRef, {
          clientCode: clientCode,
          name: name,
          isActive: true,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: currentUser.uid
        });

        return { id: clientRef.id, clientCode, name };
      });
    }

    // ===== Schedule Modal =====
    let currentScheduleTaskIndex = null;
    let openedFromGantt = false;
    let scheduleFilterMemberUid = null; // null = show all, or specific uid
    let schedGridDateFrom = null;
    let schedGridDateTo = null;

    function openScheduleModal(taskIndex) {
      openedFromGantt = false;
      currentScheduleTaskIndex = taskIndex;
      scheduleFilterMemberUid = null;
      const task = tasks[taskIndex];
      const taskName = task.description || 'Untitled';
      const clientName = task.client || 'No Client';
      document.getElementById('schedTaskName').textContent = `${taskName} - ${clientName}`;

      // Set default date range (2 weeks from today)
      const today = new Date();
      const twoWeeksLater = new Date();
      twoWeeksLater.setDate(today.getDate() + 13);

      schedGridDateFrom = today;
      schedGridDateTo = twoWeeksLater;

      document.getElementById('schedGridDateFrom').value = formatDateLocal(today);
      document.getElementById('schedGridDateTo').value = formatDateLocal(twoWeeksLater);
      document.getElementById('schedNewDate').value = formatDateLocal(today);

      renderScheduleGrid();
      showModal('scheduleModalBackdrop');
    }

    function openScheduleModalFromGantt(taskIndex) {
      openedFromGantt = true;
      currentScheduleTaskIndex = taskIndex;
      scheduleFilterMemberUid = null;
      const task = tasks[taskIndex];
      const taskName = task.description || 'Untitled';
      const clientName = task.client || 'No Client';
      document.getElementById('schedTaskName').textContent = `${taskName} - ${clientName}`;

      // Set default date range (2 weeks from today)
      const today = new Date();
      const twoWeeksLater = new Date();
      twoWeeksLater.setDate(today.getDate() + 13);

      schedGridDateFrom = today;
      schedGridDateTo = twoWeeksLater;

      document.getElementById('schedGridDateFrom').value = formatDateLocal(today);
      document.getElementById('schedGridDateTo').value = formatDateLocal(twoWeeksLater);
      document.getElementById('schedNewDate').value = formatDateLocal(today);

      renderScheduleGrid();
      showModal('scheduleModalBackdrop');
    }

    function updateScheduleGridDateRange() {
      const fromVal = document.getElementById('schedGridDateFrom').value;
      const toVal = document.getElementById('schedGridDateTo').value;
      if (fromVal) schedGridDateFrom = new Date(fromVal);
      if (toVal) schedGridDateTo = new Date(toVal);
      renderScheduleGrid();
    }

    function renderScheduleGrid() {
      const task = tasks[currentScheduleTaskIndex];
      const team = task.team || [];
      const schedules = task.schedules || [];
      const container = document.getElementById('scheduleGridContainer');
      const legacyView = document.getElementById('scheduleLegacyView');
      const weekdaysOnly = document.getElementById('schedGridWeekdaysOnly').checked;

      // If no team or solo mode, show legacy view
      if (!isInFirmMode() || team.length === 0) {
        container.style.display = 'none';
        legacyView.style.display = 'block';
        renderScheduleList();
        return;
      }

      container.style.display = 'block';
      legacyView.style.display = 'none';

      // Generate dates in range
      const dates = [];
      const current = new Date(schedGridDateFrom);
      while (current <= schedGridDateTo) {
        const dayOfWeek = current.getDay();
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
        if (!weekdaysOnly || !isWeekend) {
          dates.push(new Date(current));
        }
        current.setDate(current.getDate() + 1);
      }

      if (dates.length === 0) {
        container.innerHTML = '<div class="subtle" style="text-align:center; padding:40px;">No dates in selected range</div>';
        return;
      }

      // Build schedule lookup: { "date|memberUid": schedule }
      const schedLookup = {};
      schedules.forEach(s => {
        const key = `${s.date}|${s.memberUid || ''}`;
        schedLookup[key] = s;
      });

      // Fixed column widths (compact)
      const memberColWidth = 42;
      const dateColWidth = 40;
      const totalColWidth = 24;

      // Build grid HTML
      let html = `<div style="overflow-x:auto; overflow-y:auto; max-height:60vh;">
        <table style="border-collapse:collapse; font-size:11px; table-layout:fixed;">
          <thead style="position:sticky; top:0; z-index:3;">
            <tr style="background:var(--panel);">
              <th style="padding:2px 2px; text-align:left; border:1px solid var(--border); position:sticky; left:0; background:var(--panel); z-index:4; width:${dateColWidth}px; font-size:8px;"></th>
              ${team.map(m => {
                const name = getMemberDisplayName(m.uid);
                const shortName = name.split(' ')[0].substring(0, 5);
                const isPending = isMemberPending(m.uid);
                const roleAbbrev = (m.jobRole || '').substring(0, 4);
                return `<th class="sched-member-header" data-member-uid="${m.uid}" style="padding:2px 1px; text-align:center; border:1px solid var(--border); width:${memberColWidth}px; cursor:pointer; background:var(--panel);" title="Click to add/edit hours for ${escapeHtml(name)} (${m.jobRole})">
                  <div style="font-weight:600; font-size:8px; color:var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(shortName)}</div>
                  <div style="font-size:7px; color:var(--muted); font-weight:400;">${escapeHtml(roleAbbrev)}${isPending ? '*' : ''}</div>
                </th>`;
              }).join('')}
              <th style="padding:2px 1px; text-align:center; border:1px solid var(--border); width:${totalColWidth}px; background:var(--panel-2); font-size:7px;">Tot</th>
            </tr>
          </thead>
          <tbody>`;

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      dates.forEach(date => {
        const dateStr = formatDateLocal(date);
        const dayOfWeek = date.getDay();
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
        const isToday = date.getTime() === today.getTime();
        const dayName = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][dayOfWeek];
        const monthDay = `${date.getDate()}/${date.getMonth() + 1}`;

        let rowTotal = 0;

        html += `<tr style="background:${isToday ? 'rgba(20,184,166,0.1)' : isWeekend ? 'var(--panel-2)' : 'var(--bg)'};">
          <td style="padding:1px 2px; border:1px solid var(--border); position:sticky; left:0; background:${isToday ? 'rgba(20,184,166,0.15)' : isWeekend ? 'var(--panel-2)' : 'var(--panel)'}; z-index:1; white-space:nowrap; font-size:7px; width:${dateColWidth}px;">
            <span style="font-weight:${isToday ? '700' : '400'}; color:${isToday ? 'var(--teal)' : 'var(--text)'};">${dayName}</span>
            <span style="color:var(--muted); margin-left:1px;">${monthDay}</span>
          </td>`;

        team.forEach(m => {
          const key = `${dateStr}|${m.uid}`;
          const sched = schedLookup[key];
          const hours = sched?.hours || '';
          const status = sched?.status || 'locked';
          const schedId = sched?.id || '';

          if (hours) rowTotal += parseFloat(hours) || 0;

          // Status color indicator
          const statusColor = status === 'locked' ? '#22c55e' : status === 'likely' ? '#3b82f6' : '#f59e0b';
          const statusBorder = hours ? `border-left:3px solid ${statusColor}` : '';

          html += `<td style="padding:0; border:1px solid var(--border); text-align:center; width:${memberColWidth}px; ${statusBorder}">
            <input type="number"
              class="sched-grid-input"
              data-date="${dateStr}"
              data-member="${m.uid}"
              data-sched-id="${schedId}"
              value="${hours}"
              min="0" max="24" step="0.5"
              placeholder="‚Äî"
              style="width:100%; height:18px; text-align:center; font-size:9px; font-weight:${hours ? '600' : '400'};
                background:${hours ? 'var(--panel-2)' : 'transparent'};
                border:1px solid ${hours ? 'rgba(20,184,166,0.55)' : 'transparent'};
                border-radius:2px; color:var(--text);"
            />
          </td>`;
        });

        html += `<td style="padding:1px; border:1px solid var(--border); text-align:center; font-weight:600; font-size:7px; background:var(--panel-2); width:${totalColWidth}px; color:${rowTotal > 0 ? 'var(--text)' : 'var(--muted)'};">
          ${rowTotal > 0 ? rowTotal : ''}
        </td></tr>`;
      });

      // Totals row
      html += `<tr style="background:var(--panel); font-weight:600; font-size:7px;">
        <td style="padding:1px 2px; border:1px solid var(--border); position:sticky; left:0; background:var(--panel); z-index:1; width:${dateColWidth}px;">Tot</td>`;

      let grandTotal = 0;
      team.forEach(m => {
        let memberTotal = 0;
        schedules.filter(s => s.memberUid === m.uid).forEach(s => {
          memberTotal += s.hours || 0;
        });
        grandTotal += memberTotal;
        html += `<td style="padding:1px; border:1px solid var(--border); text-align:center; width:${memberColWidth}px; color:${memberTotal > 0 ? 'var(--teal)' : 'var(--muted)'};">
          ${memberTotal > 0 ? memberTotal : ''}
        </td>`;
      });

      html += `<td style="padding:1px; border:1px solid var(--border); text-align:center; background:var(--teal); color:white; width:${totalColWidth}px;">
        ${grandTotal}
      </td></tr>`;

      html += `</tbody></table></div>`;

      container.innerHTML = html;

      // Add event listeners to inputs
      container.querySelectorAll('.sched-grid-input').forEach(input => {
        input.addEventListener('change', handleScheduleGridInputChange);
        input.addEventListener('focus', (e) => e.target.select());
      });

      // Add click listeners to member headers for range popout
      container.querySelectorAll('.sched-member-header').forEach(header => {
        header.addEventListener('click', (e) => {
          const memberUid = header.dataset.memberUid;
          openMemberRangePopout(memberUid, header);
        });
      });

      // Update summary
      document.getElementById('schedTotalHours').textContent = `${grandTotal}h`;
      const breakdown = team.map(m => {
        const memberTotal = schedules.filter(s => s.memberUid === m.uid).reduce((sum, s) => sum + (s.hours || 0), 0);
        return `${getMemberDisplayName(m.uid).split(' ')[0]}: ${memberTotal}h`;
      }).join(' | ');
      document.getElementById('schedMemberBreakdown').textContent = breakdown ? `(${breakdown})` : '';
    }

    function handleScheduleGridInputChange(e) {
      const input = e.target;
      const dateStr = input.dataset.date;
      const memberUid = input.dataset.member;
      const schedId = input.dataset.schedId;
      const newHours = parseFloat(input.value) || 0;
      const defaultStatus = document.getElementById('schedGridDefaultStatus').value;

      const task = tasks[currentScheduleTaskIndex];
      if (!task.schedules) task.schedules = [];

      if (schedId) {
        // Update existing schedule
        const sched = task.schedules.find(s => s.id === schedId);
        if (sched) {
          if (newHours > 0) {
            sched.hours = newHours;
          } else {
            // Remove if hours is 0
            task.schedules = task.schedules.filter(s => s.id !== schedId);
          }
        }
      } else if (newHours > 0) {
        // Add new schedule
        task.schedules.push({
          id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
          date: dateStr,
          hours: newHours,
          status: defaultStatus,
          memberUid: memberUid
        });
      }

      saveTasks(false);
      if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(task).catch(console.warn);

      // Re-render to update totals and styling
      renderScheduleGrid();
      renderTasks();
    }

    // Member Range Popout functionality
    let memberRangeCurrentUid = null;

    function openMemberRangePopout(memberUid, anchorElement) {
      const popout = document.getElementById('memberRangePopout');
      const title = document.getElementById('memberRangeTitle');
      const selectorRow = document.getElementById('memberRangeSelectorRow');
      const selector = document.getElementById('memberRangeSelector');

      const task = tasks[currentScheduleTaskIndex];
      const team = task?.team || [];

      // Populate member selector
      selector.innerHTML = team.map(m =>
        `<option value="${m.uid}">${escapeHtml(getMemberDisplayName(m.uid))} (${m.jobRole})</option>`
      ).join('');

      if (memberUid) {
        // Opened from specific member header - hide selector, use that member
        memberRangeCurrentUid = memberUid;
        selectorRow.style.display = 'none';
        title.textContent = `Schedule: ${getMemberDisplayName(memberUid)}`;
        selector.value = memberUid;
      } else {
        // Opened from Add Range button - show selector
        selectorRow.style.display = 'block';
        title.textContent = 'Add Hours';
        memberRangeCurrentUid = team.length > 0 ? team[0].uid : null;
        if (memberRangeCurrentUid) selector.value = memberRangeCurrentUid;
      }

      // Set default date range from the schedule grid
      const fromDate = document.getElementById('schedGridDateFrom').value;
      const toDate = document.getElementById('schedGridDateTo').value;
      document.getElementById('memberRangeFrom').value = fromDate;
      document.getElementById('memberRangeTo').value = toDate;
      document.getElementById('memberRangeClearFrom').value = fromDate;
      document.getElementById('memberRangeClearTo').value = toDate;

      // Position popout
      if (anchorElement) {
        const rect = anchorElement.getBoundingClientRect();
        popout.style.left = Math.min(rect.left, window.innerWidth - 300) + 'px';
        popout.style.top = Math.min(rect.bottom + 8, window.innerHeight - 400) + 'px';
      } else {
        // Center horizontally in the modal
        popout.style.left = '50%';
        popout.style.top = '150px';
        popout.style.transform = 'translateX(-50%)';
      }
      popout.style.display = 'block';

      // Reset to Add tab
      switchMemberRangeTab('add');

      // Render edit list
      renderMemberRangeEditList();
    }

    function closeMemberRangePopout() {
      const popout = document.getElementById('memberRangePopout');
      popout.style.display = 'none';
      popout.style.transform = '';
      memberRangeCurrentUid = null;
    }

    function switchMemberRangeTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.member-range-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });

      // Show/hide content
      document.getElementById('memberRangeAddTab').style.display = tabName === 'add' ? 'block' : 'none';
      document.getElementById('memberRangeEditTab').style.display = tabName === 'edit' ? 'block' : 'none';
      document.getElementById('memberRangeClearTab').style.display = tabName === 'clear' ? 'block' : 'none';

      // Refresh edit list when switching to edit tab
      if (tabName === 'edit') {
        renderMemberRangeEditList();
      }
    }

    function addMemberRangeHours() {
      const task = tasks[currentScheduleTaskIndex];
      if (!task || !memberRangeCurrentUid) return;

      const fromDate = document.getElementById('memberRangeFrom').value;
      const toDate = document.getElementById('memberRangeTo').value;
      const hours = parseFloat(document.getElementById('memberRangeHours').value);
      const status = document.getElementById('memberRangeStatus').value;
      const weekdaysOnly = document.getElementById('memberRangeWeekdays').checked;

      if (!fromDate || !toDate) {
        toast('Please select date range');
        return;
      }
      if (!hours || hours <= 0) {
        toast('Please enter hours per day');
        return;
      }

      if (!task.schedules) task.schedules = [];

      const start = new Date(fromDate);
      const end = new Date(toDate);
      let addedCount = 0;

      const current = new Date(start);
      while (current <= end) {
        const dayOfWeek = current.getDay();
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

        if (!weekdaysOnly || !isWeekend) {
          const dateStr = formatDateLocal(current);

          // Check if entry already exists for this member on this date
          const existingIdx = task.schedules.findIndex(s =>
            s.date === dateStr && s.memberUid === memberRangeCurrentUid
          );

          if (existingIdx >= 0) {
            // Update existing
            task.schedules[existingIdx].hours = hours;
            task.schedules[existingIdx].status = status;
          } else {
            // Add new
            task.schedules.push({
              id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random() + addedCount,
              date: dateStr,
              hours: hours,
              status: status,
              memberUid: memberRangeCurrentUid
            });
          }
          addedCount++;
        }
        current.setDate(current.getDate() + 1);
      }

      saveTasks(false);
      if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(task).catch(console.warn);

      toast(`Added ${addedCount} schedule entries`);
      renderScheduleGrid();
      renderTasks();
      renderMemberRangeEditList();
    }

    function renderMemberRangeEditList() {
      const task = tasks[currentScheduleTaskIndex];
      const container = document.getElementById('memberRangeEditList');

      if (!task || !memberRangeCurrentUid) {
        container.innerHTML = '<div class="subtle" style="text-align:center; padding:20px;">No entries</div>';
        return;
      }

      // Get schedules for this member, sorted by date
      const memberSchedules = (task.schedules || [])
        .filter(s => s.memberUid === memberRangeCurrentUid)
        .sort((a, b) => a.date.localeCompare(b.date));

      if (memberSchedules.length === 0) {
        container.innerHTML = '<div class="subtle" style="text-align:center; padding:12px; font-size:10px;">No scheduled hours</div>';
        return;
      }

      container.innerHTML = memberSchedules.map(sched => {
        const date = new Date(sched.date);
        const dayName = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'][date.getDay()];
        const dateDisplay = `${dayName} ${date.getDate()}/${date.getMonth() + 1}`;
        const statusColor = sched.status === 'locked' ? '#22c55e' : sched.status === 'likely' ? '#3b82f6' : '#f59e0b';

        return `
          <div class="member-range-entry" data-sched-id="${sched.id}" style="display:flex; align-items:center; gap:4px; padding:3px 6px; background:var(--bg); border-radius:4px; border-left:2px solid ${statusColor};">
            <span style="flex:1; font-size:10px; color:var(--text);">${dateDisplay}</span>
            <input type="number" class="member-edit-hours" data-sched-id="${sched.id}" value="${sched.hours}" min="0.5" max="24" step="0.5" style="width:40px; height:20px; text-align:center; font-size:10px;" />
            <select class="member-edit-status" data-sched-id="${sched.id}" style="height:20px; font-size:9px; padding:1px 2px;">
              <option value="locked" ${sched.status === 'locked' ? 'selected' : ''}>L</option>
              <option value="likely" ${sched.status === 'likely' ? 'selected' : ''}>Lk</option>
              <option value="tentative" ${sched.status === 'tentative' ? 'selected' : ''}>T</option>
            </select>
            <button class="mini member-delete-entry" data-sched-id="${sched.id}" type="button" style="padding:1px 4px; font-size:9px; color:var(--danger); border-color:var(--danger);">‚úï</button>
          </div>
        `;
      }).join('');

      // Add event listeners
      container.querySelectorAll('.member-edit-hours').forEach(input => {
        input.addEventListener('change', (e) => updateMemberScheduleEntry(e.target.dataset.schedId, 'hours', parseFloat(e.target.value)));
      });
      container.querySelectorAll('.member-edit-status').forEach(select => {
        select.addEventListener('change', (e) => updateMemberScheduleEntry(e.target.dataset.schedId, 'status', e.target.value));
      });
      container.querySelectorAll('.member-delete-entry').forEach(btn => {
        btn.addEventListener('click', (e) => deleteMemberScheduleEntry(e.target.dataset.schedId));
      });
    }

    function updateMemberScheduleEntry(schedId, field, value) {
      const task = tasks[currentScheduleTaskIndex];
      if (!task) return;

      const sched = (task.schedules || []).find(s => s.id === schedId);
      if (sched) {
        sched[field] = value;
        saveTasks(false);
        if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(task).catch(console.warn);
        renderScheduleGrid();
        renderTasks();
        // Update border color if status changed
        if (field === 'status') {
          renderMemberRangeEditList();
        }
      }
    }

    function deleteMemberScheduleEntry(schedId) {
      const task = tasks[currentScheduleTaskIndex];
      if (!task) return;

      task.schedules = (task.schedules || []).filter(s => s.id !== schedId);
      saveTasks(false);
      if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(task).catch(console.warn);
      renderScheduleGrid();
      renderTasks();
      renderMemberRangeEditList();
    }

    function clearMemberRange() {
      const task = tasks[currentScheduleTaskIndex];
      if (!task || !memberRangeCurrentUid) return;

      const fromDate = document.getElementById('memberRangeClearFrom').value;
      const toDate = document.getElementById('memberRangeClearTo').value;
      const weekdaysOnly = document.getElementById('memberRangeClearWeekdays').checked;

      if (!fromDate || !toDate) {
        toast('Please select date range to clear');
        return;
      }

      const start = new Date(fromDate);
      const end = new Date(toDate);
      let removedCount = 0;

      task.schedules = (task.schedules || []).filter(sched => {
        if (sched.memberUid !== memberRangeCurrentUid) return true;

        const schedDate = new Date(sched.date);
        if (schedDate < start || schedDate > end) return true;

        if (weekdaysOnly) {
          const dayOfWeek = schedDate.getDay();
          if (dayOfWeek === 0 || dayOfWeek === 6) return true;
        }

        removedCount++;
        return false;
      });

      saveTasks(false);
      if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(task).catch(console.warn);

      toast(`Cleared ${removedCount} schedule entries`);
      renderScheduleGrid();
      renderTasks();
      renderMemberRangeEditList();
    }

    function setMemberRangeBulkStatus() {
      const task = tasks[currentScheduleTaskIndex];
      if (!task || !memberRangeCurrentUid) return;

      const newStatus = document.getElementById('memberRangeBulkStatus').value;

      (task.schedules || []).forEach(sched => {
        if (sched.memberUid === memberRangeCurrentUid) {
          sched.status = newStatus;
        }
      });

      saveTasks(false);
      if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(task).catch(console.warn);
      toast('Updated all entries to ' + (newStatus === 'locked' ? 'Locked In' : newStatus === 'likely' ? 'Likely' : 'Tentative'));
      renderScheduleGrid();
      renderTasks();
      renderMemberRangeEditList();
    }

    function closeScheduleModal() {
      hideModal('scheduleModalBackdrop');
      currentScheduleTaskIndex = null;
      closeMemberRangePopout(); // Close any open popout

      // If opened from Gantt, refresh and keep Gantt visible
      if (openedFromGantt) {
        openedFromGantt = false;

        // Preserve scroll position
        const modalBody = document.querySelector('#ganttModalBackdrop .modal-body');
        const scrollLeft = modalBody ? modalBody.scrollLeft : 0;
        const scrollTop = modalBody ? modalBody.scrollTop : 0;

        renderGantt();
        showModal('ganttModalBackdrop');

        // Restore scroll position
        if (modalBody) {
          modalBody.scrollLeft = scrollLeft;
          modalBody.scrollTop = scrollTop;
        }
      }
    }

    function setScheduleMode(mode) {
      scheduleMode = mode;
      // Guard against missing legacy elements
      const modeSingle = document.getElementById('schedModeSingle');
      const modeRange = document.getElementById('schedModeRange');
      const modeMatrix = document.getElementById('schedModeMatrix');
      const singleMode = document.getElementById('schedSingleMode');
      const rangeMode = document.getElementById('schedRangeMode');
      const matrixMode = document.getElementById('schedMatrixMode');

      if (modeSingle) modeSingle.classList.toggle('active', mode === 'single');
      if (modeRange) modeRange.classList.toggle('active', mode === 'range');
      if (modeMatrix) modeMatrix.classList.toggle('active', mode === 'matrix');
      if (singleMode) singleMode.style.display = mode === 'single' ? 'flex' : 'none';
      if (rangeMode) rangeMode.style.display = mode === 'range' ? 'block' : 'none';
      if (matrixMode) matrixMode.style.display = mode === 'matrix' ? 'block' : 'none';

      // If switching to matrix mode, render the matrix grid
      if (mode === 'matrix') {
        renderScheduleMatrixGrid();
      }
    }

    function renderScheduleMatrixGrid() {
      const task = tasks[currentScheduleTaskIndex];
      const team = task.team || [];
      const container = document.getElementById('schedMatrixGrid');

      // Guard against missing legacy container
      if (!container) return;

      if (team.length === 0) {
        container.innerHTML = '<div class="subtle" style="padding:16px; text-align:center;">No team members assigned to this job</div>';
        return;
      }

      let html = `
        <div style="display:grid; grid-template-columns:1fr 80px 100px; gap:1px; background:var(--border);">
          <div style="background:var(--panel); padding:8px 12px; font-size:11px; font-weight:600; color:var(--muted);">Team Member</div>
          <div style="background:var(--panel); padding:8px 12px; font-size:11px; font-weight:600; color:var(--muted);">Hours</div>
          <div style="background:var(--panel); padding:8px 12px; font-size:11px; font-weight:600; color:var(--muted);">Status</div>
      `;

      team.forEach(m => {
        const name = getMemberDisplayName(m.uid);
        html += `
          <div style="background:var(--bg); padding:8px 12px; display:flex; align-items:center;">
            <span style="color:var(--text);">${escapeHtml(name)}</span>
            <span style="color:var(--muted); font-size:10px; margin-left:6px;">(${m.jobRole})</span>
          </div>
          <div style="background:var(--bg); padding:4px;">
            <input type="number" class="matrix-hours" data-uid="${m.uid}" min="0.5" step="0.5" placeholder="‚Äî" style="width:100%; height:31px; font-size:12px; text-align:center; background:var(--panel-2); border:1px solid rgba(20,184,166,0.55); border-radius:6px; color:var(--text);" />
          </div>
          <div style="background:var(--bg); padding:4px;">
            <select class="matrix-status" data-uid="${m.uid}" style="width:100%; height:31px; font-size:11px;">
              <option value="locked">Locked</option>
              <option value="likely">Likely</option>
              <option value="tentative">Tentative</option>
            </select>
          </div>
        `;
      });

      html += '</div>';
      container.innerHTML = html;
    }

    function saveScheduleMatrix() {
      const task = tasks[currentScheduleTaskIndex];
      const dateInput = document.getElementById('schedMatrixDate');

      // Guard against missing legacy element
      if (!dateInput) return;

      const date = dateInput.value;

      if (!date) {
        toast('Please select a date');
        return;
      }

      if (!task.schedules) task.schedules = [];

      let addedCount = 0;
      const hoursInputs = document.querySelectorAll('.matrix-hours');

      hoursInputs.forEach(input => {
        const hours = parseFloat(input.value);
        if (!hours || hours <= 0) return;

        const uid = input.dataset.uid;
        const statusSelect = document.querySelector(`.matrix-status[data-uid="${uid}"]`);
        const status = statusSelect?.value || 'locked';

        task.schedules.push({
          id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random() + addedCount,
          date: date,
          hours: hours,
          status: status,
          memberUid: uid
        });
        addedCount++;
      });

      if (addedCount === 0) {
        toast('No hours entered');
        return;
      }

      saveTasks(false);
      if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(task).catch(console.warn);

      renderScheduleList();
      renderTasks();
      renderScheduleMatrixGrid(); // Clear inputs

      toast(`Added schedules for ${addedCount} team member${addedCount > 1 ? 's' : ''}`);
    }

    window.saveScheduleMatrix = saveScheduleMatrix;

    function addScheduleRange() {
      // Guard against missing legacy elements
      const startInput = document.getElementById('schedRangeStart');
      const endInput = document.getElementById('schedRangeEnd');
      const hoursInput = document.getElementById('schedRangeHours');
      const weekdaysInput = document.getElementById('schedWeekdaysOnly');
      const statusInput = document.getElementById('schedRangeStatus');
      if (!startInput || !endInput || !hoursInput) return;

      const startDate = startInput.value;
      const endDate = endInput.value;
      const hoursPerDay = parseFloat(hoursInput.value);
      const weekdaysOnly = weekdaysInput?.checked ?? true;
      const status = statusInput?.value || 'locked';

      if (!startDate) {
        toast('Please select a start date');
        return;
      }
      if (!endDate) {
        toast('Please select an end date');
        return;
      }
      if (!hoursPerDay || hoursPerDay <= 0) {
        toast('Please enter hours per day');
        return;
      }

      const start = new Date(startDate);
      const end = new Date(endDate);

      if (end < start) {
        toast('End date must be after start date');
        return;
      }

      const task = tasks[currentScheduleTaskIndex];
      if (!task.schedules) task.schedules = [];

      // Get selected member (if team has multiple members)
      const memberSelect = document.getElementById('schedMemberSelect');
      const memberUid = (task.team && task.team.length > 1 && memberSelect.value) ? memberSelect.value : (task.team?.[0]?.uid || task.assignedTo || null);

      let daysAdded = 0;
      const current = new Date(start);

      while (current <= end) {
        const dayOfWeek = current.getDay();
        const isWeekday = dayOfWeek !== 0 && dayOfWeek !== 6;

        if (!weekdaysOnly || isWeekday) {
          task.schedules.push({
            id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random() + daysAdded,
            date: current.toISOString().split('T')[0],
            hours: hoursPerDay,
            status: status,
            memberUid: memberUid
          });
          daysAdded++;
        }

        current.setDate(current.getDate() + 1);
      }

      saveTasks(false);
      if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(task).catch(console.warn);

      renderScheduleList();
      renderTasks();

      const memberName = memberUid ? getMemberDisplayName(memberUid) : '';
      toast(`Added ${daysAdded} days (${daysAdded * hoursPerDay}h total)${memberName ? ` for ${memberName}` : ''}`);

      // Clear hours input
      document.getElementById('schedRangeHours').value = '';
    }

    function renderScheduleList() {
      const task = tasks[currentScheduleTaskIndex];
      const allSchedules = task.schedules || [];
      const container = document.getElementById('scheduleList');
      container.innerHTML = '';

      // Filter schedules by selected member (if filter is active)
      const schedules = scheduleFilterMemberUid
        ? allSchedules.filter(s => s.memberUid === scheduleFilterMemberUid)
        : allSchedules;

      const hasTeam = task.team && task.team.length > 1;

      if (schedules.length === 0) {
        const msg = scheduleFilterMemberUid
          ? 'No time scheduled for this team member'
          : 'No time scheduled yet';
        container.innerHTML = `<div class="subtle" style="text-align:center; padding:20px;">${msg}</div>`;
        document.getElementById('schedTotalHours').textContent = '0h';
        document.getElementById('schedMemberBreakdown').textContent = '';
        return;
      }

      // Sort by date, then by member
      const sorted = [...schedules].sort((a, b) => {
        const dateCompare = new Date(a.date) - new Date(b.date);
        if (dateCompare !== 0) return dateCompare;
        return (a.memberUid || '').localeCompare(b.memberUid || '');
      });

      sorted.forEach(sched => {
        const item = document.createElement('div');
        item.className = 'schedule-item';
        const dateFormatted = formatScheduleDate(sched.date);
        const currentStatus = sched.status || 'locked';

        // Show member name if team has multiple members and not filtered
        const memberName = hasTeam && !scheduleFilterMemberUid && sched.memberUid
          ? getMemberDisplayName(sched.memberUid)
          : '';
        const memberBadge = memberName
          ? `<span style="font-size:10px; color:var(--muted); background:var(--panel-2); padding:2px 6px; border-radius:4px; margin-left:4px;">${escapeHtml(memberName.split(' ')[0])}</span>`
          : '';

        item.innerHTML = `
          <span class="schedule-item-date">${dateFormatted}${memberBadge}</span>
          <select class="schedule-item-status" data-id="${sched.id}" style="height:28px; font-size:11px; padding:2px 4px; border:1px solid rgba(20,184,166,0.55); border-radius:6px; background:var(--panel-2); color:var(--text); cursor:pointer;">
            <option value="locked" ${currentStatus === 'locked' ? 'selected' : ''} style="color:#22c55e;">‚óè Locked</option>
            <option value="likely" ${currentStatus === 'likely' ? 'selected' : ''} style="color:#3b82f6;">‚óè Likely</option>
            <option value="tentative" ${currentStatus === 'tentative' ? 'selected' : ''} style="color:#f59e0b;">‚óè Tentative</option>
          </select>
          <input type="number" class="schedule-item-hours-input" value="${sched.hours}" min="0.5" step="0.5" data-id="${sched.id}" style="width:60px; height:28px; padding:4px 8px; border:1px solid rgba(20,184,166,0.55); border-radius:8px; background:#141420; color:#f4f7fb; font-weight:600; font-size:13px; text-align:center;" />
          <span class="schedule-item-delete" data-id="${sched.id}">√ó</span>
        `;
        item.querySelector('.schedule-item-delete').addEventListener('click', () => deleteScheduleBlock(sched.id));
        item.querySelector('.schedule-item-hours-input').addEventListener('change', (e) => updateScheduleHours(sched.id, e.target.value));
        item.querySelector('.schedule-item-status').addEventListener('change', (e) => updateScheduleStatus(sched.id, e.target.value));
        container.appendChild(item);
      });

      // Calculate total hours (all schedules, not filtered)
      const total = allSchedules.reduce((sum, s) => sum + (s.hours || 0), 0);
      document.getElementById('schedTotalHours').textContent = `${total}h`;

      // Show per-member breakdown if team has multiple members
      const breakdownEl = document.getElementById('schedMemberBreakdown');
      if (hasTeam && isInFirmMode()) {
        const hoursByMember = {};
        allSchedules.forEach(s => {
          if (!hoursByMember[s.memberUid]) hoursByMember[s.memberUid] = 0;
          hoursByMember[s.memberUid] += s.hours || 0;
        });
        const breakdown = Object.entries(hoursByMember)
          .map(([uid, hrs]) => `${getMemberDisplayName(uid).split(' ')[0]}: ${hrs}h`)
          .join(' | ');
        breakdownEl.textContent = breakdown ? `(${breakdown})` : '';
      } else {
        breakdownEl.textContent = '';
      }
    }

    function formatScheduleDate(dateStr) {
      const date = new Date(dateStr);
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return `${days[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]}`;
    }

    // Format date as YYYY-MM-DD in local timezone (not UTC)
    function formatDateLocal(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function addScheduleBlock() {
      const dateInput = document.getElementById('schedNewDate');
      const hoursInput = document.getElementById('schedNewHours');
      const statusInput = document.getElementById('schedStatus');
      const date = dateInput.value;
      const hours = parseFloat(hoursInput.value);
      const status = statusInput.value;

      if (!date) {
        toast('Please select a date');
        return;
      }
      if (!hours || hours <= 0) {
        toast('Please enter hours');
        return;
      }

      const task = tasks[currentScheduleTaskIndex];
      if (!task.schedules) task.schedules = [];

      // Get selected member (if team has multiple members)
      const memberSelect = document.getElementById('schedMemberSelect');
      const memberUid = (task.team && task.team.length > 1 && memberSelect.value) ? memberSelect.value : (task.team?.[0]?.uid || task.assignedTo || null);

      task.schedules.push({
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
        date: date,
        hours: hours,
        status: status,
        memberUid: memberUid
      });

      saveTasks(false);
      if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(task).catch(console.warn);

      renderScheduleList();
      renderTasks();

      // Clear inputs
      hoursInput.value = '';
      // Move date to next day
      const nextDate = new Date(date);
      nextDate.setDate(nextDate.getDate() + 1);
      dateInput.value = nextDate.toISOString().split('T')[0];
    }

    function deleteScheduleBlock(blockId) {
      const task = tasks[currentScheduleTaskIndex];
      task.schedules = (task.schedules || []).filter(s => s.id !== blockId);
      saveTasks(false);
      if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(task).catch(console.warn);
      renderScheduleList();
      renderTasks();
    }

    function updateScheduleHours(blockId, newHours) {
      const hours = parseFloat(newHours);
      if (!hours || hours <= 0) {
        renderScheduleList(); // Reset to previous value
        return;
      }
      const task = tasks[currentScheduleTaskIndex];
      const sched = (task.schedules || []).find(s => s.id === blockId);
      if (sched) {
        sched.hours = hours;
        saveTasks(false);
        if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(task).catch(console.warn);
        renderScheduleList();
        renderTasks();
      }
    }

    function updateScheduleStatus(blockId, newStatus) {
      const task = tasks[currentScheduleTaskIndex];
      const sched = (task.schedules || []).find(s => s.id === blockId);
      if (sched) {
        sched.status = newStatus;
        saveTasks(false);
        if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(task).catch(console.warn);
        renderScheduleList();
        renderTasks();
      }
    }

    function clearAllSchedules() {
      const task = tasks[currentScheduleTaskIndex];
      if (!task.schedules || task.schedules.length === 0) return;
      if (!confirm('Clear all scheduled time for this task?')) return;
      task.schedules = [];
      saveTasks(false);
      if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(task).catch(console.warn);
      renderScheduleList();
      renderTasks();
    }

    // ===== Gantt Chart =====
    let ganttZoom = 'normal'; // 'narrow', 'normal', 'wide'
    let ganttHideWeekends = true;
    let ganttDateFrom = null;
    let ganttDateTo = null;
    let ganttMemberFilter = null; // null = all members, or specific uid
    let ganttJobFilter = null; // null = all jobs, or specific task index
    let ganttExpandedTasks = new Set(); // Track which tasks have expanded rows

    // Job role order for sorting team members (lowest to highest)
    const JOB_ROLE_ORDER = { 'Preparer': 1, 'Reviewer': 2, 'Partner': 3 };

    function openGanttModal() {
      // Set default date range if not set
      if (!ganttDateFrom || !ganttDateTo) {
        resetGanttDateRange();
      }

      // Always default to user mode - logged-in user's schedule across all jobs
      setGanttViewMode('user');

      // Populate job filter dropdown
      setupGanttJobFilter();

      renderGantt();
      showModal('ganttModalBackdrop');
    }

    function setGanttViewMode(mode) {
      const userBtn = document.getElementById('ganttViewUser');
      const jobBtn = document.getElementById('ganttViewJob');
      const jobSection = document.getElementById('ganttJobFilterSection');

      if (mode === 'user') {
        // User mode - show logged-in user's jobs
        ganttJobFilter = null;
        ganttMemberFilter = currentUser?.uid || null;
        userBtn.classList.add('active');
        jobBtn.classList.remove('active');
        // Style active button
        userBtn.style.background = 'var(--teal)';
        userBtn.style.color = 'white';
        userBtn.style.borderColor = 'var(--teal)';
        jobBtn.style.background = 'var(--panel)';
        jobBtn.style.color = 'var(--muted)';
        jobBtn.style.borderColor = 'var(--border)';
        jobSection.style.display = 'none';
      } else {
        // Job mode - show job dropdown
        ganttMemberFilter = null;
        userBtn.classList.remove('active');
        jobBtn.classList.add('active');
        // Style active button
        jobBtn.style.background = 'var(--teal)';
        jobBtn.style.color = 'white';
        jobBtn.style.borderColor = 'var(--teal)';
        userBtn.style.background = 'var(--panel)';
        userBtn.style.color = 'var(--muted)';
        userBtn.style.borderColor = 'var(--border)';
        jobSection.style.display = 'inline';
        // If no job selected yet, don't render until one is chosen
        if (ganttJobFilter === null) {
          document.getElementById('ganttJobFilter').value = '';
        }
      }
    }

    function setupGanttJobFilter() {
      const filterSelect = document.getElementById('ganttJobFilter');

      filterSelect.innerHTML = '<option value="">Select a job...</option>';

      // Get tasks with team members, sorted by client then description
      const tasksWithTeam = tasks
        .map((t, idx) => ({ task: t, index: idx }))
        .filter(({ task }) => task.team && task.team.length > 0 && !task.completed)
        .sort((a, b) => {
          const clientA = (a.task.client || '').toLowerCase();
          const clientB = (b.task.client || '').toLowerCase();
          if (clientA !== clientB) return clientA.localeCompare(clientB);
          return (a.task.description || '').toLowerCase().localeCompare((b.task.description || '').toLowerCase());
        });

      tasksWithTeam.forEach(({ task, index }) => {
        const label = `${task.client || 'No Client'} - ${(task.description || 'Untitled').substring(0, 30)}${(task.description || '').length > 30 ? '...' : ''}`;
        filterSelect.innerHTML += `<option value="${index}">${escapeHtml(label)}</option>`;
      });

      // Add change handler
      filterSelect.onchange = () => {
        const val = filterSelect.value;
        if (val !== '') {
          ganttJobFilter = parseInt(val, 10);
          ganttMemberFilter = null; // Job mode shows all team members
          renderGantt();
        }
      };

      // Restore current filter value
      filterSelect.value = ganttJobFilter !== null ? String(ganttJobFilter) : '';
    }

    function setupGanttMemberFilter() {
      const filterSection = document.getElementById('ganttMemberFilterSection');
      const filterSelect = document.getElementById('ganttMemberFilter');

      // In job mode, hide the member filter (team members are shown as rows)
      if (ganttJobFilter !== null) {
        filterSection.style.display = 'none';
        return;
      }

      if (isInFirmMode() && firmMembers.length > 0) {
        filterSection.style.display = 'inline';
        filterSelect.innerHTML = '<option value="">All Members</option>';

        // User mode: show all members who have schedules
        const membersWithSchedules = new Set();
        tasks.forEach(task => {
          if (!task.schedules || task.completed) return;
          task.schedules.forEach(s => {
            if (s.memberUid) membersWithSchedules.add(s.memberUid);
          });
        });

        // Add all members to dropdown
        const sortedMembers = [...firmMembers]
          .filter(m => m.status === 'active')
          .sort((a, b) => (a.displayName || '').localeCompare(b.displayName || ''));

        sortedMembers.forEach(m => {
          const hasSchedules = membersWithSchedules.has(m.uid);
          filterSelect.innerHTML += `<option value="${m.uid}"${hasSchedules ? '' : ' style="color:var(--muted)"'}>${escapeHtml(m.displayName)}${hasSchedules ? '' : ' (no schedules)'}</option>`;
        });

        // Add change handler
        filterSelect.onchange = () => {
          ganttMemberFilter = filterSelect.value || null;
          renderGantt();
        };

        // Restore current filter value if it's valid for the current dropdown options
        const currentValueValid = ganttMemberFilter && filterSelect.querySelector(`option[value="${ganttMemberFilter}"]`);
        filterSelect.value = currentValueValid ? ganttMemberFilter : '';
        if (!currentValueValid) ganttMemberFilter = null;
      } else {
        filterSection.style.display = 'none';
      }
    }

    function updateGanttDateRange() {
      const fromVal = document.getElementById('ganttDateFrom').value;
      const toVal = document.getElementById('ganttDateTo').value;
      ganttDateFrom = fromVal ? new Date(fromVal) : null;
      ganttDateTo = toVal ? new Date(toVal) : null;
      renderGantt();
    }

    function resetGanttDateRange() {
      // Find actual date range from tasks
      let minDate = null;
      let maxDate = null;
      tasks.forEach(task => {
        if (!task.schedules || task.completed) return;
        task.schedules.forEach(sched => {
          const d = new Date(sched.date);
          if (!minDate || d < minDate) minDate = new Date(d);
          if (!maxDate || d > maxDate) maxDate = new Date(d);
        });
        if (task.dueDate) {
          const due = new Date(task.dueDate);
          if (!maxDate || due > maxDate) maxDate = new Date(due);
        }
      });

      if (minDate && maxDate) {
        minDate.setDate(minDate.getDate() - 7);
        maxDate.setDate(maxDate.getDate() + 7);
        ganttDateFrom = minDate;
        ganttDateTo = maxDate;
        document.getElementById('ganttDateFrom').value = minDate.toISOString().split('T')[0];
        document.getElementById('ganttDateTo').value = maxDate.toISOString().split('T')[0];
      }
      renderGantt();
    }

    function closeGanttModal() {
      hideModal('ganttModalBackdrop');
    }

    function setGanttZoom(zoom) {
      ganttZoom = zoom;
      document.querySelectorAll('.gantt-zoom-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.zoom === zoom);
      });
      renderGantt();
    }

    function toggleGanttWeekends() {
      ganttHideWeekends = document.getElementById('ganttHideWeekends').checked;
      renderGantt();
    }

    function renderGantt() {
      const container = document.getElementById('ganttChart');
      container.innerHTML = '';

      // Check if in Job mode but no job selected
      const jobViewActive = document.getElementById('ganttViewJob').classList.contains('active');
      if (jobViewActive && ganttJobFilter === null) {
        container.innerHTML = `<div class="gantt-empty">Select a job from the dropdown to view team schedules.</div>`;
        return;
      }

      // Determine if we're in job mode (single job, team members as rows)
      const isJobMode = ganttJobFilter !== null && ganttJobFilter >= 0 && ganttJobFilter < tasks.length;
      const selectedJob = isJobMode ? tasks[ganttJobFilter] : null;

      // In job mode, we show team members as rows
      // In user mode, we show tasks as rows (filtered to current member)
      let tasksWithSchedules = [];
      let teamMembersForJob = [];

      if (isJobMode) {
        // Job mode: Get team members for the selected job
        if (selectedJob && selectedJob.schedules && selectedJob.schedules.length > 0) {
          tasksWithSchedules = [selectedJob];
          // Get team members sorted by role order
          teamMembersForJob = [...(selectedJob.team || [])].sort((a, b) => {
            const orderA = JOB_ROLE_ORDER[a.jobRole] || 99;
            const orderB = JOB_ROLE_ORDER[b.jobRole] || 99;
            if (orderA !== orderB) return orderA - orderB;
            return getMemberDisplayName(a.uid).localeCompare(getMemberDisplayName(b.uid));
          });
        }
      } else {
        // User mode: Get all tasks with schedules, filtered to current member
        tasksWithSchedules = tasks.filter(t => t.schedules && t.schedules.length > 0 && !t.completed);
        if (ganttMemberFilter) {
          tasksWithSchedules = tasksWithSchedules.filter(t =>
            t.schedules.some(s => s.memberUid === ganttMemberFilter)
          );
        }
      }

      // Check if we have anything to display
      if (isJobMode && teamMembersForJob.length === 0) {
        const jobName = selectedJob ? `${selectedJob.client || 'No Client'} - ${selectedJob.description || 'Untitled'}` : 'this job';
        container.innerHTML = `<div class="gantt-empty">No team members assigned to ${jobName}. Add team members first.</div>`;
        return;
      }

      if (!isJobMode && tasksWithSchedules.length === 0) {
        const msg = ganttMemberFilter
          ? `No scheduled time blocks for ${getMemberDisplayName(ganttMemberFilter)}.`
          : 'No scheduled time blocks. Add schedules to tasks to see them here.';
        container.innerHTML = `<div class="gantt-empty">${msg}</div>`;
        return;
      }

      // Use date filter or calculate from tasks
      let minDate = ganttDateFrom ? new Date(ganttDateFrom) : null;
      let maxDate = ganttDateTo ? new Date(ganttDateTo) : null;

      // If no filter set, calculate from tasks
      if (!minDate || !maxDate) {
        tasksWithSchedules.forEach(task => {
          task.schedules.forEach(sched => {
            const d = new Date(sched.date);
            if (!minDate || d < minDate) minDate = new Date(d);
            if (!maxDate || d > maxDate) maxDate = new Date(d);
          });
          if (task.dueDate) {
            const due = new Date(task.dueDate);
            if (!maxDate || due > maxDate) maxDate = new Date(due);
          }
        });
        // Extend range by 1 week each side
        if (minDate) minDate.setDate(minDate.getDate() - 7);
        if (maxDate) maxDate.setDate(maxDate.getDate() + 7);
      }

      // Calculate cell width based on zoom (each cell = 1 day)
      let cellWidth = 32;
      if (ganttZoom === 'narrow') cellWidth = 20;
      if (ganttZoom === 'wide') cellWidth = 48;

      // Generate all dates in range
      const allDates = [];
      const current = new Date(minDate);
      while (current <= maxDate) {
        allDates.push(new Date(current));
        current.setDate(current.getDate() + 1);
      }

      // Filter out weekends if hideWeekends is enabled
      const dates = ganttHideWeekends
        ? allDates.filter(d => d.getDay() !== 0 && d.getDay() !== 6)
        : allDates;

      // Create a map from date string to column index for bar positioning
      const dateToColIndex = {};
      dates.forEach((d, idx) => {
        dateToColIndex[formatDateLocal(d)] = idx;
      });

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Get filter checkbox states for totals calculation
      const showLocked = document.getElementById('ganttShowLocked')?.checked ?? true;
      const showLikely = document.getElementById('ganttShowLikely')?.checked ?? true;
      const showTentative = document.getElementById('ganttShowTentative')?.checked ?? true;

      // Calculate totals per date (respecting filters)
      const totalsByDate = {};
      tasksWithSchedules.forEach(task => {
        (task.schedules || []).forEach(sched => {
          // Filter by member if active
          if (ganttMemberFilter && sched.memberUid !== ganttMemberFilter) return;

          // Determine the status for filtering
          const schedStatus = sched.status === 'tentative' || sched.tentative ? 'tentative' :
                              sched.status === 'likely' ? 'likely' : 'locked';

          const shouldCount = (schedStatus === 'locked' && showLocked) ||
                              (schedStatus === 'likely' && showLikely) ||
                              (schedStatus === 'tentative' && showTentative);

          if (shouldCount) {
            if (!totalsByDate[sched.date]) totalsByDate[sched.date] = 0;
            totalsByDate[sched.date] += sched.hours;
          }
        });
      });

      // Build sidebar HTML based on mode
      let sidebarHtml = '';
      if (isJobMode) {
        // Job mode: Team members as rows
        sidebarHtml = `
          <div class="gantt-sidebar">
            <div class="gantt-sidebar-header"><span class="client-col">Team Member</span><span class="task-col">Role</span></div>
            ${teamMembersForJob.map((member, idx) => `
              <div class="gantt-sidebar-row gantt-member-row" data-member-uid="${member.uid}" data-task-index="${ganttJobFilter}" title="${escapeHtml(getMemberDisplayName(member.uid))} (${member.jobRole})">
                <span class="client-col">${escapeHtml(getMemberDisplayName(member.uid).substring(0, 15))}${getMemberDisplayName(member.uid).length > 15 ? '...' : ''}</span>
                <span class="task-col">${escapeHtml(member.jobRole || 'Team')}</span>
              </div>
            `).join('')}
            <div class="gantt-sidebar-row gantt-totals-row"><span class="client-col"></span><span class="task-col">Total</span></div>
          </div>`;
      } else {
        // User mode: Tasks as rows
        sidebarHtml = `
          <div class="gantt-sidebar">
            <div class="gantt-sidebar-header"><span class="client-col">Client</span><span class="task-col">Task</span></div>
            ${tasksWithSchedules.map((task, idx) => `
              <div class="gantt-sidebar-row" data-task-index="${tasks.indexOf(task)}" title="${escapeHtml(task.client || 'No Client')} - ${escapeHtml(task.description || 'Untitled')}">
                <span class="client-col">${escapeHtml((task.client || '').substring(0, 15))}${(task.client || '').length > 15 ? '...' : ''}</span>
                <span class="task-col">${escapeHtml((task.description || 'Untitled').substring(0, 25))}${(task.description || '').length > 25 ? '...' : ''}</span>
              </div>
            `).join('')}
            <div class="gantt-sidebar-row gantt-totals-row"><span class="client-col"></span><span class="task-col">Total</span></div>
          </div>`;
      }

      // Build HTML
      const html = `
        <div class="gantt-container">
          ${sidebarHtml}
          <div class="gantt-timeline">
            <div class="gantt-header" style="width:${dates.length * (cellWidth + 1)}px;">
              ${dates.map(d => {
                const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                const isToday = d.getTime() === today.getTime();
                const isMonday = d.getDay() === 1;
                const dateStr = formatDateLocal(d);
                const isHoliday = !isWeekend && isHolidayOrBlocked(dateStr); // Only highlight weekday holidays
                const holidayName = getHolidayName(dateStr);
                const dayNum = d.getDate();
                const dayName = ['S', 'M', 'T', 'W', 'T', 'F', 'S'][d.getDay()];
                const label = cellWidth >= 32 ? `${dayName}<br>${dayNum}` : dayNum;
                const title = isHoliday ? `${holidayName}` : '';
                return `<div class="gantt-header-cell ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''} ${isMonday ? 'monday' : ''} ${isHoliday ? 'holiday' : ''}" style="width:${cellWidth}px;" title="${title}">${label}</div>`;
              }).join('')}
            </div>
            <div class="gantt-rows" style="width:${dates.length * (cellWidth + 1)}px;">
              ${isJobMode ? teamMembersForJob.map((member, rowIdx) => {
                // Job mode: Each row is a team member
                const taskIdx = ganttJobFilter;
                const task = selectedJob;
                const memberUid = member.uid;

                // Get schedules for this member only
                const schedByDate = {};
                const isFirstMember = rowIdx === 0;
                (task.schedules || []).forEach(sched => {
                  // For first member, also include legacy schedules without memberUid
                  const schedMemberUid = sched.memberUid || null;
                  const matchesMember = schedMemberUid === memberUid;
                  const isLegacyForFirst = isFirstMember && !schedMemberUid;

                  if (!matchesMember && !isLegacyForFirst) return;

                  // Use a unique key to prevent double-counting
                  const key = sched.date;
                  if (!schedByDate[key]) {
                    schedByDate[key] = { ...sched, hours: 0 };
                  }
                  schedByDate[key].hours += sched.hours;
                });

                const dueDateStr = task.dueDate || null;

                const cells = dates.map(d => {
                  const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                  const isToday = d.getTime() === today.getTime();
                  const isMonday = d.getDay() === 1;
                  const dateStr = formatDateLocal(d);
                  const isHoliday = !isWeekend && isHolidayForMember(dateStr, memberUid);
                  const holidayName = getHolidayNameForMember(dateStr, memberUid);

                  const sched = schedByDate[dateStr];
                  let barHtml = '';
                  if (sched) {
                    const schedStatus = sched.status === 'tentative' || sched.tentative ? 'tentative' :
                                        sched.status === 'likely' ? 'likely' : 'locked';
                    const showLocked = document.getElementById('ganttShowLocked')?.checked ?? true;
                    const showLikely = document.getElementById('ganttShowLikely')?.checked ?? true;
                    const showTentative = document.getElementById('ganttShowTentative')?.checked ?? true;
                    const shouldShow = (schedStatus === 'locked' && showLocked) ||
                                       (schedStatus === 'likely' && showLikely) ||
                                       (schedStatus === 'tentative' && showTentative);
                    if (shouldShow) {
                      let barClass = schedStatus === 'locked' ? 'locked-in' : schedStatus === 'likely' ? 'likely' : 'tentative';
                      const statusLabel = schedStatus === 'tentative' ? ' (T)' : schedStatus === 'likely' ? ' (L)' : '';
                      barHtml = `<div class="gantt-bar ${barClass}" data-task-index="${taskIdx}" data-member-uid="${memberUid}" data-sched-id="${sched.id}" data-date="${dateStr}" title="${sched.hours}h${statusLabel} on ${formatScheduleDate(sched.date)}">${sched.hours}</div>`;
                    }
                  }

                  let dueMarkerHtml = '';
                  if (rowIdx === 0 && dueDateStr === dateStr) {
                    dueMarkerHtml = `<div class="gantt-due-marker" title="Due: ${formatScheduleDate(task.dueDate)}"></div>`;
                  }

                  const cellTitle = isHoliday ? holidayName : '';
                  return `<div class="gantt-row-cell ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''} ${isMonday ? 'monday' : ''} ${isHoliday ? 'holiday' : ''}" style="width:${cellWidth}px;" data-date="${dateStr}" data-member-uid="${memberUid}" title="${cellTitle}">${barHtml}${dueMarkerHtml}</div>`;
                }).join('');

                return `<div class="gantt-row" data-row="${rowIdx}" data-task-index="${taskIdx}" data-member-uid="${memberUid}">${cells}</div>`;
              }).join('') : tasksWithSchedules.map((task, rowIdx) => {
                // User mode: Each row is a task
                const taskIdx = tasks.indexOf(task);

                // Create a map of date -> aggregated schedule for this task
                // If member filter is active, only show that member's schedules
                const schedByDate = {};
                (task.schedules || []).forEach(sched => {
                  if (ganttMemberFilter && sched.memberUid !== ganttMemberFilter) return;
                  if (!schedByDate[sched.date]) {
                    schedByDate[sched.date] = { ...sched, hours: 0 };
                  }
                  schedByDate[sched.date].hours += sched.hours;
                });

                const dueDateStr = task.dueDate || null;
                const assignedMemberUid = ganttMemberFilter || task.assignedTo;

                const cells = dates.map(d => {
                  const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                  const isToday = d.getTime() === today.getTime();
                  const isMonday = d.getDay() === 1;
                  const dateStr = formatDateLocal(d);
                  const isHoliday = !isWeekend && (assignedMemberUid ? isHolidayForMember(dateStr, assignedMemberUid) : isHolidayOrBlocked(dateStr));
                  const holidayName = assignedMemberUid ? getHolidayNameForMember(dateStr, assignedMemberUid) : getHolidayName(dateStr);

                  const sched = schedByDate[dateStr];
                  let barHtml = '';
                  if (sched) {
                    const schedStatus = sched.status === 'tentative' || sched.tentative ? 'tentative' :
                                        sched.status === 'likely' ? 'likely' : 'locked';
                    const showLocked = document.getElementById('ganttShowLocked')?.checked ?? true;
                    const showLikely = document.getElementById('ganttShowLikely')?.checked ?? true;
                    const showTentative = document.getElementById('ganttShowTentative')?.checked ?? true;
                    const shouldShow = (schedStatus === 'locked' && showLocked) ||
                                       (schedStatus === 'likely' && showLikely) ||
                                       (schedStatus === 'tentative' && showTentative);
                    if (shouldShow) {
                      let barClass = task.completed ? 'completed' : schedStatus === 'locked' ? 'locked-in' : schedStatus === 'likely' ? 'likely' : 'tentative';
                      const statusLabel = schedStatus === 'tentative' ? ' (T)' : schedStatus === 'likely' ? ' (L)' : '';
                      barHtml = `<div class="gantt-bar ${barClass}" data-task-index="${taskIdx}" data-sched-id="${sched.id}" data-date="${dateStr}" title="${sched.hours}h${statusLabel} on ${formatScheduleDate(sched.date)}">${sched.hours}</div>`;
                    }
                  }

                  let dueMarkerHtml = '';
                  if (dueDateStr === dateStr) {
                    dueMarkerHtml = `<div class="gantt-due-marker" title="Due: ${formatScheduleDate(task.dueDate)}"></div>`;
                  }

                  const cellTitle = isHoliday ? holidayName : '';
                  return `<div class="gantt-row-cell ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''} ${isMonday ? 'monday' : ''} ${isHoliday ? 'holiday' : ''}" style="width:${cellWidth}px;" data-date="${dateStr}" title="${cellTitle}">${barHtml}${dueMarkerHtml}</div>`;
                }).join('');

                return `<div class="gantt-row" data-row="${rowIdx}" data-task-index="${taskIdx}">${cells}</div>`;
              }).join('')}
              <div class="gantt-row gantt-totals-row">
                ${dates.map(d => {
                  const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                  const isToday = d.getTime() === today.getTime();
                  const isMonday = d.getDay() === 1;
                  const dateStr = formatDateLocal(d);
                  const isHoliday = !isWeekend && isHolidayOrBlocked(dateStr); // Only highlight weekday holidays
                  const total = totalsByDate[dateStr] || 0;
                  const isOver = total > hoursPerDay;
                  return `<div class="gantt-row-cell gantt-total-cell ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''} ${isMonday ? 'monday' : ''} ${isHoliday ? 'holiday' : ''} ${isOver ? 'over-capacity' : ''}" style="width:${cellWidth}px;">${total > 0 ? total : ''}</div>`;
                }).join('')}
              </div>
            </div>
          </div>
        </div>
      `;

      container.innerHTML = html;

      // Add click handlers for bars - open schedule modal on top of Gantt
      container.querySelectorAll('.gantt-bar').forEach(bar => {
        bar.addEventListener('click', (e) => {
          e.stopPropagation();
          const idx = parseInt(bar.dataset.taskIndex);
          openScheduleModalFromGantt(idx);
        });
      });

      // Add click handlers for sidebar rows
      container.querySelectorAll('.gantt-sidebar-row').forEach(row => {
        row.addEventListener('click', () => {
          if (window._ganttPanned) return;
          const idx = parseInt(row.dataset.taskIndex);
          if (!isNaN(idx)) openScheduleModalFromGantt(idx);
        });
      });

      // Add click handlers for empty cells to add schedule
      container.querySelectorAll('.gantt-row-cell').forEach(cell => {
        cell.addEventListener('click', (e) => {
          // Don't trigger if clicking on a bar or if just finished panning
          if (e.target.closest('.gantt-bar')) return;
          if (window._ganttPanned) return;

          const row = cell.closest('.gantt-row');
          const taskIdx = parseInt(row.dataset.taskIndex);
          const dateStr = cell.dataset.date;
          const memberUid = cell.dataset.memberUid || row.dataset.memberUid || null;

          if (taskIdx >= 0 && dateStr) {
            addScheduleFromGantt(taskIdx, dateStr, memberUid);
          }
        });
      });

      // Add drag handlers for bars
      initGanttDragDrop(container, dates, minDate, cellWidth);

      // Add pan functionality
      initGanttPan();
    }

    function addScheduleFromGantt(taskIdx, dateStr, memberUid = null) {
      const task = tasks[taskIdx];
      if (!task) return;

      // Determine memberUid - use passed value, fall back to current user or first team member
      const effectiveMemberUid = memberUid || currentUser?.uid || (task.team && task.team[0]?.uid) || null;

      // Check if there's already a schedule for this date AND member
      const existing = (task.schedules || []).find(s =>
        s.date === dateStr && s.memberUid === effectiveMemberUid
      );
      if (existing) {
        // Already has entry for this member on this date
        return;
      }

      // Add new schedule with default hours and memberUid
      if (!task.schedules) task.schedules = [];
      task.schedules.push({
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
        date: dateStr,
        hours: hoursPerDay,
        status: 'locked',
        memberUid: effectiveMemberUid
      });

      saveTasks(false);
      if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(task).catch(console.warn);

      // Preserve scroll position when re-rendering
      const modalBody = document.querySelector('#ganttModalBackdrop .modal-body');
      const scrollLeft = modalBody ? modalBody.scrollLeft : 0;
      const scrollTop = modalBody ? modalBody.scrollTop : 0;

      renderGantt();
      renderTasks();

      // Restore scroll position
      if (modalBody) {
        modalBody.scrollLeft = scrollLeft;
        modalBody.scrollTop = scrollTop;
      }
    }

    function initGanttDragDrop(container, dates, minDate, cellWidth) {
      let dragBar = null;
      let dragStartX = 0;
      let dragSchedId = null;
      let dragTaskIndex = null;

      container.querySelectorAll('.gantt-bar').forEach(bar => {
        bar.addEventListener('mousedown', (e) => {
          e.preventDefault();
          dragBar = bar;
          dragStartX = e.clientX;
          dragSchedId = bar.dataset.schedId;
          dragTaskIndex = parseInt(bar.dataset.taskIndex);
          bar.style.opacity = '0.7';
          bar.style.position = 'relative';
          bar.style.zIndex = '10';
        });
      });

      document.addEventListener('mousemove', (e) => {
        if (!dragBar) return;
        const dx = e.clientX - dragStartX;
        dragBar.style.transform = `translateX(${dx}px)`;
      });

      document.addEventListener('mouseup', (e) => {
        if (!dragBar) return;

        // Find which cell we dropped on
        dragBar.style.visibility = 'hidden'; // Hide bar to get cell beneath
        const elem = document.elementFromPoint(e.clientX, e.clientY);
        dragBar.style.visibility = '';

        // Find the cell (could be the cell itself or a child)
        const cell = elem?.closest('.gantt-row-cell');
        if (cell && cell.dataset.date) {
          const newDateStr = cell.dataset.date;

          // Update the schedule
          const task = tasks[dragTaskIndex];
          const sched = task.schedules.find(s => s.id === dragSchedId);
          if (sched && sched.date !== newDateStr) {
            sched.date = newDateStr;
            saveTasks(false);
            if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(task).catch(console.warn);
            renderGantt();
            renderTasks();
          }
        }

        // Reset bar styles
        dragBar.style.opacity = '1';
        dragBar.style.transform = '';
        dragBar.style.position = '';
        dragBar.style.zIndex = '';
        dragBar = null;
        dragSchedId = null;
        dragTaskIndex = null;
      });
    }

    // Gantt pan functionality - called after render
    let ganttPanState = { active: false, timeline: null, modalBody: null, startX: 0, startY: 0, scrollX: 0, scrollY: 0 };

    function initGanttPan() {
      const timeline = document.querySelector('.gantt-timeline');
      const modalBody = document.querySelector('#ganttModalBackdrop .modal-body');
      if (!timeline || !modalBody) return;

      timeline.addEventListener('mousedown', (e) => {
        if (e.target.closest('.gantt-bar')) return;
        if (e.button !== 0) return;

        ganttPanState.active = true;
        ganttPanState.timeline = timeline;
        ganttPanState.modalBody = modalBody;
        ganttPanState.startX = e.pageX;
        ganttPanState.startY = e.pageY;
        ganttPanState.scrollX = timeline.scrollLeft;
        ganttPanState.scrollY = modalBody.scrollTop;
        timeline.style.cursor = 'grabbing';
        document.body.style.cursor = 'grabbing';
        e.preventDefault();
        e.stopPropagation();
      });
    }

    // Global mouse handlers for pan
    document.addEventListener('mousemove', (e) => {
      if (!ganttPanState.active) return;
      const dx = e.pageX - ganttPanState.startX;
      const dy = e.pageY - ganttPanState.startY;
      ganttPanState.timeline.scrollLeft = ganttPanState.scrollX - dx;
      ganttPanState.modalBody.scrollTop = ganttPanState.scrollY - dy;

      if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
        window._ganttPanned = true;
      }
    });

    document.addEventListener('mouseup', () => {
      if (ganttPanState.active) {
        if (ganttPanState.timeline) ganttPanState.timeline.style.cursor = '';
        document.body.style.cursor = '';
        ganttPanState.active = false;
        setTimeout(() => { window._ganttPanned = false; }, 100);
      }
    });

    // Draggable modal functionality
    function initDraggableModal(modalId, handleSelector) {
      const modal = document.getElementById(modalId);
      const handle = modal?.querySelector(handleSelector);
      if (!modal || !handle) return;

      let isDragging = false;
      let startX = 0;
      let startY = 0;
      let modalX = 0;
      let modalY = 0;

      // Center modal initially
      function centerModal() {
        const rect = modal.getBoundingClientRect();
        modalX = (window.innerWidth - rect.width) / 2;
        modalY = (window.innerHeight - rect.height) / 2;
        modal.style.left = modalX + 'px';
        modal.style.top = modalY + 'px';
      }

      handle.addEventListener('mousedown', (e) => {
        // Don't drag if clicking on interactive elements
        if (e.target.closest('input') || e.target.closest('button') || e.target.closest('select') || e.target.closest('label')) return;

        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;

        const rect = modal.getBoundingClientRect();
        modalX = rect.left;
        modalY = rect.top;

        document.body.style.cursor = 'move';
        e.preventDefault();
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;

        const dx = e.clientX - startX;
        const dy = e.clientY - startY;

        modal.style.left = (modalX + dx) + 'px';
        modal.style.top = (modalY + dy) + 'px';
      });

      document.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          document.body.style.cursor = '';
        }
      });

      // Center when modal opens
      const backdrop = modal.closest('.modal-backdrop');
      if (backdrop) {
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.attributeName === 'style') {
              const display = backdrop.style.display;
              if (display === 'flex' || display === 'block') {
                centerModal();
              }
            }
          });
        });
        observer.observe(backdrop, { attributes: true });
      }
    }

    // Initialize draggable Gantt modal
    initDraggableModal('ganttModal', '.draggable-handle');

    // Weekly Total functionality
    let weeklyDateFrom = '';
    let weeklyDateTo = '';
    let weeklyShowAvailableOnly = false;

    function renderWeeklyTotal() {
      // Get filter values
      const filterFrom = weeklyDateFrom ? new Date(weeklyDateFrom) : null;
      const filterTo = weeklyDateTo ? new Date(weeklyDateTo) : null;
      const showAvailableOnly = weeklyShowAvailableOnly;
      const weeklyAvailable = hoursPerDay * 5;

      // Collect all scheduled hours from all tasks
      const hoursByDate = {};
      tasks.forEach(task => {
        if (task.completed) return;
        (task.schedules || []).forEach(sched => {
          const schedDate = new Date(sched.date);
          // Apply date filter
          if (filterFrom && schedDate < filterFrom) return;
          if (filterTo && schedDate > filterTo) return;

          if (!hoursByDate[sched.date]) hoursByDate[sched.date] = 0;
          hoursByDate[sched.date] += sched.hours;
        });
      });

      // Group by week (Monday to Sunday)
      const weeklyTotals = {};
      Object.keys(hoursByDate).sort().forEach(dateStr => {
        const date = new Date(dateStr);
        // Get Monday of this week
        const day = date.getDay();
        const diff = day === 0 ? -6 : 1 - day; // Adjust for Monday start
        const monday = new Date(date);
        monday.setDate(date.getDate() + diff);
        const weekKey = monday.toISOString().split('T')[0];

        if (!weeklyTotals[weekKey]) {
          weeklyTotals[weekKey] = { hours: 0, days: 0 };
        }
        weeklyTotals[weekKey].hours += hoursByDate[dateStr];
        weeklyTotals[weekKey].days++;
      });

      // Build HTML
      let weeks = Object.keys(weeklyTotals).sort();

      // Filter to only weeks with capacity available if checkbox is checked
      if (showAvailableOnly) {
        weeks = weeks.filter(weekKey => {
          const capacity = weeklyAvailable - weeklyTotals[weekKey].hours;
          return capacity > 0;
        });
      }

      let html = '';

      if (weeks.length === 0) {
        html = '<p style="color:var(--muted); text-align:center;">No scheduled time found.</p>';
      } else {
        let grandTotal = 0;
        let weeksShown = 0;
        html = '<table style="width:100%; border-collapse:collapse;">';
        html += '<thead><tr style="border-bottom:2px solid var(--border);">';
        html += '<th style="text-align:left; padding:8px; color:var(--muted);">Week Starting</th>';
        html += '<th style="text-align:center; padding:8px; color:var(--muted);">Days</th>';
        html += '<th style="text-align:right; padding:8px; color:var(--muted);">Hours</th>';
        html += '<th style="text-align:right; padding:8px; color:var(--muted);">Available</th>';
        html += '<th style="text-align:right; padding:8px; color:var(--muted);">Capacity</th>';
        html += '<th style="text-align:right; padding:8px; color:var(--muted);">Avg/Day</th>';
        html += '</tr></thead><tbody>';

        weeks.forEach(weekKey => {
          const data = weeklyTotals[weekKey];
          const weekDate = new Date(weekKey);
          const weekEnd = new Date(weekDate);
          weekEnd.setDate(weekEnd.getDate() + 6);
          const avgPerDay = (data.hours / data.days).toFixed(1);
          grandTotal += data.hours;
          weeksShown++;

          const capacity = weeklyAvailable - data.hours;
          const capacityColor = capacity >= 0 ? 'color:#22c55e;' : 'color:#ef4444;';

          html += `<tr style="border-bottom:1px solid var(--border);">`;
          html += `<td style="padding:8px;">${formatScheduleDate(weekKey)} - ${formatScheduleDate(weekEnd.toISOString().split('T')[0])}</td>`;
          html += `<td style="text-align:center; padding:8px;">${data.days}</td>`;
          html += `<td style="text-align:right; padding:8px; font-weight:700;">${data.hours.toFixed(1)}h</td>`;
          html += `<td style="text-align:right; padding:8px;">${weeklyAvailable.toFixed(1)}h</td>`;
          html += `<td style="text-align:right; padding:8px; font-weight:700; ${capacityColor}">${capacity >= 0 ? '+' : ''}${capacity.toFixed(1)}h</td>`;
          html += `<td style="text-align:right; padding:8px;">${avgPerDay}h</td>`;
          html += '</tr>';
        });

        html += '</tbody>';
        const totalAvailable = weeklyAvailable * weeks.length;
        const totalCapacity = totalAvailable - grandTotal;
        const totalCapacityColor = totalCapacity >= 0 ? 'color:#22c55e;' : 'color:#ef4444;';
        html += '<tfoot><tr style="border-top:2px solid var(--teal); background:rgba(20,184,166,0.1);">';
        html += `<td style="padding:8px; font-weight:700; color:var(--teal);">Grand Total</td>`;
        html += `<td style="text-align:center; padding:8px;"></td>`;
        html += `<td style="text-align:right; padding:8px; font-weight:700; color:var(--teal);">${grandTotal.toFixed(1)}h</td>`;
        html += `<td style="text-align:right; padding:8px; color:var(--teal);">${totalAvailable.toFixed(1)}h</td>`;
        html += `<td style="text-align:right; padding:8px; font-weight:700; ${totalCapacityColor}">${totalCapacity >= 0 ? '+' : ''}${totalCapacity.toFixed(1)}h</td>`;
        html += `<td style="text-align:right; padding:8px;"></td>`;
        html += '</tr></tfoot></table>';
      }

      document.getElementById('weeklyTotalContent').innerHTML = html;
    }

    function showWeeklyTotal() {
      // Sync UI with state
      document.getElementById('weeklyDateFrom').value = weeklyDateFrom;
      document.getElementById('weeklyDateTo').value = weeklyDateTo;
      document.getElementById('weeklyShowAvailable').checked = weeklyShowAvailableOnly;
      renderWeeklyTotal();
      showModal('weeklyTotalBackdrop');
    }

    function updateWeeklyFilters() {
      weeklyDateFrom = document.getElementById('weeklyDateFrom').value;
      weeklyDateTo = document.getElementById('weeklyDateTo').value;
      weeklyShowAvailableOnly = document.getElementById('weeklyShowAvailable').checked;
      renderWeeklyTotal();
    }

    function resetWeeklyFilters() {
      weeklyDateFrom = '';
      weeklyDateTo = '';
      document.getElementById('weeklyDateFrom').value = '';
      document.getElementById('weeklyDateTo').value = '';
      renderWeeklyTotal();
    }

    document.getElementById('ganttWeeklyTotal').addEventListener('click', showWeeklyTotal);
    document.getElementById('weeklyTotalClose').addEventListener('click', () => hideModal('weeklyTotalBackdrop'));
    document.getElementById('weeklyTotalBackdrop').addEventListener('mousedown', (e) => {
      if (e.target.id === 'weeklyTotalBackdrop') hideModal('weeklyTotalBackdrop');
    });
    document.getElementById('weeklyDateFrom').addEventListener('change', updateWeeklyFilters);
    document.getElementById('weeklyDateTo').addEventListener('change', updateWeeklyFilters);
    document.getElementById('weeklyDateReset').addEventListener('click', resetWeeklyFilters);
    document.getElementById('weeklyShowAvailable').addEventListener('change', updateWeeklyFilters);

    // ===== Capacity Checker =====
    function showCapacityChecker() {
      // Default to next 30 days
      const today = new Date();
      const endDate = new Date(today);
      endDate.setDate(endDate.getDate() + 30);

      document.getElementById('capacityDateFrom').value = today.toISOString().split('T')[0];
      document.getElementById('capacityDateTo').value = endDate.toISOString().split('T')[0];
      document.getElementById('capacityContent').innerHTML = '<p style="color:var(--muted); text-align:center;">Select a date range and click Check</p>';
      showModal('capacityModalBackdrop');
    }

    function checkCapacity() {
      const fromDate = document.getElementById('capacityDateFrom').value;
      const toDate = document.getElementById('capacityDateTo').value;

      if (!fromDate || !toDate) {
        toast('Please select both dates');
        return;
      }

      const start = new Date(fromDate);
      const end = new Date(toDate);

      if (end < start) {
        toast('End date must be after start date');
        return;
      }

      // Collect all scheduled hours by date (excluding completed tasks)
      const hoursByDate = {};
      tasks.forEach(task => {
        if (task.completed) return;
        (task.schedules || []).forEach(sched => {
          if (!hoursByDate[sched.date]) hoursByDate[sched.date] = 0;
          hoursByDate[sched.date] += sched.hours;
        });
      });

      // Find dates with available capacity
      const availableDates = [];
      const current = new Date(start);

      while (current <= end) {
        const dayOfWeek = current.getDay();
        const isWeekday = dayOfWeek !== 0 && dayOfWeek !== 6;

        if (isWeekday) {
          const dateStr = current.toISOString().split('T')[0];
          const scheduled = hoursByDate[dateStr] || 0;
          const available = hoursPerDay - scheduled;

          if (available > 0) {
            availableDates.push({
              date: dateStr,
              scheduled: scheduled,
              available: available
            });
          }
        }

        current.setDate(current.getDate() + 1);
      }

      // Build HTML
      let html = '';
      if (availableDates.length === 0) {
        html = '<p style="color:var(--muted); text-align:center;">No available capacity in this date range.</p>';
      } else {
        html = `<p style="color:var(--teal); margin-bottom:12px;">${availableDates.length} days with available capacity:</p>`;
        html += '<table style="width:100%; border-collapse:collapse;">';
        html += '<thead><tr style="border-bottom:2px solid var(--border);">';
        html += '<th style="text-align:left; padding:8px; color:var(--muted);">Date</th>';
        html += '<th style="text-align:right; padding:8px; color:var(--muted);">Scheduled</th>';
        html += '<th style="text-align:right; padding:8px; color:var(--muted);">Available</th>';
        html += '</tr></thead><tbody>';

        availableDates.forEach(d => {
          html += '<tr style="border-bottom:1px solid var(--border);">';
          html += `<td style="padding:8px;">${formatScheduleDate(d.date)}</td>`;
          html += `<td style="text-align:right; padding:8px;">${d.scheduled.toFixed(1)}h</td>`;
          html += `<td style="text-align:right; padding:8px; color:#22c55e; font-weight:700;">${d.available.toFixed(1)}h</td>`;
          html += '</tr>';
        });

        html += '</tbody></table>';

        // Summary
        const totalAvailable = availableDates.reduce((sum, d) => sum + d.available, 0);
        html += `<p style="color:var(--teal); margin-top:16px; font-weight:700;">Total available: ${totalAvailable.toFixed(1)}h</p>`;
      }

      document.getElementById('capacityContent').innerHTML = html;
    }

    document.getElementById('capacityBtn').addEventListener('click', showCapacityChecker);
    document.getElementById('capacityClose').addEventListener('click', () => hideModal('capacityModalBackdrop'));
    document.getElementById('capacityModalBackdrop').addEventListener('mousedown', (e) => {
      if (e.target.id === 'capacityModalBackdrop') hideModal('capacityModalBackdrop');
    });
    document.getElementById('capacityCheck').addEventListener('click', checkCapacity);

    // ===== Client Search Modal =====
    let clientSearchTaskIndex = null;

    // ===== Add Client Confirm Modal =====
    let pendingClientName = null;
    let pendingClientDescInput = null;

    function showAddClientConfirm(clientName, descInput) {
      pendingClientName = clientName;
      pendingClientDescInput = descInput;
      document.getElementById('addClientConfirmText').textContent = `Add "${clientName}" to client list?`;
      showModal('addClientConfirmBackdrop');
    }

    function handleAddClientYes() {
      if (pendingClientName) {
        masterClients.push(pendingClientName);
        masterClients.sort((a, b) => a.localeCompare(b));
        saveMasterLists();
        updateClientDatalist();
      }
      hideModal('addClientConfirmBackdrop');
      if (pendingClientDescInput) {
        pendingClientDescInput.focus();
      }
      pendingClientName = null;
      pendingClientDescInput = null;
    }

    function handleAddClientNo() {
      hideModal('addClientConfirmBackdrop');
      if (pendingClientDescInput) {
        pendingClientDescInput.focus();
      }
      pendingClientName = null;
      pendingClientDescInput = null;
    }

    function openClientSearch(taskIndex) {
      clientSearchTaskIndex = taskIndex;
      document.getElementById('clientSearchInput').value = '';
      renderClientSearchResults('');
      showModal('clientSearchBackdrop');
      setTimeout(() => document.getElementById('clientSearchInput').focus(), 50);
    }

    function closeClientSearch() {
      clientSearchTaskIndex = null;
      hideModal('clientSearchBackdrop');
    }

    function renderClientSearchResults(query) {
      const container = document.getElementById('clientSearchResults');
      container.innerHTML = '';

      const q = (query || '').toLowerCase().trim();
      const filtered = masterClients.filter(c => c.toLowerCase().includes(q));

      if (filtered.length === 0) {
        container.innerHTML = '<div class="subtle" style="text-align:center; padding:16px;">No clients found</div>';
        return;
      }

      filtered.forEach(client => {
        const row = document.createElement('div');
        row.style.cssText = 'padding:10px 12px; cursor:pointer; border-bottom:1px solid var(--border); color:var(--text);';
        row.textContent = client;
        row.addEventListener('mouseenter', () => row.style.background = 'var(--panel-2)');
        row.addEventListener('mouseleave', () => row.style.background = 'transparent');
        row.addEventListener('click', () => selectClientFromSearch(client));
        container.appendChild(row);
      });
    }

    function selectClientFromSearch(clientName) {
      if (clientSearchTaskIndex === null) return;

      tasks[clientSearchTaskIndex].client = clientName;
      saveTasks(false);
      if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(tasks[clientSearchTaskIndex]).catch(console.warn);

      closeClientSearch();
      renderTasks();

      // Focus on description field of the selected row
      setTimeout(() => {
        const row = document.querySelector(`tr[data-task-index="${clientSearchTaskIndex}"]`);
        if (row) {
          const descInput = row.querySelector('input[data-field="description"]');
          if (descInput) descInput.focus();
        }
      }, 50);
    }

    function addLinkToTask(raw) {
      if (linksTaskIndex == null) return;

      const parts = String(raw || '')
        .split(/\r?\n|,|;/g)
        .map(s => s.trim())
        .filter(Boolean);

      if (parts.length === 0) return;

      tasks[linksTaskIndex].items = tasks[linksTaskIndex].items || [];
      for (const url of parts) tasks[linksTaskIndex].items.push({ type: 'url', label: url, href: url });

      saveTasks(true);
      if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(tasks[linksTaskIndex]).catch(console.warn);
      renderLinksList();
      renderTasks();
    }

    function removeItemFromTask(itemIndex) {
      if (linksTaskIndex == null) return;
      const arr = tasks[linksTaskIndex].items || [];
      arr.splice(itemIndex, 1);
      tasks[linksTaskIndex].items = arr;
      saveTasks(true);
      if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(tasks[linksTaskIndex]).catch(console.warn);
      renderLinksList();
      renderTasks();
    }

    function renderLinksList() {
      const list = document.getElementById('linksList');
      list.innerHTML = '';
      if (linksTaskIndex == null) return;
      const t = tasks[linksTaskIndex];
      const items = Array.isArray(t.items) ? t.items : [];

      if (items.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'subtle';
        empty.textContent = 'No links or documents.';
        list.appendChild(empty);
        return;
      }

      items.forEach((it, idx) => {
        const row = document.createElement('div');
        row.className = 'list-item';

        const label = document.createElement('div');
        if (it.type === 'file') {
          label.innerHTML = `<span class="pill">FILE</span> <span style="margin-left:8px;">${escapeHtml(it.label || 'file')}</span>`;
        } else {
          const a = document.createElement('a');
          a.href = it.href;
          a.target = '_blank';
          a.rel = 'noreferrer';
          a.textContent = it.label || it.href;
          label.appendChild(a);
        }

        const openBtn = document.createElement('button');
        openBtn.className = 'mini';
        openBtn.type = 'button';
        openBtn.textContent = 'Open';
        openBtn.addEventListener('click', () => {
          if (it.type === 'file') {
            const dataUrl = it.dataUrl;
            if (!dataUrl) return;
            const win = window.open();
            if (win) win.location.href = dataUrl;
          } else {
            window.open(it.href, '_blank', 'noreferrer');
          }
        });

        const delBtn = document.createElement('button');
        delBtn.className = 'mini btn-danger';
        delBtn.type = 'button';
        delBtn.textContent = 'Remove';
        delBtn.addEventListener('click', () => removeItemFromTask(idx));

        row.appendChild(label);
        row.appendChild(openBtn);
        row.appendChild(delBtn);
        list.appendChild(row);
      });
    }

    async function attachFileToTask(file) {
      if (linksTaskIndex == null) return;
      if (!file) return;

      const maxBytes = 1_500_000;
      if (file.size > maxBytes) {
        alert('File is too large for local storage. Please upload it to Drive/SharePoint and paste the link instead.');
        return;
      }

      const dataUrl = await readAsDataURL(file);
      tasks[linksTaskIndex].items = tasks[linksTaskIndex].items || [];
      tasks[linksTaskIndex].items.push({ type: 'file', label: file.name, dataUrl });
      saveTasks(true);
      if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(tasks[linksTaskIndex]).catch(console.warn);
      renderLinksList();
      renderTasks();
    }

    function readAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(String(reader.result || ''));
        reader.onerror = () => reject(reader.error);
        reader.readAsDataURL(file);
      });
    }

    function buildWorkListText() {
      const decorated = tasks.map((task, index) => ({ task, index }));
      let open = decorated.filter(x => !x.task.completed);
      if (sortClient !== 'none' || sortDue !== 'none' || sortPriority !== 'none') open = [...open].sort(compareBySort);

      const now = new Date();
      const dateStr = `${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')}/${now.getFullYear()}`;
      const timeStr = now.toLocaleTimeString();
      const header = `Raze ‚Äî Work list\n${dateStr}, ${timeStr}\n`;
      if (open.length === 0) return header + `\n(No open tasks)\n`;

      const lines = open.map((x, i) => {
        const t = x.task;
        const p = t.priority || 'Medium';
        const c = (t.client || '').trim() || '‚Äî';
        const d = (t.description || '').trim() || '‚Äî';
        const tm = formatHMS(t.seconds || 0);
        return `${String(i + 1).padStart(2, '0')}. [${p}] ${c} ‚Äî ${d} (Time: ${tm})`;
      });

      return header + `\n` + lines.join(`\n`) + `\n`;
    }

    function emailWorkList() {
      const body = buildWorkListText();
      const subject = `Work list ‚Äî ${new Date().toLocaleDateString()}`;

      let to = localStorage.getItem(EMAIL_TO_KEY) || '';
      const ask = prompt('Send to email address (leave blank to choose in your email app):', to);
      if (ask === null) return;
      to = (ask || '').trim();
      localStorage.setItem(EMAIL_TO_KEY, to);

      const url = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.location.href = url;
    }

    async function copyWorkList() {
      const text = buildWorkListText();
      try {
        await navigator.clipboard.writeText(text);
        showToast('Copied to clipboard');
      } catch {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
      }
    }

    function downloadExcel() {
      // Filter non-blank tasks (tasks with client or description)
      const exportTasks = tasks.filter(t => (t.client || '').trim() || (t.description || '').trim());

      // Build data array with headers
      const data = [
        ['No.', 'Client', 'Task', 'Job Type', 'Status', 'Due Date', 'Completed']
      ];

      exportTasks.forEach((t, index) => {
        // Format due date as dd-mmm-yy
        let dueDateFormatted = '';
        if (t.dueDate) {
          const d = new Date(t.dueDate);
          const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          const day = String(d.getDate()).padStart(2, '0');
          const month = months[d.getMonth()];
          const year = String(d.getFullYear()).slice(-2);
          dueDateFormatted = `${day}-${month}-${year}`;
        }

        data.push([
          index + 1,
          t.client || '',
          t.description || '',
          t.jobType || '',
          t.status || '',
          dueDateFormatted,
          t.completed ? 'Yes' : 'No'
        ]);
      });

      // Create workbook and worksheet
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(data);

      // Set column widths (width in characters)
      ws['!cols'] = [
        { wch: 8 },   // Column 1: No.
        { wch: 20 },  // Column 2: Client
        { wch: 60 },  // Column 3: Task
        { wch: 20 },  // Column 4: Job Type
        { wch: 20 },  // Column 5: Status
        { wch: 20 },  // Column 6: Due Date
        { wch: 10 }   // Column 7: Completed
      ];

      XLSX.utils.book_append_sheet(wb, ws, 'Tasks');

      // Generate filename with date
      const now = new Date();
      const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
      const filename = `Raze_Tasks_${dateStr}.xlsx`;

      // Download
      XLSX.writeFile(wb, filename);
    }

    // ===== THEME TOGGLE =====
    function getPreferredTheme() {
      const stored = localStorage.getItem(THEME_KEY);
      if (stored) return stored;
      return window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
    }

    function setTheme(theme) {
      if (theme === 'light') {
        document.documentElement.classList.add('light');
      } else {
        document.documentElement.classList.remove('light');
      }
      localStorage.setItem(THEME_KEY, theme);
      updateThemeToggleIcon();
    }

    function toggleTheme() {
      const current = document.documentElement.classList.contains('light') ? 'light' : 'dark';
      setTheme(current === 'light' ? 'dark' : 'light');
    }

    function updateThemeToggleIcon() {
      const btn = document.getElementById('themeToggle');
      if (btn) {
        const isLight = document.documentElement.classList.contains('light');
        btn.textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
        btn.title = isLight ? 'Switch to dark theme' : 'Switch to light theme';
      }
    }

    // ===== NOTIFICATIONS =====
    let notificationCheckInterval = null;
    let notifiedTaskIds = new Set(JSON.parse(localStorage.getItem(NOTIFIED_TASKS_KEY) || '[]'));

    function getNotificationSettings() {
      const defaults = { enabled: false, overdue: true, dueSoon: true, interval: 15 };
      try {
        return { ...defaults, ...JSON.parse(localStorage.getItem(NOTIFICATIONS_KEY) || '{}') };
      } catch { return defaults; }
    }

    function saveNotificationSettings(settings) {
      localStorage.setItem(NOTIFICATIONS_KEY, JSON.stringify(settings));
    }

    function updateNotificationStatus() {
      const statusEl = document.getElementById('notificationStatus');
      if (!statusEl) return;
      if (!('Notification' in window)) {
        statusEl.textContent = 'Notifications not supported in this browser';
        return;
      }
      const perm = Notification.permission;
      if (perm === 'granted') {
        statusEl.textContent = 'Notifications enabled';
        statusEl.style.color = 'var(--success)';
      } else if (perm === 'denied') {
        statusEl.textContent = 'Notifications blocked. Please enable in browser settings.';
        statusEl.style.color = 'var(--danger)';
      } else {
        statusEl.textContent = 'Click button above to enable notifications';
        statusEl.style.color = 'var(--muted)';
      }
    }

    async function requestNotificationPermission() {
      if (!('Notification' in window)) {
        toast('Notifications not supported');
        return;
      }
      const permission = await Notification.requestPermission();
      updateNotificationStatus();
      if (permission === 'granted') {
        const settings = getNotificationSettings();
        settings.enabled = true;
        saveNotificationSettings(settings);
        document.getElementById('notificationsEnabled').checked = true;
        startNotificationChecker();
        toast('Notifications enabled');
      }
    }

    function showTaskNotification(task, type) {
      if (Notification.permission !== 'granted') return;
      const title = type === 'overdue' ? '‚ö†Ô∏è Overdue Task' : '‚è∞ Task Due Soon';
      const body = `${task.client}: ${task.description}`;
      try {
        new Notification(title, { body, icon: '‚è±Ô∏è', tag: task.id });
        notifiedTaskIds.add(task.id);
        localStorage.setItem(NOTIFIED_TASKS_KEY, JSON.stringify([...notifiedTaskIds]));
      } catch (e) { console.warn('Notification failed:', e); }
    }

    function checkDueNotifications() {
      const settings = getNotificationSettings();
      if (!settings.enabled || Notification.permission !== 'granted') return;

      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 2);

      tasks.forEach(task => {
        if (task.completed || !task.dueDate || notifiedTaskIds.has(task.id)) return;
        const due = new Date(task.dueDate);

        if (settings.overdue && due < today) {
          showTaskNotification(task, 'overdue');
        } else if (settings.dueSoon && due >= today && due < tomorrow) {
          showTaskNotification(task, 'dueSoon');
        }
      });
    }

    function startNotificationChecker() {
      if (notificationCheckInterval) clearInterval(notificationCheckInterval);
      const settings = getNotificationSettings();
      if (!settings.enabled) return;
      const intervalMs = (settings.interval || 15) * 60 * 1000;
      notificationCheckInterval = setInterval(checkDueNotifications, intervalMs);
      checkDueNotifications();
    }

    function openNotificationsModal() {
      const settings = getNotificationSettings();
      document.getElementById('notificationsEnabled').checked = settings.enabled;
      document.getElementById('notifyOverdue').checked = settings.overdue;
      document.getElementById('notifyDueSoon').checked = settings.dueSoon;
      document.getElementById('notificationInterval').value = settings.interval || 15;
      updateNotificationStatus();
      showModal('notificationsModalBackdrop');
    }

    // ===== RECURRING TASKS =====
    let recurringTaskIndex = null;

    function calculateNextOccurrence(pattern, fromDate) {
      const from = fromDate ? new Date(fromDate) : new Date();
      const next = new Date(from);

      switch (pattern.type) {
        case 'weekly':
          next.setDate(next.getDate() + (pattern.interval || 1) * 7);
          if (pattern.dayOfWeek !== undefined) {
            const diff = (pattern.dayOfWeek - next.getDay() + 7) % 7;
            next.setDate(next.getDate() + diff);
          }
          break;
        case 'monthly':
          next.setMonth(next.getMonth() + (pattern.interval || 1));
          if (pattern.dayOfMonth) {
            next.setDate(Math.min(pattern.dayOfMonth, new Date(next.getFullYear(), next.getMonth() + 1, 0).getDate()));
          }
          break;
        case 'yearly':
          next.setFullYear(next.getFullYear() + (pattern.interval || 1));
          break;
        case 'custom':
          next.setDate(next.getDate() + (pattern.interval || 1));
          break;
      }
      return next.toISOString().split('T')[0];
    }

    function createRecurringInstance(parentTask) {
      const instance = backfillTask({
        ...parentTask,
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
        isRecurring: false,
        recurrencePattern: null,
        parentTaskId: parentTask.id,
        completed: false,
        seconds: 0,
        status: 'Not Started',
        dueDate: parentTask.nextOccurrence || '',
        createdAt: new Date().toISOString()
      });
      return instance;
    }

    function processRecurringTasks() {
      const today = new Date().toISOString().split('T')[0];
      const recurringTasks = tasks.filter(t => t.isRecurring && t.nextOccurrence);

      recurringTasks.forEach(task => {
        if (task.nextOccurrence <= today) {
          const instance = createRecurringInstance(task);
          tasks.push(instance);
          task.nextOccurrence = calculateNextOccurrence(task.recurrencePattern, task.nextOccurrence);
          persistTaskToFirestore(task).catch(console.warn);
          persistTaskToFirestore(instance).catch(console.warn);
        }
      });

      if (recurringTasks.length > 0) {
        saveTasks(false);
        renderTasks();
      }
    }

    function openRecurringModal(index) {
      recurringTaskIndex = index;
      const task = tasks[index];
      document.getElementById('recurringTaskId').textContent = task.id;
      document.getElementById('isRecurring').checked = task.isRecurring;
      document.getElementById('recurrenceSettings').style.display = task.isRecurring ? 'grid' : 'none';

      if (task.recurrencePattern) {
        document.getElementById('recurrenceType').value = task.recurrencePattern.type || 'weekly';
        document.getElementById('recurrenceInterval').value = task.recurrencePattern.interval || 1;
        document.getElementById('recurrenceDayOfWeek').value = task.recurrencePattern.dayOfWeek || 0;
        document.getElementById('recurrenceDayOfMonth').value = task.recurrencePattern.dayOfMonth || 1;
      }
      updateRecurrenceUI();
      showModal('recurringModalBackdrop');
    }

    function updateRecurrenceUI() {
      const type = document.getElementById('recurrenceType').value;
      const labels = { weekly: 'week(s)', monthly: 'month(s)', yearly: 'year(s)', custom: 'day(s)' };
      document.getElementById('recurrenceIntervalLabel').textContent = labels[type] || 'period(s)';
      document.getElementById('dayOfWeekRow').style.display = type === 'weekly' ? 'flex' : 'none';
      document.getElementById('dayOfMonthRow').style.display = ['monthly', 'yearly'].includes(type) ? 'flex' : 'none';
    }

    function saveRecurringSettings() {
      if (recurringTaskIndex === null) return;
      const task = tasks[recurringTaskIndex];
      const isRecurring = document.getElementById('isRecurring').checked;

      task.isRecurring = isRecurring;
      if (isRecurring) {
        task.recurrencePattern = {
          type: document.getElementById('recurrenceType').value,
          interval: parseInt(document.getElementById('recurrenceInterval').value) || 1,
          dayOfWeek: parseInt(document.getElementById('recurrenceDayOfWeek').value),
          dayOfMonth: parseInt(document.getElementById('recurrenceDayOfMonth').value)
        };
        if (!task.nextOccurrence) {
          task.nextOccurrence = calculateNextOccurrence(task.recurrencePattern, task.dueDate || new Date());
        }
      } else {
        task.recurrencePattern = null;
        task.nextOccurrence = null;
      }

      saveTasks(false);
      persistTaskToFirestore(task).catch(console.warn);
      renderTasks();
      hideModal('recurringModalBackdrop');
      toast(isRecurring ? 'Recurring task enabled' : 'Recurring disabled');
    }

    // ===== TASK DEPENDENCIES =====
    let dependencyTaskIndex = null;

    function hasUnmetDependencies(task) {
      if (!task.dependsOn || task.dependsOn.length === 0) return false;
      return task.dependsOn.some(depId => {
        const depTask = tasks.find(t => t.id === depId);
        return depTask && !depTask.completed;
      });
    }

    function getDependencyStatus(task) {
      if (!task.dependsOn) return [];
      return task.dependsOn.map(depId => {
        const depTask = tasks.find(t => t.id === depId);
        return depTask ? { id: depId, task: depTask, complete: depTask.completed } : null;
      }).filter(Boolean);
    }

    function wouldCreateCircularDependency(taskId, newDepId, visited = new Set()) {
      if (taskId === newDepId) return true;
      if (visited.has(newDepId)) return false;
      visited.add(newDepId);

      const depTask = tasks.find(t => t.id === newDepId);
      if (!depTask || !depTask.dependsOn) return false;

      return depTask.dependsOn.some(subDepId => wouldCreateCircularDependency(taskId, subDepId, visited));
    }

    function addDependency(taskIndex, depTaskId) {
      const task = tasks[taskIndex];
      if (!task.dependsOn) task.dependsOn = [];
      if (task.dependsOn.includes(depTaskId)) return;
      if (wouldCreateCircularDependency(task.id, depTaskId)) {
        toast('Cannot add: would create circular dependency');
        return;
      }
      task.dependsOn.push(depTaskId);
      saveTasks(false);
      persistTaskToFirestore(task).catch(console.warn);
      renderDependencyList(taskIndex);
      renderTasks();
    }

    function removeDependency(taskIndex, depTaskId) {
      const task = tasks[taskIndex];
      if (!task.dependsOn) return;
      task.dependsOn = task.dependsOn.filter(id => id !== depTaskId);
      saveTasks(false);
      persistTaskToFirestore(task).catch(console.warn);
      renderDependencyList(taskIndex);
      renderTasks();
    }

    function openDependenciesModal(index) {
      dependencyTaskIndex = index;
      const task = tasks[index];
      document.getElementById('dependencyTaskId').textContent = task.id;
      renderDependencyList(index);
      populateDependencySelect(index);
      showModal('dependenciesModalBackdrop');
    }

    function renderDependencyList(index) {
      const task = tasks[index];
      const list = document.getElementById('dependencyList');
      const deps = getDependencyStatus(task);

      if (deps.length === 0) {
        list.innerHTML = '<div class="subtle" style="padding:12px; text-align:center;">No dependencies</div>';
        return;
      }

      list.innerHTML = deps.map(dep => `
        <div class="dependency-item">
          <span class="dependency-status ${dep.complete ? 'complete' : 'incomplete'}">${dep.complete ? '‚úì' : ''}</span>
          <span style="flex:1; color:var(--text);">${escapeHtml(dep.task.client)}: ${escapeHtml(dep.task.description)}</span>
          <button type="button" class="btn-danger" style="padding:2px 8px; font-size:11px;" onclick="removeDependency(${index}, '${dep.id}')">Remove</button>
        </div>
      `).join('');
    }

    function populateDependencySelect(index) {
      const task = tasks[index];
      const select = document.getElementById('addDependencySelect');
      const availableTasks = tasks.filter(t =>
        t.id !== task.id &&
        !task.dependsOn?.includes(t.id) &&
        !wouldCreateCircularDependency(task.id, t.id)
      );

      select.innerHTML = '<option value="">Select a task...</option>' +
        availableTasks.map(t => `<option value="${t.id}">${escapeHtml(t.client)}: ${escapeHtml(t.description)}</option>`).join('');
    }

    // ===== DRAG AND DROP =====
    let draggedRow = null;
    let draggedTaskIndex = null;

    function onRowDragStart(e, index) {
      draggedRow = e.target.closest('tr');
      draggedTaskIndex = index;
      draggedRow.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', index);
    }

    function onRowDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const row = e.target.closest('tr');
      if (row && !row.classList.contains('divider') && row !== draggedRow) {
        document.querySelectorAll('tr.drag-over').forEach(r => r.classList.remove('drag-over'));
        row.classList.add('drag-over');
      }
    }

    function onRowDrop(e, targetIndex) {
      e.preventDefault();
      if (draggedTaskIndex === null || draggedTaskIndex === targetIndex) return;

      const task = tasks[draggedTaskIndex];
      tasks.splice(draggedTaskIndex, 1);
      const newIndex = targetIndex > draggedTaskIndex ? targetIndex - 1 : targetIndex;
      tasks.splice(newIndex, 0, task);

      updateSortOrders();
      sortClient = 'none';
      sortDue = 'none';
      sortPriority = 'none';
      localStorage.setItem(SORT_CLIENT_KEY, 'none');
      localStorage.setItem(SORT_DUE_KEY, 'none');
      localStorage.setItem(SORT_PRIORITY_KEY, 'none');

      saveTasks(false);
      renderTasks();
    }

    function onRowDragEnd() {
      if (draggedRow) draggedRow.classList.remove('dragging');
      document.querySelectorAll('tr.drag-over').forEach(r => r.classList.remove('drag-over'));
      draggedRow = null;
      draggedTaskIndex = null;
    }

    function updateSortOrders() {
      tasks.forEach((task, index) => {
        task.sortOrder = index;
        persistTaskToFirestore(task).catch(console.warn);
      });
    }

    // ===== DASHBOARD / ANALYTICS =====
    let dashboardTimeRange = 7;

    function calculateAnalyticsData(days) {
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - days);
      const cutoffStr = cutoff.toISOString().split('T')[0];

      const relevantTasks = tasks.filter(t => t.createdAt >= cutoffStr || t.dueDate >= cutoffStr);
      const allTasks = [...tasks, ...archive];

      const completed = relevantTasks.filter(t => t.completed).length;
      const total = relevantTasks.length;
      const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;

      const timeByClient = {};
      const timeByJobType = {};
      const statusCounts = {};

      relevantTasks.forEach(t => {
        if (t.seconds > 0) {
          timeByClient[t.client || 'No Client'] = (timeByClient[t.client || 'No Client'] || 0) + t.seconds;
          timeByJobType[t.jobType || 'Other'] = (timeByJobType[t.jobType || 'Other'] || 0) + t.seconds;
        }
        if (!t.completed) {
          statusCounts[t.status || 'Not Started'] = (statusCounts[t.status || 'Not Started'] || 0) + 1;
        }
      });

      return { completionRate, completed, total, timeByClient, timeByJobType, statusCounts };
    }

    function renderCompletionRing(percent) {
      const circumference = 2 * Math.PI * 45;
      const offset = circumference - (percent / 100) * circumference;
      return `
        <svg class="completion-ring" viewBox="0 0 120 120">
          <circle cx="60" cy="60" r="45" fill="none" stroke="var(--border)" stroke-width="10"/>
          <circle cx="60" cy="60" r="45" fill="none" stroke="var(--accent)" stroke-width="10"
            stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"
            transform="rotate(-90 60 60)" stroke-linecap="round"/>
          <text x="60" y="60" text-anchor="middle" dy="0.35em" fill="var(--text)" font-size="24" font-weight="700">${percent}%</text>
        </svg>
      `;
    }

    function renderBarChart(data, maxItems = 10) {
      const sorted = Object.entries(data).sort((a, b) => b[1] - a[1]).slice(0, maxItems);
      const max = Math.max(...sorted.map(([, v]) => v), 1);

      return sorted.map(([label, value]) => {
        const pct = (value / max) * 100;
        const hours = (value / 3600).toFixed(1);
        return `
          <div class="bar-row">
            <span class="bar-label" title="${escapeHtml(label)}">${escapeHtml(label)}</span>
            <div class="bar-container"><div class="bar-fill" style="width:${pct}%"></div></div>
            <span class="bar-value">${hours}h</span>
          </div>
        `;
      }).join('');
    }

    function renderPieChart(data, colors) {
      const entries = Object.entries(data);
      const total = entries.reduce((sum, [, v]) => sum + v, 0) || 1;
      let startAngle = 0;
      const slices = [];
      const legend = [];

      entries.forEach(([label, value], i) => {
        const pct = value / total;
        const angle = pct * 360;
        const endAngle = startAngle + angle;
        const color = colors[i % colors.length];

        const x1 = 50 + 40 * Math.cos((startAngle - 90) * Math.PI / 180);
        const y1 = 50 + 40 * Math.sin((startAngle - 90) * Math.PI / 180);
        const x2 = 50 + 40 * Math.cos((endAngle - 90) * Math.PI / 180);
        const y2 = 50 + 40 * Math.sin((endAngle - 90) * Math.PI / 180);
        const largeArc = angle > 180 ? 1 : 0;

        if (angle > 0) {
          slices.push(`<path d="M50,50 L${x1},${y1} A40,40 0 ${largeArc},1 ${x2},${y2} Z" fill="${color}"/>`);
        }
        legend.push(`<div class="legend-item"><span class="legend-color" style="background:${color}"></span><span>${escapeHtml(label)} (${value})</span></div>`);
        startAngle = endAngle;
      });

      return `
        <div class="pie-chart-container">
          <svg viewBox="0 0 100 100" width="100" height="100">${slices.join('')}</svg>
          <div class="pie-legend">${legend.join('')}</div>
        </div>
      `;
    }

    function renderDashboard() {
      const data = calculateAnalyticsData(dashboardTimeRange);
      const statusColors = ['#6b7280', '#f59e0b', '#3b82f6', '#8b5cf6', '#22c55e', '#10b981'];
      const jobTypeColors = ['#3b82f6', '#ef4444', '#22c55e', '#f59e0b', '#8b5cf6', '#ec4899', '#6b7280'];

      const content = document.getElementById('dashboardContent');
      content.innerHTML = `
        <div class="dashboard-card">
          <div class="dashboard-card-title">Completion Rate</div>
          ${renderCompletionRing(data.completionRate)}
          <div style="text-align:center; margin-top:8px; color:var(--muted); font-size:12px;">
            ${data.completed} of ${data.total} tasks completed
          </div>
        </div>
        <div class="dashboard-card">
          <div class="dashboard-card-title">Time by Client (Top 10)</div>
          <div class="bar-chart">${renderBarChart(data.timeByClient) || '<div class="subtle">No time tracked</div>'}</div>
        </div>
        <div class="dashboard-card">
          <div class="dashboard-card-title">Time by Job Type</div>
          ${Object.keys(data.timeByJobType).length > 0 ? renderPieChart(data.timeByJobType, jobTypeColors) : '<div class="subtle">No time tracked</div>'}
        </div>
        <div class="dashboard-card">
          <div class="dashboard-card-title">Status Distribution</div>
          ${Object.keys(data.statusCounts).length > 0 ? renderPieChart(data.statusCounts, statusColors) : '<div class="subtle">No open tasks</div>'}
        </div>
      `;
    }

    function openDashboard() {
      dashboardTimeRange = 7;
      document.querySelectorAll('.time-range-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.range === '7');
      });
      renderDashboard();
      showModal('dashboardModalBackdrop');
    }

    function updateSummaryStats() {
      const openTasks = tasks.filter(t => !t.completed);

      // Total tasks
      document.getElementById('totalTasksCount').textContent = openTasks.length;

      // Overdue
      const overdue = openTasks.filter(t => isOverdue(t.dueDate) && t.status !== 'Complete').length;
      document.getElementById('overdueCount').textContent = overdue;

      // Due this week
      const dueThisWeek = openTasks.filter(t => isThisWeek(t.dueDate)).length;
      document.getElementById('dueThisWeekCount').textContent = dueThisWeek;

      // Time this week (sum of all time from tasks created/modified this week)
      const weekStart = new Date();
      weekStart.setDate(weekStart.getDate() - weekStart.getDay());
      weekStart.setHours(0, 0, 0, 0);
      let weekSeconds = 0;
      let billableSeconds = 0;
      tasks.forEach(t => {
        weekSeconds += t.seconds || 0;
        if (t.billable) billableSeconds += t.seconds || 0;
      });
      document.getElementById('timeThisWeek').textContent = formatHMS(weekSeconds);
      document.getElementById('billableTime').textContent = formatHMS(billableSeconds);
    }

    function renderTasks() {
      purgeBlankRowsIfNeeded();
      buildClientDatalist();
      setActiveTimerStamp();
      setArchiveCount();
      updateSummaryStats();

      const body = document.getElementById('taskBody');
      body.innerHTML = '';

      const decorated = tasks.map((task, index) => ({ task, index }));
      let open = decorated.filter(x => !x.task.completed);
      const done = decorated.filter(x => x.task.completed);

      // Apply filters
      if (filterStatus !== 'all') {
        open = open.filter(x => x.task.status === filterStatus);
      }
      if (filterJobType !== 'all') {
        open = open.filter(x => x.task.jobType === filterJobType);
      }

      if (sortClient !== 'none' || sortDue !== 'none' || sortPriority !== 'none') open = [...open].sort(compareBySort);

      const appendRow = (item, displayNumber) => {
        const task = item.task;
        const index = item.index;

        const row = document.createElement('tr');
        row.dataset.taskIndex = String(index);
        if (task.completed) row.classList.add('completed');
        if (selectedTaskIndex === index) row.classList.add('selected');

        const isRunning = runningTaskIndex === index;
        const timerLabel = task.completed ? formatHMS(task.seconds) : (isRunning ? '‚è∏' : '‚èµ');
        const timerTitle = task.completed ? `Total time: ${formatHMS(task.seconds)}` : `Time: ${formatHMS(task.seconds)}`;

        const noteClass = `icon-btn ${hasNotes(task) ? 'has-dot' : ''}`;
        const linkClass = `icon-btn ${hasItems(task) ? 'has-dot' : ''}`;
        const isBlocked = hasUnmetDependencies(task);
        const recurringClass = `icon-btn recurring-icon ${task.isRecurring ? 'active' : ''}`;
        const dependencyClass = `icon-btn dependency-icon ${task.dependsOn?.length > 0 ? 'has-deps' : ''}`;

        // Due date display
        let dueBadge = '';
        if (task.dueDate) {
          let dueClass = 'due-normal';
          if (isOverdue(task.dueDate)) dueClass = 'due-overdue';
          else if (isDueSoon(task.dueDate)) dueClass = 'due-soon';
          dueBadge = `<span class="due-badge ${dueClass}">${formatDueDate(task.dueDate)}</span>`;
        }

        row.setAttribute('draggable', 'true');

        row.innerHTML = `
          <td style="width:20px; text-align:center; cursor:grab;" class="drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</td>
          <td style="width:32px; text-align:center;">${displayNumber}</td>
          <td style="width:140px;">
            <div style="display:flex; gap:4px;">
              <input list="clientList" data-field="client" type="text" value="${escapeHtml(task.client)}" style="flex:1; min-width:0;" />
              <button type="button" class="client-search-btn" style="padding:4px 8px; font-size:12px; flex-shrink:0;" title="Search clients">&#128269;</button>
            </div>
          </td>
          <td style="width:300px;">
            <input data-field="description" type="text" value="${escapeHtml(task.description)}" />
          </td>
          <td style="width:70px;">
            <select data-field="jobType" style="width:100%; height:31px; font-size:10px;">
              ${masterJobTypes.map(jt => `<option value="${escapeHtml(jt)}" ${task.jobType === jt ? 'selected' : ''}>${escapeHtml(getShortJobType(jt))}</option>`).join('')}
            </select>
          </td>
          <td style="width:70px;">
            <select data-field="status" style="width:100%; height:31px; font-size:10px;">
              <option value="Not Started" ${task.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
              <option value="Info Requested" ${task.status === 'Info Requested' ? 'selected' : ''}>Info Req</option>
              <option value="In Progress" ${task.status === 'In Progress' ? 'selected' : ''}>In Prog</option>
              <option value="Review" ${task.status === 'Review' ? 'selected' : ''}>Review</option>
              <option value="Lodged" ${task.status === 'Lodged' ? 'selected' : ''}>Lodged</option>
              <option value="Complete" ${task.status === 'Complete' ? 'selected' : ''}>Complete</option>
            </select>
          </td>
          <td class="team-cell" style="width:70px; ${isInFirmMode() ? '' : 'display:none;'}">
            <button type="button" class="team-btn" data-task-index="${index}" style="width:100%; height:31px; padding:0 6px; font-size:11px; display:flex; align-items:center; justify-content:center; gap:4px; border:1px solid ${(task.team && task.team.length > 0) ? 'var(--teal)' : 'rgba(20,184,166,0.55)'}; border-radius:8px; background:transparent; color:${(task.team && task.team.length > 0) ? 'var(--teal-2)' : 'var(--muted)'}; cursor:pointer;" title="${getTeamTooltip(task)}">
              <span>${(task.team && task.team.length) || 0}</span>
              <span style="font-size:13px;">üë•</span>
            </button>
          </td>
          <td style="width:70px;">
            <span class="due-date-display" data-field="dueDateDisplay" style="display:block; width:100%; height:31px; line-height:31px; font-size:10px; text-align:center; cursor:pointer; background:var(--panel-2); border:1px solid rgba(20,184,166,0.55); border-radius:8px;">${task.dueDate ? formatShortDate(task.dueDate) : '‚Äî'}</span>
            <input data-field="dueDate" type="date" value="${task.dueDate || ''}" style="position:absolute; opacity:0; pointer-events:none;" />
          </td>
          <td style="width:20px; text-align:center;">
            <div class="prio ${prioClass(task.priority)}" title="Click to cycle (L/M/H)">${prioLetter(task.priority)}</div>
          </td>
          <td class="center" style="width:24px; padding:4px;">
            <span data-field="completed" class="custom-checkbox ${task.completed ? 'checked' : ''} ${isBlocked ? 'dependency-locked' : ''}" style="display:inline-block; width:18px; height:18px; background:#0f151a; border:1px solid rgba(20,184,166,0.55); border-radius:4px; cursor:${isBlocked ? 'not-allowed' : 'pointer'}; text-align:center; line-height:16px; font-size:12px; color:#3b82f6;" title="${isBlocked ? 'Blocked by dependencies' : ''}">${task.completed ? '‚úì' : (isBlocked ? 'üîí' : '')}</span>
          </td>
          <td class="center" style="width:24px; padding:4px;">
            <div class="timer-btn ${isRunning ? 'running' : ''} ${task.completed ? 'disabled' : ''}" title="${timerTitle}">${timerLabel}</div>
          </td>
          <td class="center" style="width:24px; padding:4px;">
            <div class="icon-btn schedule-btn ${(task.schedules && task.schedules.length > 0) ? 'has-dot' : ''}" title="Schedule"><span class="icon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm-8 4H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/></svg></span></div>
          </td>
          <td class="center" style="width:24px; padding:4px;">
            <div class="${noteClass}" title="Notes"><span class="icon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm0 2.5L19.5 10H14V4.5zM8 13h8v2H8v-2zm0 4h8v2H8v-2zM8 9h4v2H8V9z"/></svg></span></div>
          </td>
          <td class="center" style="width:24px; padding:4px;">
            <div class="${linkClass}" title="Links & Documents"><span class="icon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M10.59 13.41a1 1 0 0 1 0-1.41l3.18-3.18a3 3 0 0 1 4.24 4.24l-2.47 2.47a3 3 0 0 1-4.24 0 1 1 0 1 1 1.41-1.41 1 1 0 0 0 1.41 0l2.47-2.47a1 1 0 0 0-1.41-1.41l-3.18 3.18a1 1 0 0 1-1.41 0z"/><path d="M13.41 10.59a1 1 0 0 1 0 1.41l-3.18 3.18a3 3 0 0 1-4.24-4.24l2.47-2.47a3 3 0 0 1 4.24 0 1 1 0 0 1-1.41 1.41 1 1 0 0 0-1.41 0L7.41 11.35a1 1 0 0 0 1.41 1.41l3.18-3.18a1 1 0 0 1 1.41 0z"/></svg></span></div>
          </td>
          <td class="center" style="width:24px; padding:4px;">
            <div class="${recurringClass}" title="${task.isRecurring ? 'Recurring task (click to edit)' : 'Set as recurring'}">üîÑ</div>
          </td>
          <td class="center" style="width:24px; padding:4px;">
            <div class="${dependencyClass}" title="${task.dependsOn?.length > 0 ? task.dependsOn.length + ' dependencies' : 'Manage dependencies'}">üîó</div>
          </td>
          <td class="delete-btn" style="width:24px; padding:4px; text-align:center;">X</td>
        `;

        row.addEventListener('mousedown', () => setSelected(index));

        const clientInput = row.querySelector('input[data-field="client"]');
        const descInput = row.querySelector('input[data-field="description"]');

        clientInput.addEventListener('focus', () => setSelected(index));
        descInput.addEventListener('focus', () => setSelected(index));

        clientInput.addEventListener('input', (e) => {
          tasks[index].client = e.target.value;
          saveTasks(false);
          if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(tasks[index]).catch(console.warn);
          buildClientDatalist();
          if (runningTaskIndex === index) setActiveTimerStamp();
        });

        let clientPromptShown = false;

        clientInput.addEventListener('keydown', (e) => {
          if ((e.key === 'Tab' && !e.shiftKey) || e.key === 'Enter') {
            const clientName = (e.target.value || '').trim();
            if (clientName && !masterClients.includes(clientName)) {
              e.preventDefault();
              e.stopImmediatePropagation();
              clientPromptShown = true;
              showAddClientConfirm(clientName, descInput);
              return false;
            } else if (e.key === 'Enter' && clientName) {
              // Existing client, just move to description
              e.preventDefault();
              descInput.focus();
              return false;
            }
          }
        });

        clientInput.addEventListener('blur', (e) => {
          if (clientPromptShown) {
            clientPromptShown = false;
            return;
          }
          const clientName = (e.target.value || '').trim();
          if (clientName && !masterClients.includes(clientName)) {
            showAddClientConfirm(clientName, descInput);
          }
        });

        const clientSearchBtn = row.querySelector('.client-search-btn');
        clientSearchBtn.addEventListener('click', () => openClientSearch(index));

        descInput.addEventListener('input', (e) => {
          tasks[index].description = e.target.value;
          saveTasks(false);
          if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(tasks[index]).catch(console.warn);
          if (runningTaskIndex === index) setActiveTimerStamp();
        });

        // New field event listeners
        const jobTypeSelect = row.querySelector('select[data-field="jobType"]');
        const statusSelect = row.querySelector('select[data-field="status"]');
        const dueDateInput = row.querySelector('input[data-field="dueDate"]');
        const dueDateDisplay = row.querySelector('[data-field="dueDateDisplay"]');

        jobTypeSelect.addEventListener('change', (e) => {
          tasks[index].jobType = e.target.value;
          saveTasks(false);
          if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(tasks[index]).catch(console.warn);
        });

        statusSelect.addEventListener('change', (e) => {
          tasks[index].status = e.target.value;
          saveTasks(false);
          if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(tasks[index]).catch(console.warn);
          updateSummaryStats();
        });

        // Team button click handler (firm mode only)
        const teamBtn = row.querySelector('.team-btn');
        if (teamBtn) {
          teamBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            setSelected(index);
            openJobTeamModal(index);
          });
        }

        dueDateDisplay.addEventListener('click', (e) => {
          e.stopPropagation();
          dueDateInput.showPicker();
        });

        dueDateInput.addEventListener('change', (e) => {
          tasks[index].dueDate = e.target.value;
          dueDateDisplay.textContent = e.target.value ? formatShortDate(e.target.value) : '‚Äî';
          saveTasks(false);
          if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(tasks[index]).catch(console.warn);
          updateSummaryStats();
        });

        const enterHandler = (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            addTask({ focus: true });
          }
        };
        clientInput.addEventListener('keydown', enterHandler);
        descInput.addEventListener('keydown', enterHandler);

        row.querySelector('.prio').addEventListener('click', (e) => {
          e.stopPropagation();
          setSelected(index);
          cyclePriority(index);
        });

        row.querySelector('span[data-field="completed"]').addEventListener('click', (e) => {
          e.stopPropagation();
          setSelected(index);
          if (hasUnmetDependencies(tasks[index])) {
            toast('Cannot complete: has unmet dependencies');
            return;
          }
          const isCompleted = !tasks[index].completed;
          e.target.textContent = isCompleted ? '‚úì' : '';
          e.target.classList.toggle('checked', isCompleted);
          toggleComplete(index, isCompleted);
        });

        row.querySelector('.timer-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          setSelected(index);
          if (tasks[index].completed) return;
          toggleTimer(index);
        });

        row.querySelectorAll('.icon-btn')[0].addEventListener('click', (e) => {
          e.stopPropagation();
          setSelected(index);
          openScheduleModal(index);
        });

        row.querySelectorAll('.icon-btn')[1].addEventListener('click', (e) => {
          e.stopPropagation();
          setSelected(index);
          openNotes(index);
        });

        row.querySelectorAll('.icon-btn')[2].addEventListener('click', (e) => {
          e.stopPropagation();
          setSelected(index);
          openLinks(index);
        });

        // Recurring icon
        row.querySelectorAll('.icon-btn')[3].addEventListener('click', (e) => {
          e.stopPropagation();
          setSelected(index);
          openRecurringModal(index);
        });

        // Dependency icon
        row.querySelectorAll('.icon-btn')[4].addEventListener('click', (e) => {
          e.stopPropagation();
          setSelected(index);
          openDependenciesModal(index);
        });

        row.querySelector('.delete-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          deleteTask(index);
        });

        // Drag and drop events
        row.addEventListener('dragstart', (e) => onRowDragStart(e, index));
        row.addEventListener('dragover', onRowDragOver);
        row.addEventListener('drop', (e) => onRowDrop(e, index));
        row.addEventListener('dragend', onRowDragEnd);

        body.appendChild(row);
      };

      let n = 1;
      open.forEach(item => appendRow(item, n++));

      if (open.length > 0 && done.length > 0) {
        const div = document.createElement('tr');
        div.className = 'divider';
        div.innerHTML = `<td colspan="17">Completed</td>`;
        body.appendChild(div);
      }

      done.forEach(item => appendRow(item, n++));
    }

    let toastTimer = null;

    function showToast(message) {
      const el = document.getElementById('toast');
      if (!el) return;
      el.textContent = message;
      el.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        el.classList.remove('show');
      }, 2500);
    }

    function escapeHtml(str) {
      return String(str ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // ===== Job Team Assignment Functions =====
    let currentJobTeamTaskIndex = null;

    function getTeamTooltip(task) {
      if (!task.team || task.team.length === 0) {
        return 'No team assigned - click to add';
      }
      const groupedByRole = {};
      task.team.forEach(m => {
        const role = m.jobRole || 'Member';
        if (!groupedByRole[role]) groupedByRole[role] = [];
        const member = firmMembers.find(fm => fm.uid === m.uid);
        groupedByRole[role].push(member?.displayName || 'Unknown');
      });
      return Object.entries(groupedByRole)
        .map(([role, names]) => `${role}: ${names.join(', ')}`)
        .join('\n');
    }

    function getMemberDisplayName(uid) {
      const member = firmMembers.find(m => m.uid === uid);
      return member?.displayName || 'Unknown';
    }

    function getMemberRole(uid) {
      const member = firmMembers.find(m => m.uid === uid);
      return member?.role || '';
    }

    function isMemberPending(uid) {
      const member = firmMembers.find(m => m.uid === uid);
      return member?.status === 'pending';
    }

    function openJobTeamModal(taskIndex) {
      currentJobTeamTaskIndex = taskIndex;
      const task = tasks[taskIndex];
      const taskName = task.description || 'Untitled';
      const clientName = task.client || 'No Client';
      document.getElementById('jobTeamTaskName').textContent = `${clientName} - ${taskName}`;

      // Populate member select dropdown (include pending members)
      const memberSelect = document.getElementById('jobTeamMemberSelect');
      memberSelect.innerHTML = '<option value="">Select person...</option>';
      const sortedMembers = [...firmMembers]
        .filter(m => m.status === 'active' || m.status === 'pending')
        .sort((a, b) => (a.displayName || '').localeCompare(b.displayName || ''));
      sortedMembers.forEach(m => {
        const pendingLabel = m.status === 'pending' ? ' (Pending)' : '';
        memberSelect.innerHTML += `<option value="${m.uid}">${escapeHtml(m.displayName)} (${m.role || 'Member'})${pendingLabel}</option>`;
      });

      // Populate role select dropdown with firm's job roles
      const roleSelect = document.getElementById('jobTeamRoleSelect');
      roleSelect.innerHTML = '';
      (jobRoles || DEFAULT_JOB_ROLES).forEach(role => {
        roleSelect.innerHTML += `<option value="${role}">${role}</option>`;
      });

      renderJobTeamCurrentList();
      showModal('jobTeamModalBackdrop');
    }

    function closeJobTeamModal() {
      hideModal('jobTeamModalBackdrop');
      currentJobTeamTaskIndex = null;
      renderTasks();
    }

    function renderJobTeamCurrentList() {
      const container = document.getElementById('jobTeamCurrentList');
      const task = tasks[currentJobTeamTaskIndex];
      const team = task.team || [];

      if (team.length === 0) {
        container.innerHTML = '<div class="subtle" style="text-align:center; padding:16px;">No team members assigned yet</div>';
        return;
      }

      // Group by role
      const groupedByRole = {};
      const roleOrder = jobRoles || DEFAULT_JOB_ROLES;

      team.forEach(m => {
        const role = m.jobRole || 'Member';
        if (!groupedByRole[role]) groupedByRole[role] = [];
        groupedByRole[role].push(m);
      });

      let html = '';
      roleOrder.forEach(role => {
        const members = groupedByRole[role];
        if (!members || members.length === 0) return;

        html += `<div style="margin-bottom:12px;">
          <div style="font-size:10px; font-weight:700; text-transform:uppercase; color:var(--muted); margin-bottom:6px; letter-spacing:0.05em;">${escapeHtml(role)}${members.length > 1 ? 'S' : ''}</div>`;

        members.forEach(m => {
          const displayName = getMemberDisplayName(m.uid);
          const firmRole = getMemberRole(m.uid);
          const isPending = isMemberPending(m.uid);
          const pendingBadge = isPending ? '<span style="color:var(--warning); font-size:10px; margin-left:6px; background:rgba(245,158,11,0.15); padding:1px 5px; border-radius:3px;">Pending</span>' : '';
          html += `<div style="display:flex; justify-content:space-between; align-items:center; padding:6px 8px; background:var(--panel-2); border-radius:6px; margin-bottom:4px;">
            <div>
              <span style="color:var(--text);">${escapeHtml(displayName)}</span>
              ${firmRole ? `<span style="color:var(--muted); font-size:11px; margin-left:6px;">(${escapeHtml(firmRole)})</span>` : ''}${pendingBadge}
            </div>
            <button type="button" onclick="removeJobTeamMember('${m.uid}')" class="mini btn-danger" style="padding:2px 8px; font-size:11px;">Remove</button>
          </div>`;
        });

        html += '</div>';
      });

      // Show any roles that aren't in the standard list
      Object.keys(groupedByRole).forEach(role => {
        if (roleOrder.includes(role)) return;
        const members = groupedByRole[role];

        html += `<div style="margin-bottom:12px;">
          <div style="font-size:10px; font-weight:700; text-transform:uppercase; color:var(--muted); margin-bottom:6px; letter-spacing:0.05em;">${escapeHtml(role)}${members.length > 1 ? 'S' : ''}</div>`;

        members.forEach(m => {
          const displayName = getMemberDisplayName(m.uid);
          const firmRole = getMemberRole(m.uid);
          const isPending = isMemberPending(m.uid);
          const pendingBadge = isPending ? '<span style="color:var(--warning); font-size:10px; margin-left:6px; background:rgba(245,158,11,0.15); padding:1px 5px; border-radius:3px;">Pending</span>' : '';
          html += `<div style="display:flex; justify-content:space-between; align-items:center; padding:6px 8px; background:var(--panel-2); border-radius:6px; margin-bottom:4px;">
            <div>
              <span style="color:var(--text);">${escapeHtml(displayName)}</span>
              ${firmRole ? `<span style="color:var(--muted); font-size:11px; margin-left:6px;">(${escapeHtml(firmRole)})</span>` : ''}${pendingBadge}
            </div>
            <button type="button" onclick="removeJobTeamMember('${m.uid}')" class="mini btn-danger" style="padding:2px 8px; font-size:11px;">Remove</button>
          </div>`;
        });

        html += '</div>';
      });

      container.innerHTML = html;
    }

    function addJobTeamMember() {
      const memberSelect = document.getElementById('jobTeamMemberSelect');
      const roleSelect = document.getElementById('jobTeamRoleSelect');
      const uid = memberSelect.value;
      const jobRole = roleSelect.value;

      if (!uid) {
        toast('Please select a person');
        return;
      }

      const task = tasks[currentJobTeamTaskIndex];
      if (!task.team) task.team = [];

      // Check if already on team
      if (task.team.find(m => m.uid === uid)) {
        toast('This person is already on the team');
        return;
      }

      task.team.push({
        uid: uid,
        jobRole: jobRole,
        addedAt: new Date().toISOString(),
        addedBy: currentUser?.uid || null
      });

      // Update teamMemberUids
      task.teamMemberUids = task.team.map(m => m.uid).filter(Boolean);

      // Update assignedTo for backward compatibility
      const firstPreparer = task.team.find(m => m.jobRole === 'Preparer');
      task.assignedTo = firstPreparer?.uid || task.team[0]?.uid || task.assignedTo;

      saveTasks(false);
      if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(task).catch(console.warn);

      renderJobTeamCurrentList();
      memberSelect.value = '';
      toast(`${getMemberDisplayName(uid)} added as ${jobRole}`);
    }

    function removeJobTeamMember(uid) {
      const task = tasks[currentJobTeamTaskIndex];
      if (!task.team) return;

      const memberName = getMemberDisplayName(uid);
      task.team = task.team.filter(m => m.uid !== uid);

      // Update teamMemberUids
      task.teamMemberUids = task.team.map(m => m.uid).filter(Boolean);

      // Update assignedTo for backward compatibility
      const firstPreparer = task.team.find(m => m.jobRole === 'Preparer');
      task.assignedTo = firstPreparer?.uid || task.team[0]?.uid || null;

      // Also remove any schedules for this member
      if (task.schedules && task.schedules.length > 0) {
        const removedCount = task.schedules.filter(s => s.memberUid === uid).length;
        task.schedules = task.schedules.filter(s => s.memberUid !== uid);
        if (removedCount > 0) {
          toast(`${memberName} removed (${removedCount} scheduled entries also removed)`);
        } else {
          toast(`${memberName} removed`);
        }
      } else {
        toast(`${memberName} removed`);
      }

      saveTasks(false);
      if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(task).catch(console.warn);

      renderJobTeamCurrentList();
    }

    // Make functions available globally
    window.openJobTeamModal = openJobTeamModal;
    window.closeJobTeamModal = closeJobTeamModal;
    window.addJobTeamMember = addJobTeamMember;
    window.removeJobTeamMember = removeJobTeamMember;

    function getShortJobType(jobType) {
      const shortNames = {
        'Tax Return': 'Tax',
        'BAS': 'BAS',
        'Financial Statements': 'Fin Stmts',
        'Audit': 'Audit',
        'Bookkeeping': 'Books',
        'Advisory': 'Advisory',
        'Other': 'Other'
      };
      return shortNames[jobType] || jobType;
    }

    // Lightweight self-tests
    (function runSelfTests() {
      try {
        console.assert(formatHMS(0) === '0:00', 'formatHMS(0) should be 0:00');
        console.assert(formatHMS(65) === '1:05', 'formatHMS(65) should be 1:05');
        console.assert(formatHMS(3661) === '1:01:01', 'formatHMS(3661) should be 1:01:01');

        console.assert(escapeHtml('a&b') === 'a&amp;b', 'escapeHtml should escape &');
        console.assert(escapeHtml('<x>') === '&lt;x&gt;', 'escapeHtml should escape <>');

        const multi = 'https://a.com\nhttps://b.com, https://c.com;https://d.com';
        const parts = String(multi)
          .split(/\r?\n|,|;/g)
          .map(s => s.trim())
          .filter(Boolean);
        console.assert(parts.length === 4, 'multi-link split should produce 4 links');

        const bf = backfillTask({});
        console.assert(!!bf.id, 'backfillTask should create id');

        const txt = buildWorkListText();
        console.assert(txt.includes('\n'), 'buildWorkListText should include newline separators');

        // New test: toggleComplete should not throw on blank task
        tasks = [backfillTask({ client: '', description: '' })];
        toggleComplete(0, true);
        console.assert(tasks[0].completed === true, 'toggleComplete should set completed');
        tasks = [];

        // New test: purgeBlankRowsIfNeeded keeps a small buffer so Add still "adds" rows
        blankMode = 'remove';
        tasks = [];
        for (let i = 0; i < 8; i++) tasks.push(backfillTask({ client: '', description: '' }));
        selectedTaskIndex = 7;
        purgeBlankRowsIfNeeded();
        console.assert(tasks.length <= 5, 'purge should keep at most 5 blank rows');
        console.assert(selectedTaskIndex != null, 'selectedTaskIndex should remain valid after purge');
        tasks = [];
        blankMode = localStorage.getItem(BLANK_KEY) || 'bottom';
      } catch (e) {
        console.warn('Self-tests skipped:', e);
      }
    })();

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeNotes();
        closeLinks();
      }

      if (e.key === 'Delete' || e.key === 'Backspace') {
        const t = e.target;
        const isTyping = t && (t.tagName === 'INPUT' || t.tagName === 'TEXTAREA' || t.isContentEditable);
        if (isTyping) return;
        if (selectedTaskIndex != null) {
          e.preventDefault();
          deleteTask(selectedTaskIndex);
        }
      }

      if (e.key === ' ' || e.code === 'Space') {
        const t = e.target;
        const isTyping = t && (t.tagName === 'INPUT' || t.tagName === 'TEXTAREA' || t.isContentEditable);
        if (isTyping) return;
        if (selectedTaskIndex != null && selectedTaskIndex >= 0 && selectedTaskIndex < tasks.length) {
          e.preventDefault();
          if (!tasks[selectedTaskIndex].completed) toggleTimer(selectedTaskIndex);
        }
      }
    });

    window.addEventListener('beforeunload', () => {
      if (runningTaskIndex != null) saveTasks(true);
    });

    // Notes modal wiring
    document.getElementById('notesClose').addEventListener('click', closeNotes);
    document.getElementById('notesSave').addEventListener('click', closeNotes);
    document.getElementById('notesBackdrop').addEventListener('mousedown', (e) => {
      if (e.target.id === 'notesBackdrop') closeNotes();
    });

    const notesTextarea = document.getElementById('notesTextarea');
    notesTextarea.addEventListener('input', () => {
      if (notesTaskIndex == null) return;
      tasks[notesTaskIndex].notes = notesTextarea.value;
      saveTasks(false);
      if (hasFirebaseConfig() && currentUser) persistTaskToFirestore(tasks[notesTaskIndex]).catch(console.warn);
    });

    // Links modal wiring
    document.getElementById('linksClose').addEventListener('click', closeLinks);
    document.getElementById('linksDone').addEventListener('click', closeLinks);
    document.getElementById('linksBackdrop').addEventListener('mousedown', (e) => {
      if (e.target.id === 'linksBackdrop') closeLinks();
    });

    document.getElementById('addLinkBtn').addEventListener('click', () => {
      addLinkToTask(document.getElementById('newLinkInput').value);
      document.getElementById('newLinkInput').value = '';
      document.getElementById('newLinkInput').focus();
    });

    document.getElementById('newLinkInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('addLinkBtn').click();
      }
    });

    document.getElementById('uploadBtn').addEventListener('click', () => {
      document.getElementById('filePicker').click();
    });

    document.getElementById('filePicker').addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      e.target.value = '';
      try {
        await attachFileToTask(file);
      } catch (err) {
        console.warn(err);
        alert('Could not attach file.');
      }
    });

    // Controls
    document.getElementById('addBtn').addEventListener('click', () => addTask({ focus: true }));
    document.getElementById('emailBtn').addEventListener('click', emailWorkList);
    document.getElementById('copyBtn').addEventListener('click', copyWorkList);
    document.getElementById('excelBtn').addEventListener('click', downloadExcel);
    document.getElementById('adminBtn').addEventListener('click', openAdmin);
    document.getElementById('teamBtn').addEventListener('click', showTeamModal);
    document.getElementById('rolesBtn').addEventListener('click', showRolesModal);
    document.getElementById('holidaysBtn').addEventListener('click', showHolidaysModal);
    document.getElementById('ganttBtn').addEventListener('click', openGanttModal);
    document.getElementById('dashboardBtn').addEventListener('click', openDashboard);
    document.getElementById('notificationsBtn').addEventListener('click', openNotificationsModal);
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);

    // Dashboard time range buttons
    document.querySelectorAll('.time-range-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.time-range-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        dashboardTimeRange = parseInt(btn.dataset.range);
        renderDashboard();
      });
    });

    // Notification settings
    document.getElementById('requestNotificationPermission').addEventListener('click', requestNotificationPermission);
    document.getElementById('notificationsEnabled').addEventListener('change', (e) => {
      const settings = getNotificationSettings();
      settings.enabled = e.target.checked;
      saveNotificationSettings(settings);
      if (settings.enabled) startNotificationChecker();
      else if (notificationCheckInterval) clearInterval(notificationCheckInterval);
    });
    document.getElementById('notifyOverdue').addEventListener('change', (e) => {
      const settings = getNotificationSettings();
      settings.overdue = e.target.checked;
      saveNotificationSettings(settings);
    });
    document.getElementById('notifyDueSoon').addEventListener('change', (e) => {
      const settings = getNotificationSettings();
      settings.dueSoon = e.target.checked;
      saveNotificationSettings(settings);
    });
    document.getElementById('notificationInterval').addEventListener('change', (e) => {
      const settings = getNotificationSettings();
      settings.interval = parseInt(e.target.value);
      saveNotificationSettings(settings);
      if (settings.enabled) startNotificationChecker();
    });

    // Recurring task modal
    document.getElementById('isRecurring').addEventListener('change', (e) => {
      document.getElementById('recurrenceSettings').style.display = e.target.checked ? 'grid' : 'none';
    });
    document.getElementById('recurrenceType').addEventListener('change', updateRecurrenceUI);
    document.getElementById('saveRecurringBtn').addEventListener('click', saveRecurringSettings);

    // Dependencies modal
    document.getElementById('addDependencySelect').addEventListener('change', (e) => {
      if (e.target.value && dependencyTaskIndex !== null) {
        addDependency(dependencyTaskIndex, e.target.value);
        e.target.value = '';
      }
    });

    // Admin modal
    document.getElementById('adminClose').addEventListener('click', closeAdmin);
    document.getElementById('adminDone').addEventListener('click', closeAdmin);
    document.getElementById('addClientBtn').addEventListener('click', () => {
      addClient(document.getElementById('newClientInput').value);
    });
    document.getElementById('newClientInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') addClient(e.target.value);
    });
    document.getElementById('addJobTypeBtn').addEventListener('click', () => {
      addJobType(document.getElementById('newJobTypeInput').value);
    });
    document.getElementById('newJobTypeInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') addJobType(e.target.value);
    });
    document.getElementById('addTeamNameBtn').addEventListener('click', () => {
      addTeamName(document.getElementById('newTeamNameInput').value);
    });
    document.getElementById('newTeamNameInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') addTeamName(e.target.value);
    });
    document.getElementById('adminBackdrop').addEventListener('mousedown', (e) => {
      if (e.target.id === 'adminBackdrop') closeAdmin();
    });
    document.getElementById('hoursPerDaySelect').addEventListener('change', handleHoursPerDayChange);
    document.getElementById('hoursPerDayCustom').addEventListener('change', handleHoursPerDayCustom);
    document.getElementById('hoursPerDayCustom').addEventListener('blur', handleHoursPerDayCustom);

    // Client search modal
    document.getElementById('clientSearchClose').addEventListener('click', closeClientSearch);
    document.getElementById('clientSearchInput').addEventListener('input', (e) => {
      renderClientSearchResults(e.target.value);
    });
    document.getElementById('clientSearchBackdrop').addEventListener('mousedown', (e) => {
      if (e.target.id === 'clientSearchBackdrop') closeClientSearch();
    });

    // Add client confirm modal
    document.getElementById('addClientConfirmYes').addEventListener('click', handleAddClientYes);
    document.getElementById('addClientConfirmNo').addEventListener('click', handleAddClientNo);
    document.getElementById('addClientConfirmBackdrop').addEventListener('mousedown', (e) => {
      if (e.target.id === 'addClientConfirmBackdrop') handleAddClientNo();
    });

    // Schedule modal
    document.getElementById('scheduleClose').addEventListener('click', closeScheduleModal);
    document.getElementById('scheduleDone').addEventListener('click', closeScheduleModal);
    document.getElementById('schedAddBtn').addEventListener('click', addScheduleBlock);
    document.getElementById('schedClearAll').addEventListener('click', clearAllSchedules);
    document.getElementById('schedNewHours').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') addScheduleBlock();
    });
    document.getElementById('schedViewGantt').addEventListener('click', () => {
      closeScheduleModal();
      openGanttModal(); // Always open in user mode (default)
    });
    document.getElementById('scheduleModalBackdrop').addEventListener('mousedown', (e) => {
      if (e.target.id === 'scheduleModalBackdrop') closeScheduleModal();
    });
    // Schedule grid date range controls
    document.getElementById('schedGridDateFrom').addEventListener('change', updateScheduleGridDateRange);
    document.getElementById('schedGridDateTo').addEventListener('change', updateScheduleGridDateRange);
    document.getElementById('schedGridWeekdaysOnly').addEventListener('change', () => renderScheduleGrid());

    // Member Range Popout event listeners
    document.getElementById('memberRangeClose').addEventListener('click', closeMemberRangePopout);
    document.getElementById('memberRangeAddBtn').addEventListener('click', addMemberRangeHours);
    document.getElementById('memberRangeClearBtn').addEventListener('click', clearMemberRange);
    document.getElementById('memberRangeSetStatus').addEventListener('click', setMemberRangeBulkStatus);
    document.getElementById('schedAddRange').addEventListener('click', (e) => {
      e.stopPropagation();
      openMemberRangePopout(null, e.target);
    });
    document.getElementById('memberRangeSelector').addEventListener('change', (e) => {
      memberRangeCurrentUid = e.target.value;
      renderMemberRangeEditList();
    });
    document.querySelectorAll('.member-range-tab').forEach(tab => {
      tab.addEventListener('click', () => switchMemberRangeTab(tab.dataset.tab));
    });
    // Close popout when clicking outside
    document.addEventListener('click', (e) => {
      const popout = document.getElementById('memberRangePopout');
      if (popout.style.display !== 'none' && !popout.contains(e.target) && !e.target.closest('.sched-member-header') && !e.target.closest('#schedAddRange')) {
        closeMemberRangePopout();
      }
    });

    // Job Team modal backdrop
    document.getElementById('jobTeamModalBackdrop').addEventListener('mousedown', (e) => {
      if (e.target.id === 'jobTeamModalBackdrop') closeJobTeamModal();
    });
    // Legacy schedule mode buttons (only if they exist - for backwards compatibility)
    const schedModeSingle = document.getElementById('schedModeSingle');
    const schedModeRange = document.getElementById('schedModeRange');
    const schedModeMatrix = document.getElementById('schedModeMatrix');
    const schedAddRangeBtn = document.getElementById('schedAddRangeBtn');
    const schedMatrixSave = document.getElementById('schedMatrixSave');
    const schedRangeHours = document.getElementById('schedRangeHours');
    if (schedModeSingle) schedModeSingle.addEventListener('click', () => setScheduleMode('single'));
    if (schedModeRange) schedModeRange.addEventListener('click', () => setScheduleMode('range'));
    if (schedModeMatrix) schedModeMatrix.addEventListener('click', () => setScheduleMode('matrix'));
    if (schedAddRangeBtn) schedAddRangeBtn.addEventListener('click', addScheduleRange);
    if (schedMatrixSave) schedMatrixSave.addEventListener('click', saveScheduleMatrix);
    if (schedRangeHours) schedRangeHours.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') addScheduleRange();
    });

    // Gantt modal
    document.getElementById('ganttClose').addEventListener('click', closeGanttModal);
    document.getElementById('ganttModalBackdrop').addEventListener('mousedown', (e) => {
      if (e.target.id === 'ganttModalBackdrop') closeGanttModal();
    });
    document.querySelectorAll('.gantt-zoom-btn').forEach(btn => {
      btn.addEventListener('click', () => setGanttZoom(btn.dataset.zoom));
    });
    // View toggle buttons
    document.getElementById('ganttViewUser').addEventListener('click', () => {
      setGanttViewMode('user');
      renderGantt();
    });
    document.getElementById('ganttViewJob').addEventListener('click', () => {
      setGanttViewMode('job');
      // Don't render until a job is selected
      if (ganttJobFilter !== null) {
        renderGantt();
      }
    });
    document.getElementById('ganttHideWeekends').addEventListener('change', toggleGanttWeekends);
    document.getElementById('ganttShowLocked').addEventListener('change', renderGantt);
    document.getElementById('ganttShowLikely').addEventListener('change', renderGantt);
    document.getElementById('ganttShowTentative').addEventListener('change', renderGantt);
    document.getElementById('ganttDateFrom').addEventListener('change', updateGanttDateRange);
    document.getElementById('ganttDateTo').addEventListener('change', updateGanttDateRange);
    document.getElementById('ganttDateReset').addEventListener('click', resetGanttDateRange);

    // Home button
    document.getElementById('homeBtn').addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    // Arrow key navigation for selected row
    document.addEventListener('keydown', (e) => {
      // Only handle arrow keys when not in an input/textarea/select
      const tag = document.activeElement.tagName.toLowerCase();
      if (tag === 'input' || tag === 'textarea' || tag === 'select') return;

      if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
        e.preventDefault();
        const rows = document.querySelectorAll('tbody#taskBody tr[data-task-index]');
        if (rows.length === 0) return;

        const indices = Array.from(rows).map(r => Number(r.dataset.taskIndex));

        if (selectedTaskIndex === null) {
          // Select first or last row
          setSelected(e.key === 'ArrowDown' ? indices[0] : indices[indices.length - 1]);
        } else {
          const currentPos = indices.indexOf(selectedTaskIndex);
          if (currentPos === -1) {
            setSelected(indices[0]);
          } else if (e.key === 'ArrowUp' && currentPos > 0) {
            setSelected(indices[currentPos - 1]);
          } else if (e.key === 'ArrowDown' && currentPos < indices.length - 1) {
            setSelected(indices[currentPos + 1]);
          }
        }

        // Scroll selected row into view
        const selectedRow = document.querySelector(`tr[data-task-index="${selectedTaskIndex}"]`);
        if (selectedRow) {
          selectedRow.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
      }
    });

    // Filter controls
    document.getElementById('filterStatus').addEventListener('change', (e) => {
      filterStatus = e.target.value;
      renderTasks();
    });

    document.getElementById('filterJobType').addEventListener('change', (e) => {
      filterJobType = e.target.value;
      renderTasks();
    });

    // Column header sorting
    function updateSortIcons() {
      const clientIcon = document.getElementById('sortClientIcon');
      const dueIcon = document.getElementById('sortDueIcon');
      const priorityIcon = document.getElementById('sortPriorityIcon');
      clientIcon.textContent = sortClient === 'asc' ? '‚ñ≤' : sortClient === 'desc' ? '‚ñº' : '';
      dueIcon.textContent = sortDue === 'asc' ? '‚ñ≤' : sortDue === 'desc' ? '‚ñº' : '';
      priorityIcon.textContent = sortPriority === 'asc' ? '‚ñ≤' : sortPriority === 'desc' ? '‚ñº' : '';
    }

    function clearAllSorts() {
      sortClient = 'none';
      sortDue = 'none';
      sortPriority = 'none';
    }

    document.getElementById('sortClient').addEventListener('click', () => {
      const next = sortClient === 'none' ? 'asc' : sortClient === 'asc' ? 'desc' : 'none';
      clearAllSorts();
      sortClient = next;
      localStorage.setItem(SORT_CLIENT_KEY, sortClient);
      localStorage.setItem(SORT_DUE_KEY, sortDue);
      localStorage.setItem(SORT_PRIORITY_KEY, sortPriority);
      updateSortIcons();
      renderTasks();
    });

    document.getElementById('sortDue').addEventListener('click', () => {
      const next = sortDue === 'none' ? 'asc' : sortDue === 'asc' ? 'desc' : 'none';
      clearAllSorts();
      sortDue = next;
      localStorage.setItem(SORT_CLIENT_KEY, sortClient);
      localStorage.setItem(SORT_DUE_KEY, sortDue);
      localStorage.setItem(SORT_PRIORITY_KEY, sortPriority);
      updateSortIcons();
      renderTasks();
    });

    document.getElementById('sortPriority').addEventListener('click', () => {
      const next = sortPriority === 'none' ? 'asc' : sortPriority === 'asc' ? 'desc' : 'none';
      clearAllSorts();
      sortPriority = next;
      localStorage.setItem(SORT_CLIENT_KEY, sortClient);
      localStorage.setItem(SORT_DUE_KEY, sortDue);
      localStorage.setItem(SORT_PRIORITY_KEY, sortPriority);
      updateSortIcons();
      renderTasks();
    });

    updateSortIcons();

    document.getElementById('clearArchiveBtn').addEventListener('click', async () => {
      if (archive.length === 0) return;
      const ok = confirm('Clear archive permanently?\n\nThis cannot be undone.');
      if (!ok) return;

      if (hasFirebaseConfig() && currentUser && fbDb) {
        try {
          const uid = currentUser.uid;
          const snap = await userArchiveCol(uid).get();
          const batch = fbDb.batch();
          snap.forEach(d => batch.delete(d.ref));
          await batch.commit();
        } catch (e) {
          console.warn(e);
        }
      }

      archive = [];
      saveTasks(true);
      renderTasks();
    });

    document.getElementById('clearBlankBtn').addEventListener('click', async () => {
      const blankTasks = tasks.filter(t => {
        const client = (t.client || '').trim();
        const desc = (t.description || '').trim();
        return client === '' && desc === '';
      });

      if (blankTasks.length === 0) {
        showToast('No blank rows to remove');
        return;
      }

      // Remove blank tasks from Firestore if logged in
      if (hasFirebaseConfig() && currentUser && fbDb) {
        try {
          const uid = currentUser.uid;
          for (const t of blankTasks) {
            await userTasksCol(uid).doc(t.id).delete();
          }
        } catch (e) {
          console.warn(e);
        }
      }

      // Remove blank tasks from local array
      tasks = tasks.filter(t => {
        const client = (t.client || '').trim();
        const desc = (t.description || '').trim();
        return !(client === '' && desc === '');
      });

      saveTasks(true);
      renderTasks();
      showToast(`Removed ${blankTasks.length} blank row${blankTasks.length > 1 ? 's' : ''}`);
    });

    // ===== Auth wiring =====
    const authBackdrop = document.getElementById('authBackdrop');
    const appWrap = document.getElementById('app');
    const authEmail = document.getElementById('authEmail');
    const authPass = document.getElementById('authPass');
    const authStatus = document.getElementById('authStatus');
    const userBadge = document.getElementById('userBadge');

    function showAuth(msg = '') {
      authBackdrop.style.display = 'flex';
      appWrap.style.display = 'none';
      authStatus.textContent = msg || (hasFirebaseConfig() ? 'Not signed in' : 'Firebase not configured');
    }

    function showApp() {
      authBackdrop.style.display = 'none';
      appWrap.style.display = 'block';
    }

    // System announcements handling (supports multiple)
    function showSystemAnnouncements(announcements) {
      const container = document.getElementById('announcementsContainer');
      if (!container || !announcements || announcements.length === 0) {
        if (container) container.innerHTML = '';
        return;
      }

      // Get dismissed announcements from session
      const dismissed = JSON.parse(sessionStorage.getItem('dismissedAnnouncements') || '[]');

      const colors = {
        info: 'var(--accent)',
        success: 'var(--success)',
        warning: 'var(--warning)',
        danger: 'var(--danger)'
      };

      const now = Date.now();
      const activeAnnouncements = announcements.filter(ann => {
        if (!ann.enabled) return false;
        const hasStarted = !ann.startsAt || now >= ann.startsAt;
        const hasEnded = ann.endsAt && now > ann.endsAt;
        const isDismissed = dismissed.includes(ann.createdAt?.toString() || ann.title);
        return hasStarted && !hasEnded && !isDismissed;
      });

      if (activeAnnouncements.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = activeAnnouncements.map((ann, idx) => {
        const bgColor = colors[ann.type] || colors.info;
        const annId = ann.createdAt?.toString() || ann.title;
        return `
          <div class="announcement-banner" data-id="${annId}" style="background:${bgColor}; color:white; padding:10px 20px; text-align:center; position:relative; display:flex; align-items:center; justify-content:center; gap:8px;">
            <strong>${ann.title || ''}</strong>
            <span>${ann.message || ''}</span>
            <button onclick="dismissAnnouncement('${annId}')" style="position:absolute; right:12px; background:none; border:none; color:white; cursor:pointer; font-size:18px; opacity:0.8;">&times;</button>
          </div>
        `;
      }).join('');
    }

    function dismissAnnouncement(annId) {
      const dismissed = JSON.parse(sessionStorage.getItem('dismissedAnnouncements') || '[]');
      if (!dismissed.includes(annId)) {
        dismissed.push(annId);
        sessionStorage.setItem('dismissedAnnouncements', JSON.stringify(dismissed));
      }
      // Remove the banner from DOM
      const banner = document.querySelector(`.announcement-banner[data-id="${annId}"]`);
      if (banner) banner.remove();
    }

    // Admin override banner (when admin enters another firm)
    function showAdminOverrideBanner(firmName) {
      // Create banner if it doesn't exist
      let banner = document.getElementById('adminOverrideBanner');
      if (!banner) {
        banner = document.createElement('div');
        banner.id = 'adminOverrideBanner';
        banner.style.cssText = 'background: linear-gradient(135deg, #7c3aed, #4f46e5); color: white; padding: 8px 20px; text-align: center; position: fixed; top: 0; left: 0; right: 0; z-index: 99998; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 12px;';
        document.body.insertBefore(banner, document.body.firstChild);
        // Add padding to body to account for banner
        document.body.style.paddingTop = '40px';
      }
      banner.innerHTML = `
        <span><strong>Admin Mode:</strong> Viewing "${firmName}"</span>
        <a href="admin.html" style="color: white; text-decoration: underline; font-weight: 600;">Back to Admin Portal</a>
      `;
      banner.style.display = 'flex';
    }

    // Admin portal link (subtle link for admins using their own account)
    function showAdminPortalLink() {
      let link = document.getElementById('adminPortalLink');
      if (!link) {
        link = document.createElement('div');
        link.id = 'adminPortalLink';
        link.style.cssText = 'background: rgba(124, 58, 237, 0.9); color: white; padding: 6px 16px; text-align: center; position: fixed; top: 0; right: 0; z-index: 99998; font-size: 12px; border-bottom-left-radius: 8px;';
        document.body.appendChild(link);
      }
      link.innerHTML = `<a href="admin.html" style="color: white; text-decoration: none; font-weight: 600;">&#9881; Admin Portal</a>`;
      link.style.display = 'block';
    }

    async function doSignIn() {
      if (!hasFirebaseConfig() || !fbAuth) {
        alert('Firebase is not configured. Add FIREBASE_CONFIG values in the code.');
        return;
      }
      const email = (authEmail.value || '').trim();
      const pass = authPass.value || '';
      if (!email || !pass) {
        authStatus.textContent = 'Enter email + password';
        return;
      }
      authStatus.textContent = 'Signing in‚Ä¶';
      try {
        await fbAuth.signInWithEmailAndPassword(email, pass);
      } catch (e) {
        authStatus.textContent = (e && e.message) ? e.message : 'Sign in failed';
      }
    }

    async function doSignUp() {
      if (!hasFirebaseConfig() || !fbAuth) {
        alert('Firebase is not configured. Add FIREBASE_CONFIG values in the code.');
        return;
      }
      const email = (authEmail.value || '').trim();
      const pass = authPass.value || '';
      if (!email || !pass) {
        authStatus.textContent = 'Enter email + password';
        return;
      }
      if (pass.length < 6) {
        authStatus.textContent = 'Password must be at least 6 characters';
        return;
      }
      authStatus.textContent = 'Creating‚Ä¶';
      try {
        await fbAuth.createUserWithEmailAndPassword(email, pass);
      } catch (e) {
        authStatus.textContent = (e && e.message) ? e.message : 'Create account failed';
      }
    }

    document.getElementById('signInBtn').addEventListener('click', doSignIn);
    document.getElementById('signUpBtn').addEventListener('click', doSignUp);
    document.getElementById('signOutBtn').addEventListener('click', async () => {
      if (!fbAuth) return;
      try { await fbAuth.signOut(); } catch (e) { console.warn(e); }
      // Clear password field on sign out
      document.getElementById('authPass').value = '';
    });

    // Header sign out button
    document.getElementById('signOutBtnHeader').addEventListener('click', async () => {
      if (!fbAuth) return;
      try { await fbAuth.signOut(); } catch (e) { console.warn(e); }
      document.getElementById('authPass').value = '';
    });

    // Firm switcher button - onclick handler is defined inline on the button

    authPass.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        doSignIn();
      }
    });

    // Cancel button - return to home
    document.getElementById('cancelAuthBtn').addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    // Toggle password visibility
    document.getElementById('togglePassBtn').addEventListener('click', () => {
      const passInput = document.getElementById('authPass');
      const toggleBtn = document.getElementById('togglePassBtn');
      if (passInput.type === 'password') {
        passInput.type = 'text';
        toggleBtn.textContent = 'Hide';
      } else {
        passInput.type = 'password';
        toggleBtn.textContent = 'Show';
      }
    });

    // Forgot password
    document.getElementById('forgotPassBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      const email = document.getElementById('authEmail').value.trim();
      if (!email) {
        alert('Please enter your email address first.');
        return;
      }
      if (!fbAuth) return;
      try {
        await fbAuth.sendPasswordResetEmail(email);
        alert('Password reset email sent. Check your inbox.');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    });

    // Event listeners for Team modal
    document.getElementById('teamCloseBtn').addEventListener('click', () => hideModal('teamModalBackdrop'));


    // Boot
    (async function init() {
      // Initialize theme
      setTheme(getPreferredTheme());

      // Start notification checker if enabled
      startNotificationChecker();

      loadLocal();

      // Process recurring tasks
      processRecurringTasks();

      if (hasFirebaseConfig()) {
        if (fbAuth) {
          showAuth('Not signed in');
          fbAuth.onAuthStateChanged(async (user) => {
            currentUser = user || null;
            if (!currentUser) {
              userBadge.textContent = '‚Äî';
              showAuth('Not signed in');
              return;
            }

            userBadge.textContent = currentUser.email || 'Signed in';
            document.getElementById('userBadgeHeader').textContent = currentUser.email || '';
            authStatus.textContent = '';

            try {
              // Check for admin override (admin entering a specific firm)
              const urlParams = new URLSearchParams(window.location.search);
              const adminFirmOverride = urlParams.get('adminFirm');
              let isAppAdmin = false;

              // Check if user is an app admin
              const adminDoc = await fbDb.collection('appAdmins').doc(currentUser.uid).get();
              if (adminDoc.exists && adminDoc.data().isActive) {
                isAppAdmin = true;
                window.isAppAdmin = true; // Global flag for UI

                // If admin came here without specifying a firm, redirect to admin dashboard
                if (!adminFirmOverride) {
                  window.location.href = 'admin.html';
                  return;
                }

                // If admin is entering a specific firm (not their own), show override banner
                if (adminFirmOverride) {
                  // Verify the firm exists
                  const firmDoc = await fbDb.collection('firms').doc(adminFirmOverride).get();
                  if (firmDoc.exists) {
                    // Check if this is the admin's own firm
                    const adminUserDoc = await fbDb.collection('users').doc(currentUser.uid).get();
                    const adminUserData = adminUserDoc.exists ? adminUserDoc.data() : {};
                    const isOwnFirm = adminUserData.firmId === adminFirmOverride;

                    currentFirmId = adminFirmOverride;
                    firmSetupDismissed = true;
                    window.isAdminOverride = !isOwnFirm; // Only flag if viewing another firm
                    await loadFirmData(currentFirmId);
                    showApp();
                    updateFirmUI();

                    // Show admin banner (different style if viewing own firm vs other firm)
                    if (isOwnFirm) {
                      showAdminPortalLink(); // Just show link to admin portal
                    } else {
                      showAdminOverrideBanner(firmDoc.data().name || 'Unknown Firm');
                    }
                    setSavedStamp();
                    setActiveTimerStamp();
                    setArchiveCount();
                    renderTasks();
                    return;
                  }
                }

                // Admin without override param - continue to load their own data normally
                // but show admin portal link
              }

              // Check app config for maintenance mode and announcements
              const appConfigDoc = await fbDb.collection('appConfig').doc('main').get();
              const appConfig = appConfigDoc.exists ? appConfigDoc.data() : {};

              // Handle maintenance mode (admins bypass this)
              if (appConfig.maintenanceMode && !isAppAdmin) {
                const maintenanceOverlay = document.getElementById('maintenanceOverlay');
                const maintenanceMsg = document.getElementById('maintenanceMessage');
                if (appConfig.maintenanceMessage) {
                  maintenanceMsg.textContent = appConfig.maintenanceMessage;
                }
                maintenanceOverlay.style.display = 'flex';
                authBackdrop.style.display = 'none';
                return; // Don't proceed with app loading
              }

              // Handle system announcements (supports multiple)
              if (appConfig.announcements && appConfig.announcements.length > 0) {
                showSystemAnnouncements(appConfig.announcements);
              }

              // Check if user belongs to a firm and auto-migrate firmId to firmIds
              const userDoc = await fbDb.collection('users').doc(currentUser.uid).get();
              const userData = userDoc.exists ? userDoc.data() : {};

              // Auto-migrate: if firmId exists but firmIds doesn't, create firmIds array
              if (userData.firmId && !userData.firmIds) {
                await fbDb.collection('users').doc(currentUser.uid).set({
                  firmIds: [userData.firmId]
                }, { merge: true });
                userData.firmIds = [userData.firmId];
              }

              // Load all firms user belongs to
              await loadUserFirms();

              if (userFirms.length > 1) {
                // User belongs to multiple firms - always show selector
                showApp();
                showFirmSelectorModal();
                if (isAppAdmin) {
                  showAdminPortalLink();
                }
              } else if (userData.firmId) {
                // Single firm mode - load firm data
                currentFirmId = userData.firmId;
                firmSetupDismissed = true;
                await loadFirmData(currentFirmId);
                showApp();
                updateFirmUI();
                updateFirmSwitcher();
                if (isAppAdmin) {
                  showAdminPortalLink();
                }
              } else if (userFirms.length === 1) {
                // User belongs to exactly one firm - load it directly
                currentFirmId = userFirms[0].id;
                firmSetupDismissed = true;
                await fbDb.collection('users').doc(currentUser.uid).set({ firmId: currentFirmId }, { merge: true });
                await loadFirmData(currentFirmId);
                showApp();
                updateFirmUI();
                if (isAppAdmin) {
                  showAdminPortalLink();
                }
              } else {
                // No firm yet - load solo data and show firm setup modal
                try {
                  await loadFromFirestore();
                  await loadMasterLists();
                } catch (e2) {
                  console.warn('Solo data load:', e2);
                }
                showApp();
                // Show admin portal link if user is an app admin
                if (isAppAdmin) {
                  showAdminPortalLink();
                } else {
                  showFirmSetupModal();
                }
              }
            } catch (e) {
              console.warn('Firm check failed, falling back to solo mode:', e);
              // Fallback to solo mode
              try {
                await loadFromFirestore();
                await loadMasterLists();
              } catch (e2) {
                console.warn(e2);
              }
              showApp();
            }

            setSavedStamp();
            setActiveTimerStamp();
            setArchiveCount();
            renderTasks();
          });
        } else {
          // Firebase configured but failed to load - show error, don't bypass auth
          showAuth('Firebase failed to load. Please refresh.');
        }
      } else {
        // No Firebase config - allow local-only mode
        showApp();
        setSavedStamp();
        setActiveTimerStamp();
        setArchiveCount();
        renderTasks();
      }
    })();
  </script>
</body>
</html>
