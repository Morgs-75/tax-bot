<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Loan Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-main: #050509;
      --bg-panel: #141420;
      --border-subtle: #2a2a3d;
      --accent: #14b8a6;
      --accent-2: #5eead4;
      --text-main: #f5f5f7;
      --text-muted: #9ca3af;
      --danger-soft: rgba(249, 115, 115, 0.10);
      --radius-lg: 12px;
      --radius-md: 8px;
      --shadow-soft: 0 18px 45px rgba(0,0,0,0.65);
    }

    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }

    body {
      margin: 0;
      padding: 16px;
      background: radial-gradient(circle at top, #111827 0, #020617 40%, #000 100%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
    }

    .app-shell { width: 100%; max-width: 1650px; display: flex; flex-direction: column; gap: 16px; }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 14px 18px;
      border-radius: var(--radius-lg);
      background: linear-gradient(120deg, rgba(15, 23, 42, 0.9), rgba(17, 24, 39, 0.95));
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: var(--shadow-soft);
    }

    .app-title-block h1 { margin: 0 0 4px; font-size: 18px; letter-spacing: 0.03em; }
    .app-title-block p { margin: 0; font-size: 12px; color: var(--text-muted); }

    .app-actions { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.85);
      color: var(--text-main);
      padding: 6px 14px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s ease-out;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #0d9488, #14b8a6);
      border-color: transparent;
      box-shadow: 0 8px 20px rgba(20, 184, 166, 0.45);
    }

    .btn:hover {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(20, 184, 166, 0.35), rgba(15, 23, 42, 0.98));
      transform: translateY(-0.5px);
    }

    .btn-danger {
      background: var(--danger-soft);
      border-color: rgba(248, 113, 113, 0.6);
      color: #fecaca;
    }

    .btn-icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      font-size: 14px;
    }

    .badge-neutral {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      padding: 3px 7px;
      font-size: 10px;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .layout-grid { display: grid; grid-template-columns: minmax(360px, 520px) minmax(0, 1fr); gap: 16px; }
    @media (max-width: 1024px) { .layout-grid { grid-template-columns: 1fr; } }

    .panel {
      background: radial-gradient(circle at top left, rgba(20, 184, 166, 0.12), transparent 56%),
                  radial-gradient(circle at bottom right, rgba(129, 140, 248, 0.09), transparent 60%),
                  var(--bg-panel);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: 0 18px 40px rgba(0,0,0,0.7);
      padding: 14px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 0;
    }

    #loanSetupPanel { border: 2px solid var(--accent); }

    .panel-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 4px; }
    .panel-title { font-size: 13px; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; color: #e5e7eb; }
    .panel-sub { font-size: 11px; color: var(--text-muted); }

    .pill {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--text-muted);
    }

    .form-grid { display: flex; flex-direction: column; gap: 12px; }

    /* Form rows for horizontal distribution */
    .form-row {
      display: flex;
      gap: 12px;
    }
    .form-row > .stack {
      flex: 1;
      min-width: 0;
    }
    .form-row-2 > .stack { flex: 1 1 50%; }
    .form-row-3 > .stack { flex: 1 1 33.333%; }

    @media (max-width: 640px) {
      .form-row { flex-direction: column; }
      .form-row > .stack { flex: 1 1 100%; }
    }

    .stack { display: flex; flex-direction: column; gap: 6px; }

    label { font-size: 11px; color: var(--accent-2); font-weight: 700; margin-bottom: 3px; display: block; }

    /* Remove spinner controls from number inputs */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] { -moz-appearance: textfield; }

    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 6px 8px;
      font-size: 12px;
      background: #020617;
      border-radius: 6px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: var(--text-main);
      outline: none;
      transition: border-color 0.15s ease-out, box-shadow 0.15s ease-out, background 0.15s ease-out;
    }

    input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 1px rgba(20, 184, 166, 0.8); }
    input::placeholder { color: #6b7280; }

    .numeric-input { text-align: right; }

    .config-panels { display: flex; flex-direction: column; gap: 10px; }

    .table-wrapper { border-radius: var(--radius-md); border: 1px solid var(--border-subtle); background: rgba(15, 23, 42, 0.9); overflow: hidden; }

    /* Schedule table scrolling with sticky header */
    #schedulePanel .table-wrapper { 
      max-height: 70vh; 
      overflow-y: auto; 
      overflow-x: auto; 
    }

    /* Schedule table column sizing:
       - Let browser auto-size to widest numeric content
       - Then equalise all columns to the max measured width via JS */
    #schedulePanel table { table-layout: auto; width: 100%; }

    #schedulePanel th,
    #schedulePanel td {
      white-space: normal; /* allow header wrapping */
      word-break: break-word;
    }

    table { width: 100%; border-collapse: collapse; font-size: 11px; }

    thead { background: linear-gradient(to right, rgba(15, 23, 42, 0.9), rgba(17, 24, 39, 0.95)); }

    #scheduleHead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: linear-gradient(to right, rgba(15, 23, 42, 0.98), rgba(17, 24, 39, 0.99));
    }

    th, td { padding: 4px 6px; border-bottom: 1px solid rgba(31, 41, 55, 0.9); white-space: nowrap; }

    th {
      text-align: left;
      font-weight: 500;
      color: #9ca3af;
      position: sticky;
      top: 0;
      z-index: 1;
      background: linear-gradient(to right, rgba(15, 23, 42, 0.96), rgba(17, 24, 39, 0.98));
    }

    td.numeric, th.numeric { text-align: right; font-variant-numeric: tabular-nums; }

    tbody tr:nth-child(even) { background: rgba(15, 23, 42, 0.8); }
    tbody tr:nth-child(odd) { background: rgba(15, 23, 42, 0.6); }
    tbody tr:hover { background: rgba(30, 64, 175, 0.45); }

    .summary-strip { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 8px; }

    .summary-card {
      padding: 6px 8px;
      border-radius: 10px;
      background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.24), transparent 60%), rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(20, 184, 166, 0.55);
      min-width: 0;
      flex: 1 1 110px;
    }

    .summary-label { font-size: 10px; color: var(--text-main); text-transform: uppercase; letter-spacing: 0.08em; text-align: center; }
    .summary-value { margin-top: 2px; font-size: 13px; font-variant-numeric: tabular-nums; text-align: center; }

    .error-box {
      display: none;
      margin-top: 4px;
      padding: 8px 10px;
      border-radius: 8px;
      background: var(--danger-soft);
      border: 1px solid rgba(248, 113, 113, 0.7);
      color: #fecaca;
      font-size: 11px;
    }

    .error-box span { font-weight: 600; margin-right: 4px; }

    .warning-box {
      display: none;
      position: relative;
      margin-top: 4px;
      padding: 8px 30px 8px 10px;
      border-radius: 8px;
      background: rgba(251, 191, 36, 0.15);
      border: 1px solid rgba(251, 191, 36, 0.5);
      color: #fcd34d;
      font-size: 11px;
    }

    .warning-box span.warning-icon { font-weight: 600; margin-right: 4px; }

    .warning-box .warning-close {
      position: absolute;
      top: 4px;
      right: 6px;
      background: none;
      border: none;
      color: #fcd34d;
      font-size: 14px;
      cursor: pointer;
      padding: 2px 6px;
      line-height: 1;
      opacity: 0.7;
    }

    .warning-box .warning-close:hover { opacity: 1; }

    .caption-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-top: 2px; font-size: 11px; color: var(--text-muted); flex-wrap: wrap; }
    .note { font-size: 10px; color: var(--text-muted); }

    /* Date input with icon INSIDE */
    .date-row { position: relative; display: flex; align-items: center; }

    .date-row .date-input {
      width: 100%;
      padding-right: 40px;
      cursor: text;
      user-select: text;
    }

    .date-row .picker-hint {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      width: 28px;
      height: 28px;
      padding: 0;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      background: rgba(15, 23, 42, 0.95);
      border: none;
      color: var(--text-main);
      cursor: pointer;
    }

    .date-row .picker-hint:hover { background: rgba(20, 184, 166, 0.18); }

    /* Date picker overlay */
    .dp-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.12);
      display: none;
      z-index: 10001;
    }

    .dp {
      position: absolute;
      width: 320px;
      max-width: calc(100vw - 24px);
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.98), rgba(2, 6, 23, 0.98));
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.8);
      padding: 12px;
      --dp-arrow-left: 18px;
      --dp-arrow-top: -6px;
      --dp-arrow-bottom: auto;
    }

    .dp::before {
      content: "";
      position: absolute;
      width: 10px;
      height: 10px;
      background: rgba(15, 23, 42, 0.98);
      border-left: 1px solid rgba(148, 163, 184, 0.25);
      border-top: 1px solid rgba(148, 163, 184, 0.25);
      transform: rotate(45deg);
      top: var(--dp-arrow-top);
      bottom: var(--dp-arrow-bottom);
      left: var(--dp-arrow-left);
    }

    .dp-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 10px; }

    .dp-month { display: flex; justify-content: center; align-items: center; gap: 8px; flex: 1 1 auto; }

    .dp-select {
      appearance: none;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
      color: var(--text-main);
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 12px;
      cursor: pointer;
      outline: none;
      min-width: 120px;
      text-align: center;
    }

    .dp-select:focus { border-color: var(--accent); box-shadow: 0 0 0 1px rgba(20, 184, 166, 0.8); }

    .dp-nav {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      cursor: pointer;
    }

    .dp-nav:hover { border-color: var(--accent); }

    .dp-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }

    .dp-dow { font-size: 10px; color: var(--text-muted); text-align: center; padding: 4px 0; }

    .dp-day {
      height: 34px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.15);
      background: rgba(15, 23, 42, 0.85);
      color: var(--text-main);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
    }

    .dp-day:hover { border-color: var(--accent); background: rgba(20, 184, 166, 0.22); }
    .dp-day.muted { opacity: 0.35; }
    .dp-day.today { border-color: rgba(34, 197, 94, 0.6); }
    .dp-day.selected { border-color: var(--accent); background: rgba(20, 184, 166, 0.35); }

    .dp-footer { display: flex; justify-content: space-between; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .dp-footer .btn { flex: 1 1 auto; justify-content: center; }

    .hidden { display: none !important; }

    /* Print Options Modal */
    .print-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    .print-modal {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 24px;
      min-width: 300px;
      max-width: 400px;
    }
    .print-modal h3 {
      margin: 0 0 16px;
      color: var(--text-main);
      font-size: 16px;
    }
    .print-modal label {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      color: var(--text-main);
      cursor: pointer;
    }
    .print-modal input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #14b8a6;
    }
    .print-modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: flex-end;
    }

    /* Transaction Modal */
    .transaction-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    .transaction-modal {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 24px;
      min-width: 400px;
      max-width: 500px;
    }
    .transaction-modal h3 {
      margin: 0 0 16px;
      color: var(--text-main);
      font-size: 16px;
    }
    .transaction-modal .form-group {
      margin-bottom: 14px;
    }
    .transaction-modal label {
      display: block;
      margin-bottom: 6px;
      color: var(--text-main);
      font-size: 12px;
    }
    .transaction-modal input,
    .transaction-modal select,
    .transaction-modal textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.8);
      color: var(--text-main);
      font-size: 13px;
    }
    .transaction-modal textarea {
      min-height: 80px;
      resize: vertical;
    }
    .transaction-modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: flex-end;
    }
    .transaction-modal .date-row {
      width: 100%;
    }
    .transaction-modal .date-row .date-input {
      padding-right: 40px;
    }

    /* Info tooltip with dimmed overlay */
    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 3px;
      background: rgba(79,156,255,0.3);
      color: var(--accent);
      font-size: 11px;
      font-weight: bold;
      cursor: help;
      position: relative;
    }
    .info-icon:hover .info-overlay {
      display: block;
    }
    .info-icon:hover .info-tooltip {
      display: block;
    }
    .info-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 9998;
    }
    .info-tooltip {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--bg-panel);
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 16px 20px;
      max-width: 350px;
      color: var(--text-main);
      font-size: 13px;
      font-weight: normal;
      line-height: 1.5;
      z-index: 9999;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }

    /* Term Sheet Styles */
    .term-sheet {
      display: none;
      font-family: Arial, sans-serif;
      font-size: 11px;
      color: #000;
      background: #fff;
      padding: 40px;
      max-width: 800px;
      margin: 0 auto;
    }

    .term-sheet h1 {
      font-size: 18px;
      text-align: center;
      margin: 0 0 8px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .term-sheet h2 {
      font-size: 14px;
      text-align: center;
      margin: 0 0 30px;
      font-weight: normal;
      color: #555;
    }

    .term-sheet .parties {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #ccc;
    }

    .term-sheet .party {
      flex: 1;
    }

    .term-sheet .party-label {
      font-size: 10px;
      text-transform: uppercase;
      color: #666;
      margin-bottom: 4px;
    }

    .term-sheet .party-name {
      font-size: 14px;
      font-weight: bold;
    }

    .term-sheet table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    .term-sheet th,
    .term-sheet td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .term-sheet th {
      width: 40%;
      font-weight: normal;
      color: #555;
      background: #f9f9f9;
    }

    .term-sheet td {
      font-weight: 500;
    }

    #tsRepaymentScheduleTable th {
      width: auto;
      font-weight: 500;
    }
    #tsRepaymentScheduleTable th:first-child,
    #tsRepaymentScheduleTable td:first-child {
      text-align: left;
    }
    #tsRepaymentScheduleTable th:nth-child(2),
    #tsRepaymentScheduleTable td:nth-child(2) {
      text-align: right;
    }
    #tsRepaymentScheduleTable th:nth-child(3),
    #tsRepaymentScheduleTable td:nth-child(3) {
      text-align: center;
    }
    #tsRepaymentScheduleTable td {
      font-weight: normal;
    }

    #tsYearlySummaryTable th,
    #tsYearlySummaryTable td,
    #tsMonthlySummaryTable th,
    #tsMonthlySummaryTable td {
      width: auto;
      font-size: 10px;
      padding: 6px 8px;
    }

    #tsYearlySummaryTable thead th,
    #tsMonthlySummaryTable thead th {
      font-weight: bold;
      background: #f0f0f0;
    }

    .term-sheet .section-title {
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: 25px 0 10px;
      padding-bottom: 5px;
      border-bottom: 2px solid #333;
    }

    .term-sheet .footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #ccc;
      font-size: 10px;
      color: #666;
      text-align: center;
    }

    /* Print Styles */
    @media print {
      html, body {
        margin: 0 !important;
        padding: 0 !important;
        height: auto !important;
        min-height: 0 !important;
        overflow: visible !important;
        background: #fff !important;
      }
      body > *:not(.term-sheet) {
        display: none !important;
        height: 0 !important;
        overflow: hidden !important;
      }
      .app-shell, .app-header, .main-content, .panel, .schedule-panel {
        display: none !important;
      }
      .term-sheet {
        display: block !important;
        position: static !important;
        width: 100% !important;
        max-width: 100% !important;
        height: auto !important;
        padding: 15px !important;
        margin: 0 !important;
        background: #fff !important;
        box-sizing: border-box !important;
      }
      .term-sheet * {
        visibility: visible !important;
      }
      .term-sheet table {
        page-break-inside: auto;
      }
      .term-sheet table thead {
        display: table-header-group;
      }
      .term-sheet table caption {
        display: table-caption;
        caption-side: top;
      }
      .term-sheet table tr {
        page-break-inside: avoid;
        break-inside: avoid;
      }
      #tsMonthlySummaryTable caption,
      #tsYearlySummaryTable caption {
        page-break-after: avoid !important;
        break-after: avoid !important;
      }
      #tsMonthlySummaryTable,
      #tsYearlySummaryTable {
        page-break-before: avoid !important;
        break-before: avoid !important;
      }
      .term-sheet .section-title {
        page-break-after: avoid;
      }
      .term-sheet .footer {
        margin-top: 20px;
      }
      #tsMonthlySummarySection[style*="display: none"],
      #tsYearlySummarySection[style*="display: none"] {
        display: none !important;
      }
      .print-modal-overlay {
        display: none !important;
      }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="app-title-block">
        <h1>Loan Management Schedule</h1>
        <p>Daily interest Â· Month-end capitalisation Â· Non-accrual support</p>
      </div>
      <div class="app-actions">
        <span class="badge-neutral">
          <span style="width:8px;height:8px;border-radius:999px;background:#22c55e;display:inline-block;"></span>
          <span>Live calculator</span>
        </span>
        <button class="btn btn-primary" id="recalcButton" type="button">Generate Schedule</button>
      </div>
    </header>

    <div class="layout-grid">
      <section class="panel" id="loanSetupPanel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Loan Setup</div>
            <div class="panel-sub">Core terms and schedule horizon</div>
          </div>
          <button class="btn btn-primary" type="button" id="printTermSheetButton">Print Loan Terms</button>
        </div>

        <div class="stack">
          <div class="form-grid">
            <!-- Line 1: Borrower, Lender -->
            <div class="form-row form-row-2">
              <div class="stack">
                <label for="borrowerName">Borrower</label>
                <input id="borrowerName" type="text" placeholder="Borrower name" />
              </div>
              <div class="stack">
                <label for="lenderName">Lender</label>
                <input id="lenderName" type="text" placeholder="Lender name" />
              </div>
            </div>

            <!-- Line 2: Loan Start, Loan End, First Repayment -->
            <div class="form-row form-row-3">
              <div class="stack">
                <label for="loanStartDate">Loan Start</label>
                <div class="date-row">
                  <input id="loanStartDate" class="date-input" type="text" placeholder="DD/MM/YYYY" />
                  <button class="picker-hint" type="button" data-open-picker="loanStartDate" title="Pick date" aria-label="Pick date">ðŸ“…</button>
                </div>
              </div>
              <div class="stack">
                <label for="scheduleEndDate">Loan End</label>
                <div class="date-row">
                  <input id="scheduleEndDate" class="date-input" type="text" placeholder="DD/MM/YYYY" />
                  <button class="picker-hint" type="button" data-open-picker="scheduleEndDate" title="Pick date" aria-label="Pick date">ðŸ“…</button>
                </div>
              </div>
              <div class="stack" id="firstRepaymentStack">
                <label for="firstRepaymentDate">First Repayment</label>
                <div class="date-row">
                  <input id="firstRepaymentDate" class="date-input" type="text" placeholder="DD/MM/YYYY" />
                  <button class="picker-hint" type="button" data-open-picker="firstRepaymentDate" title="Pick date" aria-label="Pick date">ðŸ“…</button>
                </div>
              </div>
            </div>

            <!-- Line 3: Facility Amount, Balloon -->
            <div class="form-row form-row-2">
              <div class="stack">
                <label for="initialAmount">Facility Amount</label>
                <input id="initialAmount" type="number" class="numeric-input" step="0.01" min="0" placeholder="0.00" />
              </div>
              <div class="stack">
                <label for="balloonResidual">Balloon</label>
                <input id="balloonResidual" type="number" class="numeric-input" step="0.01" min="0" placeholder="0.00" />
              </div>
            </div>

            <!-- Line 4: Cash Rate, PIK Rate -->
            <div class="form-row form-row-2">
              <div class="stack">
                <label for="cashRateType">Cash Rate Type</label>
                <select id="cashRateType">
                  <option value="fixed" selected>Fixed</option>
                  <option value="variable">Variable (Base + Margin)</option>
                </select>
              </div>
              <div class="stack">
                <label for="pikRate">PIK Rate (%)</label>
                <input id="pikRate" type="number" class="numeric-input" step="0.0001" min="0" placeholder="0.00" />
              </div>
            </div>

            <!-- Line 4b: Cash Rate Details (conditional) -->
            <div class="form-row form-row-2" id="cashRateFixedRow">
              <div class="stack">
                <label for="initialRate" id="initialRateLabel">Annual Rate (%)</label>
                <input id="initialRate" type="number" class="numeric-input" step="0.0001" placeholder="10.00" />
              </div>
              <div class="stack">
                <label for="defaultInterestRate">Default Interest (%)</label>
                <input id="defaultInterestRate" type="number" class="numeric-input" step="0.0001" min="0" placeholder="0.00" />
              </div>
            </div>

            <div class="form-row" id="cashRateVariableRow" style="display:none;">
              <div class="stack" style="flex:1;">
                <label for="baseRateSource">Base Rate Source</label>
                <select id="baseRateSource" style="width:100%;">
                  <option value="rba" selected>RBA Cash Rate</option>
                  <option value="manual">Manual Entry</option>
                </select>
              </div>
              <div class="stack" style="flex:1;">
                <label for="fixedMargin">Margin (%)</label>
                <input id="fixedMargin" type="number" class="numeric-input" step="0.0001" placeholder="0.00" />
              </div>
              <div class="stack" style="flex:1;">
                <label for="totalRateDisplay">Total Rate (%)</label>
                <input id="totalRateDisplay" type="text" class="numeric-input" readonly value="0.00" />
              </div>
              <div class="stack" style="flex:1;">
                <label for="defaultInterestRateVar">Default Interest (%)</label>
                <input id="defaultInterestRateVar" type="number" class="numeric-input" step="0.0001" min="0" placeholder="0.00" />
              </div>
            </div>

            <!-- Line 5: Loan Costs, Exit Fee -->
            <div class="form-row form-row-2">
              <div class="stack">
                <label for="loanCostsTotal">Loan Costs</label>
                <div style="display:flex;gap:6px;align-items:center;">
                  <input id="loanCostsTotal" type="number" class="numeric-input" step="0.01" min="0" placeholder="0.00" readonly />
                  <button class="btn" type="button" id="editLoanCostsBtn" style="padding:4px 8px;font-size:11px;">Edit</button>
                </div>
              </div>
              <div class="stack">
                <label for="exitFeeAmount">Exit Fee</label>
                <input id="exitFeeAmount" type="number" class="numeric-input" step="0.01" min="0" placeholder="0.00" />
                <small class="note">Payable at Loan End</small>
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;margin-top:4px;font-size:11px;color:var(--text-muted);">
                  <input type="checkbox" id="exitFeeFullOnEarly" style="width:14px;height:14px;accent-color:#14b8a6;" />
                  Payable in full on early repayment
                </label>
              </div>
            </div>

            <!-- Line 6: Repayment Type, Repayment Holiday -->
            <div class="form-row form-row-2">
              <div class="stack">
                <label for="repaymentType">Repayment Type</label>
                <select id="repaymentType">
                  <option value="principalAndInterest" selected>Principal &amp; Interest</option>
                  <option value="interestOnly">Interest Only</option>
                  <option value="payableAtEnd">Payable at End</option>
                </select>
              </div>
              <div class="stack">
                <label for="repaymentHolidayType">Repayment Holiday</label>
                <select id="repaymentHolidayType">
                  <option value="none" selected>None</option>
                  <option value="principal">Principal Holiday (P&amp;I loans)</option>
                  <option value="full">Full Holiday</option>
                </select>
              </div>
            </div>

            <!-- Line 6b: Repayment Holiday Period (conditional) -->
            <div class="form-row form-row-2" id="repaymentHolidayPeriodRow" style="display:none;">
              <div class="stack">
                <label for="repaymentHolidayStart">Holiday Start</label>
                <div class="date-row">
                  <input id="repaymentHolidayStart" class="date-input" type="text" placeholder="DD/MM/YYYY" />
                  <button class="picker-hint" type="button" data-open-picker="repaymentHolidayStart" title="Pick date" aria-label="Pick date">ðŸ“…</button>
                </div>
              </div>
              <div class="stack">
                <label for="repaymentHolidayEnd">Holiday End</label>
                <div class="date-row">
                  <input id="repaymentHolidayEnd" class="date-input" type="text" placeholder="DD/MM/YYYY" />
                  <button class="picker-hint" type="button" data-open-picker="repaymentHolidayEnd" title="Pick date" aria-label="Pick date">ðŸ“…</button>
                </div>
              </div>
            </div>

            <!-- Line 7: Principal Holiday Starts/Ends -->
            <div class="form-row form-row-2">
              <div class="stack">
                <label for="principalHolidayStart">Principal Holiday Starts</label>
                <div class="date-row">
                  <input id="principalHolidayStart" class="date-input" type="text" placeholder="DD/MM/YYYY" />
                  <button class="picker-hint" type="button" data-open-picker="principalHolidayStart" title="Pick date" aria-label="Pick date">ðŸ“…</button>
                </div>
              </div>
              <div class="stack">
                <label for="principalHolidayEnd">Principal Holiday Ends</label>
                <div class="date-row">
                  <input id="principalHolidayEnd" class="date-input" type="text" placeholder="DD/MM/YYYY" />
                  <button class="picker-hint" type="button" data-open-picker="principalHolidayEnd" title="Pick date" aria-label="Pick date">ðŸ“…</button>
                </div>
              </div>
            </div>

            <!-- Line 8: Total Payment Holidays (multiple periods) -->
            <div class="stack">
              <label>Total Payment Holidays</label>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>Start Date</th>
                      <th>End Date</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="paymentHolidaysBody"></tbody>
                </table>
              </div>
              <button class="btn" type="button" onclick="addPaymentHolidayRow()">+ Add Payment Holiday</button>
            </div>

            <!-- Line 9: IRR fields (moved from exit fee section) -->
            <div class="form-row form-row-3">
              <div class="stack">
                <label for="irrExcludingFee">IRR (exc Exit Fee)</label>
                <input id="irrExcludingFee" type="text" readonly class="numeric-input" style="background:var(--bg-main);" value="â€”" />
              </div>
              <div class="stack">
                <label for="irrIncludingFee">IRR (inc Exit Fee)</label>
                <input id="irrIncludingFee" type="text" readonly class="numeric-input" style="background:var(--bg-main);" value="â€”" />
              </div>
              <div class="stack">
                <label for="exitFeeRateAnnual">Exit Fee Rate</label>
                <input id="exitFeeRateAnnual" type="text" readonly class="numeric-input" style="background:var(--bg-main);" value="â€”" />
              </div>
            </div>

            <!-- Calculated Payment Display -->
            <div class="form-row form-row-2">
              <div class="stack">
                <label for="calculatedPayment" style="display:flex;align-items:center;gap:6px;">
                  Initial Monthly Payment
                  <span class="info-icon">i
                    <span class="info-overlay"></span>
                    <span class="info-tooltip">When a drawdown occurs that is not considered as part of the initial loan, the principal payments will be updated to reflect the higher principal.</span>
                  </span>
                </label>
                <input id="calculatedPayment" type="text" class="numeric-input" readonly value="0.00" />
              </div>
              <div class="stack">
                <label for="overridePayment">Override Monthly Payment</label>
                <input id="overridePayment" type="number" class="numeric-input" step="0.01" min="0" placeholder="Auto-calculated" />
              </div>
            </div>

            <!-- Hidden legacy fields for compatibility -->
            <input type="hidden" id="useBaseMargin" />
            <input type="hidden" id="enableExitFee" value="1" />
            <input type="hidden" id="exitFeeDate" />
            <input type="hidden" id="exitFeeRateDaily" />
            <input type="hidden" id="piTermYears" />
            <input type="hidden" id="principalHolidayMonths" />
            <input type="hidden" id="holidayInterestTreatment" value="payMonthly" />
          </div>

          <div class="caption-row">
            <small>Interest calculated daily on a 365-day year and capitalised at calendar month-end (unless non-accrual or principal holiday interest-only handling).</small>
            <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
              <button class="btn" type="button" id="generatePiButton">Recalculate monthly payment</button>
              <div style="display:flex;gap:6px;">
                <button class="btn" type="button" id="clearAllButton" style="min-width:75px;justify-content:center;">Clear all</button>
                <button class="btn" type="button" id="saveLoanButton" style="min-width:75px;justify-content:center;">Save</button>
                <button class="btn" type="button" id="saveAsLoanButton" style="min-width:75px;justify-content:center;">Save As</button>
                <button class="btn" type="button" id="homeButton" style="min-width:75px;justify-content:center;">Home</button>
              </div>
              <select id="savedLoansSelect" style="min-width:150px;">
                <option value="">â€” Load saved loan â€”</option>
              </select>
              <button class="btn btn-danger" type="button" id="deleteLoanButton" style="padding:6px 10px;">âœ•</button>
            </div>
          </div>

          <div id="errorBox" class="error-box">
            <span>!</span><span id="errorMessageText"></span>
          </div>

          <div id="warningBox" class="warning-box">
            <span class="warning-icon">!</span><span id="warningMessageText"></span>
            <button type="button" class="warning-close" onclick="closeWarning()">&times;</button>
          </div>
        </div>

        <div class="stack" style="margin-top:10px;">
          <div class="panel-header" style="margin-bottom:4px;">
            <div>
              <div class="panel-title">Configuration</div>
              <div class="panel-sub">Transactions Â· Rate changes Â· Non-accrual periods</div>
            </div>
            <span class="pill">Step 2</span>
          </div>

          <div class="config-panels">
            <div class="stack">
              <div class="panel-sub" style="font-weight:500;">Transactions</div>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Type</th>
                      <th class="numeric">Amount</th>
                      <th>Description</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="transactionsBody"></tbody>
                </table>
              </div>
              <div style="display:flex;gap:6px;flex-wrap:wrap;">
                <button class="btn" type="button" onclick="addTransactionRow()" style="min-width:145px;justify-content:center;">+ Add transaction</button>
                <button class="btn" type="button" onclick="downloadTransactionTemplate()" style="min-width:145px;justify-content:center;">Download Template</button>
                <button class="btn" type="button" onclick="document.getElementById('transactionFileInput').click()" style="min-width:145px;justify-content:center;">Import from Excel</button>
                <input type="file" id="transactionFileInput" accept=".xlsx,.xls" style="display:none;" onchange="handleTransactionFileUpload(this)" />
              </div>
            </div>

            <div class="stack">
              <div class="panel-sub" style="font-weight:500;">Interest rate changes</div>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>Effective from</th>
                      <th class="numeric" id="rateChangeHeader">New rate (%)</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="rateChangesBody"></tbody>
                </table>
              </div>
              <button class="btn" type="button" onclick="addRateChangeRow()">+ Add rate change</button>
            </div>

            <div class="stack">
              <div class="panel-sub" style="font-weight:500;">Default interest periods</div>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>Start date</th>
                      <th>End date</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="defaultInterestBody"></tbody>
                </table>
              </div>
              <button class="btn" type="button" onclick="addDefaultInterestRow()">+ Add default interest period</button>
            </div>

            <div class="stack">
              <div class="panel-sub" style="font-weight:500;">Non-accrual periods</div>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>Start date</th>
                      <th>End date</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="nonAccrualBody"></tbody>
                </table>
              </div>
              <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                <button class="btn" type="button" onclick="addNonAccrualRow()">+ Add non-accrual period</button>
                <button class="btn btn-danger" type="button" onclick="capitaliseNonAccrualInterest()">Capitalise non-accrual interest</button>
                <label style="display:flex;align-items:center;gap:8px;margin-left:auto;color:var(--text-main);font-size:11px;">
                  <input id="enableNonAccrual" type="checkbox" checked style="width:14px;height:14px;accent-color:#14b8a6;" />
                  Track non-accrual interest
                </label>
              </div>
              <small class="note">If you capitalise, the non-accrual bucket is cleared on that capitalisation date (shown as 0.00 in the right-hand column).</small>
            </div>
          </div>
        </div>
      </section>

      <section class="panel" id="schedulePanel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Schedule</div>
            <div class="panel-sub">Daily schedule with month-end capitalisation</div>
          </div>
          <span class="pill">Step 3</span>
        </div>

        <div class="summary-strip">
          <div class="summary-card">
            <div class="summary-label">Initial Advance</div>
            <div class="summary-value" id="summaryInitialAdvance">0.00</div>
          </div>
          <div class="summary-card" id="summaryLoanCostsCard" style="display:none;">
            <div class="summary-label">Loan Costs</div>
            <div class="summary-value" id="summaryLoanCosts">0.00</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Drawdowns</div>
            <div class="summary-value" id="summaryDrawdowns">0.00</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Interest</div>
            <div class="summary-value" id="summaryInterest">0.00</div>
          </div>
          <div class="summary-card" id="summaryOtherCard" title="">
            <div class="summary-label">Other</div>
            <div class="summary-value" id="summaryOtherFees">0.00</div>
          </div>
          <div class="summary-card exitfee-summary" id="summaryExitFeeCard" style="display:none;">
            <div class="summary-label">Exit Fee</div>
            <div class="summary-value" id="summaryExitFee">0.00</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Repayments</div>
            <div class="summary-value" id="summaryRepayments">(0.00)</div>
          </div>
          <div class="summary-card exitfee-summary" id="summaryTotalCostCard" style="display:none;">
            <div class="summary-label">Total Cost</div>
            <div class="summary-value" id="summaryTotalCost">0.00</div>
          </div>
        </div>

        <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;margin-bottom:10px;">
          <div class="stack" style="flex:0 0 auto;">
            <label for="displayMode">Display</label>
            <select id="displayMode" style="width:140px;">
              <option value="daily" selected>Daily</option>
              <option value="monthly">Monthly</option>
              <option value="financialYear">Financial Year</option>
            </select>
          </div>
          <div class="stack" style="flex:0 0 auto;">
            <label for="filterFromDate">From date</label>
            <div class="date-row">
              <input id="filterFromDate" class="date-input" type="text" placeholder="DD/MM/YYYY" style="width:120px;" />
              <button class="picker-hint" type="button" data-open-picker="filterFromDate" title="Pick date" aria-label="Pick date">ðŸ“…</button>
            </div>
          </div>
          <div class="stack" style="flex:0 0 auto;">
            <label for="filterToDate">To date</label>
            <div class="date-row">
              <input id="filterToDate" class="date-input" type="text" placeholder="DD/MM/YYYY" style="width:120px;" />
              <button class="picker-hint" type="button" data-open-picker="filterToDate" title="Pick date" aria-label="Pick date">ðŸ“…</button>
            </div>
          </div>
          <button class="btn" type="button" id="clearFilterButton" style="min-width:115px;text-align:center;justify-content:center;">Clear filter</button>
          <button class="btn btn-primary" type="button" id="exportExcelButton">Export to Excel</button>
        </div>

        <div class="table-wrapper">
          <table>
            <thead id="scheduleHead">
              <tr>
                <th>Date</th>
                <th class="numeric" style="text-align:center;">Rate (%)</th>
                <th class="numeric">Opening balance</th>
                <th class="numeric">Drawdowns</th>
                <th class="numeric">Repayment</th>
                <th class="numeric">Interest for day</th>
                <th class="numeric">Month-end capitalised</th>
                <th class="numeric">Closing balance</th>
                <th class="numeric nonaccrual-col">Non-accrual interest balance</th>
              </tr>
            </thead>
            <tbody id="scheduleBody"></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <!-- Date Picker Overlay -->
  <div class="dp-overlay" id="dpOverlay" aria-hidden="true">
    <div class="dp" role="dialog" aria-modal="true" aria-label="Date picker">
      <div class="dp-header">
        <button class="dp-nav" type="button" id="dpPrev" aria-label="Previous month">â—€</button>
        <div class="dp-month">
          <select id="dpMonthSelect" class="dp-select" aria-label="Month"></select>
          <select id="dpYearSelect" class="dp-select" aria-label="Year"></select>
        </div>
        <button class="dp-nav" type="button" id="dpNext" aria-label="Next month">â–¶</button>
      </div>
      <div class="dp-grid" id="dpDow"></div>
      <div class="dp-grid" id="dpDays"></div>
      <div class="dp-footer">
        <button class="btn" type="button" id="dpToday">Today</button>
        <button class="btn btn-danger" type="button" id="dpClear">Clear</button>
        <button class="btn btn-primary" type="button" id="dpClose">Close</button>
      </div>
    </div>
  </div>

  <!-- Transaction Modal -->
  <div class="transaction-modal-overlay" id="transactionModal">
    <div class="transaction-modal">
      <h3>Add Transaction</h3>
      <div class="form-group">
        <label>Date</label>
        <div class="date-row">
          <input type="text" id="txModalDate" class="date-input" placeholder="DD/MM/YYYY" />
          <button class="picker-hint" type="button" id="txModalDatePicker" title="Pick date" aria-label="Pick date">ðŸ“…</button>
        </div>
      </div>
      <div class="form-group">
        <label>Type</label>
        <select id="txModalType">
          <option value="drawdown">Drawdown</option>
          <option value="repayment">Repayment</option>
        </select>
      </div>
      <div class="form-group">
        <label>Amount</label>
        <input type="number" id="txModalAmount" step="0.01" placeholder="0.00" />
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="txModalDescription" placeholder="Enter transaction description..."></textarea>
      </div>
      <div class="form-group" id="txModalAdjustGroup" style="display:none;">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
          <input type="checkbox" id="txModalAdjustPayments" style="width:16px;height:16px;accent-color:#14b8a6;" />
          Adjust future repayments
        </label>
        <small style="color:var(--text-muted);font-size:10px;margin-top:4px;display:block;">If checked, monthly payments will be recalculated after this repayment. If unchecked, payments continue unchanged and the loan may end early.</small>
      </div>
      <div class="transaction-modal-buttons">
        <button class="btn" type="button" onclick="closeTransactionModal()">Cancel</button>
        <button class="btn btn-primary" type="button" onclick="saveTransactionFromModal()">Add Transaction</button>
      </div>
    </div>
  </div>

  <!-- Loan Costs Modal -->
  <div class="transaction-modal-overlay" id="loanCostsModal">
    <div class="transaction-modal" style="min-width:500px;">
      <h3>Loan Costs Schedule</h3>
      <div class="table-wrapper" style="margin-bottom:12px;">
        <table>
          <thead>
            <tr>
              <th>Description</th>
              <th class="numeric">Amount</th>
              <th style="width:80px;text-align:center;">Deduct from Drawdown</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="loanCostsBody"></tbody>
        </table>
      </div>
      <button class="btn" type="button" onclick="addLoanCostRow()" style="margin-bottom:12px;">+ Add Cost</button>
      <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--bg-main);border-radius:6px;margin-bottom:12px;">
        <span style="font-weight:500;">Total Loan Costs:</span>
        <span id="loanCostsTotalDisplay" style="font-weight:700;">$0.00</span>
      </div>
      <div class="transaction-modal-buttons">
        <button class="btn" type="button" onclick="closeLoanCostsModal()">Cancel</button>
        <button class="btn btn-primary" type="button" onclick="saveLoanCostsModal()">Save</button>
      </div>
    </div>
  </div>

  <script>
    // NOTE: This app intentionally avoids JavaScript template literals (backticks).
    // Some sandboxes wrap HTML in document.write(`...`), and backticks inside can break parsing.

    // Global error surfacing
    window.addEventListener('error', function (e) {
      try {
        var msg = ((e && e.error && e.error.message) || (e && e.message) || 'Unknown error');
        if (e && e.filename) msg += ' (at ' + e.filename + ':' + e.lineno + ':' + e.colno + ')';
        showError(msg);
      } catch (_) {}
    });

    window.addEventListener('unhandledrejection', function (e) {
      try {
        var msg2 = (e && e.reason && e.reason.message) ? e.reason.message : String((e && e.reason) || 'Unhandled promise rejection');
        showError(msg2);
      } catch (_) {}
    });

    // --- Utilities ---

    function utcDate(y, m, d) { return new Date(Date.UTC(y, m, d)); }

    // --- RBA Cash Rate History (from 2000 to present) ---
    // Format: { date: 'YYYY-MM-DD', rate: X.XX }
    // Rates are effective from the date shown
    var RBA_CASH_RATES = [
      // 2000
      { date: '2000-02-02', rate: 5.50 },
      { date: '2000-04-05', rate: 5.75 },
      { date: '2000-05-03', rate: 6.00 },
      { date: '2000-08-02', rate: 6.25 },
      // 2001
      { date: '2001-02-07', rate: 5.75 },
      { date: '2001-03-07', rate: 5.50 },
      { date: '2001-04-04', rate: 5.00 },
      { date: '2001-05-02', rate: 4.75 },
      { date: '2001-06-06', rate: 5.00 },
      { date: '2001-09-05', rate: 4.75 },
      { date: '2001-10-03', rate: 4.50 },
      { date: '2001-12-05', rate: 4.25 },
      // 2002
      { date: '2002-05-08', rate: 4.50 },
      { date: '2002-06-05', rate: 4.75 },
      // 2003
      { date: '2003-11-05', rate: 5.00 },
      { date: '2003-12-03', rate: 5.25 },
      // 2005
      { date: '2005-03-02', rate: 5.50 },
      // 2006
      { date: '2006-05-03', rate: 5.75 },
      { date: '2006-08-02', rate: 6.00 },
      { date: '2006-11-08', rate: 6.25 },
      // 2007
      { date: '2007-08-08', rate: 6.50 },
      { date: '2007-11-07', rate: 6.75 },
      // 2008
      { date: '2008-02-06', rate: 7.00 },
      { date: '2008-03-05', rate: 7.25 },
      { date: '2008-09-03', rate: 7.00 },
      { date: '2008-10-08', rate: 6.00 },
      { date: '2008-11-05', rate: 5.25 },
      { date: '2008-12-03', rate: 4.25 },
      // 2009
      { date: '2009-02-04', rate: 3.25 },
      { date: '2009-04-08', rate: 3.00 },
      { date: '2009-10-07', rate: 3.25 },
      { date: '2009-11-04', rate: 3.50 },
      { date: '2009-12-02', rate: 3.75 },
      // 2010
      { date: '2010-03-03', rate: 4.00 },
      { date: '2010-04-07', rate: 4.25 },
      { date: '2010-05-05', rate: 4.50 },
      { date: '2010-11-03', rate: 4.75 },
      // 2011
      { date: '2011-11-02', rate: 4.50 },
      { date: '2011-12-06', rate: 4.25 },
      // 2012
      { date: '2012-05-02', rate: 3.75 },
      { date: '2012-06-06', rate: 3.50 },
      { date: '2012-10-03', rate: 3.25 },
      { date: '2012-12-05', rate: 3.00 },
      // 2013
      { date: '2013-05-08', rate: 2.75 },
      { date: '2013-08-07', rate: 2.50 },
      // 2015
      { date: '2015-02-04', rate: 2.25 },
      { date: '2015-05-06', rate: 2.00 },
      // 2016
      { date: '2016-05-04', rate: 1.75 },
      { date: '2016-08-03', rate: 1.50 },
      // 2019
      { date: '2019-06-05', rate: 1.25 },
      { date: '2019-07-03', rate: 1.00 },
      { date: '2019-10-02', rate: 0.75 },
      // 2020
      { date: '2020-03-04', rate: 0.50 },
      { date: '2020-03-20', rate: 0.25 },
      { date: '2020-11-04', rate: 0.10 },
      // 2022
      { date: '2022-05-04', rate: 0.35 },
      { date: '2022-06-08', rate: 0.85 },
      { date: '2022-07-06', rate: 1.35 },
      { date: '2022-08-03', rate: 1.85 },
      { date: '2022-09-07', rate: 2.35 },
      { date: '2022-10-05', rate: 2.60 },
      { date: '2022-11-02', rate: 2.85 },
      { date: '2022-12-07', rate: 3.10 },
      // 2023
      { date: '2023-02-08', rate: 3.35 },
      { date: '2023-03-08', rate: 3.60 },
      { date: '2023-05-03', rate: 3.85 },
      { date: '2023-06-07', rate: 4.10 },
      { date: '2023-11-08', rate: 4.35 },
      // 2025
      { date: '2025-02-18', rate: 4.10 }
    ];

    // Get the RBA rate effective on a given date
    function getRbaRateOnDate(date) {
      if (!date) return null;
      var dateStr = formatDateInput(date);
      var effectiveRate = null;
      for (var i = 0; i < RBA_CASH_RATES.length; i++) {
        if (RBA_CASH_RATES[i].date <= dateStr) {
          effectiveRate = RBA_CASH_RATES[i].rate;
        } else {
          break;
        }
      }
      return effectiveRate;
    }

    // Get all RBA rate changes within a date range
    function getRbaRateChangesInRange(startDate, endDate) {
      if (!startDate || !endDate) return [];
      var startStr = formatDateInput(startDate);
      var endStr = formatDateInput(endDate);
      var changes = [];
      for (var i = 0; i < RBA_CASH_RATES.length; i++) {
        var r = RBA_CASH_RATES[i];
        if (r.date > startStr && r.date <= endStr) {
          changes.push({ date: parseDateISO(r.date), rate: r.rate });
        }
      }
      return changes;
    }

    function parseDateISO(iso) {
      if (!iso) return null;
      var parts = iso.split('-');
      if (parts.length !== 3) return null;
      var y = Number(parts[0]);
      var m = Number(parts[1]);
      var d = Number(parts[2]);
      var dt = utcDate(y, m - 1, d);
      return isNaN(dt.getTime()) ? null : dt;
    }

    function parseDateDDMM(value) {
      // Strict DD/MM/YYYY
      if (!value) return null;
      var parts = value.split('/');
      if (parts.length !== 3) return null;
      var d = Number(parts[0]);
      var m = Number(parts[1]);
      var y = Number(parts[2]);
      var dt = utcDate(y, m - 1, d);
      if (isNaN(dt.getTime())) return null;
      if (dt.getUTCFullYear() !== y || dt.getUTCMonth() !== (m - 1) || dt.getUTCDate() !== d) return null;
      return dt;
    }

    function parseDateUserInput(value) {
      // Flexible parser for manual typing.
      // Accepts: DD/MM/YYYY, D/M/YYYY, DD-MM-YYYY, DD.MM.YYYY, DDMMYYYY, and 2-digit years.
      var raw = (value || '').trim();
      if (!raw) return null;

      var digits = raw.replace(/[^0-9]/g, '');
      if (digits.length === 8) {
        var d1 = Number(digits.slice(0, 2));
        var m1 = Number(digits.slice(2, 4));
        var y1 = Number(digits.slice(4, 8));
        var dt1 = utcDate(y1, m1 - 1, d1);
        if (isNaN(dt1.getTime())) return null;
        if (dt1.getUTCFullYear() !== y1 || dt1.getUTCMonth() !== (m1 - 1) || dt1.getUTCDate() !== d1) return null;
        return dt1;
      }

      var parts = raw.split(/[\/\.\- ]+/).filter(function (p) { return !!p; });
      if (parts.length !== 3) return null;

      var d = Number(parts[0]);
      var m = Number(parts[1]);
      var y = Number(parts[2]);
      if (!isFinite(d) || !isFinite(m) || !isFinite(y)) return null;
      if (y < 100) y = (y <= 79) ? (2000 + y) : (1900 + y);

      var dt = utcDate(y, m - 1, d);
      if (isNaN(dt.getTime())) return null;
      if (dt.getUTCFullYear() !== y || dt.getUTCMonth() !== (m - 1) || dt.getUTCDate() !== d) return null;
      return dt;
    }

    function formatDateDDMMYYYY(date) {
      var d = String(date.getUTCDate()).padStart(2, '0');
      var m = String(date.getUTCMonth() + 1).padStart(2, '0');
      var y = date.getUTCFullYear();
      return d + '/' + m + '/' + y;
    }

    function formatDateInput(date) {
      var y = date.getUTCFullYear();
      var m = String(date.getUTCMonth() + 1).padStart(2, '0');
      var d = String(date.getUTCDate()).padStart(2, '0');
      return String(y) + '-' + m + '-' + d;
    }

    function getInputDate(inputEl) {
      if (!inputEl) return null;
      var iso = inputEl.dataset.iso || '';
      var parsedIso = parseDateISO(iso);
      if (parsedIso) return parsedIso;
      return parseDateUserInput(inputEl.value) || parseDateDDMM(inputEl.value);
    }

    function setInputDate(inputEl, date) {
      if (!inputEl) return;
      if (!date) {
        delete inputEl.dataset.iso;
        inputEl.value = '';
        return;
      }
      inputEl.dataset.iso = formatDateInput(date);
      inputEl.value = formatDateDDMMYYYY(date);
    }

    function addDays(date, days) {
      var dt = new Date(date.getTime());
      dt.setUTCDate(dt.getUTCDate() + days);
      return dt;
    }

    function isSameDay(a, b) {
      return a.getUTCFullYear() === b.getUTCFullYear() && a.getUTCMonth() === b.getUTCMonth() && a.getUTCDate() === b.getUTCDate();
    }

    function isEndOfMonth(date) {
      var next = addDays(date, 1);
      return next.getUTCMonth() !== date.getUTCMonth();
    }

    function addMonthsKeepDay(base, months) {
      var y = base.getUTCFullYear();
      var m = base.getUTCMonth();
      var d = base.getUTCDate();
      var tentative = utcDate(y, m + months, 1);
      var daysInTargetMonth = utcDate(tentative.getUTCFullYear(), tentative.getUTCMonth() + 1, 0).getUTCDate();
      var day = Math.min(d, daysInTargetMonth);
      return utcDate(tentative.getUTCFullYear(), tentative.getUTCMonth(), day);
    }

    function formatNumber(value) {
      if (!isFinite(value)) return '';
      var abs = Math.abs(value);
      var core = abs.toLocaleString('en-AU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      return value < 0 ? '(' + core + ')' : core;
    }

    function showError(message) {
      var box = document.getElementById('errorBox');
      var text = document.getElementById('errorMessageText');
      text.textContent = message;
      box.style.display = 'block';
    }

    function clearError() {
      var box = document.getElementById('errorBox');
      var text = document.getElementById('errorMessageText');
      text.textContent = '';
      box.style.display = 'none';
    }

    function showWarning(message) {
      var box = document.getElementById('warningBox');
      var text = document.getElementById('warningMessageText');
      text.textContent = message;
      box.style.display = 'block';
    }

    function closeWarning() {
      var box = document.getElementById('warningBox');
      var text = document.getElementById('warningMessageText');
      text.textContent = '';
      box.style.display = 'none';
    }

    function checkDefaultInterestWarning() {
      var periods = readDefaultInterestPeriods();
      var defaultInterestRateFixed = parseFloat(document.getElementById('defaultInterestRate').value) || 0;
      var defaultInterestRateVar = parseFloat(document.getElementById('defaultInterestRateVar').value) || 0;
      var defaultInterestRate = isBaseMarginEnabled() ? defaultInterestRateVar : defaultInterestRateFixed;

      if (periods.length > 0 && defaultInterestRate <= 0) {
        showWarning('You are entering a period where default interest should apply but you have not added a rate of default interest.');
      } else {
        closeWarning();
      }
    }

    function removeRow(button) {
      var row = button.closest('tr');
      if (row) row.remove();
      recalculateMonthlyPayment(true);
    }

    // --- Non-accrual state ---

    // The computed bucket balance at the end of the last schedule run.
    var lastComputedNonAccrualTotal = 0;

    // Store daily records from last schedule calculation for use in printing
    var lastDailyRecords = [];

    // Store repayment schedule periods for printing (tracks when repayment amount changes)
    // Format: [{ fromDate: Date, toDate: Date, amount: number, count: number }]
    var lastRepaymentPeriods = [];

    // Capitalisation events (manual): [{ date: Date, amount: number }]
    // When an event occurs, the non-accrual bucket is reduced (typically to zero) on that date.
    var nonAccrualCapitalisations = [];

    function buildCapMap() {
      var m = new Map();
      for (var i = 0; i < nonAccrualCapitalisations.length; i++) {
        var ev = nonAccrualCapitalisations[i];
        if (!ev || !ev.date || !isFinite(ev.amount) || ev.amount <= 0) continue;
        var k = formatDateInput(ev.date);
        m.set(k, (m.get(k) || 0) + ev.amount);
      }
      return m;
    }

    function applyNonAccrualVisibility() {
      var enabledEl = document.getElementById('enableNonAccrual');
      var enabled = enabledEl ? !!enabledEl.checked : true;
      var card = document.getElementById('summaryNonAccrualCard');
      if (card) card.classList.toggle('hidden', !enabled);
      document.querySelectorAll('.nonaccrual-col').forEach(function (el) {
        el.classList.toggle('hidden', !enabled);
      });
    }

    // --- Date Picker ---

    var dp = {
      overlay: document.getElementById('dpOverlay'),
      picker: document.querySelector('#dpOverlay .dp'),
      monthSelect: document.getElementById('dpMonthSelect'),
      yearSelect: document.getElementById('dpYearSelect'),
      dow: document.getElementById('dpDow'),
      days: document.getElementById('dpDays'),
      prev: document.getElementById('dpPrev'),
      next: document.getElementById('dpNext'),
      todayBtn: document.getElementById('dpToday'),
      clearBtn: document.getElementById('dpClear'),
      closeBtn: document.getElementById('dpClose'),
      activeInput: null,
      viewYear: null,
      viewMonth: null
    };

    var DOW = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    var MONTH_NAMES = ['January','February','March','April','May','June','July','August','September','October','November','December'];

    function fillMonthYearSelects(yearBase) {
      dp.monthSelect.innerHTML = '';
      MONTH_NAMES.forEach(function (nm, idx) {
        var opt = document.createElement('option');
        opt.value = String(idx);
        opt.textContent = nm;
        dp.monthSelect.appendChild(opt);
      });

      var base = (yearBase != null) ? yearBase : (dp.viewYear != null ? dp.viewYear : new Date().getUTCFullYear());
      var span = 50;
      var start = base - span;
      var end = base + span;

      dp.yearSelect.innerHTML = '';
      for (var y = start; y <= end; y++) {
        var optY = document.createElement('option');
        optY.value = String(y);
        optY.textContent = String(y);
        dp.yearSelect.appendChild(optY);
      }

      dp.monthSelect.value = String(dp.viewMonth);
      dp.yearSelect.value = String(dp.viewYear);
    }

    function positionPickerNearInput(inputEl) {
      if (!inputEl) return;
      var r = inputEl.getBoundingClientRect();
      var margin = 8;

      dp.picker.style.left = '-9999px';
      dp.picker.style.top = '-9999px';

      var pr = dp.picker.getBoundingClientRect();
      var pw = pr.width || 320;
      var ph = pr.height || 380;

      var left = r.left;
      var top = r.bottom + 8;

      left = Math.min(left, window.innerWidth - pw - margin);
      left = Math.max(left, margin);

      if (top + ph + margin > window.innerHeight) {
        top = r.top - ph - 8;
        dp.picker.style.setProperty('--dp-arrow-top', 'auto');
        dp.picker.style.setProperty('--dp-arrow-bottom', '-6px');
      } else {
        dp.picker.style.setProperty('--dp-arrow-top', '-6px');
        dp.picker.style.setProperty('--dp-arrow-bottom', 'auto');
      }
      top = Math.max(top, margin);

      dp.picker.style.left = String(Math.round(left)) + 'px';
      dp.picker.style.top = String(Math.round(top)) + 'px';

      var arrowLeft = Math.min(Math.max(14, (r.left - left) + 18), pw - 18);
      dp.picker.style.setProperty('--dp-arrow-left', String(Math.round(arrowLeft)) + 'px');
    }

    function renderDatePicker() {
      dp.dow.innerHTML = '';
      for (var i = 0; i < DOW.length; i++) {
        var el = document.createElement('div');
        el.className = 'dp-dow';
        el.textContent = DOW[i];
        dp.dow.appendChild(el);
      }

      dp.monthSelect.value = String(dp.viewMonth);
      dp.yearSelect.value = String(dp.viewYear);

      dp.days.innerHTML = '';

      var first = utcDate(dp.viewYear, dp.viewMonth, 1);
      var firstDowSun0 = first.getUTCDay();
      var firstDowMon0 = (firstDowSun0 + 6) % 7;
      var daysInMonth = utcDate(dp.viewYear, dp.viewMonth + 1, 0).getUTCDate();
      var prevMonthDays = utcDate(dp.viewYear, dp.viewMonth, 0).getUTCDate();

      var selected = dp.activeInput ? getInputDate(dp.activeInput) : null;
      var now = new Date();
      var today = utcDate(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate());

      for (var cell = 0; cell < 42; cell++) {
        var dayIndex = cell - firstDowMon0 + 1;
        var showDay, showMonth, showYear;
        var muted = false;

        if (dayIndex <= 0) {
          muted = true;
          showDay = prevMonthDays + dayIndex;
          showMonth = dp.viewMonth - 1;
          showYear = dp.viewYear;
          if (showMonth < 0) { showMonth = 11; showYear--; }
        } else if (dayIndex > daysInMonth) {
          muted = true;
          showDay = dayIndex - daysInMonth;
          showMonth = dp.viewMonth + 1;
          showYear = dp.viewYear;
          if (showMonth > 11) { showMonth = 0; showYear++; }
        } else {
          showDay = dayIndex;
          showMonth = dp.viewMonth;
          showYear = dp.viewYear;
        }

        var cellDate = utcDate(showYear, showMonth, showDay);

        var btn = document.createElement('div');
        btn.className = 'dp-day' + (muted ? ' muted' : '');
        btn.textContent = String(showDay);
        btn.tabIndex = 0;

        if (isSameDay(cellDate, today)) btn.classList.add('today');
        if (selected && isSameDay(cellDate, selected)) btn.classList.add('selected');

        btn.addEventListener('click', (function (d) {
          return function () {
            if (!dp.activeInput) return;
            setInputDate(dp.activeInput, d);
            dp.activeInput.dispatchEvent(new Event('change', { bubbles: true }));
            closeDatePicker();
          };
        })(cellDate));

        btn.addEventListener('keydown', function (e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            this.click();
          }
        });

        dp.days.appendChild(btn);
      }
    }

    function openDatePicker(inputEl) {
      dp.activeInput = inputEl;
      var current = getInputDate(inputEl);
      var now = new Date();
      var base = current || utcDate(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate());
      dp.viewYear = base.getUTCFullYear();
      dp.viewMonth = base.getUTCMonth();

      dp.overlay.style.display = 'block';
      dp.overlay.setAttribute('aria-hidden', 'false');

      fillMonthYearSelects(dp.viewYear);
      renderDatePicker();
      positionPickerNearInput(inputEl);
    }

    function closeDatePicker() {
      dp.overlay.style.display = 'none';
      dp.overlay.setAttribute('aria-hidden', 'true');
      dp.activeInput = null;
    }

    dp.prev.addEventListener('click', function () {
      dp.viewMonth -= 1;
      if (dp.viewMonth < 0) { dp.viewMonth = 11; dp.viewYear -= 1; }
      if (!dp.yearSelect.querySelector('option[value="' + dp.viewYear + '"]')) fillMonthYearSelects(dp.viewYear);
      renderDatePicker();
      if (dp.activeInput) positionPickerNearInput(dp.activeInput);
    });

    dp.next.addEventListener('click', function () {
      dp.viewMonth += 1;
      if (dp.viewMonth > 11) { dp.viewMonth = 0; dp.viewYear += 1; }
      if (!dp.yearSelect.querySelector('option[value="' + dp.viewYear + '"]')) fillMonthYearSelects(dp.viewYear);
      renderDatePicker();
      if (dp.activeInput) positionPickerNearInput(dp.activeInput);
    });

    dp.monthSelect.addEventListener('change', function () {
      dp.viewMonth = parseInt(dp.monthSelect.value, 10);
      renderDatePicker();
      if (dp.activeInput) positionPickerNearInput(dp.activeInput);
    });

    dp.yearSelect.addEventListener('change', function () {
      dp.viewYear = parseInt(dp.yearSelect.value, 10);
      renderDatePicker();
      if (dp.activeInput) positionPickerNearInput(dp.activeInput);
    });

    dp.todayBtn.addEventListener('click', function () {
      var now = new Date();
      var t = utcDate(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate());
      dp.viewYear = t.getUTCFullYear();
      dp.viewMonth = t.getUTCMonth();
      fillMonthYearSelects(dp.viewYear);
      renderDatePicker();
      if (dp.activeInput) positionPickerNearInput(dp.activeInput);
    });

    dp.clearBtn.addEventListener('click', function () {
      if (dp.activeInput) {
        setInputDate(dp.activeInput, null);
        dp.activeInput.dispatchEvent(new Event('change', { bubbles: true }));
      }
      closeDatePicker();
    });

    dp.closeBtn.addEventListener('click', closeDatePicker);

    dp.overlay.addEventListener('click', function (e) {
      if (e.target === dp.overlay) closeDatePicker();
    });

    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && dp.overlay.style.display === 'block') closeDatePicker();
    });

    function wireDatePicker(inputEl) {
      if (!inputEl) return;

      // Manual typing is allowed; picker is optional via icon or Alt+â†“.
      // On blur: if valid, reformat to DD/MM/YYYY and store ISO in data-iso.
      function normaliseOnBlur() {
        var raw = (inputEl.value || '').trim();
        if (raw === '') {
          setInputDate(inputEl, null);
          clearError();
          return;
        }

        var dt = parseDateUserInput(raw);
        if (!dt) {
          showError('Invalid date: "' + raw + '". Use DD/MM/YYYY (e.g. 05/01/2026).');
          return;
        }

        clearError();
        setInputDate(inputEl, dt);
      }

      inputEl.addEventListener('input', function () { delete inputEl.dataset.iso; });
      inputEl.addEventListener('blur', normaliseOnBlur);

      inputEl.addEventListener('keydown', function (e) {
        if (e.altKey && (e.key === 'ArrowDown' || e.key === 'Down')) {
          e.preventDefault();
          openDatePicker(inputEl);
        }
      });
    }

    function wireOpenButtons() {
      document.querySelectorAll('[data-open-picker]').forEach(function (btn) {
        btn.addEventListener('click', function (e) {
          e.preventDefault();
          e.stopPropagation();
          var id = btn.getAttribute('data-open-picker');
          var el = document.getElementById(id);
          if (el) openDatePicker(el);
        });
      });
    }

    function dateCellHtml() {
      return '' +
        '<div class="date-row">' +
          '<input class="date-input" type="text" placeholder="DD/MM/YYYY" />' +
          '<button class="picker-hint" type="button" data-open-picker-inline title="Pick date" aria-label="Pick date">ðŸ“…</button>' +
        '</div>';
    }

    function wireInlinePickers(container) {
      container.querySelectorAll('.date-input').forEach(function (inp) { wireDatePicker(inp); });
      container.querySelectorAll('[data-open-picker-inline]').forEach(function (btn) {
        btn.addEventListener('click', function (e) {
          e.preventDefault();
          var row = btn.closest('.date-row');
          var input = row ? row.querySelector('.date-input') : null;
          if (input) openDatePicker(input);
        });
      });
    }

    // --- Config row creation ---

    // Track which transaction row is being edited (null = adding new)
    var editingTransactionRow = null;

    function updateTxModalAdjustVisibility() {
      var typeVal = document.getElementById('txModalType').value;
      var adjustGroup = document.getElementById('txModalAdjustGroup');
      var repaymentType = document.getElementById('repaymentType').value;
      // Only show for repayments on P&I loans
      if (typeVal === 'repayment' && repaymentType === 'principalAndInterest') {
        adjustGroup.style.display = 'block';
      } else {
        adjustGroup.style.display = 'none';
      }
    }

    function openTransactionModal(row) {
      var modalTitle = document.querySelector('.transaction-modal h3');
      var saveBtn = document.querySelector('.transaction-modal-buttons .btn-primary');

      if (row) {
        // Editing existing row
        editingTransactionRow = row;
        var dateInput = row.cells[0].querySelector('.date-input');
        var typeSelect = row.cells[1].querySelector('select');
        var amountInput = row.cells[2].querySelector('input');
        var descInput = row.cells[3].querySelector('input');
        var adjustVal = row.dataset.adjustPayments === 'true';

        document.getElementById('txModalDate').value = dateInput ? dateInput.value : '';
        document.getElementById('txModalType').value = typeSelect ? typeSelect.value : 'drawdown';
        document.getElementById('txModalAmount').value = amountInput ? amountInput.value : '';
        document.getElementById('txModalDescription').value = descInput ? descInput.value : '';
        document.getElementById('txModalAdjustPayments').checked = adjustVal;

        modalTitle.textContent = 'Edit Transaction';
        saveBtn.textContent = 'Save Changes';
      } else {
        // Adding new
        editingTransactionRow = null;
        document.getElementById('txModalDate').value = '';
        document.getElementById('txModalType').value = 'drawdown';
        document.getElementById('txModalAmount').value = '';
        document.getElementById('txModalDescription').value = '';
        document.getElementById('txModalAdjustPayments').checked = false;

        modalTitle.textContent = 'Add Transaction';
        saveBtn.textContent = 'Add Transaction';
      }

      updateTxModalAdjustVisibility();
      document.getElementById('transactionModal').style.display = 'flex';

      // Wire date picker to modal date input if not already wired
      var txModalDateInput = document.getElementById('txModalDate');
      var txModalDatePickerBtn = document.getElementById('txModalDatePicker');
      if (!txModalDateInput._datePickerWired) {
        wireDatePicker(txModalDateInput);
        txModalDateInput._datePickerWired = true;
        // Wire the calendar button
        if (txModalDatePickerBtn) {
          txModalDatePickerBtn.addEventListener('click', function(e) {
            e.preventDefault();
            openDatePicker(txModalDateInput);
          });
        }
      }

      // Wire type change to toggle adjust payments visibility
      var txModalTypeSelect = document.getElementById('txModalType');
      if (!txModalTypeSelect._adjustWired) {
        txModalTypeSelect.addEventListener('change', updateTxModalAdjustVisibility);
        txModalTypeSelect._adjustWired = true;
      }
    }

    function closeTransactionModal() {
      document.getElementById('transactionModal').style.display = 'none';
      editingTransactionRow = null;
    }

    function sortTransactionRows() {
      var tbody = document.getElementById('transactionsBody');
      var rows = Array.from(tbody.querySelectorAll('tr'));

      rows.sort(function(a, b) {
        var dateA = getInputDate(a.cells[0].querySelector('.date-input'));
        var dateB = getInputDate(b.cells[0].querySelector('.date-input'));
        // Rows without dates go to the end
        if (!dateA && !dateB) return 0;
        if (!dateA) return 1;
        if (!dateB) return -1;
        return dateA.getTime() - dateB.getTime();
      });

      // Re-append rows in sorted order
      rows.forEach(function(row) {
        tbody.appendChild(row);
      });
    }

    function saveTransactionFromModal() {
      var dateStr = document.getElementById('txModalDate').value;
      var type = document.getElementById('txModalType').value;
      var amount = parseFloat(document.getElementById('txModalAmount').value);
      var description = document.getElementById('txModalDescription').value;
      var adjustPayments = document.getElementById('txModalAdjustPayments').checked;

      if (!dateStr) {
        alert('Please enter a date.');
        return;
      }
      if (!isFinite(amount) || amount === 0) {
        alert('Please enter a valid amount.');
        return;
      }

      var date = getInputDate(document.getElementById('txModalDate'));

      if (editingTransactionRow) {
        // Update existing row
        var row = editingTransactionRow;
        var dateInput = row.cells[0].querySelector('.date-input');
        var typeSelect = row.cells[1].querySelector('select');
        var amountInput = row.cells[2].querySelector('input');
        var descInput = row.cells[3].querySelector('input');

        if (dateInput) setInputDate(dateInput, date);
        if (typeSelect) typeSelect.value = type;
        if (amountInput) amountInput.value = amount.toFixed(2);
        if (descInput) descInput.value = description;
        row.dataset.adjustPayments = adjustPayments ? 'true' : 'false';
      } else {
        // Add new row
        addTransactionRow({
          date: date,
          type: type,
          amount: amount,
          description: description,
          adjustPayments: adjustPayments
        });
      }

      sortTransactionRows();
      closeTransactionModal();
      recalculateScheduleDebounced();
    }

    // --- Loan Costs Modal ---
    var loanCostsData = [];

    function openLoanCostsModal() {
      var tbody = document.getElementById('loanCostsBody');
      tbody.innerHTML = '';

      // Populate with existing data or add default rows
      if (loanCostsData.length === 0) {
        loanCostsData = [
          { description: 'Loan Establishment Fee', amount: 0, deductFromDrawdown: false },
          { description: 'Legal Fees', amount: 0, deductFromDrawdown: false },
          { description: 'Tax/Government Fees', amount: 0, deductFromDrawdown: false }
        ];
      }

      loanCostsData.forEach(function(cost, idx) {
        addLoanCostRowWithData(cost, idx);
      });

      updateLoanCostsTotalDisplay();
      document.getElementById('loanCostsModal').style.display = 'flex';
    }

    function closeLoanCostsModal() {
      document.getElementById('loanCostsModal').style.display = 'none';
    }

    function addLoanCostRow() {
      var idx = document.getElementById('loanCostsBody').children.length;
      addLoanCostRowWithData({ description: '', amount: 0, deductFromDrawdown: false }, idx);
    }

    function addLoanCostRowWithData(cost, idx) {
      var tbody = document.getElementById('loanCostsBody');
      var tr = document.createElement('tr');
      tr.innerHTML = '' +
        '<td><input type="text" value="' + (cost.description || '') + '" placeholder="Description" style="width:100%;" /></td>' +
        '<td class="numeric"><input type="number" step="0.01" class="numeric-input" value="' + (cost.amount || 0).toFixed(2) + '" placeholder="0.00" onchange="updateLoanCostsTotalDisplay()" /></td>' +
        '<td style="text-align:center;"><input type="checkbox" ' + (cost.deductFromDrawdown ? 'checked' : '') + ' style="width:16px;height:16px;accent-color:#14b8a6;" /></td>' +
        '<td class="numeric"><button type="button" class="btn btn-icon btn-danger" onclick="removeLoanCostRow(this)">&times;</button></td>';
      tbody.appendChild(tr);
    }

    function removeLoanCostRow(btn) {
      btn.closest('tr').remove();
      updateLoanCostsTotalDisplay();
    }

    function updateLoanCostsTotalDisplay() {
      var total = 0;
      var rows = document.getElementById('loanCostsBody').querySelectorAll('tr');
      rows.forEach(function(row) {
        var amountInput = row.cells[1].querySelector('input');
        var amount = parseFloat(amountInput.value) || 0;
        total += amount;
      });
      document.getElementById('loanCostsTotalDisplay').textContent = '$' + formatNumber(total);
    }

    function saveLoanCostsModal() {
      loanCostsData = [];
      var rows = document.getElementById('loanCostsBody').querySelectorAll('tr');
      var total = 0;
      rows.forEach(function(row) {
        var desc = row.cells[0].querySelector('input').value;
        var amount = parseFloat(row.cells[1].querySelector('input').value) || 0;
        var deduct = row.cells[2].querySelector('input').checked;
        if (desc || amount > 0) {
          loanCostsData.push({ description: desc, amount: amount, deductFromDrawdown: deduct });
        }
        total += amount;
      });
      document.getElementById('loanCostsTotal').value = total.toFixed(2);
      closeLoanCostsModal();
      recalculateScheduleDebounced();
    }

    // --- Payment Holiday Rows ---
    function addPaymentHolidayRow(prefill) {
      var tbody = document.getElementById('paymentHolidaysBody');
      var tr = document.createElement('tr');
      tr.innerHTML = '' +
        '<td>' + dateCellHtml() + '</td>' +
        '<td>' + dateCellHtml() + '</td>' +
        '<td class="numeric"><button type="button" class="btn btn-icon btn-danger" onclick="removeRow(this)">&times;</button></td>';
      tbody.appendChild(tr);
      wireInlinePickers(tr);

      if (prefill) {
        var startInput = tr.cells[0].querySelector('.date-input');
        var endInput = tr.cells[1].querySelector('.date-input');
        if (prefill.start) setInputDate(startInput, prefill.start);
        if (prefill.end) setInputDate(endInput, prefill.end);
      }

      recalculateMonthlyPayment(true);
    }

    // --- Cash Rate Type Toggle ---
    function updateCashRateTypeVisibility() {
      var rateType = document.getElementById('cashRateType').value;
      var fixedRow = document.getElementById('cashRateFixedRow');
      var variableRow = document.getElementById('cashRateVariableRow');

      if (rateType === 'fixed') {
        fixedRow.style.display = '';
        variableRow.style.display = 'none';
      } else {
        fixedRow.style.display = 'none';
        variableRow.style.display = '';
      }
    }

    // --- Repayment Holiday Type Toggle ---
    function updateRepaymentHolidayVisibility() {
      var holidayType = document.getElementById('repaymentHolidayType').value;
      var periodRow = document.getElementById('repaymentHolidayPeriodRow');

      if (holidayType === 'none') {
        periodRow.style.display = 'none';
      } else {
        periodRow.style.display = '';
      }
    }

    function addTransactionRow(prefill) {
      if (prefill == null) {
        openTransactionModal();
        return;
      }
      var tbody = document.getElementById('transactionsBody');
      var tr = document.createElement('tr');
      tr.dataset.auto = (prefill && prefill.auto) ? '1' : '0';

      tr.innerHTML = '' +
        '<td>' + dateCellHtml() + '</td>' +
        '<td>' +
          '<select>' +
            '<option value="drawdown">Drawdown</option>' +
            '<option value="repayment">Repayment</option>' +
          '</select>' +
        '</td>' +
        '<td class="numeric"><input type="number" step="0.01" class="numeric-input" placeholder="0.00" /></td>' +
        '<td><input type="text" placeholder="Description" style="width:100%;" /></td>' +
        '<td class="numeric"><button type="button" class="btn btn-icon btn-danger" onclick="removeRow(this)">&times;</button></td>';

      tbody.appendChild(tr);
      wireInlinePickers(tr);

      // Wire click handlers to open edit modal
      wireTransactionRowEditHandlers(tr);

      if (prefill) {
        var dInp = tr.cells[0].querySelector('.date-input');
        if (prefill.date) setInputDate(dInp, prefill.date);
        var sel = tr.cells[1].querySelector('select');
        if (prefill.type) sel.value = prefill.type;
        var amt = tr.cells[2].querySelector('input');
        if (isFinite(prefill.amount)) amt.value = Number(prefill.amount).toFixed(2);
        var desc = tr.cells[3].querySelector('input');
        if (prefill.description) desc.value = prefill.description;
        // Store adjustPayments flag
        tr.dataset.adjustPayments = prefill.adjustPayments ? 'true' : 'false';
      }

      recalculateMonthlyPayment(true);
    }

    function wireTransactionRowEditHandlers(tr) {
      // Get all clickable elements in the row
      var dateInput = tr.cells[0].querySelector('.date-input');
      var typeSelect = tr.cells[1].querySelector('select');
      var amountInput = tr.cells[2].querySelector('input');
      var descInput = tr.cells[3].querySelector('input');

      // Make inputs read-only and style as clickable
      if (dateInput) {
        dateInput.readOnly = true;
        dateInput.style.cursor = 'pointer';
        dateInput.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          openTransactionModal(tr);
        });
      }
      if (typeSelect) {
        typeSelect.style.cursor = 'pointer';
        typeSelect.addEventListener('mousedown', function(e) {
          e.preventDefault();
          e.stopPropagation();
          openTransactionModal(tr);
        });
      }
      if (amountInput) {
        amountInput.readOnly = true;
        amountInput.style.cursor = 'pointer';
        amountInput.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          openTransactionModal(tr);
        });
      }
      if (descInput) {
        descInput.readOnly = true;
        descInput.style.cursor = 'pointer';
        descInput.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          openTransactionModal(tr);
        });
      }
    }

    function importTransactionsFromExcel(file, mode) {
      var reader = new FileReader();
      reader.onload = async function(e) {
        try {
          var workbook = new ExcelJS.Workbook();
          await workbook.xlsx.load(e.target.result);
          
          // Try to find a sheet named "Transactions", otherwise use first sheet
          var worksheet = workbook.getWorksheet('Transactions') || workbook.worksheets[0];
          if (!worksheet) {
            alert('No worksheet found in file.');
            return;
          }

          // Detect format by checking header row
          var firstRow = worksheet.getRow(1);
          var colBValue = firstRow.getCell(2).value;
          var isNewFormat = colBValue && typeof colBValue === 'string' && 
                           colBValue.toLowerCase().includes('type');

          var transactions = [];
          worksheet.eachRow(function(row, rowNumber) {
            // Skip header row if it looks like a header
            var firstCellValue = row.getCell(1).value;
            if (rowNumber === 1 && firstCellValue && typeof firstCellValue === 'string') {
              var lowerFirst = firstCellValue.toLowerCase();
              if (lowerFirst === 'date' || lowerFirst.includes('date')) {
                return; // Skip header row
              }
            }

            var dateCell = row.getCell(1);
            var dateValue = null;
            
            // Parse date
            if (dateCell.value) {
              if (dateCell.value instanceof Date) {
                dateValue = dateCell.value;
              } else if (typeof dateCell.value === 'number') {
                var excelEpoch = new Date(1899, 11, 30);
                dateValue = new Date(excelEpoch.getTime() + dateCell.value * 86400000);
              } else if (typeof dateCell.value === 'string') {
                var parsed = parseDateUserInput(dateCell.value);
                if (parsed) dateValue = parsed;
              }
            }

            var type = null;
            var amount = null;
            var description = '';

            if (isNewFormat) {
              // New format: Date, Type, Amount, Description
              var typeCell = row.getCell(2);
              var amountCell = row.getCell(3);
              var descCell = row.getCell(4);

              // Parse type
              if (typeCell.value && typeof typeCell.value === 'string') {
                var typeStr = typeCell.value.toLowerCase().trim();
                if (typeStr === 'drawdown' || typeStr === 'draw' || typeStr === 'd') {
                  type = 'drawdown';
                } else if (typeStr === 'repayment' || typeStr === 'repay' || typeStr === 'r' || typeStr === 'payment') {
                  type = 'repayment';
                }
              }

              // Parse amount
              if (amountCell.value !== null && amountCell.value !== undefined) {
                if (typeof amountCell.value === 'number') {
                  amount = Math.abs(amountCell.value);
                } else if (typeof amountCell.value === 'string') {
                  amount = Math.abs(parseFloat(amountCell.value.replace(/[,$]/g, '')));
                }
              }

              // Parse description
              if (descCell.value) {
                description = String(descCell.value);
              }
            } else {
              // Old format: Date, Amount (positive=drawdown, negative=repayment)
              var amountCell = row.getCell(2);
              
              if (amountCell.value !== null && amountCell.value !== undefined) {
                var rawAmount = null;
                if (typeof amountCell.value === 'number') {
                  rawAmount = amountCell.value;
                } else if (typeof amountCell.value === 'string') {
                  rawAmount = parseFloat(amountCell.value.replace(/[,$]/g, ''));
                }
                
                if (isFinite(rawAmount) && rawAmount !== 0) {
                  type = rawAmount >= 0 ? 'drawdown' : 'repayment';
                  amount = Math.abs(rawAmount);
                }
              }
            }

            if (dateValue && type && isFinite(amount) && amount !== 0) {
              transactions.push({
                date: dateValue,
                type: type,
                amount: amount,
                description: description
              });
            }
          });

          if (transactions.length === 0) {
            alert('No valid transactions found in file.\n\nMake sure your file has:\n- Column A: Date\n- Column B: Type (drawdown/repayment) OR Amount\n- Column C: Amount (if using Type in B)\n- Column D: Description (optional)');
            return;
          }

          // Clear existing if replacing
          if (mode === 'replace') {
            document.getElementById('transactionsBody').innerHTML = '';
          }

          // Add transactions
          for (var i = 0; i < transactions.length; i++) {
            addTransactionRow(transactions[i]);
          }

          recalculateMonthlyPayment(true);
          recalculateSchedule();
          alert('Imported ' + transactions.length + ' transaction(s).');

        } catch (err) {
          console.error('Error importing file:', err);
          alert('Error reading Excel file: ' + (err.message || err));
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function handleTransactionFileUpload(input) {
      var file = input.files[0];
      if (!file) return;

      // Check if there are existing transactions with data
      var hasExisting = false;
      document.querySelectorAll('#transactionsBody tr').forEach(function(row) {
        var dateInput = row.cells[0].querySelector('.date-input');
        var amountInput = row.cells[2].querySelector('input');
        if ((dateInput && dateInput.value) || (amountInput && amountInput.value)) {
          hasExisting = true;
        }
      });

      if (hasExisting) {
        var choice = confirm(
          'You have existing transactions.\n\n' +
          'Click OK to ADD to existing transactions.\n' +
          'Click Cancel to REPLACE all transactions.'
        );
        importTransactionsFromExcel(file, choice ? 'add' : 'replace');
      } else {
        importTransactionsFromExcel(file, 'replace');
      }

      // Reset file input so same file can be selected again
      input.value = '';
    }

    async function downloadTransactionTemplate() {
      var workbook = new ExcelJS.Workbook();
      
      // Create Instructions sheet
      var instructionsSheet = workbook.addWorksheet('Instructions');
      
      // Set column widths
      instructionsSheet.getColumn(1).width = 80;
      
      // Add title
      instructionsSheet.getCell('A1').value = 'TRANSACTION IMPORT TEMPLATE - INSTRUCTIONS';
      instructionsSheet.getCell('A1').font = { bold: true, size: 14 };
      
      // Add instructions
      var instructions = [
        '',
        'HOW TO USE THIS TEMPLATE:',
        '',
        '1. Go to the "Transactions" sheet in this workbook',
        '',
        '2. Enter your transactions with the following columns:',
        '   â€¢ Date - The transaction date (format: DD/MM/YYYY or YYYY-MM-DD)',
        '   â€¢ Type - Either "drawdown" or "repayment"',
        '   â€¢ Amount - The transaction amount (positive number)',
        '   â€¢ Description - Optional description of the transaction',
        '',
        '3. IMPORTANT NOTES:',
        '   â€¢ The first row must contain headers (Date, Type, Amount, Description)',
        '   â€¢ Dates can be in DD/MM/YYYY or YYYY-MM-DD format',
        '   â€¢ Type must be exactly "drawdown" or "repayment" (case insensitive)',
        '   â€¢ Amount should be a positive number',
        '   â€¢ Drawdowns INCREASE the loan balance',
        '   â€¢ Repayments DECREASE the loan balance',
        '',
        '4. Save this file and use "Import from Excel" to upload it',
        '',
        '5. When importing, you can choose to:',
        '   â€¢ ADD transactions to existing ones, or',
        '   â€¢ REPLACE all existing transactions',
        '',
        'ALTERNATIVE FORMAT (also supported):',
        '',
        'You can also use a simpler 2-column format:',
        '   â€¢ Column A: Date',
        '   â€¢ Column B: Amount (positive = drawdown, negative = repayment)',
        '',
        'EXAMPLE TRANSACTIONS:',
        '',
        'Date          Type        Amount      Description',
        '01/01/2024    drawdown    50000       Additional funding',
        '15/02/2024    repayment   10000       Quarterly payment',
        '01/04/2024    repayment   10000       Quarterly payment'
      ];
      
      for (var i = 0; i < instructions.length; i++) {
        instructionsSheet.getCell('A' + (i + 2)).value = instructions[i];
        if (instructions[i].startsWith('HOW TO USE') || instructions[i].startsWith('EXAMPLE') || instructions[i].startsWith('ALTERNATIVE')) {
          instructionsSheet.getCell('A' + (i + 2)).font = { bold: true };
        }
      }
      
      // Create Transactions sheet with headers and example data
      var transactionsSheet = workbook.addWorksheet('Transactions');
      
      // Set column widths
      transactionsSheet.getColumn(1).width = 15;
      transactionsSheet.getColumn(2).width = 12;
      transactionsSheet.getColumn(3).width = 15;
      transactionsSheet.getColumn(4).width = 30;
      
      // Add headers
      transactionsSheet.getRow(1).values = ['Date', 'Type', 'Amount', 'Description'];
      transactionsSheet.getRow(1).font = { bold: true };
      transactionsSheet.getRow(1).alignment = { horizontal: 'center' };
      
      // Add example rows (commented style - users can delete or modify)
      transactionsSheet.getRow(2).values = ['01/01/2024', 'drawdown', 50000, 'Example: Additional funding'];
      transactionsSheet.getRow(3).values = ['15/03/2024', 'repayment', 10000, 'Example: Quarterly payment'];
      transactionsSheet.getRow(4).values = ['', '', '', '(Delete example rows and enter your transactions)'];
      
      // Style example rows as italic to indicate they're examples
      transactionsSheet.getRow(2).font = { italic: true, color: { argb: '666666' } };
      transactionsSheet.getRow(3).font = { italic: true, color: { argb: '666666' } };
      transactionsSheet.getRow(4).font = { italic: true, color: { argb: '999999' } };
      
      // Format amount column as number
      transactionsSheet.getColumn(3).numFmt = '#,##0.00';
      
      // Generate and download
      var buffer = await workbook.xlsx.writeBuffer();
      var blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'transaction_import_template.xlsx';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function addRateChangeRow() {
      var tbody = document.getElementById('rateChangesBody');
      var tr = document.createElement('tr');
      tr.innerHTML = '' +
        '<td>' + dateCellHtml() + '</td>' +
        '<td class="numeric"><input type="number" step="0.0001" class="numeric-input" placeholder="0.00" /></td>' +
        '<td class="numeric"><button type="button" class="btn btn-icon btn-danger" onclick="removeRow(this)">&times;</button></td>';
      tbody.appendChild(tr);
      wireInlinePickers(tr);
      recalculateMonthlyPayment(true);
    }

    function addNonAccrualRow() {
      var tbody = document.getElementById('nonAccrualBody');
      var tr = document.createElement('tr');
      tr.innerHTML = '' +
        '<td>' + dateCellHtml() + '</td>' +
        '<td>' + dateCellHtml() + '</td>' +
        '<td class="numeric"><button type="button" class="btn btn-icon btn-danger" onclick="removeRow(this)">&times;</button></td>';
      tbody.appendChild(tr);
      wireInlinePickers(tr);
      recalculateMonthlyPayment(true);
    }

    function addDefaultInterestRow() {
      var tbody = document.getElementById('defaultInterestBody');
      var tr = document.createElement('tr');
      tr.innerHTML = '' +
        '<td>' + dateCellHtml() + '</td>' +
        '<td>' + dateCellHtml() + '</td>' +
        '<td class="numeric"><button type="button" class="btn btn-icon btn-danger" onclick="removeDefaultInterestRow(this)">&times;</button></td>';
      tbody.appendChild(tr);
      wireInlinePickers(tr);
      recalculateSchedule();
      checkDefaultInterestWarning();
    }

    function removeDefaultInterestRow(button) {
      var row = button.closest('tr');
      if (row) row.remove();
      recalculateSchedule();
      checkDefaultInterestWarning();
    }

    // --- Shared input parsing helpers ---

    function getTermYears() {
      var raw = document.getElementById('piTermYears').value;
      if (raw === '') return null;
      var v = parseFloat(raw);
      return isFinite(v) ? v : NaN;
    }

    function deriveEndDateIfTermProvided(startDate, endDate, firstPayDate, repaymentType) {
      var termYears = getTermYears();
      if (repaymentType !== 'principalAndInterest') return endDate;
      if (termYears === null) return endDate;
      if (!isFinite(termYears) || termYears <= 0) { showError('P&I term (years) must be blank or a positive number.'); return null; }
      if (!firstPayDate) { showError('Please enter a valid First repayment date.'); return null; }
      var months = Math.max(1, Math.round(termYears * 12));
      var derived = addMonthsKeepDay(firstPayDate, months - 1);
      setInputDate(document.getElementById('scheduleEndDate'), derived);
      return derived;
    }

    function buildPayDates(firstPayDate, endDate) {
      var payDates = [];
      for (var i = 0; ; i++) {
        var pd = addMonthsKeepDay(firstPayDate, i);
        if (pd > endDate) break;
        payDates.push(pd);
      }
      return payDates;
    }

    // --- Base + Margin pricing ---

    function isBaseMarginEnabled() {
      var cashRateType = document.getElementById('cashRateType');
      if (cashRateType) {
        return cashRateType.value === 'variable';
      }
      // Fallback for legacy useBaseMargin checkbox
      var el = document.getElementById('useBaseMargin');
      return el ? !!el.checked : false;
    }

    function getMargin() {
      var el = document.getElementById('fixedMargin');
      var val = el ? parseFloat(el.value) : 0;
      return isFinite(val) ? val : 0;
    }

    function getEffectiveRate(baseRate) {
      if (!isBaseMarginEnabled()) return baseRate;
      return baseRate + getMargin();
    }

    function updateTotalRateDisplay() {
      var baseRate = parseFloat(document.getElementById('initialRate').value);
      var totalRateEl = document.getElementById('totalRateDisplay');
      if (!isFinite(baseRate)) {
        totalRateEl.value = 'â€”';
        return;
      }
      var total = getEffectiveRate(baseRate);
      totalRateEl.value = total.toFixed(2) + '%';
    }

    function applyBaseMarginVisibility() {
      var enabled = isBaseMarginEnabled();
      var marginStack = document.getElementById('marginStack');
      var totalRateStack = document.getElementById('totalRateStack');
      var baseSourceStack = document.getElementById('baseSourceStack');
      var initialRateLabel = document.getElementById('initialRateLabel');
      var rateChangeHeader = document.getElementById('rateChangeHeader');

      if (marginStack) marginStack.style.display = enabled ? '' : 'none';
      if (totalRateStack) totalRateStack.style.display = enabled ? '' : 'none';
      if (baseSourceStack) baseSourceStack.style.display = enabled ? '' : 'none';
      if (initialRateLabel) initialRateLabel.textContent = enabled ? 'Initial base rate (%)' : 'Initial annual interest rate (%)';
      if (rateChangeHeader) rateChangeHeader.textContent = enabled ? 'New base rate (%)' : 'New rate (%)';

      // If base+margin is disabled, reset to manual
      if (!enabled) {
        var baseSourceSelect = document.getElementById('baseRateSource');
        if (baseSourceSelect) baseSourceSelect.value = 'manual';
      }

      if (enabled) updateTotalRateDisplay();
    }

    function getBaseRateSource() {
      var el = document.getElementById('baseRateSource');
      return el ? el.value : 'manual';
    }

    function isRbaCashRateEnabled() {
      return isBaseMarginEnabled() && getBaseRateSource() === 'rba';
    }

    function applyRbaCashRates() {
      if (!isRbaCashRateEnabled()) return;

      var startDate = getInputDate(document.getElementById('loanStartDate'));
      var endDate = getInputDate(document.getElementById('scheduleEndDate'));
      
      if (!startDate) return;

      // Set initial rate to RBA rate on start date
      var initialRbaRate = getRbaRateOnDate(startDate);
      if (initialRbaRate !== null) {
        document.getElementById('initialRate').value = initialRbaRate.toFixed(2);
        updateTotalRateDisplay();
      }

      // Clear existing rate changes and add RBA rate changes
      if (endDate) {
        var rbaChanges = getRbaRateChangesInRange(startDate, endDate);
        
        // Clear rate changes table
        var rateChangesBody = document.getElementById('rateChangesBody');
        rateChangesBody.innerHTML = '';
        
        // Add RBA rate changes
        for (var i = 0; i < rbaChanges.length; i++) {
          addRateChangeRow();
          var rows = rateChangesBody.querySelectorAll('tr');
          var lastRow = rows[rows.length - 1];
          var dateInput = lastRow.cells[0].querySelector('.date-input');
          var rateInput = lastRow.cells[1].querySelector('input');
          setInputDate(dateInput, rbaChanges[i].date);
          rateInput.value = rbaChanges[i].rate.toFixed(2);
        }
        
        // Add one empty row if no changes
        if (rbaChanges.length === 0) {
          addRateChangeRow();
        }
      }

      recalculateMonthlyPayment(true);
    }

    function readRateChanges(startDate, initialRate) {
      var margin = isBaseMarginEnabled() ? getMargin() : 0;
      var rateChanges = [{ date: startDate, rate: initialRate + margin }];
      document.querySelectorAll('#rateChangesBody tr').forEach(function (row) {
        var dt = getInputDate(row.cells[0].querySelector('.date-input'));
        var rateVal = parseFloat(row.cells[1].querySelector('input').value);
        if (!dt || !isFinite(rateVal)) return;
        rateChanges.push({ date: dt, rate: rateVal + margin });
      });
      rateChanges.sort(function (a, b) { return a.date - b.date; });
      return rateChanges;
    }

    function readNonAccrualPeriods() {
      var periods = [];
      document.querySelectorAll('#nonAccrualBody tr').forEach(function (row) {
        var s = getInputDate(row.cells[0].querySelector('.date-input'));
        var e = getInputDate(row.cells[1].querySelector('.date-input'));
        if (!s || !e || e < s) return;
        periods.push({ start: s, end: e });
      });
      return periods;
    }

    function readDefaultInterestPeriods() {
      var periods = [];
      document.querySelectorAll('#defaultInterestBody tr').forEach(function (row) {
        var s = getInputDate(row.cells[0].querySelector('.date-input'));
        var e = getInputDate(row.cells[1].querySelector('.date-input'));
        if (!s || !e || e < s) return;
        periods.push({ start: s, end: e });
      });
      return periods;
    }

    function readTransactions() {
      var tx = [];
      document.querySelectorAll('#transactionsBody tr').forEach(function (row) {
        var dt = getInputDate(row.cells[0].querySelector('.date-input'));
        var typeVal = row.cells[1].querySelector('select').value;
        var amountVal = parseFloat(row.cells[2].querySelector('input').value);
        var descVal = row.cells[3].querySelector('input').value || '';
        var adjustPayments = row.dataset.adjustPayments === 'true';
        if (!dt || !isFinite(amountVal) || amountVal === 0) return;
        tx.push({ date: dt, type: typeVal, amount: amountVal, description: descVal, adjustPayments: adjustPayments });
      });
      tx.sort(function (a, b) { return a.date - b.date; });
      return tx;
    }

    function txToMap(transactions) {
      var m = new Map();
      for (var i = 0; i < transactions.length; i++) {
        var t = transactions[i];
        var key = formatDateInput(t.date);
        if (!m.has(key)) m.set(key, []);
        m.get(key).push(t);
      }
      return m;
    }

    // --- Schedule calculation ---

    function equaliseScheduleColumnWidths() {
      var table = document.querySelector('#schedulePanel table');
      if (!table) return;
      var rows = table.querySelectorAll('tr');
      if (!rows.length) return;

      var colCount = rows[0].children.length;
      var maxWidths = new Array(colCount).fill(0);

      rows.forEach(function (row) {
        Array.from(row.children).forEach(function (cell, idx) {
          var w = cell.scrollWidth;
          if (w > maxWidths[idx]) maxWidths[idx] = w;
        });
      });

      var max = Math.max.apply(null, maxWidths);
      rows.forEach(function (row) {
        Array.from(row.children).forEach(function (cell) {
          cell.style.width = String(max) + 'px';
        });
      });
    }

    // --- Exit Fee / IRR Calculation ---

    // Calculate IRR using Newton-Raphson method
    // cashFlows: array of { date: Date, amount: number } where positive = inflow, negative = outflow
    function calculateIRR(cashFlows, guess) {
      if (!cashFlows || cashFlows.length < 2) return null;
      if (guess == null) guess = 0.1;

      var maxIterations = 100;
      var tolerance = 0.0000001;
      var rate = guess;

      // Sort cash flows by date
      var sorted = cashFlows.slice().sort(function(a, b) {
        return a.date.getTime() - b.date.getTime();
      });

      var baseDate = sorted[0].date;

      for (var i = 0; i < maxIterations; i++) {
        var npv = 0;
        var dnpv = 0; // derivative

        for (var j = 0; j < sorted.length; j++) {
          var cf = sorted[j];
          var days = Math.round((cf.date.getTime() - baseDate.getTime()) / 86400000);
          var years = days / 365;
          var discountFactor = Math.pow(1 + rate, -years);
          npv += cf.amount * discountFactor;
          dnpv -= years * cf.amount * discountFactor / (1 + rate);
        }

        if (Math.abs(dnpv) < 1e-10) break;

        var newRate = rate - npv / dnpv;

        if (Math.abs(newRate - rate) < tolerance) {
          return newRate;
        }

        rate = newRate;

        // Bound the rate to prevent divergence
        if (rate < -0.99) rate = -0.99;
        if (rate > 10) rate = 10;
      }

      return rate;
    }

    // Build cash flows from schedule data
    function buildLoanCashFlows(includeExitFee) {
      var cashFlows = [];

      var initialAmount = parseFloat(document.getElementById('initialAmount').value) || 0;
      var startDate = getInputDate(document.getElementById('loanStartDate'));
      var endDate = getInputDate(document.getElementById('scheduleEndDate'));
      var exitFeeAmount = parseFloat(document.getElementById('exitFeeAmount').value) || 0;
      var exitFeeDateInput = getInputDate(document.getElementById('exitFeeDate'));
      var exitFeeDate = exitFeeDateInput || endDate;

      if (!startDate || !endDate || initialAmount <= 0) return null;

      // Initial drawdown (inflow to borrower, positive from borrower's perspective for IRR calc)
      // For lender IRR: outflow is negative
      cashFlows.push({ date: startDate, amount: -initialAmount });

      // Add additional drawdowns from transactions
      document.querySelectorAll('#transactionsBody tr').forEach(function(row) {
        var dateInput = row.cells[0].querySelector('.date-input');
        var typeSelect = row.cells[1].querySelector('select');
        var amountInput = row.cells[2].querySelector('input');
        var txDate = getInputDate(dateInput);
        var txAmount = parseFloat(amountInput.value) || 0;
        if (txDate && txAmount !== 0) {
          var absAmount = Math.abs(txAmount);
          if (typeSelect.value === 'drawdown') {
            if (txAmount >= 0) {
              cashFlows.push({ date: txDate, amount: -absAmount }); // Additional lending
            } else {
              cashFlows.push({ date: txDate, amount: absAmount }); // Negative drawdown = repayment
            }
          } else {
            // Repayment - always positive inflow regardless of sign entered
            cashFlows.push({ date: txDate, amount: absAmount });
          }
        }
      });

      // Use lastDailyRecords to get scheduled repayments if available
      if (lastDailyRecords && lastDailyRecords.length > 0) {
        for (var i = 0; i < lastDailyRecords.length; i++) {
          var rec = lastDailyRecords[i];
          if (rec.repayment < 0) {
            // Repayment (positive inflow to lender)
            cashFlows.push({ date: rec.date, amount: Math.abs(rec.repayment) });
          }
        }
        // Final balance repayment
        var lastRec = lastDailyRecords[lastDailyRecords.length - 1];
        if (lastRec.closingBalance > 0.01) {
          cashFlows.push({ date: lastRec.date, amount: lastRec.closingBalance });
        }
      } else {
        // Fallback: assume balloon at end
        cashFlows.push({ date: endDate, amount: initialAmount });
      }

      // Add exit fee if requested
      if (includeExitFee && exitFeeAmount > 0) {
        cashFlows.push({ date: exitFeeDate, amount: exitFeeAmount });
      }

      return cashFlows;
    }

    // Cache for exit fee rate calculation
    var exitFeeRateCache = {
      key: null,
      result: null
    };

    // Calculate exit fee effective rate
    function calculateExitFeeRate() {
      var exitFeeAmountForIRR = parseFloat(document.getElementById('exitFeeAmount').value) || 0;
      if (exitFeeAmountForIRR <= 0) {
        document.getElementById('irrExcludingFee').value = 'â€”';
        document.getElementById('irrIncludingFee').value = 'â€”';
        document.getElementById('exitFeeRateAnnual').value = 'â€”';
        document.getElementById('exitFeeRateDaily').value = 'â€”';
        exitFeeRateCache.key = null;
        exitFeeRateCache.result = null;
        return null;
      }

      var cfWithout = buildLoanCashFlows(false);
      var cfWith = buildLoanCashFlows(true);

      if (!cfWithout || !cfWith) {
        document.getElementById('irrExcludingFee').value = 'â€”';
        document.getElementById('irrIncludingFee').value = 'â€”';
        document.getElementById('exitFeeRateAnnual').value = 'â€”';
        document.getElementById('exitFeeRateDaily').value = 'â€”';
        return null;
      }

      // Generate simple cache key from loan parameters
      var initialAmount = document.getElementById('initialAmount').value;
      var startDateVal = document.getElementById('loanStartDate').dataset.iso || '';
      var endDateVal = document.getElementById('scheduleEndDate').dataset.iso || '';
      var exitFeeAmountVal = document.getElementById('exitFeeAmount').value;
      var exitFeeDateVal = document.getElementById('exitFeeDate').dataset.iso || '';
      var cacheKey = initialAmount + '|' + startDateVal + '|' + endDateVal + '|' + exitFeeAmountVal + '|' + exitFeeDateVal;

      // Return cached result if available
      if (exitFeeRateCache.key === cacheKey && exitFeeRateCache.result) {
        var cached = exitFeeRateCache.result;
        document.getElementById('irrExcludingFee').value = (cached.irrWithout * 100).toFixed(4) + '%';
        document.getElementById('irrIncludingFee').value = (cached.irrWith * 100).toFixed(4) + '%';
        document.getElementById('exitFeeRateAnnual').value = (cached.annualRate * 100).toFixed(4) + '%';
        document.getElementById('exitFeeRateDaily').value = (cached.dailyRate * 100).toFixed(6) + '%';
        return cached;
      }

      var irrWithout = calculateIRR(cfWithout);
      var irrWith = calculateIRR(cfWith);

      if (irrWithout === null || irrWith === null) {
        document.getElementById('irrExcludingFee').value = 'Error';
        document.getElementById('irrIncludingFee').value = 'Error';
        document.getElementById('exitFeeRateAnnual').value = 'â€”';
        document.getElementById('exitFeeRateDaily').value = 'â€”';
        return null;
      }

      var annualRate = irrWith - irrWithout;
      var dailyRate = Math.pow(1 + annualRate, 1/365) - 1;

      document.getElementById('irrExcludingFee').value = (irrWithout * 100).toFixed(4) + '%';
      document.getElementById('irrIncludingFee').value = (irrWith * 100).toFixed(4) + '%';
      document.getElementById('exitFeeRateAnnual').value = (annualRate * 100).toFixed(4) + '%';
      document.getElementById('exitFeeRateDaily').value = (dailyRate * 100).toFixed(6) + '%';

      var result = {
        irrWithout: irrWithout,
        irrWith: irrWith,
        annualRate: annualRate,
        dailyRate: dailyRate
      };

      // Cache the result
      exitFeeRateCache.key = cacheKey;
      exitFeeRateCache.result = result;

      return result;
    }

    // Calculate exit fee accrual for a given day
    // Uses effective interest method: starts at $0, compounds daily to reach full exit fee at maturity
    function calculateExitFeeAccrual(startDate, currentDate, endDate, exitFeeAmount, dailyRate) {
      if (!startDate || !currentDate || !endDate || !exitFeeAmount || !dailyRate) {
        return { daily: 0, cumulative: 0 };
      }

      var totalDays = Math.round((endDate.getTime() - startDate.getTime()) / 86400000);
      var daysElapsed = Math.round((currentDate.getTime() - startDate.getTime()) / 86400000);

      if (totalDays <= 0) return { daily: 0, cumulative: 0 };

      // Compound factor for total period
      var totalFactor = Math.pow(1 + dailyRate, totalDays) - 1;
      
      if (totalFactor === 0) return { daily: 0, cumulative: 0 };

      // Cumulative at current date: starts at 0, reaches exitFeeAmount at end
      // Formula: ExitFee Ã— [(1 + r)^d - 1] / [(1 + r)^n - 1]
      var currentFactor = Math.pow(1 + dailyRate, daysElapsed) - 1;
      var cumulativeToday = exitFeeAmount * currentFactor / totalFactor;

      // Yesterday's cumulative
      var cumulativeYesterday = 0;
      if (daysElapsed > 0) {
        var yesterdayFactor = Math.pow(1 + dailyRate, daysElapsed - 1) - 1;
        cumulativeYesterday = exitFeeAmount * yesterdayFactor / totalFactor;
      }

      // Daily accrual
      var dailyAccrual = cumulativeToday - cumulativeYesterday;

      return {
        daily: dailyAccrual,
        cumulative: cumulativeToday
      };
    }

    // Toggle exit fee fields visibility
    function applyExitFeeVisibility() {
      // Exit fee is always available now (no toggle)
      // Just calculate rates if there's an exit fee amount
      var exitFeeAmount = parseFloat(document.getElementById('exitFeeAmount').value) || 0;
      if (exitFeeAmount > 0) {
        calculateExitFeeRate();
      }
    }

    // --- Display mode helpers ---

    function getFinancialYear(date) {
      // Australian FY: July 1 - June 30
      // FY2026 = July 1, 2025 to June 30, 2026
      var year = date.getUTCFullYear();
      var month = date.getUTCMonth(); // 0-11
      if (month >= 6) { // July onwards
        return year + 1;
      }
      return year;
    }

    function getFinancialYearLabel(fy) {
      return 'FY' + String(fy).slice(-2);
    }

    function getMonthKey(date) {
      return date.getUTCFullYear() + '-' + String(date.getUTCMonth() + 1).padStart(2, '0');
    }

    function getMonthLabel(date) {
      var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return months[date.getUTCMonth()] + ' ' + date.getUTCFullYear();
    }

    function updateScheduleHeaders(displayMode) {
      var scheduleHead = document.getElementById('scheduleHead');
      var nonAccrualEnabled = document.getElementById('enableNonAccrual').checked;
      var exitFeeEnabled = (parseFloat(document.getElementById('exitFeeAmount').value) || 0) > 0;
      var pikRate = parseFloat(document.getElementById('pikRate').value) || 0;
      var pikEnabled = pikRate > 0;
      var nonAccrualColClass = nonAccrualEnabled ? 'numeric nonaccrual-col' : 'numeric nonaccrual-col hidden';
      var exitFeeColClass = exitFeeEnabled ? 'numeric exitfee-col' : 'numeric exitfee-col hidden';
      var pikColClass = pikEnabled ? 'pik-col' : 'pik-col hidden';

      if (displayMode === 'daily') {
        scheduleHead.innerHTML = '<tr>' +
          '<th>Date</th>' +
          '<th class="numeric" style="text-align:center;">Rate (%)</th>' +
          '<th class="numeric">Opening balance</th>' +
          '<th class="numeric">Drawdowns</th>' +
          '<th class="numeric">Repayment</th>' +
          '<th class="numeric">Interest for day</th>' +
          '<th class="numeric">Month-end capitalised</th>' +
          '<th class="numeric">Closing balance</th>' +
          '<th class="numeric ' + pikColClass + '">PIK Interest</th>' +
          '<th class="numeric ' + pikColClass + '">Cumulative PIK</th>' +
          '<th class="' + nonAccrualColClass + '">Non-accrual interest balance</th>' +
          '<th class="' + exitFeeColClass + '">Exit fee daily</th>' +
          '<th class="' + exitFeeColClass + '">Exit fee payment</th>' +
          '<th class="' + exitFeeColClass + '">Exit fee balance</th>' +
          '<th class="' + exitFeeColClass + '">Total (Balance + Exit Fee)</th>' +
          '</tr>';
      } else if (displayMode === 'monthly') {
        scheduleHead.innerHTML = '<tr>' +
          '<th>Month</th>' +
          '<th class="numeric">Opening balance</th>' +
          '<th class="numeric">Drawdowns</th>' +
          '<th class="numeric">Repayments</th>' +
          '<th class="numeric">Interest accrued</th>' +
          '<th class="numeric">Interest capitalised</th>' +
          '<th class="numeric">Closing balance</th>' +
          '<th class="numeric ' + pikColClass + '">PIK Interest</th>' +
          '<th class="numeric ' + pikColClass + '">Cumulative PIK</th>' +
          '<th class="' + nonAccrualColClass + '">Non-accrual interest</th>' +
          '<th class="' + exitFeeColClass + '">Exit fee accrued</th>' +
          '<th class="' + exitFeeColClass + '">Exit fee payment</th>' +
          '<th class="' + exitFeeColClass + '">Exit fee balance</th>' +
          '<th class="' + exitFeeColClass + '">Total (Balance + Exit Fee)</th>' +
          '</tr>';
      } else if (displayMode === 'financialYear') {
        scheduleHead.innerHTML = '<tr>' +
          '<th>Financial Year</th>' +
          '<th class="numeric">Opening balance</th>' +
          '<th class="numeric">Drawdowns</th>' +
          '<th class="numeric">Repayments</th>' +
          '<th class="numeric">Interest accrued</th>' +
          '<th class="numeric">Interest capitalised</th>' +
          '<th class="numeric">Closing balance</th>' +
          '<th class="numeric ' + pikColClass + '">PIK Interest</th>' +
          '<th class="numeric ' + pikColClass + '">Cumulative PIK</th>' +
          '<th class="' + nonAccrualColClass + '">Non-accrual interest</th>' +
          '<th class="' + exitFeeColClass + '">Exit fee accrued</th>' +
          '<th class="' + exitFeeColClass + '">Exit fee payment</th>' +
          '<th class="' + exitFeeColClass + '">Exit fee balance</th>' +
          '<th class="' + exitFeeColClass + '">Total (Balance + Exit Fee)</th>' +
          '</tr>';
      }
    }

    var recalculateScheduleTimer = null;
    function recalculateScheduleDebounced() {
      clearTimeout(recalculateScheduleTimer);
      recalculateScheduleTimer = setTimeout(recalculateSchedule, 50);
    }

    function recalculateSchedule() {
      clearError();
      applyNonAccrualVisibility();

      var nonAccrualEnabledEl = document.getElementById('enableNonAccrual');
      var nonAccrualEnabled = nonAccrualEnabledEl ? !!nonAccrualEnabledEl.checked : true;

      var initialAmount = parseFloat(document.getElementById('initialAmount').value);
      var startDate = getInputDate(document.getElementById('loanStartDate'));
      var initialRate = parseFloat(document.getElementById('initialRate').value);
      var endDate = getInputDate(document.getElementById('scheduleEndDate'));
      var firstRepaymentDate = getInputDate(document.getElementById('firstRepaymentDate'));
      var repaymentType = document.getElementById('repaymentType').value;
      var balloonResidualRaw = document.getElementById('balloonResidual').value;
      var balloonResidual = (balloonResidualRaw === '') ? 0 : parseFloat(balloonResidualRaw);
      var holidayMonths = Math.max(0, parseInt(document.getElementById('principalHolidayMonths').value || '0', 10));
      var holidayStartDate = getInputDate(document.getElementById('principalHolidayStart')) || startDate;
      var holidayInterestTreatment = document.getElementById('holidayInterestTreatment').value || 'payMonthly';

      if (!isFinite(initialAmount) || initialAmount < 0) { showError('Please enter a valid initial loan amount.'); return; }
      if (!startDate) { showError('Please enter a valid loan start date.'); return; }
      if (!isFinite(initialRate)) { showError('Please enter a valid initial annual interest rate.'); return; }
      if (!endDate) { showError('Please enter a valid schedule end date.'); return; }
      // First repayment date is not required when using a full-term interest holiday with lump-sum payout
      if (!firstRepaymentDate) {
        if (!(holidayInterestTreatment === 'lumpSumEnd')) {
          showError('Please enter a First repayment date.');
          return;
        }
      }

      endDate = deriveEndDateIfTermProvided(startDate, endDate, firstRepaymentDate, repaymentType);
      if (!endDate) return;

      if (endDate < startDate) { showError('The schedule end date must be on or after the start date.'); return; }
      if (firstRepaymentDate) {
        if (firstRepaymentDate < startDate || firstRepaymentDate > endDate) {
          showError('First repayment date must be between start and end dates.');
          return;
        }
      }
      if (balloonResidualRaw !== '' && (!isFinite(balloonResidual) || balloonResidual < 0)) { showError('Please enter a valid balloon residual (non-negative number).'); return; }

      var transactions = readTransactions();
      var transactionMap = txToMap(transactions);

      var rateChanges = readRateChanges(startDate, initialRate);

      var nonAccrualPeriods = readNonAccrualPeriods();
      var capMap = buildCapMap();

      // Default interest setup
      var defaultInterestPeriods = readDefaultInterestPeriods();
      var defaultInterestRateFixed = parseFloat(document.getElementById('defaultInterestRate').value) || 0;
      var defaultInterestRateVar = parseFloat(document.getElementById('defaultInterestRateVar').value) || 0;
      var defaultInterestRate = isBaseMarginEnabled() ? defaultInterestRateVar : defaultInterestRateFixed;

      function isDateInDefaultInterest(date) {
        if (defaultInterestRate <= 0) return false;
        return defaultInterestPeriods.some(function (p) { return date >= p.start && date <= p.end; });
      }

      // Non-accrual logic:
      // - A non-accrual period is whatever the user inputs.
      // - A capitalisation event clears the current non-accrual bucket on that date.
      // - If the non-accrual period continues after that date, the next day's interest should again be treated as non-accrual (i.e., a new bucket).
      function isDateInNonAccrual(date) {
        if (!nonAccrualEnabled) return false;
        return nonAccrualPeriods.some(function (p) { return date >= p.start && date <= p.end; });
      }

      var monthlyPayment = recalculateMonthlyPayment(true);
      var currentMonthlyPayment = monthlyPayment; // Track current payment (may change after drawdowns)
      var recalcAfterNextPayment = false; // Flag to recalculate after the next payment following a drawdown
      var drawdownPrincipalForRecalc = 0; // Principal to use for recalculation
      var drawdownDateForRecalc = null; // Date of the drawdown

      // Track repayment periods for printing
      var repaymentPeriods = [];
      var currentPeriodStart = null;
      var currentPeriodAmount = null;
      var currentPeriodCount = 0;

      // Helper function to recalculate payment after a drawdown
      function recalcPaymentAfterDrawdown(currentPrincipal, fromDate, remainingPayDates, currentRateIdx) {
        if (remainingPayDates.length === 0) return 0;
        var target = balloonResidual;

        // Simulate to find payment that results in target balance
        function simulateBalance(payment) {
          var simPrincipal = currentPrincipal;
          var simMonthAccrual = 0;
          var simPayIdx = 0;
          var simRateIdx = currentRateIdx;

          for (var simDt = new Date(fromDate.getTime()); simDt <= endDate; simDt = addDays(simDt, 1)) {
            // Rate changes
            while (simRateIdx + 1 < rateChanges.length && simDt >= rateChanges[simRateIdx + 1].date) simRateIdx++;
            var simRate = rateChanges[simRateIdx].rate;

            // Daily interest
            var simDailyInt = simPrincipal * simRate / 100 / 365;
            simMonthAccrual += simDailyInt;

            // Month-end capitalisation
            if (isEndOfMonth(simDt) || isSameDay(simDt, endDate)) {
              simPrincipal += simMonthAccrual;
              simMonthAccrual = 0;
            }

            // Payment
            if (simPayIdx < remainingPayDates.length && isSameDay(simDt, remainingPayDates[simPayIdx])) {
              if (!isPaymentDateInHoliday(remainingPayDates[simPayIdx])) {
                simPrincipal -= payment;
              }
              simPayIdx++;
            }
          }
          return simPrincipal;
        }

        // Binary search for correct payment
        var lo = 0;
        var hi = Math.max(1, currentPrincipal);
        for (var i = 0; i < 80; i++) {
          var endBal = simulateBalance(hi);
          if (endBal <= target + 0.01) break;
          hi *= 1.8;
          if (hi > currentPrincipal * 1000) break;
        }
        for (var iter = 0; iter < 90; iter++) {
          var mid = (lo + hi) / 2;
          var endBal2 = simulateBalance(mid);
          if (endBal2 > target) lo = mid;
          else hi = mid;
        }
        return Math.round(hi * 100) / 100;
      }

      var holidayWindowEnd = holidayMonths > 0 ? addMonthsKeepDay(holidayStartDate, holidayMonths) : null;
      function isInHolidayWindow(d) { return holidayMonths > 0 && d >= holidayStartDate && d < holidayWindowEnd; }
      function isPaymentDateInHoliday(paymentDate) {
        // In single end-of-loan payment mode, treat the whole term as the holiday.
        if (holidayInterestTreatment === 'lumpSumEnd') return true;
        return isInHolidayWindow(paymentDate);
      }

      // For single end-of-loan payment mode, treat the end date as the sole repayment date
      var effectiveFirstPayDate = firstRepaymentDate;
      if (!effectiveFirstPayDate && holidayInterestTreatment === 'lumpSumEnd') {
        effectiveFirstPayDate = endDate;
      }

      var payDates = effectiveFirstPayDate ? buildPayDates(effectiveFirstPayDate, endDate) : [];

      // Full-term interest holiday mode (no monthly repayments; pay interest + principal at end).
      var fullTermInterestHoliday = false;
      if (holidayInterestTreatment === 'lumpSumEnd' && payDates.length > 0) {
        fullTermInterestHoliday = true;
        for (var iFT = 0; iFT < payDates.length; iFT++) {
          if (!isPaymentDateInHoliday(payDates[iFT])) { fullTermInterestHoliday = false; break; }
        }
      }

      var principal = initialAmount;
      var monthInterestAccrual = 0;
      var holidayDeferredInterest = 0; // for holidayInterestTreatment === 'lumpSumEnd' (interest accrues and is paid at end date)
      var nonAccrualBucket = 0;
      var totalInterest = 0;
      var totalNonAccrualInterest = 0;
      var totalDrawdowns = 0;
      var totalRepayments = 0;
      var totalNetTransactions = 0;
      var firstOpeningBalance = initialAmount;
      var rateIndex = 0;
      var payIdx = 0;

      // PIK (Payment in Kind) setup
      var pikRate = parseFloat(document.getElementById('pikRate').value) || 0;
      var pikEnabled = pikRate > 0;
      var pikMonthAccrual = 0;
      var cumulativePik = 0;
      var totalPikInterest = 0;

      // Exit fee setup
      var exitFeeAmount = parseFloat(document.getElementById('exitFeeAmount').value) || 0;
      var exitFeeEnabled = exitFeeAmount > 0;
      var exitFeeFullOnEarly = document.getElementById('exitFeeFullOnEarly').checked;
      var exitFeeDateInput = getInputDate(document.getElementById('exitFeeDate'));
      var exitFeeDate = exitFeeDateInput || endDate;
      var exitFeeDailyRate = 0;

      if (exitFeeEnabled) {
        var exitFeeRateData = calculateExitFeeRate();
        if (exitFeeRateData && exitFeeRateData.dailyRate) {
          exitFeeDailyRate = exitFeeRateData.dailyRate;
        }
      }
      
      // Pre-calculate exit fee cumulative values for each day to avoid Math.pow in loop
      var exitFeeTotalDays = exitFeeEnabled && exitFeeAmount > 0 ? Math.round((exitFeeDate.getTime() - startDate.getTime()) / 86400000) : 0;
      var exitFeeTotalFactor = exitFeeTotalDays > 0 && exitFeeDailyRate > 0 ? Math.pow(1 + exitFeeDailyRate, exitFeeTotalDays) - 1 : 0;
      var exitFeeCumulativeByDay = [];
      var exitFeePaymentMade = false;
      if (exitFeeEnabled && exitFeeAmount > 0 && exitFeeDailyRate > 0 && exitFeeTotalFactor > 0) {
        var runningFactor = 1;
        for (var d = 0; d <= exitFeeTotalDays; d++) {
          if (d === 0) {
            exitFeeCumulativeByDay.push(0);
          } else {
            runningFactor *= (1 + exitFeeDailyRate);
            exitFeeCumulativeByDay.push(exitFeeAmount * (runningFactor - 1) / exitFeeTotalFactor);
          }
        }
      }

      // Date filter
      var filterFrom = getInputDate(document.getElementById('filterFromDate'));
      var filterTo = getInputDate(document.getElementById('filterToDate'));

      // Display mode
      var displayMode = document.getElementById('displayMode').value || 'daily';
      updateScheduleHeaders(displayMode);

      var scheduleBody = document.getElementById('scheduleBody');
      scheduleBody.innerHTML = '';

      // Collect daily data for aggregation
      var dailyRecords = [];

      var dayIndex = 0;
      for (var dt = new Date(startDate.getTime()); dt <= endDate; dt = addDays(dt, 1)) {
        var openingBalance = principal;
        var isoKey = formatDateInput(dt);

        // Apply manual transactions at start of day
        var netTransactions = 0;
        var manualRepayment = 0;
        var repaymentWithAdjust = false;
        if (transactionMap.has(isoKey)) {
          var list = transactionMap.get(isoKey);
          for (var t = 0; t < list.length; t++) {
            var txAmount = Math.abs(list[t].amount); // Use absolute value
            if (list[t].type === 'drawdown') {
              // Positive original amount = drawdown (increase principal)
              // Negative original amount = treat as repayment (decrease principal)
              if (list[t].amount >= 0) {
                netTransactions += txAmount;
                totalDrawdowns += txAmount;
              } else {
                // Negative drawdown is effectively a repayment
                manualRepayment += txAmount;
              }
            } else {
              // Repayment - always decrease principal regardless of sign entered
              manualRepayment += txAmount;
              // Check if this repayment should trigger payment recalculation
              if (list[t].adjustPayments) {
                repaymentWithAdjust = true;
              }
            }
          }
        }
        // Apply manual repayments to principal (separate from netTransactions for display)
        principal += netTransactions;
        principal -= manualRepayment;
        totalNetTransactions += netTransactions;

        // Flag to recalculate payment AFTER the next payment following a drawdown or adjustable repayment (P&I loans only)
        if ((netTransactions > 0 || repaymentWithAdjust) && repaymentType === 'principalAndInterest' && !fullTermInterestHoliday) {
          recalcAfterNextPayment = true;
          drawdownDateForRecalc = new Date(dt.getTime());
        }

        // Rate selection
        while (rateIndex + 1 < rateChanges.length && dt >= rateChanges[rateIndex + 1].date) rateIndex++;
        var currentRate = rateChanges[rateIndex].rate;

        // Add default interest rate if in a default interest period
        if (isDateInDefaultInterest(dt)) {
          currentRate += defaultInterestRate;
        }

        // Daily interest computed on post-transaction principal
        var dailyInterest = principal * currentRate / 100 / 365;

        // Daily PIK interest computed on (principal + cumulative PIK)
        var dailyPikInterest = 0;
        if (pikEnabled) {
          dailyPikInterest = (principal + cumulativePik) * pikRate / 100 / 365;
          pikMonthAccrual += dailyPikInterest;
          totalPikInterest += dailyPikInterest;
        }

        var repaymentToday = 0;
        // Include manual repayments in repaymentToday (shown as negative/outflow)
        if (manualRepayment > 0) {
          repaymentToday -= manualRepayment;
        }
        var inNonAccrual = isDateInNonAccrual(dt);

        // Track daily interest into the correct bucket.
        var normalDailyInterest = 0;
        var nonAccrualDailyInterest = 0;
        if (inNonAccrual) {
          nonAccrualBucket += dailyInterest;
          totalNonAccrualInterest += dailyInterest;
          nonAccrualDailyInterest = dailyInterest;
        } else {
          monthInterestAccrual += dailyInterest;
          normalDailyInterest = dailyInterest;
          // Track total interest payable (only non-accrual interest)
          totalInterest += dailyInterest;
        }

        // Apply non-accrual capitalisation event AFTER the day's interest is allocated.
        // This ensures the non-accrual bucket shows as 0.00 on the capitalisation date.
        if (capMap.has(isoKey) && nonAccrualEnabled) {
          var capAmt = capMap.get(isoKey);
          if (capAmt > 0) {
            // Capitalise up to the bucket balance (defensive).
            var applied = Math.min(nonAccrualBucket, capAmt);
            if (applied > 0) {
              principal += applied;
              nonAccrualBucket = nonAccrualBucket - applied;
              if (nonAccrualBucket < 0.0000001) nonAccrualBucket = 0;
            }
          }
        }

        var monthEndCapitalised = 0;
        var pikMonthEndCapitalised = 0;

        // Month-end logic
        if (isEndOfMonth(dt) || isSameDay(dt, endDate)) {
          // Capitalise PIK interest at month-end (adds to cumulative PIK, not principal)
          if (pikEnabled && pikMonthAccrual > 0) {
            cumulativePik += pikMonthAccrual;
            pikMonthEndCapitalised = pikMonthAccrual;
            pikMonthAccrual = 0;
          }
          if (!inNonAccrual) {
            var inPrincipalHoliday = (repaymentType === 'principalAndInterest' && payIdx < payDates.length && isPaymentDateInHoliday(payDates[payIdx]));
            if (repaymentType === 'interestOnly') {
              if (monthInterestAccrual !== 0) {
                repaymentToday -= monthInterestAccrual;
                monthInterestAccrual = 0;
              }
            } else if (inPrincipalHoliday) {
              if (holidayInterestTreatment === 'payMonthly') {
                if (monthInterestAccrual !== 0) {
                  repaymentToday -= monthInterestAccrual;
                  monthInterestAccrual = 0;
                }
              } else if (holidayInterestTreatment === 'capitalise') {
                if (monthInterestAccrual !== 0) {
                  principal += monthInterestAccrual;
                  monthEndCapitalised = monthInterestAccrual;
                  monthInterestAccrual = 0;
                }
              } else if (holidayInterestTreatment === 'lumpSumEnd') {
                // Interest holiday: capitalise interest monthly (principal grows), single payment at end.
                if (monthInterestAccrual !== 0) {
                  principal += monthInterestAccrual;
                  monthEndCapitalised = monthInterestAccrual;
                  monthInterestAccrual = 0;
                }
              } else {
                // defer: carry forward
              }
            } else {
              if (monthInterestAccrual !== 0) {
                principal += monthInterestAccrual;
                monthEndCapitalised = monthInterestAccrual;
                monthInterestAccrual = 0;
              }
            }
          }
        }

        // Scheduled P&I payment on repayment date
        if (repaymentType === 'principalAndInterest' && !fullTermInterestHoliday && isFinite(currentMonthlyPayment) && currentMonthlyPayment > 0) {
          if (payIdx < payDates.length && isSameDay(dt, payDates[payIdx])) {
            var inHoliday = isPaymentDateInHoliday(payDates[payIdx]);
            var madePayment = false;
            if (!inHoliday && principal > balloonResidual + 0.001) {
              // Calculate what's needed to pay off the loan (principal - balloon residual)
              var amountToPayOff = principal - balloonResidual;
              // Cap payment at what's needed to bring balance to balloon residual (or 0)
              var actualPayment = Math.min(currentMonthlyPayment, amountToPayOff);
              if (actualPayment >= 0.01) {
                principal -= actualPayment;
                repaymentToday -= actualPayment;
                madePayment = true;

                // Track repayment periods
                var roundedAmount = Math.round(actualPayment * 100) / 100;
                if (currentPeriodAmount === null) {
                  // First payment - start new period
                  currentPeriodStart = new Date(dt.getTime());
                  currentPeriodAmount = roundedAmount;
                  currentPeriodCount = 1;
                } else if (Math.abs(roundedAmount - currentPeriodAmount) < 0.01) {
                  // Same amount - continue period
                  currentPeriodCount++;
                } else {
                  // Amount changed - save current period and start new one
                  repaymentPeriods.push({
                    fromDate: currentPeriodStart,
                    toDate: new Date(payDates[payIdx - 1].getTime()),
                    amount: currentPeriodAmount,
                    count: currentPeriodCount
                  });
                  currentPeriodStart = new Date(dt.getTime());
                  currentPeriodAmount = roundedAmount;
                  currentPeriodCount = 1;
                }
              }
            }
            payIdx++;

            // After making this payment, if there was a drawdown/adjustable repayment, recalculate for future payments
            if (recalcAfterNextPayment && madePayment && principal > balloonResidual + 0.001) {
              var remainingPayDates = payDates.slice(payIdx);
              if (remainingPayDates.length > 0) {
                currentMonthlyPayment = recalcPaymentAfterDrawdown(principal, dt, remainingPayDates, rateIndex);
              }
              recalcAfterNextPayment = false;
            }
          }
        }

        // End-date lump-sum interest payment for interest-holiday mode.

        if (isSameDay(dt, endDate) && holidayDeferredInterest !== 0) {
          repaymentToday -= holidayDeferredInterest;
          holidayDeferredInterest = 0;
        }

        // End-date residual adjustment
        if (isSameDay(dt, endDate)) {
          // If full-term interest holiday is active, repay principal (less any balloon residual) at end.
          if (repaymentType === 'principalAndInterest' && fullTermInterestHoliday) {
            var principalPayout = principal - balloonResidual;
            if (principalPayout > 0.005) {
              repaymentToday -= principalPayout;
              principal -= principalPayout;
            }
          }

          // Final repayment to close the loan at balloon residual (or $0 if no balloon)
          var finalBalance = principal - balloonResidual;
          if (Math.abs(finalBalance) > 0.001) {
            repaymentToday -= finalBalance;
            principal = balloonResidual;
          }

          // Add cumulative PIK to final payment (PIK is payable at loan end)
          if (pikEnabled && cumulativePik > 0.001) {
            repaymentToday -= cumulativePik;
            cumulativePik = 0; // PIK is now paid off
          }
        }

        // Calculate exit fee accrual for this day using pre-calculated values
        var exitFeeAccrualDaily = 0;
        var exitFeeCumulative = 0;
        var exitFeePayment = 0;
        var exitFeeBalance = 0;
        if (exitFeeEnabled && exitFeeAmount > 0 && exitFeeCumulativeByDay.length > 0) {
          if (dayIndex >= 0 && dayIndex < exitFeeCumulativeByDay.length) {
            exitFeeCumulative = exitFeeCumulativeByDay[dayIndex];
            if (dayIndex > 0) {
              exitFeeAccrualDaily = exitFeeCumulative - exitFeeCumulativeByDay[dayIndex - 1];
            }
          } else if (dayIndex >= exitFeeCumulativeByDay.length) {
            // After exit fee date, cumulative stays at final value
            exitFeeCumulative = exitFeeAmount;
          }

          // Check if loan is paid off early (before scheduled exit fee date)
          var loanPaidOff = principal <= balloonResidual + 0.001;
          var isBeforeExitFeeDate = dt.getTime() < exitFeeDate.getTime();

          // On exit fee date OR when loan is paid off early, record the exit fee payment
          if (!exitFeePaymentMade) {
            if (dt.getTime() === exitFeeDate.getTime()) {
              // Normal end date - pay full exit fee
              exitFeePayment = exitFeeAmount;
              exitFeePaymentMade = true;
            } else if (loanPaidOff && isBeforeExitFeeDate) {
              // Early payoff - pay full or accumulated based on checkbox
              if (exitFeeFullOnEarly) {
                exitFeePayment = exitFeeAmount;
              } else {
                exitFeePayment = exitFeeCumulative;
              }
              exitFeePaymentMade = true;
            }
          }

          // Exit fee balance = cumulative if not paid, 0 after payment
          exitFeeBalance = exitFeePaymentMade ? 0 : exitFeeCumulative;
        }

        // Collect daily record
        dailyRecords.push({
          date: new Date(dt.getTime()),
          rate: currentRate,
          openingBalance: openingBalance,
          netTransactions: netTransactions,
          repayment: repaymentToday,
          dailyInterest: normalDailyInterest,
          dailyPikInterest: dailyPikInterest,
          pikMonthEndCapitalised: pikMonthEndCapitalised,
          cumulativePik: cumulativePik,
          nonAccrualDailyInterest: nonAccrualDailyInterest,
          monthEndCapitalised: monthEndCapitalised,
          closingBalance: principal,
          nonAccrualBucket: nonAccrualBucket,
          exitFeeDaily: exitFeeAccrualDaily,
          exitFeePayment: exitFeePayment,
          exitFeeBalance: exitFeeBalance
        });

        // Track total repayments (repaymentToday is negative for outflows)
        if (repaymentToday < 0) {
          totalRepayments += Math.abs(repaymentToday);
        }
        
        dayIndex++;
      }

      // Add exit fee payment to total repayments
      var totalExitFeePayment = 0;
      if (exitFeeEnabled && exitFeeAmount > 0) {
        totalExitFeePayment = exitFeeAmount;
        totalRepayments += exitFeeAmount;
      }

      // Calculate totals for footer
      var scheduleFirstOpeningBalance = dailyRecords.length > 0 ? dailyRecords[0].openingBalance : 0;
      var scheduleLastClosingBalance = dailyRecords.length > 0 ? dailyRecords[dailyRecords.length - 1].closingBalance : 0;

      // Save the last repayment period if there is one
      if (currentPeriodAmount !== null && currentPeriodCount > 0) {
        // Find the last payment date
        var lastPaymentDate = null;
        for (var pdi = payDates.length - 1; pdi >= 0; pdi--) {
          if (payDates[pdi] <= endDate) {
            lastPaymentDate = payDates[pdi];
            break;
          }
        }
        repaymentPeriods.push({
          fromDate: currentPeriodStart,
          toDate: lastPaymentDate || endDate,
          amount: currentPeriodAmount,
          count: currentPeriodCount
        });
      }

      // Store for use in printing
      lastDailyRecords = dailyRecords;
      lastRepaymentPeriods = repaymentPeriods;

      // Render based on display mode
      var fragment = document.createDocumentFragment();
      if (displayMode === 'daily') {
        for (var i = 0; i < dailyRecords.length; i++) {
          var rec = dailyRecords[i];
          var inFilterRange = true;
          if (filterFrom && rec.date < filterFrom) inFilterRange = false;
          if (filterTo && rec.date > filterTo) inFilterRange = false;

          if (inFilterRange) {
            var tr = document.createElement('tr');
            var rateDisplay = rec.rate.toFixed(2);
            var pikColClass = pikEnabled ? 'numeric pik-col' : 'numeric pik-col hidden';
            var exitFeeColClass = exitFeeEnabled ? 'numeric exitfee-col' : 'numeric exitfee-col hidden';
            var totalWithExitFee = rec.closingBalance + rec.exitFeeBalance;
            var exitFeePaymentDisplay = rec.exitFeePayment > 0 ? -rec.exitFeePayment : 0; // Show as negative (outflow)
            tr.innerHTML = '' +
              '<td>' + formatDateDDMMYYYY(rec.date) + '</td>' +
              '<td class="numeric" style="text-align:center;">' + rateDisplay + '</td>' +
              '<td class="numeric">' + formatNumber(rec.openingBalance) + '</td>' +
              '<td class="numeric">' + formatNumber(rec.netTransactions) + '</td>' +
              '<td class="numeric">' + formatNumber(rec.repayment) + '</td>' +
              '<td class="numeric">' + formatNumber(rec.dailyInterest) + '</td>' +
              '<td class="numeric">' + formatNumber(rec.monthEndCapitalised) + '</td>' +
              '<td class="numeric">' + formatNumber(rec.closingBalance) + '</td>' +
              '<td class="' + pikColClass + '">' + formatNumber(rec.dailyPikInterest) + '</td>' +
              '<td class="' + pikColClass + '">' + formatNumber(rec.cumulativePik) + '</td>' +
              '<td class="numeric nonaccrual-col">' + formatNumber(rec.nonAccrualBucket) + '</td>' +
              '<td class="' + exitFeeColClass + '">' + formatNumber(rec.exitFeeDaily) + '</td>' +
              '<td class="' + exitFeeColClass + '">' + formatNumber(exitFeePaymentDisplay) + '</td>' +
              '<td class="' + exitFeeColClass + '">' + formatNumber(rec.exitFeeBalance) + '</td>' +
              '<td class="' + exitFeeColClass + '">' + formatNumber(totalWithExitFee) + '</td>';
            fragment.appendChild(tr);
          }
        }
      } else if (displayMode === 'monthly') {
        // Aggregate by month
        var monthlyData = {};
        for (var i = 0; i < dailyRecords.length; i++) {
          var rec = dailyRecords[i];
          var monthKey = getMonthKey(rec.date);
          if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = {
              label: getMonthLabel(rec.date),
              firstDate: rec.date,
              openingBalance: rec.openingBalance,
              netTransactions: 0,
              repayments: 0,
              interestAccrued: 0,
              pikInterestAccrued: 0,
              interestCapitalised: 0,
              closingBalance: rec.closingBalance,
              cumulativePik: 0,
              nonAccrualInterest: 0,
              exitFeeAccrued: 0,
              exitFeePayment: 0,
              exitFeeBalance: 0
            };
          }
          var md = monthlyData[monthKey];
          md.netTransactions += rec.netTransactions;
          md.repayments += rec.repayment;
          md.interestAccrued += rec.dailyInterest;
          md.pikInterestAccrued += rec.dailyPikInterest;
          md.interestCapitalised += rec.monthEndCapitalised;
          md.closingBalance = rec.closingBalance;
          md.cumulativePik = rec.cumulativePik;
          md.nonAccrualInterest = rec.nonAccrualBucket;
          md.exitFeeAccrued += rec.exitFeeDaily;
          md.exitFeePayment += rec.exitFeePayment;
          md.exitFeeBalance = rec.exitFeeBalance;
        }

        var monthKeys = Object.keys(monthlyData).sort();
        for (var j = 0; j < monthKeys.length; j++) {
          var md = monthlyData[monthKeys[j]];
          var inFilterRange = true;
          if (filterFrom && md.firstDate < filterFrom) inFilterRange = false;
          if (filterTo && md.firstDate > filterTo) inFilterRange = false;

          if (inFilterRange) {
            var tr = document.createElement('tr');
            var pikColClass = pikEnabled ? 'numeric pik-col' : 'numeric pik-col hidden';
            var exitFeeColClass = exitFeeEnabled ? 'numeric exitfee-col' : 'numeric exitfee-col hidden';
            var totalWithExitFee = md.closingBalance + md.exitFeeBalance;
            var exitFeePaymentDisplay = md.exitFeePayment > 0 ? -md.exitFeePayment : 0;
            tr.innerHTML = '' +
              '<td>' + md.label + '</td>' +
              '<td class="numeric">' + formatNumber(md.openingBalance) + '</td>' +
              '<td class="numeric">' + formatNumber(md.netTransactions) + '</td>' +
              '<td class="numeric">' + formatNumber(md.repayments) + '</td>' +
              '<td class="numeric">' + formatNumber(md.interestAccrued) + '</td>' +
              '<td class="numeric">' + formatNumber(md.interestCapitalised) + '</td>' +
              '<td class="numeric">' + formatNumber(md.closingBalance) + '</td>' +
              '<td class="' + pikColClass + '">' + formatNumber(md.pikInterestAccrued) + '</td>' +
              '<td class="' + pikColClass + '">' + formatNumber(md.cumulativePik) + '</td>' +
              '<td class="numeric nonaccrual-col">' + formatNumber(md.nonAccrualInterest) + '</td>' +
              '<td class="' + exitFeeColClass + '">' + formatNumber(md.exitFeeAccrued) + '</td>' +
              '<td class="' + exitFeeColClass + '">' + formatNumber(exitFeePaymentDisplay) + '</td>' +
              '<td class="' + exitFeeColClass + '">' + formatNumber(md.exitFeeBalance) + '</td>' +
              '<td class="' + exitFeeColClass + '">' + formatNumber(totalWithExitFee) + '</td>';
            fragment.appendChild(tr);
          }
        }
      } else if (displayMode === 'financialYear') {
        // Aggregate by financial year
        var fyData = {};
        for (var i = 0; i < dailyRecords.length; i++) {
          var rec = dailyRecords[i];
          var fy = getFinancialYear(rec.date);
          if (!fyData[fy]) {
            fyData[fy] = {
              label: getFinancialYearLabel(fy),
              firstDate: rec.date,
              openingBalance: rec.openingBalance,
              netTransactions: 0,
              repayments: 0,
              interestAccrued: 0,
              pikInterestAccrued: 0,
              interestCapitalised: 0,
              closingBalance: rec.closingBalance,
              cumulativePik: 0,
              nonAccrualInterest: 0,
              exitFeeAccrued: 0,
              exitFeePayment: 0,
              exitFeeBalance: 0
            };
          }
          var fd = fyData[fy];
          fd.netTransactions += rec.netTransactions;
          fd.repayments += rec.repayment;
          fd.pikInterestAccrued += rec.dailyPikInterest;
          fd.cumulativePik = rec.cumulativePik;
          fd.interestAccrued += rec.dailyInterest;
          fd.interestCapitalised += rec.monthEndCapitalised;
          fd.closingBalance = rec.closingBalance;
          fd.nonAccrualInterest = rec.nonAccrualBucket;
          fd.exitFeeAccrued += rec.exitFeeDaily;
          fd.exitFeePayment += rec.exitFeePayment;
          fd.exitFeeBalance = rec.exitFeeBalance;
        }

        var fyKeys = Object.keys(fyData).sort();
        for (var j = 0; j < fyKeys.length; j++) {
          var fd = fyData[fyKeys[j]];
          var inFilterRange = true;
          if (filterFrom && fd.firstDate < filterFrom) inFilterRange = false;
          if (filterTo && fd.firstDate > filterTo) inFilterRange = false;

          if (inFilterRange) {
            var tr = document.createElement('tr');
            var pikColClass = pikEnabled ? 'numeric pik-col' : 'numeric pik-col hidden';
            var exitFeeColClass = exitFeeEnabled ? 'numeric exitfee-col' : 'numeric exitfee-col hidden';
            var totalWithExitFee = fd.closingBalance + fd.exitFeeBalance;
            var exitFeePaymentDisplay = fd.exitFeePayment > 0 ? -fd.exitFeePayment : 0;
            tr.innerHTML = '' +
              '<td>' + fd.label + '</td>' +
              '<td class="numeric">' + formatNumber(fd.openingBalance) + '</td>' +
              '<td class="numeric">' + formatNumber(fd.netTransactions) + '</td>' +
              '<td class="numeric">' + formatNumber(fd.repayments) + '</td>' +
              '<td class="numeric">' + formatNumber(fd.interestAccrued) + '</td>' +
              '<td class="numeric">' + formatNumber(fd.interestCapitalised) + '</td>' +
              '<td class="numeric">' + formatNumber(fd.closingBalance) + '</td>' +
              '<td class="' + pikColClass + '">' + formatNumber(fd.pikInterestAccrued) + '</td>' +
              '<td class="' + pikColClass + '">' + formatNumber(fd.cumulativePik) + '</td>' +
              '<td class="numeric nonaccrual-col">' + formatNumber(fd.nonAccrualInterest) + '</td>' +
              '<td class="' + exitFeeColClass + '">' + formatNumber(fd.exitFeeAccrued) + '</td>' +
              '<td class="' + exitFeeColClass + '">' + formatNumber(exitFeePaymentDisplay) + '</td>' +
              '<td class="' + exitFeeColClass + '">' + formatNumber(fd.exitFeeBalance) + '</td>' +
              '<td class="' + exitFeeColClass + '">' + formatNumber(totalWithExitFee) + '</td>';
            fragment.appendChild(tr);
          }
        }
      }

      // Calculate final exit fee balance for footer (should be 0 after payment)
      // First, calculate filtered totals based on the date filter
      var filteredRecords = dailyRecords.filter(function(rec) {
        if (filterFrom && rec.date < filterFrom) return false;
        if (filterTo && rec.date > filterTo) return false;
        return true;
      });
      
      // Calculate totals from filtered records only
      var filteredFirstOpeningBalance = filteredRecords.length > 0 ? filteredRecords[0].openingBalance : 0;
      var filteredLastClosingBalance = filteredRecords.length > 0 ? filteredRecords[filteredRecords.length - 1].closingBalance : 0;
      var filteredNetTransactions = 0;
      var filteredRepayments = 0;
      var filteredInterest = 0;
      var filteredPikInterest = 0;
      var filteredCumulativePik = filteredRecords.length > 0 ? filteredRecords[filteredRecords.length - 1].cumulativePik : 0;
      var filteredExitFeeAccrued = 0;
      var filteredExitFeePayment = 0;
      var filteredExitFeeBalance = filteredRecords.length > 0 ? filteredRecords[filteredRecords.length - 1].exitFeeBalance : 0;

      for (var i = 0; i < filteredRecords.length; i++) {
        var rec = filteredRecords[i];
        if (rec.netTransactions > 0) {
          filteredNetTransactions += rec.netTransactions;
        }
        if (rec.repayment < 0) {
          filteredRepayments += Math.abs(rec.repayment);
        }
        filteredInterest += rec.dailyInterest;
        filteredPikInterest += rec.dailyPikInterest || 0;
        filteredExitFeeAccrued += rec.exitFeeDaily || 0;
        filteredExitFeePayment += rec.exitFeePayment || 0;
      }

      // Add totals footer row
      var footerTr = document.createElement('tr');
      footerTr.style.fontWeight = 'bold';
      footerTr.style.borderTop = '2px solid var(--border)';
      var footerPikColClass = pikEnabled ? 'numeric pik-col' : 'numeric pik-col hidden';
      var exitFeeColClass = exitFeeEnabled ? 'numeric exitfee-col' : 'numeric exitfee-col hidden';
      var filteredTotalWithExitFee = filteredLastClosingBalance + filteredExitFeeBalance;
      var filteredExitFeePaymentDisplay = filteredExitFeePayment > 0 ? -filteredExitFeePayment : 0;
      if (displayMode === 'daily') {
        footerTr.innerHTML = '' +
          '<td>TOTALS</td>' +
          '<td class="numeric" style="text-align:center;"></td>' +
          '<td class="numeric">' + formatNumber(filteredFirstOpeningBalance) + '</td>' +
          '<td class="numeric">' + formatNumber(filteredNetTransactions) + '</td>' +
          '<td class="numeric">' + formatNumber(-filteredRepayments) + '</td>' +
          '<td class="numeric">' + formatNumber(filteredInterest) + '</td>' +
          '<td class="numeric"></td>' +
          '<td class="numeric">' + formatNumber(filteredLastClosingBalance) + '</td>' +
          '<td class="' + footerPikColClass + '">' + formatNumber(filteredPikInterest) + '</td>' +
          '<td class="' + footerPikColClass + '">' + formatNumber(filteredCumulativePik) + '</td>' +
          '<td class="numeric nonaccrual-col"></td>' +
          '<td class="' + exitFeeColClass + '">' + formatNumber(filteredExitFeeAccrued) + '</td>' +
          '<td class="' + exitFeeColClass + '">' + formatNumber(filteredExitFeePaymentDisplay) + '</td>' +
          '<td class="' + exitFeeColClass + '">' + formatNumber(filteredExitFeeBalance) + '</td>' +
          '<td class="' + exitFeeColClass + '">' + formatNumber(filteredTotalWithExitFee) + '</td>';
      } else {
        footerTr.innerHTML = '' +
          '<td>TOTALS</td>' +
          '<td class="numeric">' + formatNumber(filteredFirstOpeningBalance) + '</td>' +
          '<td class="numeric">' + formatNumber(filteredNetTransactions) + '</td>' +
          '<td class="numeric">' + formatNumber(-filteredRepayments) + '</td>' +
          '<td class="numeric">' + formatNumber(filteredInterest) + '</td>' +
          '<td class="numeric"></td>' +
          '<td class="numeric">' + formatNumber(filteredLastClosingBalance) + '</td>' +
          '<td class="' + footerPikColClass + '">' + formatNumber(filteredPikInterest) + '</td>' +
          '<td class="' + footerPikColClass + '">' + formatNumber(filteredCumulativePik) + '</td>' +
          '<td class="numeric nonaccrual-col"></td>' +
          '<td class="' + exitFeeColClass + '">' + formatNumber(filteredExitFeeAccrued) + '</td>' +
          '<td class="' + exitFeeColClass + '">' + formatNumber(filteredExitFeePaymentDisplay) + '</td>' +
          '<td class="' + exitFeeColClass + '">' + formatNumber(filteredExitFeeBalance) + '</td>' +
          '<td class="' + exitFeeColClass + '">' + formatNumber(filteredTotalWithExitFee) + '</td>';
      }
      // Append all rows at once using fragment
      scheduleBody.appendChild(fragment);
      scheduleBody.appendChild(footerTr);

      // Calculate deducted loan costs (costs marked as "deduct from drawdown")
      var deductedLoanCosts = 0;
      for (var i = 0; i < loanCostsData.length; i++) {
        if (loanCostsData[i].deductFromDrawdown && loanCostsData[i].amount > 0) {
          deductedLoanCosts += loanCostsData[i].amount;
        }
      }

      // Update summary boxes with filtered values
      var initialAdvance = initialAmount - deductedLoanCosts;
      document.getElementById('summaryInitialAdvance').textContent = formatNumber(initialAdvance);

      // Show Loan Costs card only if there are deducted costs
      if (deductedLoanCosts > 0) {
        document.getElementById('summaryLoanCostsCard').style.display = '';
        document.getElementById('summaryLoanCosts').textContent = formatNumber(deductedLoanCosts);
      } else {
        document.getElementById('summaryLoanCostsCard').style.display = 'none';
        document.getElementById('summaryLoanCosts').textContent = '0.00';
      }

      document.getElementById('summaryDrawdowns').textContent = formatNumber(filteredNetTransactions);
      document.getElementById('summaryInterest').textContent = formatNumber(filteredInterest);
      document.getElementById('summaryRepayments').textContent = '(' + formatNumber(filteredRepayments + filteredExitFeePayment) + ')';

      // Update "Other" summary box (PIK Interest only - Loan Costs shown separately)
      var otherTotal = filteredPikInterest;
      var otherComponents = [];
      if (filteredPikInterest > 0) {
        otherComponents.push('PIK Interest: $' + formatNumber(filteredPikInterest));
      }
      document.getElementById('summaryOtherFees').textContent = formatNumber(otherTotal);
      document.getElementById('summaryOtherCard').title = otherComponents.length > 0 ? otherComponents.join('\n') : '';

      // Update exit fee and total cost summary boxes
      var filteredTotalCost = filteredInterest + filteredExitFeeAccrued;
      if (exitFeeEnabled) {
        document.getElementById('summaryExitFeeCard').style.display = '';
        document.getElementById('summaryExitFee').textContent = formatNumber(filteredExitFeeAccrued);
        document.getElementById('summaryTotalCostCard').style.display = '';
        document.getElementById('summaryTotalCost').textContent = formatNumber(filteredTotalCost);
      } else {
        document.getElementById('summaryExitFeeCard').style.display = 'none';
        document.getElementById('summaryExitFee').textContent = '0.00';
        document.getElementById('summaryTotalCostCard').style.display = 'none';
        document.getElementById('summaryTotalCost').textContent = '0.00';
      }

      lastComputedNonAccrualTotal = nonAccrualEnabled ? nonAccrualBucket : 0;

      // Apply visibility to the generated table cells.
      applyNonAccrualVisibility();

      // Equalise widths after render.
      requestAnimationFrame(function () { equaliseScheduleColumnWidths(); });
    }

    function capitaliseNonAccrualInterest() {
      applyNonAccrualVisibility();
      var enabledEl = document.getElementById('enableNonAccrual');
      var enabled = enabledEl ? !!enabledEl.checked : true;
      if (!enabled) {
        alert('Non-accrual tracking is currently off. Turn it on to capitalise non-accrual interest.');
        return;
      }

      if (!isFinite(lastComputedNonAccrualTotal) || lastComputedNonAccrualTotal <= 0) {
        alert('No non-accrual interest available to capitalise. Generate the schedule first.');
        return;
      }

      // Default capitalisation date: the END of the latest non-accrual period.
      // (Default requested: end of the non-accrual period.)
      var capDate = null;
      var maxEnd = null;
      document.querySelectorAll('#nonAccrualBody tr').forEach(function (row) {
        var e = getInputDate(row.cells[1].querySelector('.date-input'));
        if (e && (!maxEnd || e > maxEnd)) maxEnd = e;
      });
      if (maxEnd) capDate = maxEnd;

      var startDate = getInputDate(document.getElementById('loanStartDate'));
      var endDate = getInputDate(document.getElementById('scheduleEndDate'));
      if (!capDate && startDate) capDate = startDate;
      if (capDate && endDate && capDate > endDate) capDate = endDate;

      nonAccrualCapitalisations.push({ date: capDate, amount: lastComputedNonAccrualTotal });

      alert('Non-accrual interest of ' + formatNumber(lastComputedNonAccrualTotal) + ' will be capitalised on ' + (capDate ? formatDateDDMMYYYY(capDate) : 'the selected date') + '. Re-generate the schedule to apply.');

      lastComputedNonAccrualTotal = 0;
      recalculateMonthlyPayment(true);
      recalculateSchedule();
    }

    function clearAll() {
      document.getElementById('borrowerName').value = '';
      document.getElementById('lenderName').value = '';
      document.getElementById('initialAmount').value = '';
      setInputDate(document.getElementById('loanStartDate'), null);
      document.getElementById('initialRate').value = '';
      setInputDate(document.getElementById('scheduleEndDate'), null);
      setInputDate(document.getElementById('firstRepaymentDate'), null);
      setInputDate(document.getElementById('principalHolidayStart'), null);
      setInputDate(document.getElementById('principalHolidayEnd'), null);
      document.getElementById('balloonResidual').value = '';
      document.getElementById('overridePayment').value = '';
      document.getElementById('fixedMargin').value = '';
      document.getElementById('baseRateSource').value = 'rba';
      document.getElementById('totalRateDisplay').value = '0.00';
      // New fields
      document.getElementById('cashRateType').value = 'fixed';
      document.getElementById('pikRate').value = '';
      document.getElementById('loanCostsTotal').value = '';
      document.getElementById('repaymentHolidayType').value = 'none';
      setInputDate(document.getElementById('repaymentHolidayStart'), null);
      setInputDate(document.getElementById('repaymentHolidayEnd'), null);
      document.getElementById('paymentHolidaysBody').innerHTML = '';
      loanCostsData = [];
      updateCashRateTypeVisibility();
      updateRepaymentHolidayVisibility();
      // Exit fee reset
      document.getElementById('exitFeeAmount').value = '';
      document.getElementById('exitFeeFullOnEarly').checked = false;
      document.getElementById('irrExcludingFee').value = 'â€”';
      document.getElementById('irrIncludingFee').value = 'â€”';
      document.getElementById('exitFeeRateAnnual').value = 'â€”';
      setInputDate(document.getElementById('filterFromDate'), null);
      setInputDate(document.getElementById('filterToDate'), null);
      document.getElementById('displayMode').value = 'daily';
      document.getElementById('transactionsBody').innerHTML = '';
      document.getElementById('rateChangesBody').innerHTML = '';
      document.getElementById('defaultInterestBody').innerHTML = '';
      document.getElementById('nonAccrualBody').innerHTML = '';
      document.getElementById('defaultInterestRate').value = '';
      document.getElementById('defaultInterestRateVar').value = '';
      document.getElementById('scheduleBody').innerHTML = '';
      document.getElementById('summaryInitialAdvance').textContent = '0.00';
      document.getElementById('summaryLoanCosts').textContent = '0.00';
      document.getElementById('summaryLoanCostsCard').style.display = 'none';
      document.getElementById('summaryDrawdowns').textContent = '0.00';
      document.getElementById('summaryInterest').textContent = '0.00';
      document.getElementById('summaryOtherFees').textContent = '0.00';
      document.getElementById('summaryOtherCard').title = '';
      document.getElementById('summaryRepayments').textContent = '(0.00)';
      document.getElementById('summaryExitFee').textContent = '0.00';
      document.getElementById('summaryExitFeeCard').style.display = 'none';
      document.getElementById('summaryTotalCost').textContent = '0.00';
      document.getElementById('summaryTotalCostCard').style.display = 'none';
      document.getElementById('calculatedPayment').value = '0.00';
      clearError();
      lastComputedNonAccrualTotal = 0;
      lastDailyRecords = [];
      nonAccrualCapitalisations.splice(0, nonAccrualCapitalisations.length);

      addTransactionRow({});
      addRateChangeRow();
      addNonAccrualRow();

      setInputDate(document.getElementById('principalHolidayStart'), getInputDate(document.getElementById('loanStartDate')));
      applyNonAccrualVisibility();
      applyBaseMarginVisibility();
      applyExitFeeVisibility();
    }

    function recalculateMonthlyPayment(silent) {
      if (silent == null) silent = false;
      clearError();

      var repaymentType = document.getElementById('repaymentType').value;
      var calcOut = document.getElementById('calculatedPayment');

      if (repaymentType !== 'principalAndInterest') {
        calcOut.value = 'â€”';
        return NaN;
      }

      var nonAccrualEnabledEl = document.getElementById('enableNonAccrual');
      var nonAccrualEnabled = nonAccrualEnabledEl ? !!nonAccrualEnabledEl.checked : true;

      var initialAmount = parseFloat(document.getElementById('initialAmount').value);
      var startDate = getInputDate(document.getElementById('loanStartDate'));
      var endDate = getInputDate(document.getElementById('scheduleEndDate'));
      var firstPayDate = getInputDate(document.getElementById('firstRepaymentDate'));
      var initialRate = parseFloat(document.getElementById('initialRate').value);

      var balloonResidualRaw = document.getElementById('balloonResidual').value;
      var balloonResidual = (balloonResidualRaw === '') ? 0 : parseFloat(balloonResidualRaw);

      var holidayMonths = Math.max(0, parseInt(document.getElementById('principalHolidayMonths').value || '0', 10));
      var holidayStartDate = getInputDate(document.getElementById('principalHolidayStart')) || startDate;
      var holidayInterestTreatment = document.getElementById('holidayInterestTreatment').value || 'payMonthly';
      var overridePaymentRaw = document.getElementById('overridePayment').value;
      var overridePayment = (overridePaymentRaw === '') ? null : parseFloat(overridePaymentRaw);

      if (!isFinite(initialAmount) || initialAmount < 0) { if (!silent) showError('Please enter a valid initial loan amount.'); return NaN; }
      if (!startDate) { if (!silent) showError('Please enter a valid loan start date.'); return NaN; }
      if (!endDate) { if (!silent) showError('Please enter a valid schedule end date.'); return NaN; }
      if (!firstPayDate) {
        if (!(holidayInterestTreatment === 'lumpSumEnd')) {
          if (!silent) showError('Please enter a valid First repayment date.');
          return NaN;
        }
      }
      if (!isFinite(initialRate)) { if (!silent) showError('Please enter a valid initial annual interest rate.'); return NaN; }
      if (!isFinite(balloonResidual) || balloonResidual < 0) { if (!silent) showError('Please enter a valid balloon residual (non-negative).'); return NaN; }
      if (overridePayment !== null && (!isFinite(overridePayment) || overridePayment <= 0)) { if (!silent) showError('Override payment must be blank or a positive amount.'); return NaN; }

      endDate = deriveEndDateIfTermProvided(startDate, endDate, firstPayDate, repaymentType);
      if (!endDate) return NaN;

      if (endDate < startDate) { if (!silent) showError('End date must be on or after start date.'); return NaN; }
      if (firstPayDate) {
        if (firstPayDate < startDate || firstPayDate > endDate) {
          if (!silent) showError('First repayment date must be between start and end dates.');
          return NaN;
        }
      }

      var rateChanges = readRateChanges(startDate, initialRate);
      var nonAccrualPeriods = readNonAccrualPeriods();
      var capMap = buildCapMap();

      // Non-accrual logic in payment simulation matches the schedule:
      // - Non-accrual is defined strictly by the user-entered periods.
      // - Capitalisation events clear the bucket (handled in schedule), but do not end non-accrual by themselves.
      function isDateInNonAccrual(date) {
        if (!nonAccrualEnabled) return false;
        return nonAccrualPeriods.some(function (p) { return date >= p.start && date <= p.end; });
      }

      var manualTransactions = readTransactions();
      var txMap = txToMap(manualTransactions);

      // For single end-of-loan payment mode, treat the end date as the sole repayment date
      var effectiveFirstPayDate = firstPayDate;
      if (!effectiveFirstPayDate && holidayInterestTreatment === 'lumpSumEnd') {
        effectiveFirstPayDate = endDate;
      }
      var payDates = effectiveFirstPayDate ? buildPayDates(effectiveFirstPayDate, endDate) : [];
      var holidayWindowEnd = holidayMonths > 0 ? addMonthsKeepDay(holidayStartDate, holidayMonths) : null;
      function isInHolidayWindow(d) { return holidayMonths > 0 && d >= holidayStartDate && d < holidayWindowEnd; }
      function isPaymentDateInHoliday(paymentDate) {
        // In single end-of-loan payment mode, treat the whole term as the holiday.
        if (holidayInterestTreatment === 'lumpSumEnd') return true;
        return isInHolidayWindow(paymentDate);
      }
      if (payDates.length === 0) { if (!silent) showError('No payment dates found (check first repayment date and end date).'); return NaN; }
      if (holidayMonths >= payDates.length) {
        // Allow full-term holiday if using the interest-holiday lump-sum mode.
        if (holidayInterestTreatment !== 'lumpSumEnd') {
          if (!silent) showError('Principal holiday is longer than available payment dates.');
          return NaN;
        }
      }

      // If every scheduled payment date is inside the holiday window and interest is lump-sum at end,
      // the monthly payment is effectively zero.
      if (holidayInterestTreatment === 'lumpSumEnd') {
        var allInHoliday = true;
        for (var iH = 0; iH < payDates.length; iH++) {
          if (!isPaymentDateInHoliday(payDates[iH])) { allInHoliday = false; break; }
        }
        if (allInHoliday) {
          calcOut.value = formatNumber(0);
          return 0;
        }
      }

      if (overridePayment !== null) {
        calcOut.value = formatNumber(overridePayment);
        return overridePayment;
      }

      function simulateEndingBalance(candidatePayment) {
        var principal = initialAmount;
        var monthInterestAccrual = 0;
        var holidayDeferredInterest = 0;
        var rateIndex = 0;
        var payIdx = 0;

        for (var dt = new Date(startDate.getTime()); dt <= endDate; dt = addDays(dt, 1)) {
          var isoKey = formatDateInput(dt);

          // Only apply REPAYMENT transactions, not drawdowns
          // Drawdowns are handled dynamically in the schedule with payment recalculation
          if (txMap.has(isoKey)) {
            var list = txMap.get(isoKey);
            for (var t = 0; t < list.length; t++) {
              var txAmount = Math.abs(list[t].amount);
              // Skip drawdowns - they are handled dynamically in the schedule
              if (list[t].type === 'drawdown') {
                // Do not include drawdowns in initial payment calculation
                continue;
              } else {
                // Only apply repayments
                principal -= txAmount;
              }
            }
          }

          while (rateIndex + 1 < rateChanges.length && dt >= rateChanges[rateIndex + 1].date) rateIndex++;
          var currentRate = rateChanges[rateIndex].rate;

          var inNonAccrual = isDateInNonAccrual(dt);
          var dailyInterest = principal * currentRate / 100 / 365;
          if (!inNonAccrual) monthInterestAccrual += dailyInterest;

          if (isEndOfMonth(dt) || isSameDay(dt, endDate)) {
            if (!inNonAccrual) {
              var inPrincipalHoliday = (payIdx < payDates.length && isPaymentDateInHoliday(payDates[payIdx]));
              if (inPrincipalHoliday) {
                if (holidayInterestTreatment === 'payMonthly') {
                  monthInterestAccrual = 0;
                } else if (holidayInterestTreatment === 'capitalise') {
                  principal += monthInterestAccrual;
                  monthInterestAccrual = 0;
                } else if (holidayInterestTreatment === 'lumpSumEnd') {
                  // Interest holiday: capitalise interest monthly (principal grows), single payment at end.
                  principal += monthInterestAccrual;
                  monthInterestAccrual = 0;
                } else {
                  // defer: carry forward
                }
              } else {
                principal += monthInterestAccrual;
                monthInterestAccrual = 0;
              }
            }
          }

          if (payIdx < payDates.length && isSameDay(dt, payDates[payIdx])) {
            var inHoliday = isPaymentDateInHoliday(payDates[payIdx]);
            if (!inHoliday) principal -= candidatePayment;
            payIdx++;
          }
        }

        return principal;
      }

      var target = balloonResidual;
      var lo = 0;
      var hi = Math.max(1, initialAmount);

      for (var i = 0; i < 80; i++) {
        var endBal = simulateEndingBalance(hi);
        if (endBal <= target + 0.01) break;
        hi *= 1.8;
        if (hi > Math.max(1, initialAmount) * 1000) break;
      }

      for (var iter = 0; iter < 90; iter++) {
        var mid = (lo + hi) / 2;
        var endBal2 = simulateEndingBalance(mid);
        if (endBal2 > target) lo = mid;
        else hi = mid;
      }

      var payment = Math.round(hi * 100) / 100;
      calcOut.value = formatNumber(payment);
      return payment;
    }

    // --- Excel Export ---

    async function exportToExcel() {
      var displayMode = document.getElementById('displayMode').value || 'daily';
      var nonAccrualEnabled = document.getElementById('enableNonAccrual').checked;

      // Get data from the table
      var scheduleBody = document.getElementById('scheduleBody');
      var rows = scheduleBody.querySelectorAll('tr');
      
      if (rows.length === 0) {
        alert('No data to export. Please generate a schedule first.');
        return;
      }

      // Build headers based on display mode
      var headers = [];

      if (displayMode === 'daily') {
        headers = ['Date', 'Rate', 'Opening Balance', 'Net Transactions', 'Repayment', 'Interest for Day', 'Month-end Capitalised', 'Closing Balance'];
        if (nonAccrualEnabled) headers.push('Non-accrual Interest Balance');
      } else if (displayMode === 'monthly') {
        headers = ['Month', 'Opening Balance', 'Net Transactions', 'Repayments', 'Interest Accrued', 'Interest Capitalised', 'Closing Balance'];
        if (nonAccrualEnabled) headers.push('Non-accrual Interest');
      } else if (displayMode === 'financialYear') {
        headers = ['Financial Year', 'Opening Balance', 'Net Transactions', 'Repayments', 'Interest Accrued', 'Interest Capitalised', 'Closing Balance'];
        if (nonAccrualEnabled) headers.push('Non-accrual Interest');
      }

      // Create workbook and worksheet
      var workbook = new ExcelJS.Workbook();
      var sheetName = displayMode === 'daily' ? 'Daily Schedule' : (displayMode === 'monthly' ? 'Monthly Summary' : 'FY Summary');
      var worksheet = workbook.addWorksheet(sheetName);

      // Set column properties
      var columns = [];
      for (var c = 0; c < headers.length; c++) {
        columns.push({ header: headers[c], key: 'col' + c, width: 12 });
      }
      worksheet.columns = columns;

      // Style header row - bold and wrap text
      var headerRow = worksheet.getRow(1);
      headerRow.font = { name: 'Arial', size: 10, bold: true };
      headerRow.alignment = { wrapText: true, vertical: 'middle', horizontal: 'center' };
      headerRow.height = 30;

      // Parse and add data rows
      for (var i = 0; i < rows.length; i++) {
        var cells = rows[i].querySelectorAll('td');
        var rowData = [];
        var colIdx = 0;
        
        for (var j = 0; j < cells.length; j++) {
          // Skip hidden non-accrual column
          if (!nonAccrualEnabled && cells[j].classList.contains('nonaccrual-col')) continue;
          
          var cellText = cells[j].textContent.trim();
          
          // Parse the cell value
          if (colIdx === 0) {
            // First column - date or period label
            if (displayMode === 'daily') {
              // Parse DD/MM/YYYY and convert to Date object
              var dateParts = cellText.split('/');
              if (dateParts.length === 3) {
                var d = parseInt(dateParts[0], 10);
                var m = parseInt(dateParts[1], 10) - 1;
                var y = parseInt(dateParts[2], 10);
                rowData.push(new Date(y, m, d));
              } else {
                rowData.push(cellText);
              }
            } else {
              rowData.push(cellText);
            }
          } else if (displayMode === 'daily' && colIdx === 1) {
            // Rate column (daily mode only) - store as decimal for percentage format
            var rateVal = parseFloat(cellText);
            rowData.push(isFinite(rateVal) ? rateVal / 100 : 0);
          } else {
            // Numeric value - parse from formatted string
            var numText = cellText.replace(/[(),\s]/g, '').replace(/âˆ’/g, '-');
            if (numText === '-' || numText === '') {
              rowData.push(0);
            } else {
              var numVal = parseFloat(numText);
              // Check if original had parentheses (negative)
              if (cellText.indexOf('(') !== -1) numVal = -Math.abs(numVal);
              rowData.push(isFinite(numVal) ? numVal : 0);
            }
          }
          colIdx++;
        }
        
        var dataRow = worksheet.addRow(rowData);
        dataRow.font = { name: 'Arial', size: 10 };
        
        // Apply number formats to cells
        dataRow.eachCell({ includeEmpty: false }, function(cell, colNumber) {
          if (colNumber === 1 && displayMode === 'daily') {
            // Date column
            cell.numFmt = 'dd/mm/yy';
          } else if (colNumber === 2 && displayMode === 'daily') {
            // Rate column
            cell.numFmt = '0.00%';
          } else if (colNumber > 1 || displayMode !== 'daily') {
            // Value columns
            if ((displayMode === 'daily' && colNumber > 2) || (displayMode !== 'daily' && colNumber > 1)) {
              cell.numFmt = '#,##0.00;(#,##0.00);" - "';
            }
          }
        });
      }

      // Generate filename with date
      var now = new Date();
      var filename = 'Loan_Schedule_' + now.getFullYear() + 
        String(now.getMonth() + 1).padStart(2, '0') + 
        String(now.getDate()).padStart(2, '0') + '.xlsx';

      // Write file and trigger download
      var buffer = await workbook.xlsx.writeBuffer();
      var blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // --- Print Loan Terms ---

    function printTermSheet() {
      var borrower = document.getElementById('borrowerName').value.trim() || 'â€”';
      var lender = document.getElementById('lenderName').value.trim() || 'â€”';
      var initialAmount = parseFloat(document.getElementById('initialAmount').value);
      var startDate = getInputDate(document.getElementById('loanStartDate'));
      var endDate = getInputDate(document.getElementById('scheduleEndDate'));
      var firstRepaymentDate = getInputDate(document.getElementById('firstRepaymentDate'));
      var initialRate = parseFloat(document.getElementById('initialRate').value);
      var repaymentType = document.getElementById('repaymentType').value;
      var balloonResidual = parseFloat(document.getElementById('balloonResidual').value) || 0;
      var holidayMonths = parseInt(document.getElementById('principalHolidayMonths').value || '0', 10);
      var holidayStartDate = getInputDate(document.getElementById('principalHolidayStart'));
      var holidayInterestTreatment = document.getElementById('holidayInterestTreatment').value;
      var monthlyPayment = document.getElementById('calculatedPayment').value;
      var useBaseMargin = document.getElementById('useBaseMargin').checked;
      var fixedMargin = parseFloat(document.getElementById('fixedMargin').value) || 0;
      var baseRateSource = document.getElementById('baseRateSource').value;

      // Populate term sheet
      document.getElementById('tsBorrower').textContent = borrower;
      document.getElementById('tsLender').textContent = lender;

      // Principal
      document.getElementById('tsPrincipal').textContent = isFinite(initialAmount) ? '$' + formatNumber(initialAmount) : 'â€”';

      // Dates
      document.getElementById('tsStartDate').textContent = startDate ? formatDateDDMMYYYY(startDate) : 'â€”';
      document.getElementById('tsEndDate').textContent = endDate ? formatDateDDMMYYYY(endDate) : 'â€”';

      // Term calculation
      if (startDate && endDate) {
        var months = (endDate.getUTCFullYear() - startDate.getUTCFullYear()) * 12 + (endDate.getUTCMonth() - startDate.getUTCMonth());
        var years = Math.floor(months / 12);
        var remainingMonths = months % 12;
        var termStr = '';
        if (years > 0) termStr += years + ' year' + (years > 1 ? 's' : '');
        if (remainingMonths > 0) termStr += (termStr ? ' ' : '') + remainingMonths + ' month' + (remainingMonths > 1 ? 's' : '');
        document.getElementById('tsTerm').textContent = termStr || 'â€”';
      } else {
        document.getElementById('tsTerm').textContent = 'â€”';
      }

      // Interest rate and base source
      var baseSourceText = baseRateSource === 'rba' ? 'RBA Cash Rate' : 'Manual';
      if (useBaseMargin && isFinite(initialRate) && isFinite(fixedMargin)) {
        var totalRate = initialRate + fixedMargin;
        document.getElementById('tsInterestRate').textContent = totalRate.toFixed(2) + '% p.a. (' + initialRate.toFixed(2) + '% base + ' + fixedMargin.toFixed(2) + '% margin)';
        document.getElementById('tsRateStructure').textContent = baseSourceText + ' plus fixed margin';
      } else if (isFinite(initialRate)) {
        document.getElementById('tsInterestRate').textContent = initialRate.toFixed(2) + '% p.a.';
        document.getElementById('tsRateStructure').textContent = 'Fixed rate';
      } else {
        document.getElementById('tsInterestRate').textContent = 'â€”';
        document.getElementById('tsRateStructure').textContent = 'â€”';
      }

      // Repayment type - identify method correctly
      var repaymentTypeText = '';
      if (holidayInterestTreatment === 'lumpSumEnd') {
        repaymentTypeText = 'All repayments at maturity';
      } else if (repaymentType === 'principalAndInterest') {
        repaymentTypeText = 'Principal & Interest';
      } else {
        repaymentTypeText = 'Interest Only';
      }
      document.getElementById('tsRepaymentType').textContent = repaymentTypeText;
      
      if (holidayInterestTreatment === 'lumpSumEnd') {
        document.getElementById('tsFirstRepayment').textContent = 'N/A - single payment at maturity';
        document.getElementById('tsMonthlyPayment').textContent = 'N/A';
      } else {
        document.getElementById('tsFirstRepayment').textContent = firstRepaymentDate ? formatDateDDMMYYYY(firstRepaymentDate) : 'â€”';
        document.getElementById('tsMonthlyPayment').textContent = monthlyPayment && monthlyPayment !== 'â€”' && monthlyPayment !== '0.00' ? '$' + monthlyPayment : 'â€”';
      }
      document.getElementById('tsBalloon').textContent = balloonResidual > 0 ? '$' + formatNumber(balloonResidual) : 'Nil';

      // Repayment schedule section (shows periods with different payment amounts)
      var repaymentScheduleTitle = document.getElementById('tsRepaymentScheduleTitle');
      var repaymentScheduleTable = document.getElementById('tsRepaymentScheduleTable');
      var repaymentScheduleBody = document.getElementById('tsRepaymentScheduleBody');
      repaymentScheduleBody.innerHTML = '';

      if (lastRepaymentPeriods && lastRepaymentPeriods.length > 1 && repaymentType === 'principalAndInterest') {
        // Only show if there are multiple periods (i.e., payment amount changed)
        repaymentScheduleTitle.style.display = '';
        repaymentScheduleTable.style.display = '';
        for (var rpi = 0; rpi < lastRepaymentPeriods.length; rpi++) {
          var period = lastRepaymentPeriods[rpi];
          var tr = document.createElement('tr');
          var periodStr = formatDateDDMMYYYY(period.fromDate) + ' - ' + formatDateDDMMYYYY(period.toDate);
          tr.innerHTML = '<td>' + periodStr + '</td>' +
                        '<td>$' + formatNumber(period.amount) + '</td>' +
                        '<td>' + period.count + '</td>';
          repaymentScheduleBody.appendChild(tr);
        }
      } else {
        repaymentScheduleTitle.style.display = 'none';
        repaymentScheduleTable.style.display = 'none';
      }

      // Principal holiday section
      var holidaySectionTitle = document.getElementById('tsHolidaySectionTitle');
      var holidayTable = document.getElementById('tsHolidayTable');
      if (holidayMonths > 0 && holidayInterestTreatment !== 'lumpSumEnd') {
        holidaySectionTitle.style.display = '';
        holidayTable.style.display = '';
        document.getElementById('tsHolidayPeriod').textContent = holidayMonths + ' month' + (holidayMonths > 1 ? 's' : '');
        document.getElementById('tsHolidayStart').textContent = holidayStartDate ? formatDateDDMMYYYY(holidayStartDate) : 'â€”';
        
        var interestTreatmentText = {
          'payMonthly': 'Pay monthly',
          'capitalise': 'Capitalise to principal',
          'defer': 'Defer'
        };
        document.getElementById('tsHolidayInterest').textContent = interestTreatmentText[holidayInterestTreatment] || holidayInterestTreatment;
      } else {
        holidaySectionTitle.style.display = 'none';
        holidayTable.style.display = 'none';
      }

      // Summary from calculated values - use full loan totals (not filtered)
      var fullTotalInterest = 0;
      var fullTotalRepayments = 0;
      if (lastDailyRecords && lastDailyRecords.length > 0) {
        for (var i = 0; i < lastDailyRecords.length; i++) {
          fullTotalInterest += lastDailyRecords[i].dailyInterest;
          if (lastDailyRecords[i].repayment < 0) {
            fullTotalRepayments += Math.abs(lastDailyRecords[i].repayment);
          }
        }
      }
      document.getElementById('tsTotalInterest').textContent = fullTotalInterest > 0 ? '$' + formatNumber(fullTotalInterest) : 'â€”';
      document.getElementById('tsFinalBalance').textContent = '$0.00';

      // Exit fee section
      var exitFeeAmount = parseFloat(document.getElementById('exitFeeAmount').value) || 0;
      var exitFeeEnabled = exitFeeAmount > 0;
      var exitFeeDateInput = getInputDate(document.getElementById('exitFeeDate'));
      var exitFeeDate = exitFeeDateInput || endDate;
      var exitFeeSectionTitle = document.getElementById('tsExitFeeSectionTitle');
      var exitFeeTable = document.getElementById('tsExitFeeTable');
      var exitFeeTotalRow = document.getElementById('tsExitFeeTotalRow');

      if (exitFeeEnabled) {
        exitFeeSectionTitle.style.display = '';
        exitFeeTable.style.display = '';
        exitFeeTotalRow.style.display = '';
        document.getElementById('tsExitFeeAmount').textContent = '$' + formatNumber(exitFeeAmount);
        document.getElementById('tsExitFeeDate').textContent = exitFeeDate ? formatDateDDMMYYYY(exitFeeDate) : 'â€”';
        document.getElementById('tsExitFeeRateAnnual').textContent = document.getElementById('exitFeeRateAnnual').value;
        document.getElementById('tsExitFeeRateDaily').textContent = document.getElementById('exitFeeRateDaily').value;
        document.getElementById('tsExitFeeTotal').textContent = '$' + formatNumber(exitFeeAmount);
      } else {
        exitFeeSectionTitle.style.display = 'none';
        exitFeeTable.style.display = 'none';
        exitFeeTotalRow.style.display = 'none';
      }

      // Total cost of loan (interest + exit fee)
      var totalCost = fullTotalInterest + (exitFeeEnabled ? exitFeeAmount : 0);
      document.getElementById('tsTotalCost').textContent = '$' + formatNumber(totalCost);

      // Show print options modal
      document.getElementById('printOptionsModal').style.display = 'flex';
    }

    function executePrint() {
      var showMonthly = document.getElementById('printMonthlyCheck').checked;
      var showYearly = document.getElementById('printYearlyCheck').checked;

      // Hide modal
      document.getElementById('printOptionsModal').style.display = 'none';

      // Show/hide sections and set page breaks
      var monthlySection = document.getElementById('tsMonthlySummarySection');
      var yearlySection = document.getElementById('tsYearlySummarySection');
      
      monthlySection.style.display = showMonthly ? '' : 'none';
      yearlySection.style.display = showYearly ? '' : 'none';

      // If both are shown, yearly gets page break; if only yearly, it gets the page break
      // If only monthly, monthly gets page break (it's first after loan terms)
      if (showMonthly && showYearly) {
        monthlySection.style.pageBreakBefore = 'always';
        yearlySection.style.pageBreakBefore = 'always';
      } else if (showMonthly) {
        monthlySection.style.pageBreakBefore = 'always';
      } else if (showYearly) {
        yearlySection.style.pageBreakBefore = 'always';
      }

      // Populate tables if needed
      if (lastDailyRecords && lastDailyRecords.length > 0) {
        var exitFeeEnabled = (parseFloat(document.getElementById('exitFeeAmount').value) || 0) > 0;

        // Hide/show exit fee columns in print tables
        var exitFeeCols = document.querySelectorAll('.ts-exitfee-col');
        exitFeeCols.forEach(function(col) {
          col.style.display = exitFeeEnabled ? '' : 'none';
        });
        
        // Populate monthly summary
        if (showMonthly) {
          var monthlySummaryBody = document.getElementById('tsMonthlySummaryBody');
          monthlySummaryBody.innerHTML = '';
          
          var monthData = {};
          for (var i = 0; i < lastDailyRecords.length; i++) {
            var rec = lastDailyRecords[i];
            var monthKey = getMonthKey(rec.date);
            if (!monthData[monthKey]) {
              monthData[monthKey] = {
                label: getMonthLabel(rec.date),
                openingBalance: rec.openingBalance,
                drawdowns: 0,
                repayments: 0,
                interestAccrued: 0,
                closingBalance: rec.closingBalance,
                exitFeeAccrued: 0,
                exitFeePayment: 0,
                exitFeeBalance: 0
              };
            }
            var md = monthData[monthKey];
            if (rec.netTransactions > 0) {
              md.drawdowns += rec.netTransactions;
            }
            if (rec.repayment < 0) {
              md.repayments += Math.abs(rec.repayment);
            }
            md.interestAccrued += rec.dailyInterest;
            md.closingBalance = rec.closingBalance;
            md.exitFeeAccrued += rec.exitFeeDaily || 0;
            md.exitFeePayment += rec.exitFeePayment || 0;
            md.exitFeeBalance = rec.exitFeeBalance || 0;
          }

          var monthKeys = Object.keys(monthData).sort();
          for (var j = 0; j < monthKeys.length; j++) {
            var md = monthData[monthKeys[j]];
            var tr = document.createElement('tr');
            var exitFeeColStyle = exitFeeEnabled ? 'text-align:right;' : 'text-align:right;display:none;';
            var totalWithExitFee = md.closingBalance + md.exitFeeBalance;
            tr.innerHTML = '' +
              '<td>' + md.label + '</td>' +
              '<td style="text-align:right;">$' + formatNumber(md.openingBalance) + '</td>' +
              '<td style="text-align:right;">$' + formatNumber(md.drawdowns) + '</td>' +
              '<td style="text-align:right;">$' + formatNumber(md.repayments) + '</td>' +
              '<td style="text-align:right;">$' + formatNumber(md.interestAccrued) + '</td>' +
              '<td style="text-align:right;">$' + formatNumber(md.closingBalance) + '</td>' +
              '<td style="' + exitFeeColStyle + '">$' + formatNumber(md.exitFeeAccrued) + '</td>' +
              '<td style="' + exitFeeColStyle + '">$' + formatNumber(md.exitFeeBalance) + '</td>' +
              '<td style="' + exitFeeColStyle + '">$' + formatNumber(totalWithExitFee) + '</td>';
            monthlySummaryBody.appendChild(tr);
          }
        }

        // Populate yearly summary
        if (showYearly) {
          var yearlySummaryBody = document.getElementById('tsYearlySummaryBody');
          yearlySummaryBody.innerHTML = '';
          
          var fyData = {};
          for (var i = 0; i < lastDailyRecords.length; i++) {
            var rec = lastDailyRecords[i];
            var fy = getFinancialYear(rec.date);
            if (!fyData[fy]) {
              fyData[fy] = {
                label: getFinancialYearLabel(fy),
                openingBalance: rec.openingBalance,
                drawdowns: 0,
                repayments: 0,
                interestAccrued: 0,
                closingBalance: rec.closingBalance,
                exitFeeAccrued: 0,
                exitFeePayment: 0,
                exitFeeBalance: 0
              };
            }
            var fd = fyData[fy];
            if (rec.netTransactions > 0) {
              fd.drawdowns += rec.netTransactions;
            }
            if (rec.repayment < 0) {
              fd.repayments += Math.abs(rec.repayment);
            }
            fd.interestAccrued += rec.dailyInterest;
            fd.closingBalance = rec.closingBalance;
            fd.exitFeeAccrued += rec.exitFeeDaily || 0;
            fd.exitFeePayment += rec.exitFeePayment || 0;
            fd.exitFeeBalance = rec.exitFeeBalance || 0;
          }

          var fyKeys = Object.keys(fyData).sort();
          for (var j = 0; j < fyKeys.length; j++) {
            var fd = fyData[fyKeys[j]];
            var tr = document.createElement('tr');
            var exitFeeColStyle = exitFeeEnabled ? 'text-align:right;' : 'text-align:right;display:none;';
            var totalWithExitFee = fd.closingBalance + fd.exitFeeBalance;
            tr.innerHTML = '' +
              '<td>' + fd.label + '</td>' +
              '<td style="text-align:right;">$' + formatNumber(fd.openingBalance) + '</td>' +
              '<td style="text-align:right;">$' + formatNumber(fd.drawdowns) + '</td>' +
              '<td style="text-align:right;">$' + formatNumber(fd.repayments) + '</td>' +
              '<td style="text-align:right;">$' + formatNumber(fd.interestAccrued) + '</td>' +
              '<td style="text-align:right;">$' + formatNumber(fd.closingBalance) + '</td>' +
              '<td style="' + exitFeeColStyle + '">$' + formatNumber(fd.exitFeeAccrued) + '</td>' +
              '<td style="' + exitFeeColStyle + '">$' + formatNumber(fd.exitFeeBalance) + '</td>' +
              '<td style="' + exitFeeColStyle + '">$' + formatNumber(totalWithExitFee) + '</td>';
            yearlySummaryBody.appendChild(tr);
          }
        }
      }

      // Generated date
      var now = new Date();
      document.getElementById('tsDate').textContent = formatDateDDMMYYYY(now);
      if (document.getElementById('tsDateMonthly')) {
        document.getElementById('tsDateMonthly').textContent = formatDateDDMMYYYY(now);
      }
      if (document.getElementById('tsDateYearly')) {
        document.getElementById('tsDateYearly').textContent = formatDateDDMMYYYY(now);
      }

      // Trigger print
      window.print();
    }

    function cancelPrint() {
      document.getElementById('printOptionsModal').style.display = 'none';
    }

    // --- Save/Load Loans ---

    var STORAGE_KEY = 'loanManagementSavedLoans';

    // Try to migrate saved loans from old storage keys if they exist
    function migrateSavedLoans() {
      var oldKeys = ['savedLoans', 'loanManager_savedLoans', 'loans'];
      for (var i = 0; i < oldKeys.length; i++) {
        try {
          var oldData = localStorage.getItem(oldKeys[i]);
          if (oldData) {
            var existingData = localStorage.getItem(STORAGE_KEY);
            if (!existingData || existingData === '{}') {
              localStorage.setItem(STORAGE_KEY, oldData);
              console.log('Migrated saved loans from key: ' + oldKeys[i]);
              return true;
            }
          }
        } catch (e) {
          console.error('Error migrating from ' + oldKeys[i], e);
        }
      }
      return false;
    }

    // Run migration on load
    migrateSavedLoans();

    // Debug function - run debugLocalStorage() in browser console to see all stored data
    window.debugLocalStorage = function() {
      console.log('=== All localStorage keys ===');
      for (var i = 0; i < localStorage.length; i++) {
        var key = localStorage.key(i);
        console.log(key + ':', localStorage.getItem(key));
      }
      console.log('=== Current STORAGE_KEY ===', STORAGE_KEY);
      console.log('=== Saved loans ===', getSavedLoans());
    };

    function getSavedLoans() {
      try {
        var data = localStorage.getItem(STORAGE_KEY);
        return data ? JSON.parse(data) : {};
      } catch (e) {
        console.error('Error reading saved loans:', e);
        return {};
      }
    }

    function setSavedLoans(loans) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(loans));
      } catch (e) {
        console.error('Error saving loans:', e);
        alert('Error saving loan. Storage may be full.');
      }
    }

    function updateSavedLoansDropdown() {
      var select = document.getElementById('savedLoansSelect');
      var loans = getSavedLoans();
      var keys = Object.keys(loans).sort();
      
      select.innerHTML = '<option value="">â€” Load saved loan â€”</option>';
      for (var i = 0; i < keys.length; i++) {
        var option = document.createElement('option');
        option.value = keys[i];
        option.textContent = keys[i];
        select.appendChild(option);
      }
    }

    function collectLoanData() {
      // Collect all form data
      var data = {
        borrowerName: document.getElementById('borrowerName').value,
        lenderName: document.getElementById('lenderName').value,
        initialAmount: document.getElementById('initialAmount').value,
        loanStartDate: document.getElementById('loanStartDate').value,
        initialRate: document.getElementById('initialRate').value,
        fixedMargin: document.getElementById('fixedMargin').value,
        cashRateType: document.getElementById('cashRateType').value,
        baseRateSource: document.getElementById('baseRateSource').value,
        scheduleEndDate: document.getElementById('scheduleEndDate').value,
        firstRepaymentDate: document.getElementById('firstRepaymentDate').value,
        repaymentType: document.getElementById('repaymentType').value,
        principalHolidayStart: document.getElementById('principalHolidayStart').value,
        principalHolidayEnd: document.getElementById('principalHolidayEnd').value,
        balloonResidual: document.getElementById('balloonResidual').value,
        overridePayment: document.getElementById('overridePayment').value,
        enableNonAccrual: document.getElementById('enableNonAccrual').checked,
        exitFeeAmount: document.getElementById('exitFeeAmount').value,
        exitFeeFullOnEarly: document.getElementById('exitFeeFullOnEarly').checked,
        // New fields
        pikRate: document.getElementById('pikRate').value,
        loanCostsTotal: document.getElementById('loanCostsTotal').value,
        loanCostsData: loanCostsData,
        repaymentHolidayType: document.getElementById('repaymentHolidayType').value,
        repaymentHolidayStart: document.getElementById('repaymentHolidayStart').value,
        repaymentHolidayEnd: document.getElementById('repaymentHolidayEnd').value,
        defaultInterestRate: document.getElementById('defaultInterestRate').value,
        defaultInterestRateVar: document.getElementById('defaultInterestRateVar').value,
        transactions: [],
        rateChanges: [],
        defaultInterestPeriods: [],
        nonAccrualPeriods: [],
        paymentHolidays: []
      };

      // Collect payment holidays
      document.querySelectorAll('#paymentHolidaysBody tr').forEach(function(row) {
        var startInput = row.cells[0].querySelector('.date-input');
        var endInput = row.cells[1].querySelector('.date-input');
        if (startInput && endInput) {
          data.paymentHolidays.push({
            start: startInput.value,
            end: endInput.value
          });
        }
      });

      // Collect transactions
      document.querySelectorAll('#transactionsBody tr').forEach(function(row) {
        var dateInput = row.cells[0].querySelector('.date-input');
        var typeSelect = row.cells[1].querySelector('select');
        var amountInput = row.cells[2].querySelector('input');
        var descInput = row.cells[3].querySelector('input');
        if (dateInput && typeSelect && amountInput) {
          data.transactions.push({
            date: dateInput.value,
            type: typeSelect.value,
            amount: amountInput.value,
            description: descInput ? descInput.value : '',
            adjustPayments: row.dataset.adjustPayments === 'true'
          });
        }
      });

      // Collect rate changes
      document.querySelectorAll('#rateChangesBody tr').forEach(function(row) {
        var dateInput = row.cells[0].querySelector('.date-input');
        var rateInput = row.cells[1].querySelector('input');
        if (dateInput && rateInput) {
          data.rateChanges.push({
            date: dateInput.value,
            rate: rateInput.value
          });
        }
      });

      // Collect default interest periods
      document.querySelectorAll('#defaultInterestBody tr').forEach(function(row) {
        var startInput = row.cells[0].querySelector('.date-input');
        var endInput = row.cells[1].querySelector('.date-input');
        if (startInput && endInput) {
          data.defaultInterestPeriods.push({
            start: startInput.value,
            end: endInput.value
          });
        }
      });

      // Collect non-accrual periods
      document.querySelectorAll('#nonAccrualBody tr').forEach(function(row) {
        var startInput = row.cells[0].querySelector('.date-input');
        var endInput = row.cells[1].querySelector('.date-input');
        if (startInput && endInput) {
          data.nonAccrualPeriods.push({
            start: startInput.value,
            end: endInput.value
          });
        }
      });

      return data;
    }

    function applyLoanData(data) {
      // Apply simple fields
      document.getElementById('borrowerName').value = data.borrowerName || '';
      document.getElementById('lenderName').value = data.lenderName || '';
      document.getElementById('initialAmount').value = data.initialAmount || '';
      document.getElementById('loanStartDate').value = data.loanStartDate || '';
      document.getElementById('initialRate').value = data.initialRate || '';
      document.getElementById('fixedMargin').value = data.fixedMargin || '';
      // Handle legacy useBaseMargin -> cashRateType conversion
      if (data.cashRateType) {
        document.getElementById('cashRateType').value = data.cashRateType;
      } else {
        document.getElementById('cashRateType').value = data.useBaseMargin ? 'variable' : 'fixed';
      }
      document.getElementById('baseRateSource').value = data.baseRateSource || 'rba';
      document.getElementById('scheduleEndDate').value = data.scheduleEndDate || '';
      document.getElementById('firstRepaymentDate').value = data.firstRepaymentDate || '';
      document.getElementById('repaymentType').value = data.repaymentType || 'principalAndInterest';
      document.getElementById('principalHolidayStart').value = data.principalHolidayStart || '';
      document.getElementById('principalHolidayEnd').value = data.principalHolidayEnd || '';
      document.getElementById('balloonResidual').value = data.balloonResidual || '';
      document.getElementById('overridePayment').value = data.overridePayment || '';
      document.getElementById('enableNonAccrual').checked = data.enableNonAccrual !== false;
      // Exit fee fields
      document.getElementById('exitFeeAmount').value = data.exitFeeAmount || '';
      document.getElementById('exitFeeFullOnEarly').checked = data.exitFeeFullOnEarly === true;
      // New fields
      document.getElementById('pikRate').value = data.pikRate || '';
      document.getElementById('loanCostsTotal').value = data.loanCostsTotal || '';
      loanCostsData = data.loanCostsData || [];
      document.getElementById('repaymentHolidayType').value = data.repaymentHolidayType || 'none';
      document.getElementById('repaymentHolidayStart').value = data.repaymentHolidayStart || '';
      document.getElementById('repaymentHolidayEnd').value = data.repaymentHolidayEnd || '';

      // Clear and rebuild transactions
      document.getElementById('transactionsBody').innerHTML = '';
      if (data.transactions && data.transactions.length > 0) {
        for (var i = 0; i < data.transactions.length; i++) {
          var t = data.transactions[i];
          addTransactionRow({
            date: t.date ? parseDateUserInput(t.date) : null,
            type: t.type || 'drawdown',
            amount: parseFloat(t.amount) || 0,
            description: t.description || '',
            adjustPayments: t.adjustPayments === true
          });
        }
      } else {
        addTransactionRow({});
      }

      // Clear and rebuild rate changes
      document.getElementById('rateChangesBody').innerHTML = '';
      if (data.rateChanges && data.rateChanges.length > 0) {
        for (var i = 0; i < data.rateChanges.length; i++) {
          addRateChangeRow();
          var rows = document.querySelectorAll('#rateChangesBody tr');
          var row = rows[rows.length - 1];
          var r = data.rateChanges[i];
          row.cells[0].querySelector('.date-input').value = r.date || '';
          row.cells[1].querySelector('input').value = r.rate || '';
        }
      } else {
        addRateChangeRow();
      }

      // Restore default interest rate fields
      document.getElementById('defaultInterestRate').value = data.defaultInterestRate || '';
      document.getElementById('defaultInterestRateVar').value = data.defaultInterestRateVar || '';

      // Clear and rebuild default interest periods
      document.getElementById('defaultInterestBody').innerHTML = '';
      if (data.defaultInterestPeriods && data.defaultInterestPeriods.length > 0) {
        for (var i = 0; i < data.defaultInterestPeriods.length; i++) {
          addDefaultInterestRow();
          var rows = document.querySelectorAll('#defaultInterestBody tr');
          var row = rows[rows.length - 1];
          var d = data.defaultInterestPeriods[i];
          row.cells[0].querySelector('.date-input').value = d.start || '';
          row.cells[1].querySelector('.date-input').value = d.end || '';
        }
      }

      // Clear and rebuild non-accrual periods
      document.getElementById('nonAccrualBody').innerHTML = '';
      if (data.nonAccrualPeriods && data.nonAccrualPeriods.length > 0) {
        for (var i = 0; i < data.nonAccrualPeriods.length; i++) {
          addNonAccrualRow();
          var rows = document.querySelectorAll('#nonAccrualBody tr');
          var row = rows[rows.length - 1];
          var n = data.nonAccrualPeriods[i];
          row.cells[0].querySelector('.date-input').value = n.start || '';
          row.cells[1].querySelector('.date-input').value = n.end || '';
        }
      } else {
        addNonAccrualRow();
      }

      // Clear and rebuild payment holidays
      document.getElementById('paymentHolidaysBody').innerHTML = '';
      if (data.paymentHolidays && data.paymentHolidays.length > 0) {
        for (var i = 0; i < data.paymentHolidays.length; i++) {
          addPaymentHolidayRow();
          var rows = document.querySelectorAll('#paymentHolidaysBody tr');
          var row = rows[rows.length - 1];
          var p = data.paymentHolidays[i];
          row.cells[0].querySelector('.date-input').value = p.start || '';
          row.cells[1].querySelector('.date-input').value = p.end || '';
        }
      }

      // Apply visibility and recalculate
      applyBaseMarginVisibility();
      applyNonAccrualVisibility();
      updateCashRateTypeVisibility();
      updateRepaymentHolidayVisibility();
      updateTotalRateDisplay();
      recalculateMonthlyPayment(true);
      recalculateSchedule();
    }

    function saveLoan() {
      var select = document.getElementById('savedLoansSelect');
      var currentName = select.value;
      var name;
      
      // If a loan is currently loaded, save over it without prompting
      if (currentName) {
        name = currentName;
      } else {
        // No loan loaded, prompt for a name
        name = prompt('Enter a name for this loan:');
        if (!name || !name.trim()) return;
        name = name.trim();
        
        var loans = getSavedLoans();
        if (loans[name]) {
          if (!confirm('A loan with this name already exists. Overwrite?')) return;
        }
      }

      var loans = getSavedLoans();
      loans[name] = collectLoanData();
      loans[name].savedAt = new Date().toISOString();
      setSavedLoans(loans);
      updateSavedLoansDropdown();
      document.getElementById('savedLoansSelect').value = name;
    }

    function saveAsLoan() {
      var name = prompt('Enter a name for this loan:');
      if (!name || !name.trim()) return;
      name = name.trim();

      var loans = getSavedLoans();
      if (loans[name]) {
        if (!confirm('A loan with this name already exists. Overwrite?')) return;
      }

      loans[name] = collectLoanData();
      loans[name].savedAt = new Date().toISOString();
      setSavedLoans(loans);
      updateSavedLoansDropdown();
      document.getElementById('savedLoansSelect').value = name;
    }

    function loadLoan() {
      var select = document.getElementById('savedLoansSelect');
      var name = select.value;
      if (!name) return;

      var loans = getSavedLoans();
      if (!loans[name]) {
        alert('Loan not found.');
        return;
      }

      applyLoanData(loans[name]);
      alert('Loan loaded successfully.');
    }

    function deleteLoan() {
      var select = document.getElementById('savedLoansSelect');
      var name = select.value;
      if (!name) {
        alert('Please select a loan to delete.');
        return;
      }

      if (!confirm('Are you sure you want to delete "' + name + '"?')) return;

      var loans = getSavedLoans();
      delete loans[name];
      setSavedLoans(loans);
      updateSavedLoansDropdown();
      alert('Loan deleted.');
    }

    // --- Unsaved changes tracking and Home button ---
    var hasUnsavedChanges = false;

    function markUnsavedChanges() {
      hasUnsavedChanges = true;
    }

    function goHome() {
      if (hasUnsavedChanges) {
        var choice = confirm('You have unsaved changes. Would you like to save before leaving?\n\nClick OK to save, or Cancel to leave without saving.');
        if (choice) {
          saveLoan();
        }
      }
      window.location.href = 'index.html';
    }

    // --- Tests ---

    function runTests() {
      console.assert(formatNumber(1234.5) === '1,234.50', 'formatNumber positive');
      console.assert(formatNumber(-1234.5) === '(1,234.50)', 'formatNumber negative parentheses');
      console.assert(formatNumber(0) === '0.00', 'formatNumber zero');

      var pd = parseDateDDMM('15/12/2025');
      console.assert(pd && formatDateDDMMYYYY(pd) === '15/12/2025', 'DD/MM/YYYY parse/format');

      var iso = parseDateISO('2025-12-15');
      console.assert(iso && formatDateInput(iso) === '2025-12-15', 'ISO parse/format');

      var flex = parseDateUserInput('5-1-26');
      console.assert(flex && formatDateDDMMYYYY(flex) === '05/01/2026', 'flex date parse');

      // Non-accrual capitalisation map accumulates amounts on same date
      nonAccrualCapitalisations = [
        { date: utcDate(2026, 0, 10), amount: 100 },
        { date: utcDate(2026, 0, 10), amount: 50 }
      ];
      var capMap = buildCapMap();
      console.assert(capMap.get('2026-01-10') === 150, 'capMap sums same-day caps');

      // Default cap date should be the END of the latest non-accrual period (not day-after)
      var periods = [
        { start: utcDate(2026, 0, 1), end: utcDate(2026, 0, 5) },
        { start: utcDate(2026, 1, 1), end: utcDate(2026, 1, 12) }
      ];
      var latestEnd = periods.reduce(function (acc, p) { return (!acc || p.end > acc) ? p.end : acc; }, null);
      console.assert(latestEnd && formatDateInput(latestEnd) === '2026-02-12', 'latestEnd helper');

      // Capitalisation day is included in non-accrual; if the period continues, the day after remains non-accrual (new bucket starts).
      nonAccrualCapitalisations = [{ date: utcDate(2026, 1, 12), amount: 1 }];
      function isInPeriods(periods_, d) { return periods_.some(function (p) { return d >= p.start && d <= p.end; }); }
      console.assert(isInPeriods(periods, utcDate(2026, 1, 12)) === true, 'cap day in non-accrual');
      console.assert(isInPeriods(periods, utcDate(2026, 1, 13)) === true, 'day after cap still non-accrual if period continues');

      // Reset
      nonAccrualCapitalisations = [];
    }

    // --- Wiring ---

    document.getElementById('recalcButton').addEventListener('click', function () {
      recalculateMonthlyPayment(true);
      recalculateSchedule();
    });

    document.getElementById('clearAllButton').addEventListener('click', clearAll);
    document.getElementById('generatePiButton').addEventListener('click', function () { recalculateMonthlyPayment(false); });
    document.getElementById('exportExcelButton').addEventListener('click', exportToExcel);
    document.getElementById('printTermSheetButton').addEventListener('click', printTermSheet);
    document.getElementById('saveLoanButton').addEventListener('click', function() { saveLoan(); hasUnsavedChanges = false; });
    document.getElementById('saveAsLoanButton').addEventListener('click', function() { saveAsLoan(); hasUnsavedChanges = false; });
    document.getElementById('savedLoansSelect').addEventListener('change', function() { loadLoan(); hasUnsavedChanges = false; });
    document.getElementById('deleteLoanButton').addEventListener('click', deleteLoan);
    document.getElementById('homeButton').addEventListener('click', goHome);

    // Transaction modal event listeners
    document.getElementById('transactionModal').addEventListener('click', function(e) {
      if (e.target === this) closeTransactionModal();
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && document.getElementById('transactionModal').style.display === 'flex') {
        closeTransactionModal();
      }
    });

    ['overridePayment','principalHolidayMonths','principalHolidayStart','holidayInterestTreatment','piTermYears','balloonResidual','initialAmount','initialRate'].forEach(function (id) {
      document.getElementById(id).addEventListener('input', function () {
        if (id === 'initialRate') updateTotalRateDisplay();
        recalculateMonthlyPayment(true);
      });
    });

    document.getElementById('repaymentType').addEventListener('change', function () {
      recalculateMonthlyPayment(true);
      recalculateSchedule();
    });

    document.getElementById('holidayInterestTreatment').addEventListener('change', function () {
      var mode = this.value;
      var stack = document.getElementById('firstRepaymentStack');
      if (stack) stack.classList.toggle('hidden', mode === 'lumpSumEnd');
      recalculateMonthlyPayment(true);
      recalculateSchedule();
    });

    ['loanStartDate','scheduleEndDate','firstRepaymentDate','principalHolidayStart'].forEach(function (id) {
      document.getElementById(id).addEventListener('change', function () {
        recalculateMonthlyPayment(true);
      });
    });

    ['transactionsBody','rateChangesBody','defaultInterestBody','nonAccrualBody'].forEach(function (id) {
      var el = document.getElementById(id);
      el.addEventListener('input', function () { recalculateMonthlyPayment(true); });
      el.addEventListener('change', function () { recalculateMonthlyPayment(true); });
    });

    document.getElementById('enableNonAccrual').addEventListener('change', function () {
      applyNonAccrualVisibility();
      recalculateMonthlyPayment(true);
      recalculateSchedule();
    });

    // Cash Rate Type toggle
    document.getElementById('cashRateType').addEventListener('change', function () {
      updateCashRateTypeVisibility();
      recalculateMonthlyPayment(true);
      recalculateSchedule();
      checkDefaultInterestWarning();
    });

    // Default Interest Rate fields
    document.getElementById('defaultInterestRate').addEventListener('input', function () {
      recalculateSchedule();
      checkDefaultInterestWarning();
    });
    document.getElementById('defaultInterestRateVar').addEventListener('input', function () {
      recalculateSchedule();
      checkDefaultInterestWarning();
    });

    // Default Interest Body changes
    document.getElementById('defaultInterestBody').addEventListener('input', function () {
      recalculateSchedule();
      checkDefaultInterestWarning();
    });
    document.getElementById('defaultInterestBody').addEventListener('change', function () {
      recalculateSchedule();
      checkDefaultInterestWarning();
    });

    // Repayment Holiday Type toggle
    document.getElementById('repaymentHolidayType').addEventListener('change', function () {
      updateRepaymentHolidayVisibility();
      recalculateMonthlyPayment(true);
      recalculateSchedule();
    });

    // Loan Costs Edit button
    document.getElementById('editLoanCostsBtn').addEventListener('click', openLoanCostsModal);

    // PIK Rate input
    document.getElementById('pikRate').addEventListener('input', function () {
      recalculateMonthlyPayment(true);
      recalculateSchedule();
    });

    // Wire new date pickers
    wireDatePicker(document.getElementById('principalHolidayEnd'));
    wireDatePicker(document.getElementById('repaymentHolidayStart'));
    wireDatePicker(document.getElementById('repaymentHolidayEnd'));

    // Initialize visibility states
    updateCashRateTypeVisibility();
    updateRepaymentHolidayVisibility();

    document.getElementById('useBaseMargin').addEventListener('change', function () {
      applyBaseMarginVisibility();
      recalculateMonthlyPayment(true);
      recalculateSchedule();
    });

    document.getElementById('fixedMargin').addEventListener('input', function () {
      updateTotalRateDisplay();
      recalculateMonthlyPayment(true);
    });

    document.getElementById('baseRateSource').addEventListener('change', function () {
      if (this.value === 'rba') {
        applyRbaCashRates();
      }
      recalculateMonthlyPayment(true);
      recalculateSchedule();
    });

    // Exit fee event listeners with debouncing
    document.getElementById('enableExitFee').addEventListener('change', function () {
      applyExitFeeVisibility();
      recalculateSchedule();
    });

    var exitFeeInputDebounceTimer = null;
    document.getElementById('exitFeeAmount').addEventListener('input', function () {
      clearTimeout(exitFeeInputDebounceTimer);
      exitFeeInputDebounceTimer = setTimeout(function() {
        recalculateSchedule();
      }, 300);
    });

    document.getElementById('exitFeeDate').addEventListener('change', function () {
      recalculateSchedule();
    });

    wireDatePicker(document.getElementById('exitFeeDate'));

    wireDatePicker(document.getElementById('loanStartDate'));
    document.getElementById('loanStartDate').addEventListener('change', function () {
      var hs = document.getElementById('principalHolidayStart');
      if (!getInputDate(hs)) setInputDate(hs, getInputDate(document.getElementById('loanStartDate')));
      // Update RBA rates if enabled
      if (isRbaCashRateEnabled()) {
        applyRbaCashRates();
      }
    });
    wireDatePicker(document.getElementById('scheduleEndDate'));
    document.getElementById('scheduleEndDate').addEventListener('change', function () {
      // Update RBA rate changes if enabled
      if (isRbaCashRateEnabled()) {
        applyRbaCashRates();
      }
    });
    wireDatePicker(document.getElementById('firstRepaymentDate'));
    wireDatePicker(document.getElementById('principalHolidayStart'));
    wireDatePicker(document.getElementById('filterFromDate'));
    wireDatePicker(document.getElementById('filterToDate'));
    wireOpenButtons();

    document.getElementById('filterFromDate').addEventListener('change', function () {
      recalculateSchedule();
    });
    document.getElementById('filterToDate').addEventListener('change', function () {
      recalculateSchedule();
    });
    document.getElementById('displayMode').addEventListener('change', function () {
      recalculateSchedule();
    });
    document.getElementById('clearFilterButton').addEventListener('click', function () {
      setInputDate(document.getElementById('filterFromDate'), null);
      setInputDate(document.getElementById('filterToDate'), null);
      recalculateSchedule();
    });

    addTransactionRow({});
    addRateChangeRow();
    addNonAccrualRow();

    applyNonAccrualVisibility();
    applyBaseMarginVisibility();
    applyExitFeeVisibility();
    updateSavedLoansDropdown();

    // Track unsaved changes on any form input
    document.querySelectorAll('input, select, textarea').forEach(function(el) {
      el.addEventListener('input', markUnsavedChanges);
      el.addEventListener('change', markUnsavedChanges);
    });

    var ENABLE_TESTS = false;
    if (ENABLE_TESTS) {
      try { runTests(); } catch (e) { showError((e && e.message) || String(e)); }
    }
  </script>

  <!-- Term Sheet Print Template -->
  <div class="term-sheet" id="termSheet">
    <h1>Loan Details</h1>
    <h2>Indicative Terms and Conditions</h2>

    <div class="parties">
      <div class="party">
        <div class="party-label">Borrower</div>
        <div class="party-name" id="tsBorrower">â€”</div>
      </div>
      <div class="party" style="text-align:right;">
        <div class="party-label">Lender</div>
        <div class="party-name" id="tsLender">â€”</div>
      </div>
    </div>

    <div class="section-title">Loan Details</div>
    <table>
      <tr><th>Principal Amount</th><td id="tsPrincipal">â€”</td></tr>
      <tr><th>Loan Start Date</th><td id="tsStartDate">â€”</td></tr>
      <tr><th>Maturity Date</th><td id="tsEndDate">â€”</td></tr>
      <tr><th>Loan Term</th><td id="tsTerm">â€”</td></tr>
    </table>

    <div class="section-title">Interest</div>
    <table>
      <tr><th>Interest Rate</th><td id="tsInterestRate">â€”</td></tr>
      <tr><th>Rate Structure</th><td id="tsRateStructure">â€”</td></tr>
      <tr><th>Interest Calculation</th><td>Daily, 365-day year basis</td></tr>
      <tr><th>Interest Capitalisation</th><td>Monthly (calendar month-end)</td></tr>
    </table>

    <div class="section-title">Repayment</div>
    <table>
      <tr><th>Repayment Type</th><td id="tsRepaymentType">â€”</td></tr>
      <tr><th>First Repayment Date</th><td id="tsFirstRepayment">â€”</td></tr>
      <tr><th>Repayment Frequency</th><td>Monthly</td></tr>
      <tr><th>Initial Monthly Payment</th><td id="tsMonthlyPayment">â€”</td></tr>
      <tr><th>Balloon/Residual</th><td id="tsBalloon">â€”</td></tr>
    </table>

    <div class="section-title" id="tsRepaymentScheduleTitle" style="display:none;">Repayment Schedule</div>
    <table id="tsRepaymentScheduleTable" style="display:none;">
      <thead>
        <tr><th>Period</th><th>Monthly Repayment</th><th>Number</th></tr>
      </thead>
      <tbody id="tsRepaymentScheduleBody">
      </tbody>
    </table>

    <div class="section-title" id="tsHolidaySectionTitle" style="display:none;">Principal Holiday</div>
    <table id="tsHolidayTable" style="display:none;">
      <tr><th>Holiday Period</th><td id="tsHolidayPeriod">â€”</td></tr>
      <tr><th>Holiday Start Date</th><td id="tsHolidayStart">â€”</td></tr>
      <tr><th>Interest Treatment</th><td id="tsHolidayInterest">â€”</td></tr>
    </table>

    <div class="section-title" id="tsExitFeeSectionTitle" style="display:none;">Exit Fee</div>
    <table id="tsExitFeeTable" style="display:none;">
      <tr><th>Exit Fee Amount</th><td id="tsExitFeeAmount">â€”</td></tr>
      <tr><th>Exit Fee Date</th><td id="tsExitFeeDate">â€”</td></tr>
      <tr><th>Exit Fee Rate (Annual)</th><td id="tsExitFeeRateAnnual">â€”</td></tr>
      <tr><th>Exit Fee Rate (Daily Eff.)</th><td id="tsExitFeeRateDaily">â€”</td></tr>
    </table>

    <div class="section-title">Summary</div>
    <table>
      <tr><th>Total Interest Payable</th><td id="tsTotalInterest">â€”</td></tr>
      <tr id="tsExitFeeTotalRow" style="display:none;"><th>Exit Fee</th><td id="tsExitFeeTotal">â€”</td></tr>
      <tr id="tsTotalCostRow"><th>Total Cost of Loan</th><td id="tsTotalCost">â€”</td></tr>
      <tr><th>Final Balance</th><td id="tsFinalBalance">â€”</td></tr>
    </table>

    <div class="footer" id="tsFooterPage1">
      This term sheet is for discussion purposes only and does not constitute a binding commitment to lend.<br>
      Generated on <span id="tsDate">â€”</span>
    </div>

    <!-- Monthly Schedule Summary - separate page -->
    <div id="tsMonthlySummarySection" style="display:none;page-break-before:always;">
      <table id="tsMonthlySummaryTable">
        <caption style="font-size:16px;text-align:center;margin:0 0 15px;text-transform:uppercase;letter-spacing:0.1em;font-weight:bold;caption-side:top;">Schedule Summary - Monthly</caption>
        <thead>
          <tr style="background:#f0f0f0;">
            <th style="text-align:left;">Month</th>
            <th style="text-align:right;">Opening</th>
            <th style="text-align:right;">Drawdowns</th>
            <th style="text-align:right;">Repayments</th>
            <th style="text-align:right;">Interest</th>
            <th style="text-align:right;">Closing</th>
            <th style="text-align:right;" class="ts-exitfee-col">Exit Fee</th>
            <th style="text-align:right;" class="ts-exitfee-col">Exit Fee Bal</th>
            <th style="text-align:right;" class="ts-exitfee-col">Total</th>
          </tr>
        </thead>
        <tbody id="tsMonthlySummaryBody"></tbody>
      </table>
      <div class="footer" id="tsMonthlyFooter">
        Generated on <span id="tsDateMonthly">â€”</span>
      </div>
    </div>

    <!-- Yearly Schedule Summary - separate page -->
    <div id="tsYearlySummarySection" style="display:none;page-break-before:always;">
      <table id="tsYearlySummaryTable">
        <caption style="font-size:16px;text-align:center;margin:0 0 15px;text-transform:uppercase;letter-spacing:0.1em;font-weight:bold;caption-side:top;">Schedule Summary - Financial Year</caption>
        <thead>
          <tr style="background:#f0f0f0;">
            <th style="text-align:left;">Financial Year</th>
            <th style="text-align:right;">Opening</th>
            <th style="text-align:right;">Drawdowns</th>
            <th style="text-align:right;">Repayments</th>
            <th style="text-align:right;">Interest</th>
            <th style="text-align:right;">Closing</th>
            <th style="text-align:right;" class="ts-exitfee-col">Exit Fee</th>
            <th style="text-align:right;" class="ts-exitfee-col">Exit Fee Bal</th>
            <th style="text-align:right;" class="ts-exitfee-col">Total</th>
          </tr>
        </thead>
        <tbody id="tsYearlySummaryBody"></tbody>
      </table>
      <div class="footer">
        Generated on <span id="tsDateYearly">â€”</span>
      </div>
    </div>
  </div>

  <!-- Print Options Modal -->
  <div class="print-modal-overlay" id="printOptionsModal">
    <div class="print-modal">
      <h3>Print Options</h3>
      <label>
        <input type="checkbox" id="printMonthlyCheck" checked />
        Include Monthly Schedule Summary
      </label>
      <label>
        <input type="checkbox" id="printYearlyCheck" checked />
        Include Financial Year Schedule Summary
      </label>
      <div class="print-modal-buttons">
        <button class="btn" type="button" onclick="cancelPrint()">Cancel</button>
        <button class="btn btn-primary" type="button" onclick="executePrint()">Print</button>
      </div>
    </div>
  </div>

</body>
</html>
